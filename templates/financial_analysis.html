{% extends "layout.html" %}

{% block title %}レーダーチャート{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
    }
    .table-container {
        width: 100%;
        margin: auto;
        border-collapse: collapse;
    }
    .table-container th, .table-container td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
    }
    .table-container th {
        background-color: #f2f2f2;
    }
    .highlight {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    .total {
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
    }
    .score {
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        color: red;
    }
</style>

{% if indicators | length == 0 %}
    <div class="alert alert-danger mt-5" role="alert">
        財務データが登録されていません。決算情報設定ページから財務データを登録してください。
    </div>
{% else %}
    <div class="row mt-4">
        <div class="col-sm-5">
            <h3>■ {{ indicators[0].year }}年{{ indicators[0].month }}月基本情報</h3>
            <table class="table-container">
                <tr>
                    <th>商号</th>
                    <td>{{ current_user.company_name }}</td>
                </tr>
                <tr>
                    <th>所在地</th>
                    <td>{{ current_user.prefecture }}{{ current_user.city }}{{ current_user.area }}</td>
                </tr>
                <tr>
                    <th>代表者名</th>
                    <td>{{ current_user.representative_name }}</td>
                </tr>
                <tr>
                    <th>業種_大分類</th>
                    <td>{{ indicators[0].large_category }}</td>
                </tr>
                <tr>
                    <th>業種_小分類</th>
                    <td>{{ indicators[0].small_category }}</td>
                </tr>
                <tr>
                    <th>事業規模</th>
                    <td>{{ indicators[0].business_scale }}</td>
                </tr>
                <tr>
                    <th>売上高</th>
                    <td>{{ indicators[0].sales }}</td>
                </tr>
                <tr>
                    <th>営業利益</th>
                    <td>{{ indicators[0].operating_income }}</td>
                </tr>
                <tr>
                    <th>従業員数</th>
                    <td>{{ indicators[0].employee_number }}(人)</td>
                </tr>
            </table>
        </div>
        <div class="col-sm-7">
            <div class="w-100 mt-3">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row my-4">
        <div class="col-sm-12">
            <h3>■財務指標（最新期および過去データ）</h3>
            <table class="table-container">
                <thead>
                    <tr>
                        <th rowspan="2">指標</th>
                        {% for indicator in indicators %}
                            <th colspan="3">{{ indicator.year }}年{{ indicator.month }}月</th>
                        {% endfor %}
                    </tr>
                    <tr>
                        {% for indicator in indicators %}
                            <th>算出結果</th>
                            <th>貴社点数</th>
                            <th>業種基準値</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- 売上増加率 -->
                    <tr>
                        <td>①売上増加率</td>
                        {% for indicator in indicators %}
                            <td>{{ indicator['sales_growth_rate'] }}%</td>
                            <td>{{ indicator['sales_growth_rate_score'] }}</td>
                            <td>{{ (indicator['sales_growth_rate_median'] * 100) | round(2) }}%</td>
                        {% endfor %}
                    </tr>
                    <!-- 営業利益率 -->
                    <tr>
                        <td>②営業利益率</td>
                        {% for indicator in indicators %}
                            <td>{{ indicator['operating_profit_margin'] }}%</td>
                            <td>{{ indicator['operating_profit_margin_score'] }}</td>
                            <td>{{ (indicator['operating_profit_margin_median'] * 100) | round(2) }}%</td>
                        {% endfor %}
                    </tr>
                    <!-- 労働生産性 -->
                    <tr>
                        <td>③労働生産性</td>
                        {% for indicator in indicators %}
                            <td>{{ indicator['labor_productivity'] | round(1) }}(円)</td>
                            <td>{{ indicator['labor_productivity_score'] }}</td>
                            <td>{{ indicator['labor_productivity_median'] | round(1) }}(円)</td>
                        {% endfor %}
                    </tr>
                    <!-- 他の指標も同様に -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- レーダーチャート表示 -->
    <script>
        var ctx = document.getElementById('radarChart').getContext('2d');
        var radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: [
                    '売上増加率',
                    '営業利益率',
                    '労働生産性',
                    'EBITDA有利子負債倍率',
                    '営業運転資本回転期間',
                    '自己資本比率'
                ],
                datasets: [
                {% for indicator in indicators %}
                {
                    label: '{{ indicator.year }}年{{ indicator.month }}月',
                    data: [
                        {{ indicator['sales_growth_rate_score'] }},
                        {{ indicator['operating_profit_margin_score'] }},
                        {{ indicator['labor_productivity_score'] }},
                        {{ indicator['ebitda_interest_bearing_debt_ratio_score'] }},
                        {{ indicator['operating_working_capital_turnover_period_score'] }},
                        {{ indicator['equity_ratio_score'] }}
                    ],
                    borderColor: '{{ ['orange', 'blue', 'gray'][loop.index0] }}',
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    pointBackgroundColor: '{{ ['orange', 'blue', 'gray'][loop.index0] }}',
                    fill: false
                },
                {% endfor %}
            ]
            },
            options: {
                scale: {
                    ticks: {
                        beginAtZero: true,
                        max: 5
                    },
                    pointLabels: {
                        fontSize: 14,
                        padding: 10
                    }
                }
            }
        });
    </script>
{% endif %}

{% endblock %}
