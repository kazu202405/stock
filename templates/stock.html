{% extends "layout.html" %}

{% block title %}{% if is_admin %}ç®¡ç†ç”»é¢ - {% endif %}Company Note{% endblock %}

{% block content %}
<style>
    /* çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

    :root {
        --primary-color: #1b4332;
        --secondary-color: #2d6a4f;
        --accent-color: #2d6a4f;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --border-color: #e5e5e0;
        --bg-light: #fafaf8;
    }

    body {
        background: #f7f7f5;
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
        color: var(--text-primary);
    }

    .report-container {
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #ebebeb;
        margin-bottom: 20px;
    }

    .report-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .search-bar {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .stock-code-input {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95rem;
        width: 180px;
        transition: all 0.2s;
    }

    .stock-code-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.1);
    }

    .analyze-button {
        padding: 8px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .analyze-button:hover {
        background: var(--secondary-color);
    }

    .register-button {
        padding: 8px 20px;
        background: var(--success-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .register-button:hover {
        background: #059669;
    }

    .register-button.registered {
        background: var(--text-secondary);
        cursor: default;
    }

    .register-button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚°ãƒªãƒƒãƒ‰ */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .summary-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
    }

    .company-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 2px;
    }

    .stock-price-display {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .company-code {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 15px;
    }

    .key-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .metric-item {
        padding: 12px;
        background: var(--bg-light);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
    }

    /* ä¸Šéƒ¨ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
    .metric-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-color), #52b788);
        opacity: 0.8;
    }

    .metric-item.good::before {
        background: linear-gradient(90deg, var(--success-color), #34d399);
    }

    .metric-item.warning::before {
        background: linear-gradient(90deg, var(--warning-color), #fbbf24);
    }

    .metric-item.danger::before {
        background: linear-gradient(90deg, var(--danger-color), #f87171);
    }

    /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .metric-item:hover::before {
        height: 4px;
        opacity: 1;
    }

    .metric-item {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .metric-sub {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* ãƒãƒ£ãƒ¼ãƒˆ */
    /* åˆè‡´åº¦ã‚«ãƒ¼ãƒ‰ */
    .score-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .score-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .score-main {
        text-align: center;
        padding: 10px 0;
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .score-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    .score-value.high { color: #10b981; }
    .score-value.medium { color: #f59e0b; }
    .score-value.low { color: #ef4444; }

    .score-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .score-details {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px 12px;
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 0.75rem;
    }

    .score-item-label {
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .score-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }

    .score-item-status {
        font-weight: 500;
    }

    .score-item-status.pass { color: #10b981; }
    .score-item-status.fail { color: #ef4444; }

    .chart-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        height: 100%;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .time-selector {
        display: flex;
        gap: 5px;
    }

    .time-btn {
        padding: 4px 8px;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .time-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .chart-placeholder {
        height: 220px;
        background: var(--bg-light);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« - 4ã‚«ãƒ©ãƒ ã«å¤‰æ›´ */
    .details-section {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    /* ã‚«ãƒ¼ãƒ‰ã®ä¸Šéƒ¨ã«ç´°ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ³ */
    .detail-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-color), #52b788);
        opacity: 0.6;
    }

    .detail-card:hover::after {
        height: 3px;
        opacity: 1;
    }

    .detail-header {
        background: var(--bg-light);
        padding: 12px 16px;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .detail-content {
        padding: 16px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .detail-value {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    /* è²¡å‹™æŒ‡æ¨™ãƒ†ãƒ¼ãƒ–ãƒ« */
    .financial-table {
        width: 100%;
        font-size: 0.85rem;
    }

    .financial-table th {
        text-align: left;
        padding: 8px 0;
        color: var(--text-secondary);
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
    }

    .financial-table td {
        padding: 8px 0;
        color: var(--text-primary);
    }

    .trend-up {
        color: var(--success-color);
    }

    .trend-down {
        color: var(--danger-color);
    }

    /* æ ªä¸»æ§‹æˆ */
    .shareholder-list, .executive-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .shareholder-item, .executive-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .shareholder-item:last-child, .executive-item:last-child {
        border-bottom: none;
    }

    .shareholder-name, .executive-name {
        font-size: 0.85rem;
        color: var(--text-primary);
    }

    .shareholder-percent {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--accent-color);
    }

    .executive-title {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .founder-tag {
        display: inline-block;
        padding: 2px 6px;
        background: var(--warning-color);
        color: white;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }

    .executive-tag {
        display: inline-block;
        padding: 2px 6px;
        background: var(--accent-color);
        color: white;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }

    /* é…å½“æ¨ç§»ã®ãƒŸãƒ‹ãƒãƒ£ãƒ¼ãƒˆ */
    .dividend-chart {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        height: 80px;
        margin-top: 10px;
    }

    .dividend-bar {
        flex: 1;
        background: linear-gradient(180deg, #52b788, var(--primary-color));
        border-radius: 3px 3px 0 0;
        position: relative;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .dividend-bar:hover {
        opacity: 1;
    }

    .dividend-year {
        position: absolute;
        bottom: -18px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.65rem;
        color: var(--text-secondary);
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 0.95rem;
    }

    .loading-subtext {
        font-size: 0.8rem;
        color: var(--text-secondary);
        opacity: 0.7;
    }

    .results-area {
        display: none;
    }

    .results-area.active {
        display: block;
    }

    /* ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆä¸€è¦§ */
    .watchlist-section {
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .watchlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .watchlist-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .watchlist-count {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .bulk-register-btn {
        padding: 6px 12px;
        font-size: 12px;
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .bulk-register-btn:hover {
        background-color: #059669;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 16px;
        color: #1f2937;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #9ca3af;
        cursor: pointer;
        line-height: 1;
    }

    .modal-close:hover {
        color: #4b5563;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 15px 20px;
        border-top: 1px solid #eee;
    }

    .modal-cancel-btn {
        padding: 8px 16px;
        font-size: 13px;
        background-color: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-cancel-btn:hover {
        background-color: #e5e7eb;
    }

    .modal-submit-btn {
        padding: 8px 16px;
        font-size: 13px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-submit-btn:hover {
        background-color: #2563eb;
    }

    .modal-submit-btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }

    .watchlist-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .watchlist-table th {
        text-align: left;
        padding: 10px 8px;
        background: var(--bg-light);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.8rem;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    .watchlist-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #f1f5f9;
        color: var(--text-primary);
    }

    .watchlist-table tr:hover {
        background: var(--bg-light);
    }

    .watchlist-table .company-name-cell {
        font-weight: 500;
        cursor: pointer;
        color: var(--accent-color);
    }

    .watchlist-table .company-name-cell:hover {
        text-decoration: underline;
    }

    .watchlist-table .delete-btn {
        padding: 4px 8px;
        background: transparent;
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .watchlist-table .delete-btn:hover {
        background: var(--danger-color);
        color: white;
    }

    .watchlist-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .metric-good { color: var(--success-color); }
    .metric-warning { color: var(--warning-color); }
    .metric-danger { color: var(--danger-color); }

    /* åˆè‡´åº¦ã®è‰²åˆ†ã‘ */
    .match-rate-high {
        color: var(--success-color);
        font-weight: 600;
    }
    .match-rate-medium {
        color: var(--warning-color);
        font-weight: 600;
    }
    .match-rate-low {
        color: var(--danger-color);
        font-weight: 600;
    }

    /* åˆè‡´åº¦ã®èª¬æ˜æ–‡ */
    .match-rate-description {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: #f8fafc;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 12px;
        border-left: 3px solid var(--accent-color);
    }

    /* ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ  */
    .watchlist-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 0;
    }

    .watchlist-tab {
        padding: 10px 20px;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .watchlist-tab:hover {
        color: var(--primary-color);
    }

    .watchlist-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        font-weight: 600;
    }

    .tab-content {
        display: none;
        padding-top: 16px;
    }

    .tab-content.active {
        display: block;
    }

    /* GCå–å¾—ãƒœã‚¿ãƒ³ */
    .gc-fetch-btn {
        padding: 6px 14px;
        font-size: 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .gc-fetch-btn:hover {
        opacity: 0.85;
    }

    .gc-fetch-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* GCãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
    .gc-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        gap: 16px;
    }

    .gc-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid #e5e7eb;
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: gc-spin 0.8s linear infinite;
    }

    @keyframes gc-spin {
        to { transform: rotate(360deg); }
    }

    .gc-loading-text {
        font-size: 13px;
        color: #6b7280;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1400px) {
        .details-section {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .details-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .report-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .search-bar {
            width: 100%;
        }

        .stock-code-input {
            flex: 1;
        }

        .key-metrics {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    .editable-field {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 2px 6px;
        margin: -2px -6px;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        width: auto;
        min-width: 60px;
        transition: all 0.2s;
    }

    .editable-field:hover {
        border-color: var(--border-color);
        background: white;
    }

    .editable-field:focus {
        outline: none;
        border-color: var(--accent-color);
        background: white;
        box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
    }

    .editable-cell {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 3px;
        padding: 4px 8px;
        font-size: inherit;
        color: inherit;
        width: 80px;
        text-align: right;
        transition: all 0.2s;
        -moz-appearance: textfield;
    }

    .editable-cell::-webkit-outer-spin-button,
    .editable-cell::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .editable-cell:hover {
        border-color: var(--border-color);
        background: white;
    }

    .editable-cell:focus {
        outline: none;
        border-color: var(--accent-color);
        background: white;
    }

    /* ä¿å­˜ãƒœã‚¿ãƒ³ */
    .save-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        text-align: center;
    }

    .save-section.active {
        display: block;
    }

    .save-button {
        padding: 12px 40px;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .save-button:hover {
        background: var(--primary-color);
    }

    .save-button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }

    .edit-hint {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 10px;
    }
</style>

<div class="report-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="report-header">
        <div class="search-bar">
            <input type="text" class="stock-code-input" id="stockCode" placeholder="éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (ä¾‹: 7203 / 6758.T / AAPL)">
            <button class="analyze-button" onclick="analyzeStock()">æŠ½å‡º</button>
            <button class="register-button" id="registerBtn" onclick="registerStock()" style="display: none;">ç™»éŒ²</button>
        </div>
    </div>

    <!-- ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆä¸€è¦§ -->
    <div class="watchlist-section" id="watchlistSection">
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="watchlist-tabs">
            <button class="watchlist-tab active" onclick="switchTab('watchlist')" id="tab-watchlist">
                æ¡ä»¶åˆè‡´ä¼æ¥­
            </button>
            <button class="watchlist-tab" onclick="switchTab('gc')" id="tab-gc">
                GCéŠ˜æŸ„
            </button>
            <button class="watchlist-tab" onclick="switchTab('dc')" id="tab-dc">
                DCéŠ˜æŸ„
            </button>
        </div>

        <!-- ã‚¿ãƒ–1: æ¡ä»¶åˆè‡´ä¼æ¥­ï¼ˆæ—¢å­˜ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆï¼‰ -->
        <div class="tab-content active" id="tabContent-watchlist">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    {% if is_admin %}
                    <button class="bulk-register-btn" onclick="openBulkRegisterModal()">ä¸€æ‹¬ç™»éŒ²</button>
                    <button class="gc-fetch-btn" onclick="removeAllWatchlist()" style="background-color: #dc2626;">ã™ã¹ã¦å‰Šé™¤</button>
                    {% endif %}
                    <button class="gc-fetch-btn" onclick="analyzeWlStocks()" id="wlAnalyzeBtn" style="background-color: #2563eb;">è©³ç´°å–å¾—</button>
                    <button class="gc-fetch-btn" onclick="stopWlAnalyze()" id="wlStopBtn" style="background-color: #dc2626; display: none;">åœæ­¢</button>
                    <span class="watchlist-count" id="watchlistCount">0ä»¶</span>
                </div>
            </div>
            <div class="match-rate-description">
                ã€Œåˆè‡´åº¦ã€ã¯ã€è‡ªå·±è³‡æœ¬æ¯”ç‡ãƒ»å–¶æ¥­åˆ©ç›Šç‡ãƒ»ROEç­‰ã®è²¡å‹™æŒ‡æ¨™ãŒã€ä¸€èˆ¬çš„ãªæŠ•è³‡åŸºæº–ã«ã©ã®ç¨‹åº¦åˆè‡´ã—ã¦ã„ã‚‹ã‹ã‚’ç¤ºã™å‚è€ƒå€¤ã§ã™ã€‚æŠ•è³‡åˆ¤æ–­ã‚’æ¨å¥¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </div>
            <div id="watchlistContent">
                <div class="watchlist-empty">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–2: GCé”æˆéŠ˜æŸ„ -->
        <div class="tab-content" id="tabContent-gc">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="gc-fetch-btn" onclick="fetchGcStocks()" id="gcFetchBtn">å–å¾—</button>
                    <button class="gc-fetch-btn" onclick="analyzeGcStocks()" id="gcAnalyzeBtn" style="background-color: #2563eb;">è©³ç´°å–å¾—</button>
                    <button class="gc-fetch-btn" onclick="stopGcAnalyze()" id="gcStopBtn" style="background-color: #dc2626; display: none;">åœæ­¢</button>
                    <span class="watchlist-count" id="gcCount">0ä»¶</span>
                </div>
            </div>
            <div class="match-rate-description">
                kabutan.jpã®ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹ï¼ˆ5æ—¥ç·šãŒ25æ—¥ç·šã‚’ä¸ŠæŠœã‘ï¼‰éŠ˜æŸ„ã‹ã‚‰ã€PER40å€æœªæº€ãƒ»PBR10å€æœªæº€ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™ã€‚
            </div>
            <div id="gcContent">
                <div class="watchlist-empty">ã€Œå–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦GCéŠ˜æŸ„ã‚’å–å¾—ã—ã¦ãã ã•ã„</div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–3: DCéŠ˜æŸ„ -->
        <div class="tab-content" id="tabContent-dc">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="gc-fetch-btn" onclick="fetchDcStocks()" id="dcFetchBtn">å–å¾—</button>
                    <span class="watchlist-count" id="dcCount">0ä»¶</span>
                </div>
            </div>
            <div class="match-rate-description">
                kabutan.jpã®ãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹ï¼ˆ5æ—¥ç·šãŒ25æ—¥ç·šã‚’ä¸‹æŠœã‘ï¼‰éŠ˜æŸ„ã®ä¸€è¦§ã§ã™ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãªã—ã§å…¨ä»¶è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
            </div>
            <div id="dcContent">
                <div class="watchlist-empty">ã€Œå–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦DCéŠ˜æŸ„ã‚’å–å¾—ã—ã¦ãã ã•ã„</div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- ä¸€æ‹¬ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="bulkRegisterModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>éŠ˜æŸ„ä¸€æ‹¬ç™»éŒ²</h3>
                <button class="modal-close" onclick="closeBulkRegisterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px; color: #666; font-size: 13px;">
                    éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã¾ãŸã¯æ”¹è¡Œã§å…¥åŠ›ã—ã¦ãã ã•ã„
                </p>
                <textarea id="bulkCodesInput" placeholder="ä¾‹: 7203, 6758, 9984&#10;ã¾ãŸã¯&#10;7203&#10;6758&#10;9984" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
                <div id="bulkRegisterStatus" style="margin-top: 10px; font-size: 13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-cancel-btn" onclick="closeBulkRegisterModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-submit-btn" onclick="submitBulkRegister()">ç™»éŒ²</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
            <div class="loading-subtext">ç›®å®‰ï¼š10ï½20ç§’ç¨‹åº¦</div>
        </div>
    </div>

    <!-- çµæœã‚¨ãƒªã‚¢ -->
    <div class="results-area" id="resultsArea">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content-grid">
            <!-- å·¦å´: ã‚µãƒãƒªãƒ¼æƒ…å ± -->
            <div class="summary-card">
                <div class="company-name">ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š</div>
                <div class="stock-price-display" id="stock-price-display">Â¥2,850</div>
                <div class="company-code">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰: 7203 | è‡ªå‹•è»Šè£½é€ æ¥­</div>
                
                <div class="key-metrics">
                    <div class="metric-item good">
                        <div class="metric-label">è‡ªå·±è³‡æœ¬æ¯”ç‡</div>
                        <div class="metric-value">42.5%</div>
                        <div class="metric-sub">å¥å…¨æ€§: è‰¯å¥½</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">å–¶æ¥­åˆ©ç›Šç‡</div>
                        <div class="metric-value">9.8%</div>
                        <div class="metric-sub">åç›Šæ€§: è‰¯å¥½</div>
                    </div>
                    <div class="metric-item warning">
                        <div class="metric-label">PER</div>
                        <div class="metric-value">11.2å€</div>
                        <div class="metric-sub">æ¥­ç•Œå¹³å‡: 10.5å€</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">PBR</div>
                        <div class="metric-value">0.95å€</div>
                        <div class="metric-sub">å‰²å®‰æ°´æº–</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">é…å½“åˆ©å›ã‚Š</div>
                        <div class="metric-value">2.8%</div>
                        <div class="metric-sub">5å¹´é€£ç¶šå¢—é…</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">æ™‚ä¾¡ç·é¡</div>
                        <div class="metric-value">40.2å…†å††</div>
                        <div class="metric-sub">å›½å†…æœ€å¤§ç´š</div>
                    </div>
                </div>
            </div>

            <!-- ä¸­å¤®: åˆè‡´åº¦ã‚¹ã‚³ã‚¢ -->
            <div class="score-card">
                <div class="score-header">åˆè‡´åº¦</div>
                <div class="score-main">
                    <div class="score-value" id="score-value">--</div>
                    <div class="score-label">/ 120</div>
                </div>
                <div class="score-details" id="score-details">
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#64748b;"></span>æ™‚ä¾¡ç·é¡ â‰¤700å„„</span>
                        <span class="score-item-status" id="score-market-cap">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#2563eb;"></span>è‡ªå·±è³‡æœ¬æ¯”ç‡ â‰¥30%</span>
                        <span class="score-item-status" id="score-equity-ratio">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#16a34a;"></span>å£²ä¸Šæˆé•·(å®Ÿç¸¾)</span>
                        <span class="score-item-status" id="score-revenue-growth">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#059669;"></span>å£²ä¸Šæˆé•·(äºˆæƒ³)</span>
                        <span class="score-item-status" id="score-revenue-forecast">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#ea580c;"></span>å–¶æ¥­åˆ©ç›Šç‡ â‰¥10%</span>
                        <span class="score-item-status" id="score-op-margin">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#0d9488;"></span>å–¶åˆ©æˆé•·(å®Ÿç¸¾)</span>
                        <span class="score-item-status" id="score-op-growth">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#0891b2;"></span>å–¶åˆ©æˆé•·(äºˆæƒ³)</span>
                        <span class="score-item-status" id="score-op-forecast">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#7c3aed;"></span>å–¶æ¥­CF >0</span>
                        <span class="score-item-status" id="score-op-cf">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#a855f7;"></span>ãƒ•ãƒªãƒ¼CF >0</span>
                        <span class="score-item-status" id="score-free-cf">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#dc2626;"></span>ROA >4.5%</span>
                        <span class="score-item-status" id="score-roa">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#ca8a04;"></span>PER <40å€</span>
                        <span class="score-item-status" id="score-per">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#db2777;"></span>PBR <10å€</span>
                        <span class="score-item-status" id="score-pbr">--</span>
                    </div>
                </div>
            </div>

            <!-- å³å´: ãƒãƒ£ãƒ¼ãƒˆï¼ˆTradingViewï¼‰ -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">æ ªä¾¡æ¨ç§»</div>
                </div>
                <div class="chart-placeholder" id="tradingview-chart-container">
                    <div style="display:flex;align-items:center;justify-content:center;height:300px;color:#64748b;">
                        éŠ˜æŸ„ã‚’é¸æŠã™ã‚‹ã¨ãƒãƒ£ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¼šç¤¾æ¦‚è¦ãƒ»äº‹æ¥­èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="business-summary-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">äº‹æ¥­æ¦‚è¦</div>
                <div class="detail-content">
                    <div id="business-summary-content" style="line-height: 1.8; color: var(--text-primary); font-size: 0.95rem;">
                        <div class="loading-state" style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå››å­£å ±ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
        <div class="financial-data-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">è²¡å‹™ãƒ‡ãƒ¼ã‚¿ï¼ˆç›´è¿‘5å¹´ï¼‰</div>
                <div class="detail-content" style="overflow-x: auto;">
                    <table class="financial-table" style="width: 100%; min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; width: 100px;">æ±ºç®—æœŸ</th>
                                <th>å£²ä¸Šé«˜(å„„å††)</th>
                                <th>å–¶æ¥­åˆ©ç›Š(å„„å††)</th>
                                <th>çµŒå¸¸åˆ©ç›Š(å„„å††)</th>
                                <th>ç´”åˆ©ç›Š(å„„å††)</th>
                                <th>1æ ªç›Š(å††)</th>
                                <th>1æ ªé…(å††)</th>
                                <th>é…å½“æ€§å‘(%)</th>
                            </tr>
                        </thead>
                        <tbody id="financial-data-tbody">
                            <tr data-year="1">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="2">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="3">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="4">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="5">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ»è²¡å‹™æŒ‡æ¨™ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="financial-metrics-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ»è²¡å‹™æŒ‡æ¨™</div>
                <div class="detail-content" style="overflow-x: auto;">
                    <table class="financial-table" style="width: 100%; min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; width: 100px;">æ±ºç®—æœŸ</th>
                                <th>å–¶æ¥­CF(å„„å††)</th>
                                <th>æŠ•è³‡CF(å„„å††)</th>
                                <th>è²¡å‹™CF(å„„å††)</th>
                                <th>ç¾é‡‘ç­‰(å„„å††)</th>
                                <th>æµå‹•è² å‚µ(å„„å††)</th>
                                <th>è‡ªå·±è³‡æœ¬æ¯”ç‡(%)</th>
                                <th>ROE(%)</th>
                                <th>ROA(%)</th>
                            </tr>
                        </thead>
                        <tbody id="cf-metrics-tbody">
                            <tr data-year="1">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="2">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="3">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="4">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="5">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è©³ç´°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - 3ã‚«ãƒ©ãƒ ï¼ˆè²¡å‹™å¥å…¨æ€§ãƒ»ä¸»è¦æ ªä¸»ãƒ»å½¹å“¡æ§‹æˆï¼‰ -->
        <div class="details-section" style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 20px;">

            <!-- è²¡å‹™å¥å…¨æ€§ -->
            <div class="detail-card">
                <div class="detail-header">è²¡å‹™å¥å…¨æ€§</div>
                <div class="detail-content">
                    <div class="detail-row">
                        <span class="detail-label">ç¾é é‡‘</span>
                        <span class="detail-value" id="cash-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">æµå‹•è² å‚µ</span>
                        <span class="detail-value" id="current-liab-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">æµå‹•æ¯”ç‡</span>
                        <span class="detail-value" id="current-ratio-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">é…å½“æ€§å‘</span>
                        <span class="detail-value" id="payout-ratio-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ä¿¡ç”¨å€ç‡</span>
                        <span class="detail-value" id="margin-ratio-display">---</span>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f5f9;">
                        <div class="detail-row">
                            <span class="detail-label" style="font-size: 0.75rem; color: #94a3b8;">ç¾é é‡‘æ¨ç§»</span>
                        </div>
                        <div id="cash-trend" style="margin-top: 8px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #64748b;">
                                <span id="cash-old">---</span>
                                <span>â†’</span>
                                <span id="cash-new" style="font-weight: 600;">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»è¦æ ªä¸» -->
            <div class="detail-card">
                <div class="detail-header">ä¸»è¦æ ªä¸»</div>
                <div class="detail-content">
                    <div id="major-holders-content">
                        <div class="loading-state">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ -->
                    <div id="holders-source-left" style="margin-top: 10px; font-size: 11px; color: #666;">
                    </div>
                </div>
            </div>

            <!-- å½¹å“¡æ§‹æˆ -->
            <div class="detail-card">
                <div class="detail-header">å½¹å“¡æ§‹æˆ</div>
                <div class="detail-content">
                    <div id="company-officers-content">
                        <div class="loading-state">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ -->
                    <div id="holders-source-right" style="margin-top: 10px; font-size: 11px; color: #666;">
                    </div>
                </div>
            </div>
        </div>

        {% if is_admin %}
        <!-- ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="save-section" id="saveSection">
            <p class="edit-hint">ğŸ’¡ è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å€¤ã¯ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚ç·¨é›†å¾Œã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="save-button" onclick="saveEditedData()">å¤‰æ›´ã‚’ä¿å­˜</button>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
    // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
    const IS_ADMIN = {{ 'true' if is_admin else 'false' }};

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
    let priceChart = null;
    let candlestickSeries = null;
    let volumeSeries = null;

    // ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showCandlestickChart(priceHistory) {
        const container = document.getElementById('tradingview-chart-container');
        if (!container) return;

        // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        container.innerHTML = '';

        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
        if (!priceHistory || priceHistory.length === 0) {
            container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:300px;color:#666;">æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
        if (priceChart) {
            priceChart.remove();
            priceChart = null;
        }

        // ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
        priceChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 300,
            layout: {
                background: { type: 'solid', color: '#ffffff' },
                textColor: '#333333',
            },
            grid: {
                vertLines: { color: '#e1e1e1' },
                horzLines: { color: '#e1e1e1' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
            localization: {
                locale: 'ja-JP',
                dateFormat: 'yyyy/MM/dd',
            },
        });

        // ãƒ­ãƒ¼ã‚½ã‚¯è¶³ã‚·ãƒªãƒ¼ã‚ºã‚’è¿½åŠ 
        candlestickSeries = priceChart.addCandlestickSeries({
            upColor: '#ef5350',      // é™½ç·šï¼ˆæ—¥æœ¬å¼ï¼šèµ¤ï¼‰
            downColor: '#26a69a',    // é™°ç·šï¼ˆæ—¥æœ¬å¼ï¼šç·‘/é’ï¼‰
            borderUpColor: '#ef5350',
            borderDownColor: '#26a69a',
            wickUpColor: '#ef5350',
            wickDownColor: '#26a69a',
        });

        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆnullã‚’é™¤å»ï¼‰
        const validData = priceHistory.filter(d =>
            d.open !== null && d.high !== null && d.low !== null && d.close !== null
        );

        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
        candlestickSeries.setData(validData);

        // ãƒãƒ£ãƒ¼ãƒˆã‚’å…¨ãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚£ãƒƒãƒˆ
        priceChart.timeScale().fitContent();

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        const resizeObserver = new ResizeObserver(entries => {
            if (priceChart) {
                const { width } = entries[0].contentRect;
                priceChart.applyOptions({ width: width });
            }
        });
        resizeObserver.observe(container);
    }

    // TradingViewã‹ã‚‰ã®äº’æ›æ€§ã®ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼
    function showTradingViewChart(symbol) {
        console.log('showTradingViewChart called with symbol:', symbol);
    }

    async function analyzeStock() {
        const stockCode = document.getElementById('stockCode').value.trim().toUpperCase();
        
        if (!stockCode) {
            alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // 4æ¡æ•°å­—ãªã‚‰æ—¥æœ¬æ ªã¨ã—ã¦.Tã‚’ä»˜ã‘ã‚‹ã€ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾ä½¿ç”¨
        const symbol = /^\d{4}$/.test(stockCode) ? `${stockCode}.T` : stockCode;

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resultsArea').classList.remove('active');

        try {
            // APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—
            const response = await fetch('/api/stock/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ symbol: symbol })
            });

            const data = await response.json();

            if (response.ok) {
                // çµæœã‚’è¡¨ç¤º
                updateResults(data);
                document.getElementById('resultsArea').classList.add('active');
            } else {
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                if (data.timeout || response.status === 504) {
                    alert(`â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ\n\nãƒ‡ãƒ¼ã‚¿å–å¾—ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚\nYahoo Financeã®å¿œç­”ãŒé…ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nâ†’ å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ã€ŒæŠ½å‡ºã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚`);
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            }
        } catch (error) {
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                alert(`â±ï¸ é€šä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ\n\næ¥ç¶šã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚\n\nâ†’ å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ã€ŒæŠ½å‡ºã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚`);
            } else {
                alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // çµæœã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateResults(data) {
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®è¿”å´ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        console.log('API Response Data:', data);
        
        // é€šè²¨æƒ…å ±ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        window.currentCurrency = data.currency || 'JPY';
        
        // ä¼šç¤¾åï¼ˆæ—¥æœ¬èªå„ªå…ˆï¼‰
        const companyNameElement = document.querySelector('.company-name');
        if (companyNameElement) {
            const displayName = data.name_jp || data.name || data.symbol;
            companyNameElement.textContent = displayName;
        }

        // æ ªä¾¡è¡¨ç¤º
        const stockPriceDisplay = document.getElementById('stock-price-display');
        if (stockPriceDisplay && data.last_price) {
            const currency = data.currency === 'JPY' ? 'Â¥' : '$';
            stockPriceDisplay.textContent = `${currency}${formatNumber(data.last_price)}`;
        } else if (stockPriceDisplay) {
            stockPriceDisplay.textContent = '---';
        }

        // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã¨æ¥­ç¨®ï¼ˆæ—¥æœ¬èªå„ªå…ˆè¡¨ç¤ºï¼‰
        const companyCodeElement = document.querySelector('.company-code');
        if (companyCodeElement) {
            const industryJa = data.industry_jp || null;
            const sectorJa = data.sector_jp || null;
            const industryEn = data.industry || null;
            const sectorEn = data.sector || null;
            
            // æ¥­ç¨®ã®è¡¨ç¤ºã¯ã€Œæ—¥æœ¬èª > è‹±èªã€ã®å„ªå…ˆã€è‹±èªã—ã‹ç„¡ã„å ´åˆã¯ (Sector) ã‚’æ·»ãˆã‚‹
            let industryLine = "";
            if (industryJa) {
                industryLine = industryJa + (sectorJa ? `ï¼ˆ${sectorJa}ï¼‰` : "");
            } else if (industryEn) {
                industryLine = industryEn + (sectorEn ? ` (${sectorEn})` : "");
            } else {
                industryLine = '---';
            }
            
            companyCodeElement.textContent = `éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰: ${data.symbol}` + (industryLine !== '---' ? ` | æ¥­ç¨®: ${industryLine}` : "");
        }

        // è‡ªå·±è³‡æœ¬æ¯”ç‡ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        const equityRatio =
            data.equity_ratio_pct ??
            data.equity_ratio ??
            (Array.isArray(data.equity_ratio_list) && data.equity_ratio_list.length > 0
                ? data.equity_ratio_list.sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.value
                : null);
        
        console.log('Equity Ratio Debug:', {
            equity_ratio_pct: data.equity_ratio_pct,
            equity_ratio: data.equity_ratio,
            equity_ratio_list: data.equity_ratio_list,
            finalValue: equityRatio
        });

        // ä¸»è¦æŒ‡æ¨™ã‚’æ›´æ–°ï¼ˆPERã«ã¯æ¥­ç¨®æƒ…å ±ã‚’æ¸¡ã™ã€æ—¥æœ¬èªæ¥­ç¨®å„ªå…ˆï¼‰
        updateMetric('equity-ratio', equityRatio, '%', 'è‡ªå·±è³‡æœ¬æ¯”ç‡');
        updateMetric('op-margin', data.op_margin_pct, '%', 'å–¶æ¥­åˆ©ç›Šç‡');
        const industryForPER = data.industry_jp || data.industry;  // æ—¥æœ¬èªæ¥­ç¨®å„ªå…ˆ
        updateMetric('per', data.per, 'å€', 'PER', industryForPER);  // æ—¥æœ¬èªæ¥­ç¨®æƒ…å ±ã‚’æ¸¡ã™
        updateMetric('pbr', data.pbr, 'å€', 'PBR');
        updateMetric('dividend-yield', data.dividend_yield, '%', 'é…å½“åˆ©å›ã‚Š');
        updateMetric('market-cap', data.market_cap, data.currency, 'æ™‚ä¾¡ç·é¡');

        // ROE/ROAãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        console.log('ROE received:', data.roe);
        console.log('ROA received:', data.roa);
        
        // è²¡å‹™æŒ‡æ¨™ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼ˆå››å­£å ±ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
        updateFinancialYearTable(data);

        // é…å½“æƒ…å ±æ›´æ–°
        updateDividendInfo(data);
        
        // ä¸»è¦æ ªä¸»ãƒ»å½¹å“¡æƒ…å ±ã‚’æ›´æ–°
        updateHoldersAndOfficers(data);
        
        // ä¼šç¤¾æ¦‚è¦ãƒ»äº‹æ¥­èª¬æ˜ã‚’æ›´æ–°
        updateBusinessSummary(data);

        // ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
        if (data.price_history && data.price_history.length > 0) {
            showCandlestickChart(data.price_history);
        }

        // æ ªä¾¡æƒ…å ±
        const chartTitle = document.querySelector('.chart-title');
        if (chartTitle && data.last_price) {
            const currency = data.currency === 'JPY' ? 'Â¥' : '$';
            chartTitle.textContent = `æ ªä¾¡æ¨ç§»ï¼ˆç¾åœ¨å€¤: ${currency}${formatNumber(data.last_price)}ï¼‰`;
        }

        // åˆè‡´åº¦ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆæŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’Supabaseå½¢å¼ã«å¤‰æ›ï¼‰
        const scoreData = convertToScoreFormat(data);
        updateScoreCard(scoreData);
    }

    // æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ç”¨å½¢å¼ã«å¤‰æ›
    function convertToScoreFormat(data) {
        // é…åˆ—ã‹ã‚‰æœ€æ–°å€¤ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function getLatestValue(arr) {
            if (!arr || !Array.isArray(arr) || arr.length === 0) return null;
            const sorted = [...arr].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            return sorted[0]?.value ?? null;
        }

        // æ™‚ä¾¡ç·é¡ã‚’å„„å††ã«å¤‰æ›
        const marketCapOku = data.market_cap ? data.market_cap / 1e8 : null;

        // å–¶æ¥­CFã‚’å„„å††ã«å¤‰æ›
        const opCfRaw = getLatestValue(data.operating_cf);
        const operatingCf = opCfRaw ? opCfRaw / 1e8 : null;

        // æŠ•è³‡CFã‚’å„„å††ã«å¤‰æ›
        const invCfRaw = getLatestValue(data.investing_cf);
        const investingCf = invCfRaw ? invCfRaw / 1e8 : null;

        // ãƒ•ãƒªãƒ¼CFè¨ˆç®—
        const freeCf = (operatingCf !== null && investingCf !== null) ? operatingCf + investingCf : null;

        // ROAæœ€æ–°å€¤
        const roa = getLatestValue(data.roa);

        // è‡ªå·±è³‡æœ¬æ¯”ç‡
        const equityRatio = data.equity_ratio_pct ?? data.equity_ratio ?? getLatestValue(data.equity_ratio_list);

        // å–¶æ¥­åˆ©ç›Šç‡
        const operatingMargin = data.op_margin_pct ?? data.operating_margin;

        // PER/PBR
        const per = data.per;
        const pbr = data.pbr;

        // æ¥­ç¸¾äºˆæƒ³
        const forecastRevenue = data.forecast_revenue;
        const forecastOpIncome = data.forecast_op_income;

        // å£²ä¸Šãƒ»å–¶æ¥­åˆ©ç›Šã®é…åˆ—
        const revenueList = data.revenue || [];
        const opIncomeList = data.op_income || [];

        // åˆè‡´åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆ12é …ç›® Ã— 10ç‚¹ = 120ç‚¹æº€ç‚¹ï¼‰
        let score = 0;

        // 1. æ™‚ä¾¡ç·é¡ <= 700å„„å††
        if (marketCapOku !== null && marketCapOku <= 700) score += 10;

        // 2. è‡ªå·±è³‡æœ¬æ¯”ç‡ >= 30%
        if (equityRatio !== null && equityRatio >= 30) score += 10;

        // 3. å£²ä¸Šæˆé•·ç‡(å®Ÿç¸¾) > 0%
        if (revenueList.length >= 2) {
            const sorted = [...revenueList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0]?.value && sorted[1]?.value && sorted[1].value > 0) {
                const growth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                if (growth > 0) score += 10;
            }
        }

        // 4. å£²ä¸Šæˆé•·ç‡(äºˆæƒ³) > 0%
        if (forecastRevenue && revenueList.length >= 1) {
            const sorted = [...revenueList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const lastRevenue = sorted[0]?.value ? sorted[0].value / 1e8 : null;
            if (lastRevenue && lastRevenue > 0) {
                const growth = ((forecastRevenue - lastRevenue) / lastRevenue) * 100;
                if (growth > 0) score += 10;
            }
        }

        // 5. å–¶æ¥­åˆ©ç›Šç‡ >= 10%
        if (operatingMargin !== null && operatingMargin >= 10) score += 10;

        // 6. å–¶æ¥­åˆ©ç›Šæˆé•·ç‡(å®Ÿç¸¾) > 0%
        if (opIncomeList.length >= 2) {
            const sorted = [...opIncomeList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0]?.value && sorted[1]?.value && sorted[1].value > 0) {
                const growth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                if (growth > 0) score += 10;
            }
        }

        // 7. å–¶æ¥­åˆ©ç›Šæˆé•·ç‡(äºˆæƒ³) > 0%
        if (forecastOpIncome && opIncomeList.length >= 1) {
            const sorted = [...opIncomeList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const lastOpIncome = sorted[0]?.value ? sorted[0].value / 1e8 : null;
            if (lastOpIncome && lastOpIncome > 0) {
                const growth = ((forecastOpIncome - lastOpIncome) / lastOpIncome) * 100;
                if (growth > 0) score += 10;
            }
        }

        // 8. å–¶æ¥­CF > 0
        if (operatingCf !== null && operatingCf > 0) score += 10;

        // 9. ãƒ•ãƒªãƒ¼CF > 0
        if (freeCf !== null && freeCf > 0) score += 10;

        // 10. ROA > 4.5%
        if (roa !== null && roa > 4.5) score += 10;

        // 11. PER < 40å€
        if (per !== null && per > 0 && per < 40) score += 10;

        // 12. PBR < 10å€
        if (pbr !== null && pbr > 0 && pbr < 10) score += 10;

        return {
            match_rate: score,
            market_cap: marketCapOku,
            equity_ratio: equityRatio,
            operating_margin: operatingMargin,
            operating_cf: operatingCf,
            free_cf: freeCf,
            roa: roa,
            per_forward: per,
            pbr: pbr,
            forecast_revenue: forecastRevenue,
            forecast_op_income: forecastOpIncome,
            financial_history: {
                revenue: revenueList,
                op_income: opIncomeList
            },
            cf_history: {
                roa: data.roa || []
            }
        };
    }

    // æ¥­ç¨®åˆ¥ã®PERåŸºæº–å€¤ãƒãƒƒãƒ”ãƒ³ã‚°
    const industryPERBenchmarks = {
        // ITãƒ»ãƒã‚¤ãƒ†ã‚¯ç³»
        'Technology': { good: 25, warning: 40 },
        'Software': { good: 30, warning: 50 },
        'Internet': { good: 35, warning: 60 },
        'Semiconductors': { good: 20, warning: 35 },
        
        // æˆé•·ç”£æ¥­
        'Biotechnology': { good: 30, warning: 50 },
        'Healthcare': { good: 20, warning: 35 },
        'Renewable Energy': { good: 25, warning: 40 },
        
        // è£½é€ æ¥­ãƒ»ä¼çµ±ç”£æ¥­
        'Automobiles': { good: 10, warning: 15 },
        'Manufacturing': { good: 12, warning: 18 },
        'Industrial': { good: 15, warning: 22 },
        'Construction': { good: 10, warning: 15 },
        
        // é‡‘è
        'Banks': { good: 10, warning: 15 },
        'Insurance': { good: 12, warning: 18 },
        'Financial Services': { good: 15, warning: 25 },
        
        // æ¶ˆè²»è²¡ãƒ»ã‚µãƒ¼ãƒ“ã‚¹
        'Retail': { good: 18, warning: 28 },
        'Consumer Goods': { good: 15, warning: 25 },
        'Food & Beverage': { good: 18, warning: 28 },
        
        // ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»å…¬ç›Š
        'Utilities': { good: 12, warning: 18 },
        'Real Estate': { good: 20, warning: 30 },
        'Transportation': { good: 15, warning: 22 },
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        'default': { good: 15, warning: 25 }
    };
    
    // æ¥­ç¨®åã‹ã‚‰åŸºæº–å€¤ã‚’å–å¾—
    function getIndustryPERBenchmark(industry) {
        // å®Œå…¨ä¸€è‡´ã‚’è©¦ã¿ã‚‹
        if (industryPERBenchmarks[industry]) {
            return industryPERBenchmarks[industry];
        }
        
        // éƒ¨åˆ†ä¸€è‡´ã‚’è©¦ã¿ã‚‹ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼‰
        for (const [key, value] of Object.entries(industryPERBenchmarks)) {
            if (industry && industry.toLowerCase().includes(key.toLowerCase())) {
                return value;
            }
        }
        
        return industryPERBenchmarks['default'];
    }

    // æŒ‡æ¨™ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆæ¥­ç¨®æƒ…å ±ã‚’è¿½åŠ ï¼‰- ç·¨é›†å¯èƒ½ç‰ˆ
    function updateMetric(className, value, suffix, label, industryInfo = null) {
        const elements = document.querySelectorAll('.metric-item');
        for (const elem of elements) {
            const labelElem = elem.querySelector('.metric-label');
            if (labelElem && labelElem.textContent === label) {
                const valueElem = elem.querySelector('.metric-value');
                if (valueElem) {
                    // ç·¨é›†å¯èƒ½ãªå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆ
                    const dataKey = label.replace(/\s/g, '_').toLowerCase();
                    let displayValue = '';
                    let rawValue = value;

                    if (value !== null && value !== undefined) {
                        if (label === 'æ™‚ä¾¡ç·é¡') {
                            displayValue = formatAmount(value, suffix);
                            rawValue = value;
                        } else {
                            displayValue = formatNumber(value);
                            rawValue = value;
                        }
                    } else {
                        displayValue = '';
                        rawValue = '';
                    }

                    if (IS_ADMIN) {
                        // ç®¡ç†è€…: ç·¨é›†å¯èƒ½ãªå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        valueElem.innerHTML = `<input type="text" class="editable-field"
                            data-metric="${dataKey}"
                            data-suffix="${suffix}"
                            data-raw="${rawValue}"
                            value="${displayValue}"
                            onchange="onMetricEdit(this)"
                            onfocus="this.select()"
                        >${label !== 'æ™‚ä¾¡ç·é¡' ? suffix : ''}`;
                    } else {
                        // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã®ã¿
                        const suffixText = label !== 'æ™‚ä¾¡ç·é¡' ? suffix : '';
                        valueElem.textContent = displayValue ? `${displayValue}${suffixText}` : '---';
                    }
                }

                // ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆã«æ¥­ç¨®å¹³å‡ã‚’è¡¨ç¤ºï¼ˆPERã®å ´åˆï¼‰
                const subElem = elem.querySelector('.metric-sub');
                if (label === 'PER' && industryInfo && subElem) {
                    const benchmark = getIndustryPERBenchmark(industryInfo);
                    subElem.textContent = `æ¥­ç¨®åŸºæº–: ${benchmark.good}-${benchmark.warning}å€`;
                }

                // è©•ä¾¡ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
                elem.classList.remove('good', 'warning', 'danger');
                if (label === 'è‡ªå·±è³‡æœ¬æ¯”ç‡' && value) {
                    if (value >= 40) elem.classList.add('good');
                    else if (value >= 20) elem.classList.add('warning');
                    else elem.classList.add('danger');
                } else if (label === 'å–¶æ¥­åˆ©ç›Šç‡' && value) {
                    if (value >= 10) elem.classList.add('good');
                    else if (value >= 5) elem.classList.add('warning');
                    else elem.classList.add('danger');
                } else if (label === 'PER' && value) {
                    // æ¥­ç¨®åˆ¥åŸºæº–ã§åˆ¤å®š
                    const benchmark = getIndustryPERBenchmark(industryInfo);
                    if (value <= benchmark.good) elem.classList.add('good');
                    else if (value <= benchmark.warning) elem.classList.add('warning');
                    else elem.classList.add('danger');
                } else if (label === 'PBR' && value) {
                    if (value <= 1) elem.classList.add('good');
                    else if (value <= 2) elem.classList.add('warning');
                    else elem.classList.add('danger');
                }
                break;
            }
        }
    }

    // æŒ‡æ¨™ç·¨é›†æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
    function onMetricEdit(input) {
        showSaveSection();
    }

    // è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼ˆå››å­£å ±ã‚¹ã‚¿ã‚¤ãƒ« - è»¢ç½®ç‰ˆï¼‰
    function updateFinancialYearTable(data) {
        // å¹´åº¦ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        const yearDataMap = new Map();
        
        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‹ã‚‰å¹´åº¦ã‚’åé›†
        const dataTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income', 'eps', 'dps', 'payout_ratio',
                          'operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list', 'equity_ratio_list', 'roe', 'roa'];
        
        dataTypes.forEach(type => {
            if (data[type] && Array.isArray(data[type])) {
                data[type].forEach(item => {
                    const d = new Date(item.date);
                    const year = d.getFullYear();
                    const month = d.getMonth() + 1;
                    if (!yearDataMap.has(year)) {
                        yearDataMap.set(year, { _month: month, _date: item.date });
                    }
                    yearDataMap.get(year)[type] = item.value;
                });
            }
        });
        
        // å¹´åº¦ã‚’æ˜‡é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„å¹´ãŒä¸Šã«ï¼‰
        const sortedYears = Array.from(yearDataMap.keys()).sort((a, b) => a - b).slice(-5);
        
        // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        updateFinancialDataTable(sortedYears, yearDataMap);
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ»æŒ‡æ¨™ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        updateCashFlowMetricsTable(sortedYears, yearDataMap);
        
        // æœ€æ–°ã®é…å½“æ€§å‘ã‚’è¡¨ç¤º
        updateLatestPayoutRatio(data);
        
        // è²¡å‹™å¥å…¨æ€§ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        updateFinancialHealth(data);
    }
    
    // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
    function updateFinancialDataTable(years, dataMap) {
        const tbody = document.getElementById('financial-data-tbody');
        if (!tbody) return;

        years.forEach((year, index) => {
            const row = tbody.querySelector(`tr[data-year="${index + 1}"]`);
            if (!row) return;

            // å¹´åº¦ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ï¼ˆå¹´æœˆè¡¨ç¤ºï¼‰
            const yearLabel = row.querySelector('.year-label');
            if (yearLabel) {
                const yearData = dataMap.get(year) || {};
                const month = yearData._month;
                yearLabel.textContent = month ? `${year}å¹´${month}æœˆ` : `${year}å¹´`;
                yearLabel.dataset.fullDate = yearData._date || `${year}-03-31`;
            }
            
            const yearData = dataMap.get(year) || {};
            
            // å„ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã®ã‚»ãƒ«ã‚’æ›´æ–°
            updateCellValue(row, 'revenue', yearData.revenue);
            updateCellValue(row, 'op_income', yearData.op_income);
            updateCellValue(row, 'ordinary_income', yearData.ordinary_income);
            updateCellValue(row, 'net_income', yearData.net_income);
            updateCellValue(row, 'eps', yearData.eps, true);
            updateCellValue(row, 'dps', yearData.dps, true);
            updateCellValue(row, 'payout_ratio', yearData.payout_ratio, false, true);
        });
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ»æŒ‡æ¨™ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
    function updateCashFlowMetricsTable(years, dataMap) {
        const tbody = document.getElementById('cf-metrics-tbody');
        if (!tbody) return;

        years.forEach((year, index) => {
            const row = tbody.querySelector(`tr[data-year="${index + 1}"]`);
            if (!row) return;

            // å¹´åº¦ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ï¼ˆå¹´æœˆè¡¨ç¤ºï¼‰
            const yearLabel = row.querySelector('.year-label');
            if (yearLabel) {
                const yearData = dataMap.get(year) || {};
                const month = yearData._month;
                yearLabel.textContent = month ? `${year}å¹´${month}æœˆ` : `${year}å¹´`;
                yearLabel.dataset.fullDate = yearData._date || `${year}-03-31`;
            }
            
            const yearData = dataMap.get(year) || {};
            
            // å„ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã®ã‚»ãƒ«ã‚’æ›´æ–°
            updateCellValue(row, 'operating_cf', yearData.operating_cf);
            updateCellValue(row, 'investing_cf', yearData.investing_cf);
            updateCellValue(row, 'financing_cf', yearData.financing_cf);
            updateCellValue(row, 'cash', yearData.cash);
            updateCellValue(row, 'current_liabilities_list', yearData.current_liabilities_list);
            updateCellValue(row, 'equity_ratio_list', yearData.equity_ratio_list, false, true);
            updateCellValue(row, 'roe', yearData.roe, false, true);
            updateCellValue(row, 'roa', yearData.roa, false, true);
        });
    }
    
    // ã‚»ãƒ«ã®å€¤ã‚’æ›´æ–° - ç·¨é›†å¯èƒ½ç‰ˆï¼ˆå„„å††å˜ä½ã®æ•°å€¤ã®ã¿è¡¨ç¤ºï¼‰
    function updateCellValue(row, dataType, value, isPerShare = false, isPercent = false) {
        const cell = row.querySelector(`td[data-type="${dataType}"]`);
        if (!cell) return;

        const yearIndex = row.getAttribute('data-year');
        let displayValue = '';
        let rawValue = value;

        // é‡‘é¡ç³»ã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ï¼ˆå„„å††å˜ä½ã§è¡¨ç¤ºï¼‰
        const amountTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income',
                            'operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list'];

        if (value !== undefined && value !== null) {
            if (isPerShare) {
                // 1æ ªã‚ãŸã‚Šã®å€¤ï¼ˆå††å˜ä½ï¼‰
                displayValue = value.toFixed(2);
            } else if (isPercent) {
                // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆï¼ˆæ•°å€¤ã®ã¿ï¼‰
                displayValue = value.toFixed(1);
            } else if (amountTypes.includes(dataType)) {
                // é‡‘é¡ã¯å„„å††å˜ä½ã«å¤‰æ›ã—ã¦æ•°å€¤ã®ã¿è¡¨ç¤ºï¼ˆå°æ•°2æ¡ï¼‰
                const okuValue = value / 1e8;
                displayValue = okuValue.toFixed(2);
            } else {
                displayValue = value.toFixed(2);
            }
            rawValue = value;
        } else {
            displayValue = '';
            rawValue = '';
        }

        // ç·¨é›†å¯èƒ½ãªå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦è¡¨ç¤ºï¼ˆæ•°å€¤ã®ã¿ã€å˜ä½ãªã—ï¼‰
        cell.innerHTML = `<input type="number" class="editable-cell"
            data-type="${dataType}"
            data-year="${yearIndex}"
            data-raw="${rawValue}"
            data-is-percent="${isPercent}"
            data-is-pershare="${isPerShare}"
            data-is-amount="${amountTypes.includes(dataType)}"
            value="${displayValue}"
            onchange="onCellEdit(this)"
            onfocus="this.select()"
            step="0.01"
        >`;
    }


    // é…å½“æƒ…å ±æ›´æ–°
    function updateDividendInfo(data) {
        const rows = document.querySelectorAll('.detail-card .detail-row');
        for (const row of rows) {
            const label = row.querySelector('.detail-label');
            const value = row.querySelector('.detail-value');
            if (label && value) {
                if (label.textContent === 'é…å½“åˆ©å›ã‚Š' && data.dividend_yield !== null) {
                    value.textContent = `${data.dividend_yield.toFixed(2)}%`;
                }
            }
        }
    }
    
    // æœ€æ–°ã®é…å½“æ€§å‘ã‚’è¡¨ç¤º
    function updateLatestPayoutRatio(data) {
        const payoutDisplay = document.getElementById('payout-ratio-display');
        if (payoutDisplay && data.payout_ratio && data.payout_ratio.length > 0) {
            // æœ€æ–°ã®é…å½“æ€§å‘ã‚’å–å¾—ï¼ˆæ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆã—ã¦æœ€æ–°ã‚’å–å¾—ï¼‰
            const sortedPayoutRatios = data.payout_ratio.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            const latestPayout = sortedPayoutRatios[0];
            if (latestPayout && latestPayout.value !== undefined) {
                payoutDisplay.textContent = `${latestPayout.value.toFixed(1)}%`;
            }
        }
    }
    
    // è²¡å‹™å¥å…¨æ€§ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    function updateFinancialHealth(data) {
        // ç¾é é‡‘ã®è¡¨ç¤º
        const cashDisplay = document.getElementById('cash-display');
        const cashOld = document.getElementById('cash-old');
        const cashNew = document.getElementById('cash-new');
        
        if (data.cash && data.cash.length > 0) {
            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedCash = data.cash.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            const latestCash = sortedCash[0];
            if (cashDisplay && latestCash) {
                cashDisplay.textContent = formatAmount(latestCash.value, window.currentCurrency);
            }
            
            // ç¾é é‡‘æ¨ç§»ï¼ˆæœ€ã‚‚å¤ã„ â†’ æœ€æ–°ï¼‰
            if (cashOld && cashNew && sortedCash.length > 1) {
                const oldestCash = sortedCash[sortedCash.length - 1];
                cashOld.textContent = formatAmount(oldestCash.value, window.currentCurrency);
                cashNew.textContent = formatAmount(latestCash.value, window.currentCurrency);
            } else if (cashNew && latestCash) {
                cashNew.textContent = formatAmount(latestCash.value, window.currentCurrency);
            }
        }
        
        // æµå‹•è² å‚µã®è¡¨ç¤º
        const currentLiabDisplay = document.getElementById('current-liab-display');
        let latestCurrentLiab = null;
        
        if (data.current_liabilities_list && data.current_liabilities_list.length > 0) {
            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedLiab = data.current_liabilities_list.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            latestCurrentLiab = sortedLiab[0];
            if (currentLiabDisplay && latestCurrentLiab) {
                currentLiabDisplay.textContent = formatAmount(latestCurrentLiab.value, window.currentCurrency);
            }
        } else if (data.current_liabilities) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå˜ä¸€ã®å€¤ã®å ´åˆ
            latestCurrentLiab = { value: data.current_liabilities };
            if (currentLiabDisplay) {
                currentLiabDisplay.textContent = formatAmount(data.current_liabilities, window.currentCurrency);
            }
        }
        
        // æµå‹•æ¯”ç‡ã®è¨ˆç®—ï¼ˆæµå‹•è³‡ç”£ / æµå‹•è² å‚µ * 100ï¼‰
        const currentRatioDisplay = document.getElementById('current-ratio-display');
        if (currentRatioDisplay && latestCurrentLiab) {
            // æµå‹•è³‡ç”£ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const currentAssetsList = data.current_assets_list || [];
            let latestCurrentAssets = null;
            
            if (currentAssetsList.length > 0) {
                const sortedAssets = currentAssetsList.sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                latestCurrentAssets = sortedAssets[0];
            } else if (data.cash && data.cash.length > 0) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæµå‹•è³‡ç”£ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç¾é‡‘ã§ä»£ç”¨ï¼ˆéå°è©•ä¾¡ã«ãªã‚‹ãŒï¼‰
                const sortedCash = data.cash.sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                latestCurrentAssets = sortedCash[0];
            }
            
            if (latestCurrentAssets && latestCurrentLiab.value > 0) {
                const currentRatio = (latestCurrentAssets.value / latestCurrentLiab.value) * 100;
                currentRatioDisplay.textContent = `${currentRatio.toFixed(1)}%`;
                
                // æµå‹•æ¯”ç‡ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
                if (currentRatio >= 150) {
                    currentRatioDisplay.style.color = 'var(--success-color)';
                } else if (currentRatio >= 100) {
                    currentRatioDisplay.style.color = 'var(--warning-color)';
                } else {
                    currentRatioDisplay.style.color = 'var(--danger-color)';
                }
            }
        }
        
        // ä¿¡ç”¨å€ç‡ã®è¡¨ç¤º
        const marginRatioDisplay = document.getElementById('margin-ratio-display');
        if (marginRatioDisplay) {
            if (data.margin_trading_ratio !== null && data.margin_trading_ratio !== undefined) {
                marginRatioDisplay.textContent = `${data.margin_trading_ratio.toFixed(2)}å€`;
                
                // ä¿¡ç”¨å€ç‡ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
                // 1å€æœªæº€ï¼šå£²ã‚Šæ®‹ãŒå¤šã„ï¼ˆå¼±æ°—ï¼‰
                // 1ï½3å€ï¼šæ­£å¸¸ç¯„å›²
                // 3å€ä»¥ä¸Šï¼šè²·ã„æ®‹ãŒå¤šã„ï¼ˆéç†±æ°—å‘³ï¼‰
                if (data.margin_trading_ratio < 1) {
                    marginRatioDisplay.style.color = 'var(--danger-color)';
                } else if (data.margin_trading_ratio <= 3) {
                    marginRatioDisplay.style.color = 'var(--success-color)';
                } else {
                    marginRatioDisplay.style.color = 'var(--warning-color)';
                }
                
                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã®titleå±æ€§ã‚’è¿½åŠ ï¼ˆè²·æ®‹ãƒ»å£²æ®‹ã®è©³ç´°ï¼‰
                if (data.margin_trading_buy && data.margin_trading_sell) {
                    const buyFormatted = data.margin_trading_buy.toLocaleString();
                    const sellFormatted = data.margin_trading_sell.toLocaleString();
                    marginRatioDisplay.title = `è²·æ®‹: ${buyFormatted}æ ª / å£²æ®‹: ${sellFormatted}æ ª`;
                }
            } else {
                marginRatioDisplay.textContent = '---';
            }
        }
    }

    // æˆé•·ç‡è¨ˆç®—
    function calculateGrowthRate(dataArray) {
        if (dataArray.length < 2) return null;
        const latest = dataArray[0].value;
        const oldest = dataArray[dataArray.length - 1].value;
        const years = dataArray.length - 1;
        const rate = ((latest / oldest) ** (1 / years) - 1) * 100;
        return rate;
    }


    // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatNumber(num) {
        if (num === null || num === undefined) return '---';
        if (typeof num === 'number') {
            return num.toLocaleString('ja-JP', { maximumFractionDigits: 2 });
        }
        return num;
    }

    // å…±é€š: æ–‡å­—åˆ—ã§ã‚‚æ•°å€¤ã§ã‚‚å®‰å…¨ã«æ•°å€¤åŒ–
    function toNumberSafe(v) {
        if (v === null || v === undefined) return null;
        if (typeof v === 'string') v = v.replace(/,/g, '').trim();
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆé€šè²¨åˆ¥ã€çµ¶å¯¾å€¤ã§å˜ä½åˆ¤å®šï¼‰
    function formatAmount(num, currency = 'JPY') {
        const n0 = toNumberSafe(num);
        if (n0 === null) return '---';
        
        if (currency === 'JPY') {
            const sign = n0 < 0 ? 'âˆ’' : '';           // ãƒã‚¤ãƒŠã‚¹è¨˜å·ï¼ˆå…¨è§’ï¼‰
            const n = Math.abs(n0);                   // â˜… å˜ä½åˆ¤å®šã¯çµ¶å¯¾å€¤ã§
            if (n >= 1e12) return `${sign}${(n/1e12).toFixed(2)}å…†å††`;
            if (n >= 1e8)  return `${sign}${(n/1e8).toFixed(2)}å„„å††`;
            if (n >= 1e4)  return `${sign}${(n/1e4).toFixed(2)}ä¸‡å††`;
            return `${sign}${Math.round(n).toLocaleString()}å††`;
        } else {
            // USD or other currencies
            const sign = n0 < 0 ? '-' : '';
            const n = Math.abs(n0);
            if (n >= 1e12) return `${sign}$${(n / 1e12).toFixed(2)}T`;
            if (n >= 1e9)  return `${sign}$${(n / 1e9).toFixed(2)}B`;
            if (n >= 1e6)  return `${sign}$${(n / 1e6).toFixed(2)}M`;
            return `${sign}$${Math.round(n).toLocaleString()}`;
        }
    }
    
    // æ—§é–¢æ•°åã¨ã®äº’æ›æ€§ç¶­æŒï¼ˆå¾ã€…ã«ç½®ãæ›ãˆã‚‹ï¼‰
    function formatMarketCap(num) {
        // ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é€šè²¨ã‚’å–å¾—ã§ããªã„å ´åˆã¯JPYã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã™ã‚‹
        return formatAmount(num, window.currentCurrency || 'JPY');
    }

    // ãƒãƒ£ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæœŸé–“å¤‰æ›´å¯¾å¿œï¼‰
    const PERIOD_MAP = { '1D':'1d','1W':'5d','1M':'1mo','3M':'3mo','1Y':'1y','5Y':'5y' };

    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            // è¦‹ãŸç›®æ›´æ–°
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // æœŸé–“æ±ºå®š
            const label = this.textContent.trim();
            const period = PERIOD_MAP[label] || '1y';

            // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰å–å¾—ï¼ˆ.Tä»˜ä¸ã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã‚‹ï¼‰
            const raw = document.getElementById('stockCode').value.trim();
            if (!raw) {
                alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // 4æ¡æ•°å­—ãªã‚‰æ—¥æœ¬æ ªã¨ã—ã¦.Tã‚’ä»˜ã‘ã‚‹ã€ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾ä½¿ç”¨
            const symbol = /^\d{4}$/.test(raw) ? `${raw}.T` : raw;

            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆãƒãƒ£ãƒ¼ãƒˆéƒ¨åˆ†ã®ã¿ï¼‰
                const chartPlaceholder = document.querySelector('.chart-placeholder');
                chartPlaceholder.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:#64748b;">ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­...</div>';

                // æœŸé–“ä»˜ãã§å†ãƒ•ã‚§ãƒƒãƒ
                const response = await fetch('/api/stock/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, period })
                });
                
                const data = await response.json();

                // ãƒãƒ£ãƒ¼ãƒˆã ã‘å·®ã—æ›¿ãˆ
                if (response.ok && data.chart_base64) {
                    chartPlaceholder.innerHTML = `<img src="${data.chart_base64}" style="width:100%;height:auto;" alt="æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ">`;
                    
                    // ç¾åœ¨å€¤ã‚‚æ›´æ–°
                    const chartTitle = document.querySelector('.chart-title');
                    if (chartTitle && data.last_price) {
                        const currency = data.currency === 'JPY' ? 'Â¥' : '$';
                        chartTitle.textContent = `æ ªä¾¡æ¨ç§»ï¼ˆç¾åœ¨å€¤: ${currency}${formatNumber(data.last_price)}ï¼‰`;
                    }
                } else {
                    chartPlaceholder.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:#ef4444;">ãƒãƒ£ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                const chartPlaceholder = document.querySelector('.chart-placeholder');
                chartPlaceholder.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:#ef4444;">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        });
    });

    // Enterã‚­ãƒ¼ã§åˆ†æ
    document.getElementById('stockCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            analyzeStock();
        }
    });

    // ä¸»è¦æ ªä¸»ãƒ»å½¹å“¡æƒ…å ±ã‚’æ›´æ–°
    function updateHoldersAndOfficers(data) {
        updateMajorHolders(data);
        updateCompanyOfficers(data);
        updateHoldersSource(data);
    }

    // ä¸»è¦æ ªä¸»æƒ…å ±ã‚’æ›´æ–°ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ï¼‰
    function updateMajorHolders(data) {
        const majorHoldersContent = document.getElementById('major-holders-content');
        if (!majorHoldersContent) return;

        let html = '';
        let hasData = false;

        // ä¿æœ‰æ¯”ç‡ã‚µãƒãƒªãƒ¼ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æƒ…å ±å«ã‚€ï¼‰
        if (data.major_holders && data.major_holders.length > 0) {
            const insiderData = data.major_holders.find(h => h.Breakdown && h.Breakdown.includes('insider'));
            const institutionData = data.major_holders.find(h => h.Breakdown && h.Breakdown.includes('institution'));
            
            if (insiderData || institutionData) {
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">';
                html += '<thead><tr style="background-color: #f8f9fa;">';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">ä¿æœ‰è€…</th>';
                html += '<th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6; font-size: 13px;">æ¯”ç‡</th>';
                html += '</tr></thead><tbody>';

                if (insiderData) {
                    const percentage = (insiderData.Value * 100).toFixed(1);
                    html += '<tr>';
                    html += '<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #dc2626;">ğŸ›ï¸ å‰µæ¥­å®¶ãƒ»å†…éƒ¨è€…</td>';
                    html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${percentage}%</td>`;
                    html += '</tr>';
                }

                if (institutionData) {
                    const percentage = (institutionData.Value * 100).toFixed(1);
                    html += '<tr>';
                    html += '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">ğŸ¦ æ©Ÿé–¢æŠ•è³‡å®¶</td>';
                    html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${percentage}%</td>`;
                    html += '</tr>';
                }

                html += '</tbody></table>';
                hasData = true;
            }
        }

        // ç­†é ­æ ªä¸»ï¼ˆä¸Šä½5ç¤¾ï¼‰- æ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆ
        const topHolders = [];

        // æ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å„ªå…ˆä½¿ç”¨
        if (data.major_shareholders_jp && data.major_shareholders_jp.length > 0) {
            topHolders.push(...data.major_shareholders_jp.slice(0, 5).map(h => ({
                name: h.name || 'N/A',
                percentage: h.ratio ? h.ratio.toFixed(2) : 'N/A',
                type: 'æ—¥æœ¬èª'
            })));
        } else if (data.institutional_holders && data.institutional_holders.length > 0) {
            topHolders.push(...data.institutional_holders.slice(0, 5).map(h => ({
                name: h.Holder || 'N/A',
                percentage: h['% Out'] ? (h['% Out'] * 100).toFixed(2) : 'N/A',
                type: 'æ©Ÿé–¢'
            })));
        } else if (data.institution_ownership && data.institution_ownership.length > 0) {
            topHolders.push(...data.institution_ownership.slice(0, 5).map(h => ({
                name: h.organization || 'N/A',
                percentage: h.pctHeld ? (h.pctHeld * 100).toFixed(2) : 'N/A',
                type: 'æ©Ÿé–¢'
            })));
        }

        if (topHolders.length > 0) {
            html += '<div style="margin-top: 10px;">';
            html += '<div style="font-weight: bold; margin-bottom: 8px; color: #374151;">ğŸ“Š ç­†é ­æ ªä¸»</div>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 12px;">é †ä½</th>';
            html += '<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 12px;">æ ªä¸»å</th>';
            html += '<th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #dee2e6; font-size: 12px;">ä¿æœ‰æ¯”ç‡</th>';
            html += '</tr></thead><tbody>';

            topHolders.forEach((holder, index) => {
                const rankIcon = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰');
                html += '<tr>';
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; text-align: center;">${rankIcon}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 11px;">${holder.name}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; color: #2563eb; font-size: 12px;">${holder.percentage}%</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';
            hasData = true;
        }

        if (!hasData) {
            html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
        }

        majorHoldersContent.innerHTML = html;
    }

    // å½¹å“¡æƒ…å ±ã‚’æ›´æ–°ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã€é‡è¦å½¹è·ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
    function updateCompanyOfficers(data) {
        const officersContent = document.getElementById('company-officers-content');
        if (!officersContent) return;

        let html = '';

        if (data.company_officers && data.company_officers.length > 0) {
            // é‡è¦å½¹è·ã‚’ç‰¹å®šï¼ˆæ—¥æœ¬èªå½¹è·ã‚’å„ªå…ˆä½¿ç”¨ï¼‰
            const importantOfficers = [];
            const otherOfficers = [];

            data.company_officers.forEach(officer => {
                // æ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆ
                const title = officer.title_jp || officer.title || '';
                const name = officer.name_jp || officer.name || '';

                const isCEO = title.includes('CEO') || title.includes('President') || title.includes('ç¤¾é•·') || title.includes('ä»£è¡¨');
                const isCFO = title.includes('CFO') || title.includes('Chief Financial') || title.includes('è²¡å‹™');
                const isCTO = title.includes('CTO') || title.includes('Chief Technology') || title.includes('æŠ€è¡“');
                const isChairman = title.includes('Chairman') || title.includes('ä¼šé•·') || title.includes('å–ç· å½¹ä¼šé•·');
                const isAuditor = title.includes('ç›£æŸ»å½¹') || title.includes('Auditor');

                // æ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasJpData = officer.title_jp || officer.name_jp;

                if (isCEO || isCFO || isCTO || isChairman) {
                    importantOfficers.push({
                        name: name,
                        title: title,
                        bio: officer.bio,
                        shares: officer.shares,
                        age: officer.age,
                        isImportant: true,
                        priority: isCEO ? 1 : (isChairman ? 2 : (isCFO ? 3 : 4)),
                        hasJpData: hasJpData
                    });
                } else {
                    otherOfficers.push({
                        name: name,
                        title: title,
                        bio: officer.bio,
                        shares: officer.shares,
                        age: officer.age,
                        isImportant: false,
                        hasJpData: hasJpData
                    });
                }
            });

            // é‡è¦å½¹è·ã‚’å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
            importantOfficers.sort((a, b) => a.priority - b.priority);

            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">å½¹è·</th>';
            html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">æ°å</th>';
            html += '</tr></thead><tbody>';

            // é‡è¦å½¹è·ã‚’å…ˆã«è¡¨ç¤º
            importantOfficers.forEach(officer => {
                const name = officer.name || 'N/A';
                const title = officer.title || 'N/A';
                const age = officer.age ? ` (${officer.age}æ­³)` : '';

                html += '<tr>';
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #374151;">${title}</td>`;
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #1f2937;">${name}${age}</td>`;
                html += '</tr>';
            });

            // ãã®ä»–ã®å½¹å“¡ï¼ˆæ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å¤šãè¡¨ç¤ºï¼‰
            const maxOtherOfficers = otherOfficers.some(o => o.hasJpData) ? 10 : 5;
            otherOfficers.slice(0, maxOtherOfficers).forEach(officer => {
                const name = officer.name || 'N/A';
                const title = officer.title || 'N/A';
                const age = officer.age ? ` (${officer.age}æ­³)` : '';

                html += '<tr>';
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 11px; color: #6b7280;">${title}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #374151;">${name}${age}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            // å½¹å“¡æ•°ã®ã‚µãƒãƒªãƒ¼
            const totalOfficers = data.company_officers.length;
            const displayedOfficers = importantOfficers.length + Math.min(otherOfficers.length, maxOtherOfficers);
            if (totalOfficers > displayedOfficers) {
                html += `<div style="margin-top: 8px; font-size: 11px; color: #6b7280; text-align: right;">ä»– ${totalOfficers - displayedOfficers} åã®å½¹å“¡</div>`;
            }

        } else {
            html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
        }

        officersContent.innerHTML = html;
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’æ›´æ–°ï¼ˆå·¦å³åˆ†é›¢ï¼‰
    function updateHoldersSource(data) {
        const sourceLeftElement = document.getElementById('holders-source-left');
        const sourceRightElement = document.getElementById('holders-source-right');
        
        if (!sourceLeftElement || !sourceRightElement) return;

        let sourceText = '';
        if (data.holders_source) {
            sourceText = `å‡ºå…¸: ${data.holders_source}`;
            if (data.holders_fallback_needed) {
                sourceText += ' âš ï¸';
            }
        }

        sourceLeftElement.textContent = sourceText;
        sourceRightElement.textContent = sourceText;
    }
    
    // ä¼šç¤¾æ¦‚è¦ãƒ»äº‹æ¥­èª¬æ˜ã‚’æ›´æ–°
    function updateBusinessSummary(data) {
        const summaryContent = document.getElementById('business-summary-content');
        if (!summaryContent) return;
        
        let html = '';
        
        // æ—¥æœ¬èªã®äº‹æ¥­æ¦‚è¦ã‚’å„ªå…ˆè¡¨ç¤ºï¼ˆæ—¥æœ¬èªãŒã‚ã‚Œã°æ—¥æœ¬èªã®ã¿è¡¨ç¤ºï¼‰
        if (data.business_summary_jp) {
            html = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">
                        ğŸ“‹ äº‹æ¥­ç‰¹è‰²
                    </div>
                    <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">
                        ${data.business_summary_jp}
                    </div>
                </div>
            `;
        }
        // æ—¥æœ¬èªãŒãªã„å ´åˆã®ã¿è‹±èªã‚’è¡¨ç¤º
        else if (data.business_summary) {
            html = `
                <div>
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">
                        ğŸ“„ Business Summary
                    </div>
                    <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">
                        ${data.business_summary}
                    </div>
                </div>
            `;
        }
        
        // ã©ã¡ã‚‰ã‚‚ãªã„å ´åˆ
        if (!data.business_summary_jp && !data.business_summary) {
            html = `
                <div style="color: var(--text-secondary); text-align: center; padding: 20px; font-style: italic;">
                    äº‹æ¥­æ¦‚è¦ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ
                </div>
            `;
        }
        
        summaryContent.innerHTML = html;
    }

    // ========================================
    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆé–¢é€£æ©Ÿèƒ½
    // ========================================

    // ç¾åœ¨åˆ†æä¸­ã®éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    let currentStockData = null;
    let currentSymbol = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’å–å¾—
    document.addEventListener('DOMContentLoaded', function() {
        loadWatchlist();

        // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã€ç·¨é›†æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
        if (!IS_ADMIN) {
            // ç·¨é›†å¯èƒ½ãªã‚»ãƒ«ã‚’readonlyã«
            document.querySelectorAll('.editable-cell, .editable-field').forEach(el => {
                el.readOnly = true;
                el.style.cursor = 'default';
                el.style.pointerEvents = 'none';
            });
        }
    });

    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    async function loadWatchlist() {
        try {
            const response = await fetch('/api/watchlist');
            const data = await response.json();

            if (response.ok) {
                renderWatchlist(data.watchlist || []);
            } else {
                console.error('ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', data.error);
                document.getElementById('watchlistContent').innerHTML =
                    '<div class="watchlist-empty">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        } catch (error) {
            console.error('ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('watchlistContent').innerHTML =
                '<div class="watchlist-empty">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        }
    }

    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let watchlistCache = [];

    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’æç”»
    function renderWatchlist(watchlist) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        watchlistCache = watchlist;

        const content = document.getElementById('watchlistContent');
        const countElement = document.getElementById('watchlistCount');

        countElement.textContent = `${watchlist.length}ä»¶`;

        if (watchlist.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">ç™»éŒ²éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚éŠ˜æŸ„ã‚’æ¤œç´¢ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>ã‚³ãƒ¼ãƒ‰</th>
                        <th>ä¼šç¤¾å</th>
                        <th>åˆè‡´åº¦</th>
                        <th>ã‚»ã‚¯ã‚¿ãƒ¼</th>
                        <th>æ™‚ä¾¡ç·é¡</th>
                        <th>æ ªä¾¡</th>
                        <th>PER</th>
                        <th>PBR</th>
                        <th>é…å½“åˆ©å›ã‚Š</th>
                        <th>GC</th>
                        <th>DC</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
        `;

        watchlist.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const sector = item.sector || '---';
            // market_capã¯å„„å††å˜ä½ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼ˆ10000å„„ä»¥ä¸Šã¯å…†è¡¨ç¤ºï¼‰
            const marketCap = item.market_cap ? formatMarketCapOku(item.market_cap) : '---';
            const price = item.stock_price ? formatWatchlistPrice(item.stock_price) : '---';
            const per = item.per_forward ? `${item.per_forward.toFixed(1)}å€` : '---';
            const pbr = item.pbr ? `${item.pbr.toFixed(2)}å€` : '---';
            const divYield = item.dividend_yield ? `${item.dividend_yield.toFixed(2)}%` : '---';
            // åˆè‡´åº¦
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}%` : '---';
            const matchRateClass = getMatchRateClass(item.match_rate);
            // GC/DCå½¢æˆæ—¥
            const gcDate = formatScrapedDate(item.gc_date);
            const dcDate = formatScrapedDate(item.dc_date);

            html += `
                <tr>
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td class="${matchRateClass}">${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per_forward, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td>${divYield}</td>
                    <td>${gcDate}</td>
                    <td>${dcDate}</td>
                    <td><button class="delete-btn" onclick="removeFromWatchlist('${code}')">å‰Šé™¤</button></td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆç”¨ï¼‰
    function formatWatchlistAmount(num) {
        if (num === null || num === undefined) return '---';
        if (num >= 1e12) return `${(num / 1e12).toFixed(1)}å…†`;
        if (num >= 1e8) return `${Math.round(num / 1e8)}å„„`;
        if (num >= 1e4) return `${Math.round(num / 1e4)}ä¸‡`;
        return Math.round(num).toLocaleString();
    }

    // æ™‚ä¾¡ç·é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå„„å††å˜ä½å…¥åŠ› â†’ å…†/å„„è¡¨ç¤ºï¼‰
    function formatMarketCapOku(oku) {
        if (oku === null || oku === undefined) return '---';
        if (oku >= 10000) {
            // 1å…†å††ä»¥ä¸Š
            return `${(oku / 10000).toFixed(1)}å…†`;
        }
        return `${Math.round(oku)}å„„`;
    }

    // æ ªä¾¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatWatchlistPrice(num) {
        if (num === null || num === undefined) return '---';
        return `Â¥${Math.round(num).toLocaleString()}`;
    }

    // æŒ‡æ¨™ã®è‰²åˆ†ã‘ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
    function getMetricClass(value, goodThreshold, warningThreshold) {
        if (value === null || value === undefined) return '';
        if (value <= goodThreshold) return 'metric-good';
        if (value <= warningThreshold) return 'metric-warning';
        return 'metric-danger';
    }

    // åˆè‡´åº¦ã®è‰²åˆ†ã‘ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
    function getMatchRateClass(value) {
        if (value === null || value === undefined) return '';
        if (value >= 70) return 'match-rate-high';
        if (value >= 40) return 'match-rate-medium';
        return 'match-rate-low';
    }

    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰åˆ†æï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«è¡¨ç¤ºï¼‰
    async function analyzeFromWatchlist(code) {
        document.getElementById('stockCode').value = code.replace('.T', '');

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const cachedData = watchlistCache.find(item => item.company_code === code);

        if (cachedData) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«è¡¨ç¤º
            displayCachedData(cachedData);
            document.getElementById('resultsArea').classList.add('active');

            // ãƒãƒ£ãƒ¼ãƒˆã¯æ ªä¾¡å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªã®ã§loadFullAnalysiså¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹
            // ä¸€æ™‚çš„ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const chartContainer = document.getElementById('tradingview-chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:300px;color:#666;">ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            }

            // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€çŠ¶æ…‹ã§è¡¨ç¤º
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.style.display = 'inline-block';
            registerBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°';
            registerBtn.classList.add('registered');
            registerBtn.disabled = false;

            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è©³ç´°åˆ†æã‚’å®Ÿè¡Œ
            loadFullAnalysis(code);
        } else {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯åˆ†æã‚’å®Ÿè¡Œã—ã¦è‡ªå‹•ä¿å­˜
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsArea').classList.remove('active');

            await loadFullAnalysis(code);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsArea').classList.add('active');

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.style.display = 'inline-block';
            registerBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°';
            registerBtn.classList.add('registered');
            registerBtn.disabled = false;
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤º
    function displayCachedData(data) {
        // é€šè²¨ã‚’JPYã«è¨­å®š
        window.currentCurrency = 'JPY';

        // ä¼šç¤¾å
        const companyNameElement = document.querySelector('.company-name');
        if (companyNameElement) {
            companyNameElement.textContent = data.company_name || data.company_code;
        }

        // æ ªä¾¡è¡¨ç¤º
        const stockPriceDisplay = document.getElementById('stock-price-display');
        if (stockPriceDisplay && data.stock_price) {
            stockPriceDisplay.textContent = `Â¥${formatNumber(data.stock_price)}`;
        } else if (stockPriceDisplay) {
            stockPriceDisplay.textContent = '---';
        }

        // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã¨æ¥­ç¨®
        const companyCodeElement = document.querySelector('.company-code');
        if (companyCodeElement) {
            const sector = data.sector || '---';
            companyCodeElement.textContent = `éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰: ${data.company_code} | æ¥­ç¨®: ${sector}`;
        }

        // ä¸»è¦æŒ‡æ¨™ã‚’æ›´æ–°
        updateMetric('equity-ratio', data.equity_ratio, '%', 'è‡ªå·±è³‡æœ¬æ¯”ç‡');
        updateMetric('op-margin', data.operating_margin, '%', 'å–¶æ¥­åˆ©ç›Šç‡');
        updateMetric('per', data.per_forward, 'å€', 'PER');
        updateMetric('pbr', data.pbr, 'å€', 'PBR');
        updateMetric('dividend-yield', data.dividend_yield, '%', 'é…å½“åˆ©å›ã‚Š');

        // æ™‚ä¾¡ç·é¡ï¼ˆå„„å††å˜ä½ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§å††ã«å¤‰æ›ï¼‰
        if (data.market_cap) {
            updateMetric('market-cap', data.market_cap * 1e8, 'JPY', 'æ™‚ä¾¡ç·é¡');
        } else {
            updateMetric('market-cap', null, 'JPY', 'æ™‚ä¾¡ç·é¡');
        }

        // æ ªä¾¡
        const chartTitle = document.querySelector('.chart-title');
        if (chartTitle && data.stock_price) {
            chartTitle.textContent = `æ ªä¾¡æ¨ç§»ï¼ˆç¾åœ¨å€¤: Â¥${formatNumber(data.stock_price)}ï¼‰`;
        }

        // äº‹æ¥­æ¦‚è¦ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¡¨ç¤º
        displayCachedBusinessSummary(data);

        // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¡¨ç¤º
        displayCachedFinancials(data);

        // è²¡å‹™å¥å…¨æ€§ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¡¨ç¤º
        displayCachedFinancialHealth(data);

        // ä¸»è¦æ ªä¸»ãƒ»å½¹å“¡ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¡¨ç¤º
        displayCachedHoldersAndOfficers(data);

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        currentSymbol = data.company_code;
        currentStockData = null;  // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã‹ã‚‰æ›´æ–°

        // åˆè‡´åº¦ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
        updateScoreCard(data);
    }

    // åˆè‡´åº¦ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    function updateScoreCard(data) {
        // ãƒ¡ã‚¤ãƒ³åˆè‡´åº¦è¡¨ç¤º
        const scoreValue = document.getElementById('score-value');

        const matchRate = data.match_rate;
        if (matchRate !== null && matchRate !== undefined) {
            scoreValue.textContent = matchRate;
            scoreValue.className = 'score-value';
            if (matchRate >= 70) {
                scoreValue.classList.add('high');
            } else if (matchRate >= 40) {
                scoreValue.classList.add('medium');
            } else {
                scoreValue.classList.add('low');
            }
        } else {
            scoreValue.textContent = '--';
            scoreValue.className = 'score-value';
        }

        // å„é …ç›®ã®åˆ¤å®šã‚’æ›´æ–°
        // 1. æ™‚ä¾¡ç·é¡ <= 700å„„å††
        const marketCap = data.market_cap;
        updateScoreItem('score-market-cap', marketCap !== null && marketCap <= 700, marketCap ? `${Math.round(marketCap)}å„„` : null);

        // 2. è‡ªå·±è³‡æœ¬æ¯”ç‡ >= 30%
        const equityRatio = data.equity_ratio;
        updateScoreItem('score-equity-ratio', equityRatio !== null && equityRatio >= 30, equityRatio ? `${equityRatio.toFixed(1)}%` : null);

        // 3. å£²ä¸Šæˆé•·ç‡(å®Ÿç¸¾) > 0% (å‰æœŸ vs 2æœŸå‰)
        let revenueGrowth = null;
        let revenueGrowthPass = false;
        const financialHistory = parseJsonField(data.financial_history);
        if (financialHistory && financialHistory.revenue && financialHistory.revenue.length >= 2) {
            const sorted = [...financialHistory.revenue].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted.length >= 2 && sorted[0].value && sorted[1].value && sorted[1].value > 0) {
                revenueGrowth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                revenueGrowthPass = revenueGrowth > 0;
            }
        }
        updateScoreItem('score-revenue-growth', revenueGrowthPass, revenueGrowth !== null ? `${revenueGrowth.toFixed(1)}%` : null);

        // 4. å£²ä¸Šæˆé•·ç‡(äºˆæƒ³) > 0% (å‰æœŸ vs ä»ŠæœŸäºˆæƒ³)
        let revenueForecastGrowth = null;
        let revenueForecastPass = false;
        const forecastRevenue = data.forecast_revenue;
        if (forecastRevenue && financialHistory && financialHistory.revenue && financialHistory.revenue.length >= 1) {
            const sorted = [...financialHistory.revenue].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0].value && sorted[0].value > 0) {
                revenueForecastGrowth = ((forecastRevenue - sorted[0].value) / sorted[0].value) * 100;
                revenueForecastPass = revenueForecastGrowth > 0;
            }
        }
        updateScoreItem('score-revenue-forecast', revenueForecastPass, revenueForecastGrowth !== null ? `${revenueForecastGrowth.toFixed(1)}%` : null);

        // 5. å–¶æ¥­åˆ©ç›Šç‡ >= 10%
        const opMargin = data.operating_margin;
        updateScoreItem('score-op-margin', opMargin !== null && opMargin >= 10, opMargin ? `${opMargin.toFixed(1)}%` : null);

        // 6. å–¶æ¥­åˆ©ç›Šæˆé•·ç‡(å®Ÿç¸¾) > 0%
        let opGrowth = null;
        let opGrowthPass = false;
        if (financialHistory && financialHistory.op_income && financialHistory.op_income.length >= 2) {
            const sorted = [...financialHistory.op_income].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted.length >= 2 && sorted[0].value && sorted[1].value && sorted[1].value > 0) {
                opGrowth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                opGrowthPass = opGrowth > 0;
            }
        }
        updateScoreItem('score-op-growth', opGrowthPass, opGrowth !== null ? `${opGrowth.toFixed(1)}%` : null);

        // 7. å–¶æ¥­åˆ©ç›Šæˆé•·ç‡(äºˆæƒ³) > 0% (å‰æœŸ vs ä»ŠæœŸäºˆæƒ³)
        let opForecastGrowth = null;
        let opForecastPass = false;
        const forecastOpIncome = data.forecast_op_income;
        if (forecastOpIncome && financialHistory && financialHistory.op_income && financialHistory.op_income.length >= 1) {
            const sorted = [...financialHistory.op_income].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0].value && sorted[0].value > 0) {
                opForecastGrowth = ((forecastOpIncome - sorted[0].value) / sorted[0].value) * 100;
                opForecastPass = opForecastGrowth > 0;
            }
        }
        updateScoreItem('score-op-forecast', opForecastPass, opForecastGrowth !== null ? `${opForecastGrowth.toFixed(1)}%` : null);

        // 6. å–¶æ¥­CF > 0
        const operatingCf = data.operating_cf;
        updateScoreItem('score-op-cf', operatingCf !== null && operatingCf > 0, operatingCf ? `${operatingCf.toFixed(1)}å„„` : null);

        // 7. ãƒ•ãƒªãƒ¼CF > 0
        const freeCf = data.free_cf;
        updateScoreItem('score-free-cf', freeCf !== null && freeCf > 0, freeCf ? `${freeCf.toFixed(1)}å„„` : null);

        // 8. ROA > 4.5%
        let roa = data.roa;
        if (roa === null || roa === undefined) {
            const cfHistory = parseJsonField(data.cf_history);
            if (cfHistory && cfHistory.roa && cfHistory.roa.length > 0) {
                const sorted = [...cfHistory.roa].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                roa = sorted[0].value;
            }
        }
        updateScoreItem('score-roa', roa !== null && roa > 4.5, roa ? `${roa.toFixed(1)}%` : null);

        // 9. PER < 40å€
        const per = data.per_forward;
        updateScoreItem('score-per', per !== null && per > 0 && per < 40, per ? `${per.toFixed(1)}å€` : null);

        // 10. PBR < 10å€
        const pbr = data.pbr;
        updateScoreItem('score-pbr', pbr !== null && pbr > 0 && pbr < 10, pbr ? `${pbr.toFixed(2)}å€` : null);
    }

    // JSONæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
    function parseJsonField(field) {
        if (!field) return null;
        if (typeof field === 'object') return field;
        try {
            return JSON.parse(field);
        } catch {
            return null;
        }
    }

    // ã‚¹ã‚³ã‚¢é …ç›®ã‚’æ›´æ–°
    function updateScoreItem(elementId, pass, value) {
        const element = document.getElementById(elementId);
        if (!element) return;

        if (value === null) {
            element.textContent = '--';
            element.className = 'score-item-status';
        } else {
            element.textContent = pass ? `âœ“ ${value}` : `âœ— ${value}`;
            element.className = 'score-item-status ' + (pass ? 'pass' : 'fail');
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸäº‹æ¥­æ¦‚è¦ã‚’è¡¨ç¤º
    function displayCachedBusinessSummary(data) {
        const summaryContent = document.getElementById('business-summary-content');
        if (!summaryContent) return;

        if (data.business_summary_jp) {
            summaryContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">
                        ğŸ“‹ äº‹æ¥­ç‰¹è‰²
                    </div>
                    <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">
                        ${data.business_summary_jp}
                    </div>
                </div>
            `;
        } else if (data.business_summary) {
            summaryContent.innerHTML = `
                <div>
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">
                        ğŸ“„ Business Summary
                    </div>
                    <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">
                        ${data.business_summary}
                    </div>
                </div>
            `;
        } else {
            summaryContent.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">ãƒãƒ£ãƒ¼ãƒˆèª­è¾¼æ™‚ã«æ›´æ–°ã•ã‚Œã¾ã™...</div>';
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸè²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    function displayCachedFinancials(data) {
        // financial_historyãŒã‚ã‚Œã°ãƒ‘ãƒ¼ã‚¹ã—ã¦è¡¨ç¤º
        let financialHistory = null;
        let cfHistory = null;

        try {
            if (data.financial_history) {
                financialHistory = typeof data.financial_history === 'string'
                    ? JSON.parse(data.financial_history)
                    : data.financial_history;
            }
            if (data.cf_history) {
                cfHistory = typeof data.cf_history === 'string'
                    ? JSON.parse(data.cf_history)
                    : data.cf_history;
            }
        } catch (e) {
            console.error('è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
        }

        if (financialHistory) {
            // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰
            const mockData = {
                revenue: financialHistory.revenue || [],
                op_income: financialHistory.op_income || [],
                ordinary_income: financialHistory.ordinary_income || [],
                net_income: financialHistory.net_income || [],
                eps: financialHistory.eps || [],
                dps: financialHistory.dps || [],
                payout_ratio: financialHistory.payout_ratio || []
            };

            if (cfHistory) {
                mockData.operating_cf = cfHistory.operating_cf || [];
                mockData.investing_cf = cfHistory.investing_cf || [];
                mockData.financing_cf = cfHistory.financing_cf || [];
                mockData.cash = cfHistory.cash || [];
                mockData.current_liabilities_list = cfHistory.current_liabilities || [];
                mockData.equity_ratio_list = cfHistory.equity_ratio || [];
                mockData.roe = cfHistory.roe || [];
                mockData.roa = cfHistory.roa || [];
            }

            // æ—¢å­˜ã®é–¢æ•°ã‚’ä½¿ã£ã¦è¡¨ç¤º
            updateFinancialYearTable(mockData);
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸè²¡å‹™å¥å…¨æ€§ã‚’è¡¨ç¤º
    function displayCachedFinancialHealth(data) {
        // ç¾é é‡‘
        const cashDisplay = document.getElementById('cash-display');
        if (cashDisplay) {
            if (data.cash) {
                // å„„å††å˜ä½ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§å††ã«å¤‰æ›ã—ã¦è¡¨ç¤º
                cashDisplay.textContent = formatAmount(data.cash * 1e8, 'JPY');
            } else {
                cashDisplay.textContent = '---';
            }
        }

        // æµå‹•è² å‚µ
        const currentLiabDisplay = document.getElementById('current-liab-display');
        if (currentLiabDisplay) {
            if (data.current_liabilities) {
                currentLiabDisplay.textContent = formatAmount(data.current_liabilities * 1e8, 'JPY');
            } else {
                currentLiabDisplay.textContent = '---';
            }
        }

        // æµå‹•æ¯”ç‡
        const currentRatioDisplay = document.getElementById('current-ratio-display');
        if (currentRatioDisplay) {
            if (data.current_ratio) {
                currentRatioDisplay.textContent = `${data.current_ratio.toFixed(1)}%`;
                if (data.current_ratio >= 150) {
                    currentRatioDisplay.style.color = 'var(--success-color)';
                } else if (data.current_ratio >= 100) {
                    currentRatioDisplay.style.color = 'var(--warning-color)';
                } else {
                    currentRatioDisplay.style.color = 'var(--danger-color)';
                }
            } else {
                currentRatioDisplay.textContent = '---';
            }
        }

        // é…å½“æ€§å‘
        const payoutDisplay = document.getElementById('payout-ratio-display');
        if (payoutDisplay) {
            if (data.payout_ratio) {
                payoutDisplay.textContent = `${data.payout_ratio.toFixed(1)}%`;
            } else {
                payoutDisplay.textContent = '---';
            }
        }

        // ä¿¡ç”¨å€ç‡
        const marginRatioDisplay = document.getElementById('margin-ratio-display');
        if (marginRatioDisplay) {
            if (data.margin_trading_ratio) {
                marginRatioDisplay.textContent = `${data.margin_trading_ratio.toFixed(2)}å€`;
            } else {
                marginRatioDisplay.textContent = '---';
            }
        }

        // ç¾é é‡‘æ¨ç§»
        const cashOld = document.getElementById('cash-old');
        const cashNew = document.getElementById('cash-new');
        if (cashNew && data.cash) {
            cashNew.textContent = formatAmount(data.cash * 1e8, 'JPY');
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ ªä¸»ãƒ»å½¹å“¡ã‚’è¡¨ç¤º
    function displayCachedHoldersAndOfficers(data) {
        // ä¸»è¦æ ªä¸»
        const holdersContent = document.getElementById('major-holders-content');
        if (holdersContent) {
            let holders = null;
            let institutional = null;

            try {
                if (data.major_holders) {
                    holders = typeof data.major_holders === 'string'
                        ? JSON.parse(data.major_holders)
                        : data.major_holders;
                }
                if (data.institutional_holders) {
                    institutional = typeof data.institutional_holders === 'string'
                        ? JSON.parse(data.institutional_holders)
                        : data.institutional_holders;
                }
            } catch (e) {
                console.error('æ ªä¸»ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            }

            if (holders || institutional) {
                // æ—¢å­˜ã®é–¢æ•°å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
                const mockData = {
                    major_holders: holders || [],
                    institutional_holders: institutional || []
                };
                updateMajorHolders(mockData);
            } else {
                holdersContent.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            }
        }

        // å½¹å“¡
        const officersContent = document.getElementById('company-officers-content');
        if (officersContent) {
            let officers = null;

            try {
                if (data.company_officers) {
                    officers = typeof data.company_officers === 'string'
                        ? JSON.parse(data.company_officers)
                        : data.company_officers;
                }
            } catch (e) {
                console.error('å½¹å“¡ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            }

            if (officers && officers.length > 0) {
                const mockData = { company_officers: officers };
                updateCompanyOfficers(mockData);
            } else {
                officersContent.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            }
        }
    }

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è©³ç´°åˆ†æã‚’èª­ã¿è¾¼ã‚€
    async function loadFullAnalysis(code) {
        try {
            const response = await fetch('/api/stock/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: code })
            });

            const data = await response.json();

            if (response.ok) {
                // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                currentStockData = data;
                currentSymbol = code;

                // çµæœã‚’æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãï¼‰
                updateResults(data);

                // â€» è‡ªå‹•ä¿å­˜ã¯ç„¡åŠ¹åŒ–ï¼ˆæ‰‹å‹•ã§ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®ã¿ä¿å­˜ï¼‰
                // æ‰‹å‹•ç·¨é›†ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒyfinanceãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã‚’é˜²ããŸã‚
            } else {
                console.error('è©³ç´°åˆ†æã‚¨ãƒ©ãƒ¼:', data.error);
                // TradingViewãƒãƒ£ãƒ¼ãƒˆã¯æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾
            }
        } catch (error) {
            console.error('è©³ç´°åˆ†æã‚¨ãƒ©ãƒ¼:', error);
            // TradingViewãƒãƒ£ãƒ¼ãƒˆã¯æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾
        }
    }

    // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’screened_latestã«è‡ªå‹•ä¿å­˜
    async function saveToScreenedLatest(code, stockData) {
        try {
            await fetch('/api/watchlist/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_code: code,
                    stock_data: stockData
                })
            });
            console.log('åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ:', code);
            // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
            loadWatchlist();
        } catch (error) {
            console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // éŠ˜æŸ„ã‚’ç™»éŒ²
    async function registerStock() {
        if (!currentSymbol || !currentStockData) {
            alert('å…ˆã«éŠ˜æŸ„ã‚’åˆ†æã—ã¦ãã ã•ã„');
            return;
        }

        const registerBtn = document.getElementById('registerBtn');
        registerBtn.disabled = true;
        registerBtn.textContent = 'ç™»éŒ²ä¸­...';

        try {
            const response = await fetch('/api/watchlist/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_code: currentSymbol,
                    stock_data: currentStockData
                })
            });

            const data = await response.json();

            if (response.ok) {
                registerBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°';
                registerBtn.classList.add('registered');
                registerBtn.disabled = false;
                // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’æ›´æ–°
                loadWatchlist();
            } else {
                alert(`ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                registerBtn.disabled = false;
                registerBtn.textContent = 'ç™»éŒ²';
            }
        } catch (error) {
            alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            registerBtn.disabled = false;
            registerBtn.textContent = 'ç™»éŒ²';
        }
    }

    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
    async function removeFromWatchlist(code) {
        if (!confirm(`${code} ã‚’ç™»éŒ²ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }

        try {
            const response = await fetch(`/api/watchlist/remove/${code}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’æ›´æ–°
                loadWatchlist();
                // ç¾åœ¨åˆ†æä¸­ã®éŠ˜æŸ„ãªã‚‰ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
                if (currentSymbol === code) {
                    const registerBtn = document.getElementById('registerBtn');
                    registerBtn.textContent = 'ç™»éŒ²';
                    registerBtn.classList.remove('registered');
                    registerBtn.disabled = false;
                }
            } else {
                alert(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${data.error}`);
            }
        } catch (error) {
            alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    // ç™»éŒ²çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    async function checkRegistrationStatus(symbol) {
        try {
            const response = await fetch(`/api/watchlist/check/${symbol}`);
            const data = await response.json();
            return data.is_registered || false;
        } catch (error) {
            console.error('ç™»éŒ²çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            return false;
        }
    }

    // analyzeStocké–¢æ•°ã‚’æ‹¡å¼µï¼ˆå…ƒã®é–¢æ•°ã®å¾Œã«ç™»éŒ²ãƒœã‚¿ãƒ³å‡¦ç†ã‚’è¿½åŠ ï¼‰
    const originalAnalyzeStock = analyzeStock;
    analyzeStock = async function() {
        const stockCode = document.getElementById('stockCode').value.trim().toUpperCase();

        if (!stockCode) {
            alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // 4æ¡æ•°å­—ãªã‚‰æ—¥æœ¬æ ªã¨ã—ã¦.Tã‚’ä»˜ã‘ã‚‹
        const symbol = /^\d{4}$/.test(stockCode) ? `${stockCode}.T` : stockCode;

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resultsArea').classList.remove('active');

        // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’ä¸€æ—¦éè¡¨ç¤º
        const registerBtn = document.getElementById('registerBtn');
        registerBtn.style.display = 'none';

        try {
            const response = await fetch('/api/stock/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: symbol })
            });

            const data = await response.json();

            if (response.ok) {
                // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                currentStockData = data;
                currentSymbol = symbol;

                // çµæœã‚’è¡¨ç¤º
                updateResults(data);
                document.getElementById('resultsArea').classList.add('active');

                // ç™»éŒ²çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const isRegistered = await checkRegistrationStatus(symbol);
                registerBtn.style.display = 'inline-block';
                if (isRegistered) {
                    registerBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°';
                    registerBtn.classList.add('registered');
                    registerBtn.disabled = false;
                } else {
                    registerBtn.textContent = 'ç™»éŒ²';
                    registerBtn.classList.remove('registered');
                    registerBtn.disabled = false;
                }
            } else {
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                if (data.timeout || response.status === 504) {
                    alert(`â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ\n\nãƒ‡ãƒ¼ã‚¿å–å¾—ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚\nYahoo Financeã®å¿œç­”ãŒé…ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nâ†’ å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ã€ŒæŠ½å‡ºã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚`);
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            }
        } catch (error) {
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                alert(`â±ï¸ é€šä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ\n\næ¥ç¶šã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚\n\nâ†’ å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ã€ŒæŠ½å‡ºã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚`);
            } else {
                alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    };

    // ========================================
    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆä¸€æ‹¬åˆ†ææ©Ÿèƒ½
    // ========================================

    let wlAnalyzePolling = null;

    async function analyzeWlStocks() {
        const btn = document.getElementById('wlAnalyzeBtn');
        const stopBtn = document.getElementById('wlStopBtn');
        btn.disabled = true;
        stopBtn.style.display = 'inline-block';

        try {
            const response = await fetch('/api/watchlist/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (response.ok) {
                if (data.status && data.status.total === 0) {
                    btn.disabled = false;
                    btn.textContent = 'è©³ç´°å–å¾—';
                    stopBtn.style.display = 'none';
                    alert('å…¨éŠ˜æŸ„ã®åˆ†æãŒå®Œäº†æ¸ˆã¿ã§ã™');
                } else {
                    startWlAnalyzePolling();
                }
            } else {
                if (data.status && data.status.running) {
                    startWlAnalyzePolling();
                } else {
                    alert('åˆ†æã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ä¸æ˜'));
                    btn.disabled = false;
                    btn.textContent = 'è©³ç´°å–å¾—';
                    stopBtn.style.display = 'none';
                }
            }
        } catch (error) {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
            btn.disabled = false;
            btn.textContent = 'è©³ç´°å–å¾—';
            stopBtn.style.display = 'none';
        }
    }

    async function stopWlAnalyze() {
        try {
            await fetch('/api/watchlist/analyze/stop', { method: 'POST' });
            document.getElementById('wlStopBtn').disabled = true;
            document.getElementById('wlStopBtn').textContent = 'åœæ­¢ä¸­...';
        } catch (e) {
            console.error('åœæ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—:', e);
        }
    }

    function finishWlAnalyzeUI() {
        const btn = document.getElementById('wlAnalyzeBtn');
        const stopBtn = document.getElementById('wlStopBtn');
        btn.disabled = false;
        btn.textContent = 'è©³ç´°å–å¾—';
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = 'åœæ­¢';
    }

    function startWlAnalyzePolling() {
        if (wlAnalyzePolling) clearInterval(wlAnalyzePolling);

        wlAnalyzePolling = setInterval(async () => {
            try {
                const statusRes = await fetch('/api/watchlist/analyze/status');
                const status = await statusRes.json();

                document.getElementById('wlAnalyzeBtn').textContent = `åˆ†æä¸­ ${status.done}/${status.total}`;

                // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                loadWatchlist();

                if (!status.running) {
                    clearInterval(wlAnalyzePolling);
                    wlAnalyzePolling = null;
                    finishWlAnalyzeUI();
                }
            } catch (e) {
                clearInterval(wlAnalyzePolling);
                wlAnalyzePolling = null;
                finishWlAnalyzeUI();
            }
        }, 3000);
    }

    // ========================================
    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆå…¨ä»¶å‰Šé™¤
    // ========================================

    async function removeAllWatchlist() {
        if (!confirm('ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã®å…¨éŠ˜æŸ„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        try {
            const response = await fetch('/api/watchlist/remove-all', { method: 'DELETE' });
            if (response.ok) {
                loadWatchlist();
            } else {
                const data = await response.json();
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ä¸æ˜'));
            }
        } catch (error) {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
    }

    // ========================================
    // ä¸€æ‹¬ç™»éŒ²æ©Ÿèƒ½
    // ========================================

    function openBulkRegisterModal() {
        document.getElementById('bulkRegisterModal').style.display = 'flex';
        document.getElementById('bulkCodesInput').value = '';
        document.getElementById('bulkRegisterStatus').innerHTML = '';
    }

    function closeBulkRegisterModal() {
        document.getElementById('bulkRegisterModal').style.display = 'none';
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('bulkRegisterModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeBulkRegisterModal();
        }
    });

    async function submitBulkRegister() {
        const input = document.getElementById('bulkCodesInput').value.trim();
        const statusDiv = document.getElementById('bulkRegisterStatus');
        const submitBtn = document.querySelector('.modal-submit-btn');

        if (!input) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';
            return;
        }

        // ã‚«ãƒ³ãƒã€æ”¹è¡Œã€ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã—ã¦éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        const codes = input
            .split(/[,\n\s]+/)
            .map(code => code.trim().replace('.T', ''))
            .filter(code => code && /^\d{3,4}[A-Z]?$/.test(code));

        if (codes.length === 0) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">æœ‰åŠ¹ãªéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆ3ã€œ4æ¡ã®æ•°å­—+è‹±å­—ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
            return;
        }

        // é‡è¤‡ã‚’é™¤å»
        const uniqueCodes = [...new Set(codes)];

        submitBtn.disabled = true;
        submitBtn.textContent = 'ç™»éŒ²ä¸­...';
        statusDiv.innerHTML = `<span style="color: #3b82f6;">ç™»éŒ²ä¸­... (0/${uniqueCodes.length})</span>`;

        let successCount = 0;
        let failedCodes = [];

        for (let i = 0; i < uniqueCodes.length; i++) {
            const code = uniqueCodes[i] + '.T';
            try {
                const response = await fetch('/api/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company_code: code })
                });

                if (response.ok) {
                    successCount++;
                } else {
                    failedCodes.push(uniqueCodes[i]);
                }
            } catch (error) {
                failedCodes.push(uniqueCodes[i]);
            }

            statusDiv.innerHTML = `<span style="color: #3b82f6;">ç™»éŒ²ä¸­... (${i + 1}/${uniqueCodes.length})</span>`;
        }

        submitBtn.disabled = false;
        submitBtn.textContent = 'ç™»éŒ²';

        if (failedCodes.length === 0) {
            statusDiv.innerHTML = `<span style="color: #10b981;">âœ“ ${successCount}ä»¶ã®éŠ˜æŸ„ã‚’ç™»éŒ²ã—ã¾ã—ãŸ</span>`;
        } else {
            statusDiv.innerHTML = `<span style="color: #f59e0b;">âœ“ ${successCount}ä»¶ç™»éŒ²ã€${failedCodes.length}ä»¶å¤±æ•— (${failedCodes.join(', ')})</span>`;
        }

        // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’æ›´æ–°
        loadWatchlist();

        // 2ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        setTimeout(() => {
            closeBulkRegisterModal();
        }, 2000);
    }

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿ç·¨é›†ãƒ»ä¿å­˜æ©Ÿèƒ½
    // ========================================

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«ç·¨é›†æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
    function onCellEdit(input) {
        showSaveSection();
    }

    // ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
    function showSaveSection() {
        if (!IS_ADMIN) return;
        const saveSection = document.getElementById('saveSection');
        if (saveSection) {
            saveSection.classList.add('active');
        }
    }

    // ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    function hideSaveSection() {
        const saveSection = document.getElementById('saveSection');
        if (saveSection) {
            saveSection.classList.remove('active');
        }
    }

    // ç·¨é›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    async function saveEditedData() {
        if (!currentSymbol) {
            alert('ä¿å­˜ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const saveBtn = document.querySelector('.save-button');
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';

        try {
            // ç·¨é›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const editedData = collectEditedData();

            // APIã‚’å‘¼ã³å‡ºã—ã¦ä¿å­˜
            const response = await fetch('/api/watchlist/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_code: currentSymbol,
                    edited_data: editedData
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                hideSaveSection();
                // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’æ›´æ–°
                loadWatchlist();
            } else {
                alert(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
            }
        } catch (error) {
            alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'å¤‰æ›´ã‚’ä¿å­˜';
        }
    }

    // ç·¨é›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    function collectEditedData() {
        const data = {};

        // ä¸»è¦æŒ‡æ¨™ã®ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        const metricInputs = document.querySelectorAll('.editable-field[data-metric]');
        metricInputs.forEach(input => {
            const metric = input.getAttribute('data-metric');
            const value = parseEditedValue(input.value);
            if (metric && value !== null) {
                // ãƒ¡ãƒˆãƒªãƒƒã‚¯åã‚’DBç”¨ã®ã‚­ãƒ¼ã«å¤‰æ›
                const keyMap = {
                    'è‡ªå·±è³‡æœ¬æ¯”ç‡': 'equity_ratio',
                    'å–¶æ¥­åˆ©ç›Šç‡': 'operating_margin',
                    'per': 'per_forward',
                    'pbr': 'pbr',
                    'é…å½“åˆ©å›ã‚Š': 'dividend_yield',
                    'æ™‚ä¾¡ç·é¡': 'market_cap'
                };
                const dbKey = keyMap[metric] || metric;
                data[dbKey] = value;
            }
        });

        // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        const financialHistory = {};
        const cfHistory = {};

        const cellInputs = document.querySelectorAll('.editable-cell[data-type]');
        cellInputs.forEach(input => {
            const dataType = input.getAttribute('data-type');
            const yearIndex = input.getAttribute('data-year');
            const isAmount = input.getAttribute('data-is-amount') === 'true';
            let value = parseFloat(input.value);

            if (!dataType || !yearIndex || isNaN(value)) return;

            // é‡‘é¡ç³»ã¯å„„å††â†’å††ã«å¤‰æ›
            if (isAmount) {
                value = value * 1e8;
            }

            // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã¨CFãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é¡
            const financialTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income', 'eps', 'dps', 'payout_ratio'];
            const cfTypes = ['operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list', 'equity_ratio_list', 'roe', 'roa'];

            if (financialTypes.includes(dataType)) {
                if (!financialHistory[dataType]) {
                    financialHistory[dataType] = [];
                }
                // å¹´åº¦ãƒ©ãƒ™ãƒ«ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—
                const yearLabel = document.querySelector(`#financial-data-tbody tr[data-year="${yearIndex}"] .year-label`);
                const fullDate = yearLabel && yearLabel.dataset.fullDate ? yearLabel.dataset.fullDate : `${yearIndex}-03-31`;
                financialHistory[dataType].push({
                    date: fullDate,
                    value: value
                });
            } else if (cfTypes.includes(dataType)) {
                if (!cfHistory[dataType]) {
                    cfHistory[dataType] = [];
                }
                const yearLabel = document.querySelector(`#cf-metrics-tbody tr[data-year="${yearIndex}"] .year-label`);
                const fullDate = yearLabel && yearLabel.dataset.fullDate ? yearLabel.dataset.fullDate : `${yearIndex}-03-31`;
                cfHistory[dataType].push({
                    date: fullDate,
                    value: value
                });
            }
        });

        if (Object.keys(financialHistory).length > 0) {
            data.financial_history = financialHistory;
        }
        if (Object.keys(cfHistory).length > 0) {
            data.cf_history = cfHistory;
        }

        return data;
    }

    // ç·¨é›†ã•ã‚ŒãŸå€¤ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆæ•°å€¤ã«å¤‰æ›ï¼‰
    function parseEditedValue(str) {
        if (!str || str === '---' || str === '') return null;

        // æ—¥æœ¬èªå˜ä½ã‚’å‡¦ç†
        let value = str.replace(/,/g, '').trim();

        // å…†ãƒ»å„„ãƒ»ä¸‡ã®å¤‰æ›
        if (value.includes('å…†')) {
            value = parseFloat(value.replace('å…†', '').replace('å††', '')) * 1e12;
        } else if (value.includes('å„„')) {
            value = parseFloat(value.replace('å„„', '').replace('å††', '')) * 1e8;
        } else if (value.includes('ä¸‡')) {
            value = parseFloat(value.replace('ä¸‡', '').replace('å††', '')) * 1e4;
        } else {
            // å˜ä½ãªã—ã®æ•°å€¤
            value = parseFloat(value.replace('å††', '').replace('%', '').replace('å€', ''));
        }

        return Number.isFinite(value) ? value : null;
    }

    // ========================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    // ========================================

    function switchTab(tabName) {
        document.querySelectorAll('.watchlist-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`tabContent-${tabName}`).classList.add('active');

        // GC/DCã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã€ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
        if (tabName === 'gc' && gcStocksCache.length === 0) {
            loadGcStocks();
        }
        if (tabName === 'dc' && dcStocksCache.length === 0) {
            loadDcStocks();
        }
    }

    // ========================================
    // GCéŠ˜æŸ„é–¢é€£æ©Ÿèƒ½
    // ========================================

    let gcStocksCache = [];

    // ä¿å­˜æ¸ˆã¿GCéŠ˜æŸ„ã‚’ãƒ­ãƒ¼ãƒ‰
    async function loadGcStocks() {
        try {
            const response = await fetch('/api/gc-stocks');
            const data = await response.json();
            if (response.ok) {
                renderGcStocks(data.gc_stocks || []);
            } else {
                document.getElementById('gcContent').innerHTML =
                    '<div class="watchlist-empty">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        } catch (error) {
            document.getElementById('gcContent').innerHTML =
                '<div class="watchlist-empty">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        }
    }

    // kabutan.jpã‹ã‚‰ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    async function fetchGcStocks() {
        const btn = document.getElementById('gcFetchBtn');
        btn.disabled = true;
        btn.textContent = 'å–å¾—ä¸­...';

        document.getElementById('gcContent').innerHTML =
            '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">kabutan.jpã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...ï¼ˆ10ã€œ30ç§’ç¨‹åº¦ï¼‰</div></div>';

        try {
            const response = await fetch('/api/gc-stocks/scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (response.ok) {
                renderGcStocks(data.gc_stocks || []);
            } else {
                document.getElementById('gcContent').innerHTML =
                    `<div class="watchlist-empty">å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            }
        } catch (error) {
            document.getElementById('gcContent').innerHTML =
                `<div class="watchlist-empty">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'å–å¾—';
        }
    }

    // GCéŠ˜æŸ„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    function renderGcStocks(stocks) {
        gcStocksCache = stocks;

        const content = document.getElementById('gcContent');
        const countElement = document.getElementById('gcCount');
        countElement.textContent = `${stocks.length}ä»¶`;

        if (stocks.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">GCéŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œå–å¾—ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>ã‚³ãƒ¼ãƒ‰</th>
                        <th>ä¼šç¤¾å</th>
                        <th>åˆè‡´åº¦</th>
                        <th>ã‚»ã‚¯ã‚¿ãƒ¼</th>
                        <th>æ™‚ä¾¡ç·é¡</th>
                        <th>æ ªä¾¡</th>
                        <th>PER</th>
                        <th>PBR</th>
                        <th>é…å½“åˆ©å›ã‚Š</th>
                        <th>å½¢æˆæ—¥</th>
                    </tr>
                </thead>
                <tbody>
        `;

        stocks.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const matchRate = item.match_rate !== null && item.match_rate !== undefined
                ? `${item.match_rate}/120` : '---';
            const sector = item.sector || '---';
            const marketCap = item.market_cap !== null && item.market_cap !== undefined
                ? `${Number(item.market_cap).toLocaleString()}å„„` : '---';
            const price = item.stock_price !== null && item.stock_price !== undefined
                ? Number(item.stock_price).toLocaleString() + 'å††' : '---';
            const per = item.per !== null && item.per !== undefined
                ? `${Number(item.per).toFixed(1)}å€` : '---';
            const pbr = item.pbr !== null && item.pbr !== undefined
                ? `${Number(item.pbr).toFixed(2)}å€` : '---';
            const divYield = item.dividend_yield !== null && item.dividend_yield !== undefined
                ? `${Number(item.dividend_yield).toFixed(2)}%` : '---';
            const formedDate = formatScrapedDate(item.scraped_at);

            html += `
                <tr>
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td>${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td>${divYield}</td>
                    <td>${formedDate}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    // GCéŠ˜æŸ„ã®è©³ç´°åˆ†æã‚’å®Ÿè¡Œï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ + ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
    let gcAnalyzePolling = null;

    async function analyzeGcStocks() {
        if (gcStocksCache.length === 0) {
            alert('å…ˆã«GCéŠ˜æŸ„ã‚’å–å¾—ã—ã¦ãã ã•ã„');
            return;
        }

        const btn = document.getElementById('gcAnalyzeBtn');
        const stopBtn = document.getElementById('gcStopBtn');
        btn.disabled = true;
        stopBtn.style.display = 'inline-block';

        try {
            const response = await fetch('/api/gc-stocks/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (response.ok) {
                if (data.status && data.status.total === 0) {
                    // å…¨ä»¶åˆ†ææ¸ˆã¿
                    btn.disabled = false;
                    btn.textContent = 'è©³ç´°å–å¾—';
                    stopBtn.style.display = 'none';
                    alert('å…¨éŠ˜æŸ„ã®åˆ†æãŒå®Œäº†æ¸ˆã¿ã§ã™');
                } else {
                    startGcAnalyzePolling();
                }
            } else {
                if (data.status && data.status.running) {
                    startGcAnalyzePolling();
                } else {
                    document.getElementById('gcContent').innerHTML =
                        `<div class="watchlist-empty">åˆ†æã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                    btn.disabled = false;
                    btn.textContent = 'è©³ç´°å–å¾—';
                    stopBtn.style.display = 'none';
                }
            }
        } catch (error) {
            document.getElementById('gcContent').innerHTML =
                `<div class="watchlist-empty">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            btn.disabled = false;
            btn.textContent = 'è©³ç´°å–å¾—';
            stopBtn.style.display = 'none';
        }
    }

    async function stopGcAnalyze() {
        try {
            await fetch('/api/gc-stocks/analyze/stop', { method: 'POST' });
            document.getElementById('gcStopBtn').disabled = true;
            document.getElementById('gcStopBtn').textContent = 'åœæ­¢ä¸­...';
        } catch (e) {
            console.error('åœæ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—:', e);
        }
    }

    function finishGcAnalyzeUI() {
        const btn = document.getElementById('gcAnalyzeBtn');
        const stopBtn = document.getElementById('gcStopBtn');
        btn.disabled = false;
        btn.textContent = 'è©³ç´°å–å¾—';
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = 'åœæ­¢';
    }

    function startGcAnalyzePolling() {
        if (gcAnalyzePolling) clearInterval(gcAnalyzePolling);

        gcAnalyzePolling = setInterval(async () => {
            try {
                // é€²æ—ã‚’å–å¾—
                const statusRes = await fetch('/api/gc-stocks/analyze/status');
                const status = await statusRes.json();

                const btn = document.getElementById('gcAnalyzeBtn');
                btn.textContent = `åˆ†æä¸­ ${status.done}/${status.total}`;

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
                const dataRes = await fetch('/api/gc-stocks');
                const data = await dataRes.json();
                if (dataRes.ok) {
                    renderGcStocks(data.gc_stocks || []);
                }

                // å®Œäº†åˆ¤å®š
                if (!status.running) {
                    clearInterval(gcAnalyzePolling);
                    gcAnalyzePolling = null;
                    finishGcAnalyzeUI();
                }
            } catch (e) {
                clearInterval(gcAnalyzePolling);
                gcAnalyzePolling = null;
                finishGcAnalyzeUI();
            }
        }, 3000);
    }

    // scraped_atã‚’yyyy/mm/ddå½¢å¼ã«å¤‰æ›
    function formatScrapedDate(dateStr) {
        if (!dateStr) return '---';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return '---';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}/${m}/${day}`;
    }

    // ========================================
    // DCéŠ˜æŸ„é–¢é€£æ©Ÿèƒ½
    // ========================================

    let dcStocksCache = [];

    // ä¿å­˜æ¸ˆã¿DCéŠ˜æŸ„ã‚’ãƒ­ãƒ¼ãƒ‰
    async function loadDcStocks() {
        try {
            const response = await fetch('/api/dc-stocks');
            const data = await response.json();
            if (response.ok) {
                renderDcStocks(data.dc_stocks || []);
            } else {
                document.getElementById('dcContent').innerHTML =
                    '<div class="watchlist-empty">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        } catch (error) {
            document.getElementById('dcContent').innerHTML =
                '<div class="watchlist-empty">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        }
    }

    // kabutan.jpã‹ã‚‰DCã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    async function fetchDcStocks() {
        const btn = document.getElementById('dcFetchBtn');
        btn.disabled = true;
        btn.textContent = 'å–å¾—ä¸­...';

        document.getElementById('dcContent').innerHTML =
            '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">kabutan.jpã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...ï¼ˆ10ã€œ30ç§’ç¨‹åº¦ï¼‰</div></div>';

        try {
            const response = await fetch('/api/dc-stocks/scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (response.ok) {
                renderDcStocks(data.dc_stocks || []);
            } else {
                document.getElementById('dcContent').innerHTML =
                    `<div class="watchlist-empty">å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            }
        } catch (error) {
            document.getElementById('dcContent').innerHTML =
                `<div class="watchlist-empty">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'å–å¾—';
        }
    }

    // DCéŠ˜æŸ„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    function renderDcStocks(stocks) {
        dcStocksCache = stocks;

        const content = document.getElementById('dcContent');
        const countElement = document.getElementById('dcCount');
        countElement.textContent = `${stocks.length}ä»¶`;

        if (stocks.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">DCéŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œå–å¾—ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>ã‚³ãƒ¼ãƒ‰</th>
                        <th>éŠ˜æŸ„å</th>
                        <th>å¸‚å ´</th>
                        <th>æ ªä¾¡</th>
                        <th>PER</th>
                        <th>PBR</th>
                        <th>å½¢æˆæ—¥</th>
                    </tr>
                </thead>
                <tbody>
        `;

        stocks.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const market = item.market || '---';
            const price = item.stock_price !== null && item.stock_price !== undefined
                ? Number(item.stock_price).toLocaleString() + 'å††' : '---';
            const per = item.per !== null && item.per !== undefined
                ? `${Number(item.per).toFixed(1)}å€` : '---';
            const pbr = item.pbr !== null && item.pbr !== undefined
                ? `${Number(item.pbr).toFixed(2)}å€` : '---';
            const formedDate = formatScrapedDate(item.scraped_at);

            html += `
                <tr>
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td>${market}</td>
                    <td>${price}</td>
                    <td>${per}</td>
                    <td>${pbr}</td>
                    <td>${formedDate}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

</script>
{% endblock %}