{% extends "layout.html" %}

{% block title %}{% if is_admin %}管理画面 - {% endif %}Company Note{% endblock %}

{% block content %}
<style>
    /* 統一デザイン */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

    :root {
        --primary-color: #1b4332;
        --secondary-color: #2d6a4f;
        --accent-color: #2d6a4f;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --border-color: #e5e5e0;
        --bg-light: #fafaf8;
    }

    body {
        background: #f7f7f5;
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
        color: var(--text-primary);
    }

    .report-container {
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
    }

    /* ヘッダー */
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #ebebeb;
        margin-bottom: 20px;
    }

    .report-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .search-link-btn {
        padding: 8px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .search-link-btn:hover {
        background: var(--secondary-color);
        color: white;
    }

    .trend-up {
        color: #16a34a;
        font-weight: 600;
    }

    .trend-down {
        color: #dc2626;
        font-weight: 600;
    }

    tr.row-trend-up {
        background-color: rgba(22, 163, 74, 0.04) !important;
    }
    tr.row-trend-up:hover {
        background-color: rgba(22, 163, 74, 0.08) !important;
    }

    tr.row-trend-down {
        background-color: rgba(220, 38, 38, 0.04) !important;
    }
    tr.row-trend-down:hover {
        background-color: rgba(220, 38, 38, 0.08) !important;
    }

    /* ウォッチリスト一覧 */
    .watchlist-section {
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .watchlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .watchlist-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .watchlist-count {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .bulk-register-btn {
        padding: 6px 12px;
        font-size: 12px;
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .bulk-register-btn:hover {
        background-color: #059669;
    }

    /* モーダル */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 16px;
        color: #1f2937;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #9ca3af;
        cursor: pointer;
        line-height: 1;
    }

    .modal-close:hover {
        color: #4b5563;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 15px 20px;
        border-top: 1px solid #eee;
    }

    .modal-cancel-btn {
        padding: 8px 16px;
        font-size: 13px;
        background-color: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-cancel-btn:hover {
        background-color: #e5e7eb;
    }

    .modal-submit-btn {
        padding: 8px 16px;
        font-size: 13px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-submit-btn:hover {
        background-color: #2563eb;
    }

    .modal-submit-btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }

    /* テーブル親要素の横スクロール対応 */
    #watchlistContent,
    #favoriteContent,
    #dividendContent,
    #gcContent,
    #dcContent,
    #technicalContent {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .watchlist-table {
        width: 100%;
        min-width: 700px;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .watchlist-table th {
        text-align: left;
        padding: 10px 8px;
        background: var(--bg-light);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.8rem;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    .watchlist-table th.sortable {
        cursor: pointer;
        user-select: none;
    }

    .watchlist-table th.sortable:hover {
        color: var(--primary-color);
    }

    .sort-icon {
        font-size: 0.65rem;
        margin-left: 3px;
        opacity: 0.3;
    }

    .sort-icon.active {
        opacity: 1;
        color: var(--primary-color);
    }

    /* フィルター＆アクションバー */
    .filter-action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        flex-wrap: wrap;
    }

    .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
    }

    .filter-item {
        display: flex;
        align-items: center;
        gap: 2px;
        font-size: 0.78rem;
        color: var(--text-secondary);
    }

    .filter-item label {
        white-space: nowrap;
        min-width: fit-content;
    }

    .filter-item input {
        padding: 3px 6px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.78rem;
        width: 58px;
    }

    .filter-sep {
        color: #ccc;
        font-size: 0.7rem;
    }

    .filter-reset-btn {
        padding: 4px 10px;
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .filter-reset-btn:hover {
        background: var(--bg-light);
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .watchlist-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #f1f5f9;
        color: var(--text-primary);
    }

    .watchlist-table tr:hover {
        background: var(--bg-light);
    }

    .watchlist-table .company-name-cell {
        font-weight: 500;
        cursor: pointer;
        color: var(--accent-color);
    }

    .watchlist-table .company-name-cell:hover {
        text-decoration: underline;
    }

    .watchlist-table .delete-btn {
        padding: 4px 8px;
        background: transparent;
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .watchlist-table .delete-btn:hover {
        background: var(--danger-color);
        color: white;
    }

    .watchlist-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .metric-good { color: var(--success-color); }
    .metric-warning { color: var(--warning-color); }
    .metric-danger { color: var(--danger-color); }

    /* 合致度の色分け */
    .match-rate-high { color: var(--success-color); font-weight: 600; }
    .match-rate-medium { color: var(--warning-color); font-weight: 600; }
    .match-rate-low { color: var(--danger-color); font-weight: 600; }

    .match-rate-description {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: #f8fafc;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 12px;
        border-left: 3px solid var(--accent-color);
    }

    /* タブシステム */
    .watchlist-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 0;
    }

    .watchlist-tab {
        padding: 10px 20px;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .watchlist-tab:hover {
        color: var(--primary-color);
    }

    .watchlist-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        font-weight: 600;
    }

    .tab-content {
        display: none;
        padding-top: 16px;
    }

    .tab-content.active {
        display: block;
    }

    /* GC取得ボタン */
    .gc-fetch-btn {
        padding: 6px 14px;
        font-size: 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .gc-fetch-btn:hover {
        opacity: 0.85;
    }

    .gc-fetch-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* GCローディングスピナー */
    .gc-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        gap: 16px;
    }

    .gc-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid #e5e7eb;
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: gc-spin 0.8s linear infinite;
    }

    @keyframes gc-spin {
        to { transform: rotate(360deg); }
    }

    .gc-loading-text {
        font-size: 13px;
        color: #6b7280;
    }

    /* マーケット所感 */
    .market-comment-card {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 20px;
        border-left: 3px solid #1b4332;
    }
    .market-comment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .market-comment-label {
        font-size: 13px;
        font-weight: 600;
        color: #1b4332;
    }
    .market-comment-date {
        font-size: 11px;
        color: #a3a3a3;
    }
    .market-comment-body {
        font-size: 14px;
        color: #525252;
        line-height: 1.8;
        white-space: pre-wrap;
    }
    /* 管理者：所感編集 */
    .market-comment-edit {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 20px;
    }
    .market-comment-edit textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid #e5e5e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        line-height: 1.7;
        resize: vertical;
        color: #1a1a1a;
    }
    .market-comment-edit textarea:focus {
        outline: none;
        border-color: #2d6a4f;
    }
    .market-comment-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 10px;
    }
    .market-comment-actions button {
        padding: 6px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }
    .btn-comment-save {
        background: #1b4332;
        color: #fff;
    }
    .btn-comment-save:hover {
        background: #2d6a4f;
    }
    .btn-comment-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    /* 四季報アラート */
    .shikiho-alert {
        display: none;
        background: #fffbeb;
        border: 1px solid #fcd34d;
        border-left: 3px solid #f59e0b;
        border-radius: 10px;
        padding: 14px 18px;
        margin-bottom: 16px;
        font-size: 13px;
        color: #92400e;
        line-height: 1.6;
    }
    .shikiho-alert-title {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
        .report-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
    }
</style>

<div class="report-container">
    <!-- 未回答質問の通知バナー -->
    <div id="unansweredBanner" style="display:none; margin-bottom:16px;">
        <a href="/community#questions" style="display:flex; align-items:center; gap:8px; padding:10px 16px; background:#fefce8; border:1px solid #fde68a; border-radius:8px; text-decoration:none; transition:background 0.2s;"
           onmouseover="this.style.background='#fef9c3'" onmouseout="this.style.background='#fefce8'">
            <i class="fas fa-comment-dots" style="color:#ca8a04; font-size:13px;"></i>
            <span style="font-size:12px; color:#854d0e;">回答がない質問が <strong id="unansweredCount">0</strong> 件あります</span>
            <i class="fas fa-chevron-right" style="color:#ca8a04; font-size:10px; margin-left:auto;"></i>
        </a>
    </div>

    <!-- ヘッダー -->
    <div class="report-header">
        <div class="report-title">ウォッチリスト</div>
        <a href="/search" class="search-link-btn">
            <i class="fas fa-search"></i> 銘柄検索
        </a>
    </div>

    <!-- マーケット所感 -->
    {% if is_admin %}
    <div class="shikiho-alert" id="shikihoAlert">
        <div class="shikiho-alert-title">
            <i class="fas fa-book"></i>
            <span id="shikihoAlertTitle"></span>
        </div>
        <span id="shikihoAlertBody"></span>
    </div>
    <div class="market-comment-edit" id="marketCommentEdit">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <span class="market-comment-label"><i class="fas fa-pen" style="margin-right:6px; font-size:11px;"></i>マーケット所感を編集</span>
            <span class="market-comment-date" id="commentEditDate"></span>
        </div>
        <textarea id="commentEditText" placeholder="最近のマーケット動向や注目ポイントなどを書いてみましょう..."></textarea>
        <div class="market-comment-actions">
            <button class="btn-comment-save" id="commentSaveBtn" onclick="saveMarketComment()">保存する</button>
        </div>
    </div>
    {% endif %}

    <div class="market-comment-card" id="marketCommentCard" style="display:none;">
        <div class="market-comment-header">
            <span class="market-comment-label"><i class="fas fa-chart-line" style="margin-right:6px; font-size:11px;"></i>マーケット所感</span>
            <span class="market-comment-date" id="commentDisplayDate"></span>
        </div>
        <div class="market-comment-body" id="commentDisplayBody"></div>
    </div>

    <!-- ウォッチリスト一覧 -->
    <div class="watchlist-section" id="watchlistSection">
        <!-- タブナビゲーション -->
        <div class="watchlist-tabs">
            <button class="watchlist-tab" onclick="switchTab('favorite')" id="tab-favorite">
                お気に入り
            </button>
            <button class="watchlist-tab active" onclick="switchTab('watchlist')" id="tab-watchlist">
                条件合致企業
            </button>
            <button class="watchlist-tab" onclick="switchTab('dividend')" id="tab-dividend">
                高配当企業
            </button>
            <button class="watchlist-tab" onclick="switchTab('technical')" id="tab-technical">
                テクニカル分析
            </button>
            {% if is_admin %}
            <button class="watchlist-tab" onclick="switchTab('gc')" id="tab-gc">
                GC銘柄
            </button>
            <button class="watchlist-tab" onclick="switchTab('dc')" id="tab-dc">
                DC銘柄
            </button>
            {% endif %}
        </div>

        <!-- タブ1: 条件合致企業（既存ウォッチリスト） -->
        <div class="tab-content active" id="tabContent-watchlist">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
            </div>
            <div class="match-rate-description">
                「合致度」は、自己資本比率・営業利益率・ROE等の財務指標が、一般的な投資基準にどの程度合致しているかを示す参考値です。投資判断を推奨するものではありません。
            </div>
            <div class="filter-action-bar">
                <div class="filter-bar" id="filterBar">
                    <div class="filter-item">
                        <label>合致度</label>
                        <input type="number" id="filterMatchMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="filterMatchMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>時価総額(億)</label>
                        <input type="number" id="filterCapMin" placeholder="以上" step="100">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="filterCapMax" placeholder="以下" step="100">
                    </div>
                    <div class="filter-item">
                        <label>PER</label>
                        <input type="number" id="filterPerMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="filterPerMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>PBR</label>
                        <input type="number" id="filterPbrMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="filterPbrMax" placeholder="以下" step="0.1">
                    </div>
                    <div class="filter-item">
                        <label>配当</label>
                        <input type="number" id="filterDivMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="filterDivMax" placeholder="以下" step="0.1">
                    </div>
                    <button class="filter-reset-btn" onclick="resetFilters()">リセット</button>
                </div>
                <div class="action-buttons">
                    {% if is_admin %}
                    <button class="gc-fetch-btn" onclick="openDividendRegisterModal()">高配当企業登録</button>
                    <button class="gc-fetch-btn" onclick="openBulkRegisterModal()">条件合致企業登録</button>
                    <button class="gc-fetch-btn" onclick="removeAllWatchlist()" style="background-color: #dc2626;">すべて削除</button>
                    {% endif %}
                    <button class="gc-fetch-btn" onclick="analyzeWlStocks()" id="wlAnalyzeBtn">0件 詳細取得</button>
                    <button class="gc-fetch-btn" onclick="stopWlAnalyze()" id="wlStopBtn" style="background-color: #dc2626; display: none;">停止</button>
                    <button class="gc-fetch-btn" onclick="recalculateMatchRates()" id="recalcBtn" style="background-color: #6b7280;">合致度再計算</button>
                </div>
            </div>
            <div id="watchlistContent">
                <div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>
            </div>
        </div>

        <!-- タブ: お気に入り -->
        <div class="tab-content" id="tabContent-favorite">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
            </div>
            <div class="match-rate-description">
                お気に入りに追加した銘柄を一覧表示しています。銘柄詳細ページの★ボタンから追加できます。
            </div>
            <div class="filter-action-bar">
                <div class="filter-bar" id="favFilterBar">
                    <div class="filter-item">
                        <label>合致度</label>
                        <input type="number" id="favFilterMatchMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="favFilterMatchMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>時価総額(億)</label>
                        <input type="number" id="favFilterCapMin" placeholder="以上" step="100">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="favFilterCapMax" placeholder="以下" step="100">
                    </div>
                    <div class="filter-item">
                        <label>PER</label>
                        <input type="number" id="favFilterPerMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="favFilterPerMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>PBR</label>
                        <input type="number" id="favFilterPbrMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="favFilterPbrMax" placeholder="以下" step="0.1">
                    </div>
                    <div class="filter-item">
                        <label>配当</label>
                        <input type="number" id="favFilterDivMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="favFilterDivMax" placeholder="以下" step="0.1">
                    </div>
                    <button class="filter-reset-btn" onclick="resetFavFilters()">リセット</button>
                </div>
            </div>
            <div id="favoriteContent">
                <div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>
            </div>
        </div>

        <!-- タブ: 高配当企業 -->
        <div class="tab-content" id="tabContent-dividend">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
            </div>
            <div class="match-rate-description">
                配当利回りの高い企業を一覧表示しています。
            </div>
            <div class="filter-action-bar">
                <div class="filter-bar" id="divFilterBar">
                    <div class="filter-item">
                        <label>合致度</label>
                        <input type="number" id="divFilterMatchMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="divFilterMatchMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>時価総額(億)</label>
                        <input type="number" id="divFilterCapMin" placeholder="以上" step="100">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="divFilterCapMax" placeholder="以下" step="100">
                    </div>
                    <div class="filter-item">
                        <label>PER</label>
                        <input type="number" id="divFilterPerMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="divFilterPerMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>PBR</label>
                        <input type="number" id="divFilterPbrMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="divFilterPbrMax" placeholder="以下" step="0.1">
                    </div>
                    <div class="filter-item">
                        <label>配当</label>
                        <input type="number" id="divFilterDivMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="divFilterDivMax" placeholder="以下" step="0.1">
                    </div>
                    <button class="filter-reset-btn" onclick="resetDivFilters()">リセット</button>
                </div>
                <div class="action-buttons">
                    <button class="gc-fetch-btn" onclick="analyzeDivStocks()" id="divAnalyzeBtn">0件 詳細取得</button>
                    <button class="gc-fetch-btn" onclick="stopDivAnalyze()" id="divStopBtn" style="background-color: #dc2626; display: none;">停止</button>
                </div>
            </div>
            <div id="dividendContent">
                <div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>
            </div>
        </div>

        {% if is_admin %}
        <!-- タブ2: GC達成銘柄 -->
        <div class="tab-content" id="tabContent-gc">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="gc-fetch-btn" onclick="fetchGcStocks()" id="gcFetchBtn">取得</button>
                    <button class="gc-fetch-btn" onclick="analyzeGcStocks()" id="gcAnalyzeBtn" style="background-color: var(--secondary-color);">詳細取得</button>
                    <button class="gc-fetch-btn" onclick="stopGcAnalyze()" id="gcStopBtn" style="background-color: #dc2626; display: none;">停止</button>
                    <span class="watchlist-count" id="gcCount">0件</span>
                </div>
            </div>
            <div class="match-rate-description">
                kabutan.jpのゴールデンクロス（5日線が25日線を上抜け）銘柄から、PER40倍未満・PBR10倍未満を抽出しています。
            </div>
            <div id="gcContent">
                <div class="watchlist-empty">「取得」ボタンを押してGC銘柄を取得してください</div>
            </div>
        </div>

        <!-- タブ3: DC銘柄 -->
        <div class="tab-content" id="tabContent-dc">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="gc-fetch-btn" onclick="fetchDcStocks()" id="dcFetchBtn">取得</button>
                    <span class="watchlist-count" id="dcCount">0件</span>
                </div>
            </div>
            <div class="match-rate-description">
                kabutan.jpのデッドクロス（5日線が25日線を下抜け）銘柄の一覧です。フィルタなしで全件表示しています。
            </div>
            <div id="dcContent">
                <div class="watchlist-empty">「取得」ボタンを押してDC銘柄を取得してください</div>
            </div>
        </div>
        {% endif %}

        <!-- タブ4: テクニカル分析 -->
        <div class="tab-content" id="tabContent-technical">
            <div class="watchlist-header">
                <span class="watchlist-title"></span>
            </div>
            <div class="match-rate-description">
                過去にゴールデンクロス（GC）またはデッドクロス（DC）が検出された銘柄の一覧です。screened_latestに永続保存された日付を表示しています。
            </div>
            <div class="filter-action-bar">
                <div class="filter-bar" id="techFilterBar">
                    <div class="filter-item">
                        <label>合致度</label>
                        <input type="number" id="techFilterMatchMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="techFilterMatchMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>時価総額(億)</label>
                        <input type="number" id="techFilterCapMin" placeholder="以上" step="100">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="techFilterCapMax" placeholder="以下" step="100">
                    </div>
                    <div class="filter-item">
                        <label>PER</label>
                        <input type="number" id="techFilterPerMin" placeholder="以上" step="1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="techFilterPerMax" placeholder="以下" step="1">
                    </div>
                    <div class="filter-item">
                        <label>PBR</label>
                        <input type="number" id="techFilterPbrMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="techFilterPbrMax" placeholder="以下" step="0.1">
                    </div>
                    <div class="filter-item">
                        <label>配当</label>
                        <input type="number" id="techFilterDivMin" placeholder="以上" step="0.1">
                        <span class="filter-sep">〜</span>
                        <input type="number" id="techFilterDivMax" placeholder="以下" step="0.1">
                    </div>
                    <div class="filter-item">
                        <label>方向</label>
                        <select id="techFilterTrend" style="padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="">すべて</option>
                            <option value="gc">GC（上昇）</option>
                            <option value="dc">DC（下降）</option>
                        </select>
                    </div>
                    <button class="filter-reset-btn" onclick="resetTechFilters()">リセット</button>
                </div>
                <div class="action-buttons">
                    <button class="gc-fetch-btn" onclick="analyzeTechStocks()" id="techAnalyzeBtn">0件 詳細取得</button>
                    <button class="gc-fetch-btn" onclick="stopTechAnalyze()" id="techStopBtn" style="background-color: #dc2626; display: none;">停止</button>
                </div>
            </div>
            <div id="technicalContent">
                <div class="watchlist-empty">タブを開くとデータを読み込みます</div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- 高配当企業登録モーダル -->
    <div class="modal-overlay" id="dividendRegisterModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>高配当企業登録</h3>
                <button class="modal-close" onclick="closeDividendRegisterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px; color: #666; font-size: 13px;">
                    銘柄コードをカンマ区切りまたは改行で入力してください
                </p>
                <textarea id="dividendCodesInput" placeholder="例: 8316, 8411, 2914&#10;または&#10;8316&#10;8411&#10;2914" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
                <div id="dividendRegisterStatus" style="margin-top: 10px; font-size: 13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-cancel-btn" onclick="closeDividendRegisterModal()">キャンセル</button>
                <button class="modal-submit-btn" onclick="submitDividendRegister()">登録</button>
            </div>
        </div>
    </div>

    <!-- 一括登録モーダル -->
    <div class="modal-overlay" id="bulkRegisterModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>条件合致企業登録</h3>
                <button class="modal-close" onclick="closeBulkRegisterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px; color: #666; font-size: 13px;">
                    銘柄コードをカンマ区切りまたは改行で入力してください
                </p>
                <textarea id="bulkCodesInput" placeholder="例: 7203, 6758, 9984&#10;または&#10;7203&#10;6758&#10;9984" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
                <div id="bulkRegisterStatus" style="margin-top: 10px; font-size: 13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-cancel-btn" onclick="closeBulkRegisterModal()">キャンセル</button>
                <button class="modal-submit-btn" onclick="submitBulkRegister()">登録</button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // 管理者モードフラグ
    const IS_ADMIN = {{ 'true' if is_admin else 'false' }};

    // タブ即時復元（フラッシュ防止）
    (function() {
        const saved = sessionStorage.getItem('activeTab');
        if (saved && saved !== 'watchlist') {
            const tab = document.getElementById(`tab-${saved}`);
            const content = document.getElementById(`tabContent-${saved}`);
            // タブが存在しない場合（非admin時のGC/DC等）はwatchlistに戻す
            if (!tab || !content) {
                sessionStorage.setItem('activeTab', 'watchlist');
                return;
            }
            document.querySelectorAll('.watchlist-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab) tab.classList.add('active');
            if (content) content.classList.add('active');
        }
    })();

    // ========================================
    // ウォッチリスト関連機能
    // ========================================

    // ========================================
    // 四季報発売日アラート（管理者のみ）
    // ========================================
    function checkShikihoAlert() {
        if (!IS_ADMIN) return;
        var el = document.getElementById('shikihoAlert');
        if (!el) return;

        // 四季報の発売日（毎年おおよそ固定、年ごとに微調整可能）
        // [月, 日] の形式。号名も付与
        var schedule = [
            { month: 3, day: 17, name: '春号' },
            { month: 6, day: 16, name: '夏号' },
            { month: 9, day: 16, name: '秋号' },
            { month: 12, day: 15, name: '新春号' },
        ];

        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var alertDaysBefore = 2;
        var alertDaysAfter = 1;  // 発売当日も表示

        for (var i = 0; i < schedule.length; i++) {
            var s = schedule[i];
            var releaseDate = new Date(today.getFullYear(), s.month - 1, s.day);
            releaseDate.setHours(0, 0, 0, 0);
            var diff = (releaseDate - today) / (1000 * 60 * 60 * 24);

            if (diff >= -alertDaysAfter && diff <= alertDaysBefore) {
                var titleEl = document.getElementById('shikihoAlertTitle');
                var bodyEl = document.getElementById('shikihoAlertBody');
                var dateStr = s.month + '/' + s.day;

                if (diff > 0) {
                    titleEl.textContent = '四季報' + s.name + '発売まであと' + Math.ceil(diff) + '日（' + dateStr + '）';
                    bodyEl.textContent = '条件合致企業の銘柄データを更新してください。新しい四季報データの反映をお忘れなく。';
                } else if (diff === 0) {
                    titleEl.textContent = '本日 四季報' + s.name + '発売日です（' + dateStr + '）';
                    bodyEl.textContent = '条件合致企業の銘柄データを更新してください。';
                } else {
                    titleEl.textContent = '四季報' + s.name + 'が発売されました（' + dateStr + '）';
                    bodyEl.textContent = '条件合致企業の銘柄データの更新はお済みですか？';
                }
                el.style.display = '';
                break;
            }
        }
    }

    // ========================================
    // マーケット所感
    // ========================================
    async function loadMarketComment() {
        try {
            const res = await fetch('/api/market-comment/latest');
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.content) {
                // 閲覧用カードに表示
                const card = document.getElementById('marketCommentCard');
                const body = document.getElementById('commentDisplayBody');
                const date = document.getElementById('commentDisplayDate');
                if (body) body.textContent = data.content;
                if (date) {
                    const d = new Date(data.updated_at || data.created_at);
                    date.textContent = d.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                }
                if (card) card.style.display = '';

                // 管理者：編集エリアにも反映
                const editText = document.getElementById('commentEditText');
                const editDate = document.getElementById('commentEditDate');
                if (editText) editText.value = data.content;
                if (editDate && data.updated_at) {
                    const d2 = new Date(data.updated_at);
                    editDate.textContent = '最終更新: ' + d2.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
        } catch (e) {
            console.error('マーケット所感取得エラー:', e);
        }
    }

    async function saveMarketComment() {
        const textarea = document.getElementById('commentEditText');
        const btn = document.getElementById('commentSaveBtn');
        const content = textarea ? textarea.value.trim() : '';
        if (!content) return;

        btn.disabled = true;
        btn.textContent = '保存中...';
        try {
            const res = await fetch('/api/market-comment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // 表示を更新
                await loadMarketComment();
                btn.textContent = '保存しました';
                setTimeout(() => { btn.textContent = '保存する'; btn.disabled = false; }, 1500);
            } else {
                alert('保存できませんでした。しばらくしてからもう一度お試しください。');
                btn.textContent = '保存する';
                btn.disabled = false;
            }
        } catch (e) {
            alert('接続がうまくいきませんでした。ページを再読み込みしてお試しください。');
            btn.textContent = '保存する';
            btn.disabled = false;
        }
    }

    // ページ読み込み時にデータ取得＆遅延ロード
    document.addEventListener('DOMContentLoaded', function() {
        checkShikihoAlert();
        loadMarketComment();
        loadWatchlist();
        const savedTab = sessionStorage.getItem('activeTab');
        if (savedTab === 'favorite') loadFavoriteStocks();
        if (savedTab === 'dividend') loadDividendStocks();
        if (savedTab === 'gc') loadGcStocks();
        if (savedTab === 'dc') loadDcStocks();
        if (savedTab === 'technical') loadTechnicalStocks();
    });

    // ウォッチリストを読み込んで表示
    async function loadWatchlist() {
        // キャッシュがあれば先に表示（ローディング回避）
        const cached = sessionStorage.getItem('watchlistCache');
        if (cached) {
            try {
                renderWatchlist(JSON.parse(cached));
            } catch(e) {}
        } else {
            document.getElementById('watchlistContent').innerHTML =
                '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>';
        }

        // バックグラウンドで最新データを取得
        try {
            const response = await fetch('/api/watchlist');
            const data = await response.json();

            if (response.ok) {
                const list = data.watchlist || [];
                sessionStorage.setItem('watchlistCache', JSON.stringify(list));
                renderWatchlist(list);
            } else {
                if (!cached) {
                    document.getElementById('watchlistContent').innerHTML =
                        '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
                }
            }
        } catch (error) {
            if (!cached) {
                document.getElementById('watchlistContent').innerHTML =
                    '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
            }
        }
    }

    // ウォッチリストデータをキャッシュ
    let watchlistCache = [];

    // ウォッチリストを描画
    // ソート状態
    let currentSort = { key: null, asc: true };

    function renderWatchlist(watchlist) {
        watchlistCache = watchlist;
        applyFilterAndSort();
    }

    function applyFilterAndSort() {
        let list = [...watchlistCache];

        // フィルタリング
        const matchMin = parseFloat(document.getElementById('filterMatchMin')?.value);
        const matchMax = parseFloat(document.getElementById('filterMatchMax')?.value);
        const capMin = parseFloat(document.getElementById('filterCapMin')?.value);
        const capMax = parseFloat(document.getElementById('filterCapMax')?.value);
        const perMin = parseFloat(document.getElementById('filterPerMin')?.value);
        const perMax = parseFloat(document.getElementById('filterPerMax')?.value);
        const pbrMin = parseFloat(document.getElementById('filterPbrMin')?.value);
        const pbrMax = parseFloat(document.getElementById('filterPbrMax')?.value);
        const divMin = parseFloat(document.getElementById('filterDivMin')?.value);
        const divMax = parseFloat(document.getElementById('filterDivMax')?.value);

        if (!isNaN(matchMin)) list = list.filter(i => i.match_rate != null && i.match_rate >= matchMin);
        if (!isNaN(matchMax)) list = list.filter(i => i.match_rate != null && i.match_rate <= matchMax);
        if (!isNaN(capMin)) list = list.filter(i => i.market_cap != null && i.market_cap >= capMin);
        if (!isNaN(capMax)) list = list.filter(i => i.market_cap != null && i.market_cap <= capMax);
        if (!isNaN(perMin)) list = list.filter(i => i.per_forward != null && i.per_forward >= perMin);
        if (!isNaN(perMax)) list = list.filter(i => i.per_forward != null && i.per_forward <= perMax);
        if (!isNaN(pbrMin)) list = list.filter(i => i.pbr != null && i.pbr >= pbrMin);
        if (!isNaN(pbrMax)) list = list.filter(i => i.pbr != null && i.pbr <= pbrMax);
        if (!isNaN(divMin)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield >= divMin);
        if (!isNaN(divMax)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield <= divMax);

        // ソート
        if (currentSort.key) {
            list.sort((a, b) => {
                let va = a[currentSort.key], vb = b[currentSort.key];
                if (va == null && vb == null) return 0;
                if (va == null) return 1;
                if (vb == null) return -1;
                if (typeof va === 'string') return currentSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return currentSort.asc ? va - vb : vb - va;
            });
        }

        const content = document.getElementById('watchlistContent');
        const wlBtn = document.getElementById('wlAnalyzeBtn');

        const totalCount = watchlistCache.length;
        const filteredCount = list.length;
        const countLabel = totalCount === filteredCount ? `${totalCount}` : `${filteredCount}/${totalCount}`;
        wlBtn.textContent = `${countLabel}件 詳細取得`;

        if (watchlistCache.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">登録銘柄がありません。<a href="/search">銘柄検索</a>から登録してください。</div>';
            return;
        }

        if (list.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">条件に一致する銘柄がありません</div>';
            return;
        }

        const sortIcon = (key) => {
            if (currentSort.key !== key) return '<span class="sort-icon">▲▼</span>';
            return currentSort.asc
                ? '<span class="sort-icon active">▲</span>'
                : '<span class="sort-icon active">▼</span>';
        };

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortWatchlist('company_code')">コード${sortIcon('company_code')}</th>
                        <th class="sortable" onclick="sortWatchlist('company_name')">会社名${sortIcon('company_name')}</th>
                        <th class="sortable" onclick="sortWatchlist('match_rate')">合致度${sortIcon('match_rate')}</th>
                        <th>セクター</th>
                        <th class="sortable" onclick="sortWatchlist('market_cap')">時価総額${sortIcon('market_cap')}</th>
                        <th class="sortable" onclick="sortWatchlist('stock_price')">株価${sortIcon('stock_price')}</th>
                        <th class="sortable" onclick="sortWatchlist('per_forward')">PER${sortIcon('per_forward')}</th>
                        <th class="sortable" onclick="sortWatchlist('pbr')">PBR${sortIcon('pbr')}</th>
                        <th class="sortable" onclick="sortWatchlist('dividend_yield')">配当利回り${sortIcon('dividend_yield')}</th>
                        <th class="sortable" onclick="sortWatchlist('payout_ratio')">配当性向${sortIcon('payout_ratio')}</th>
                        <th>GC</th>
                        <th>DC</th>
                        <th>方向</th>
                        ${IS_ADMIN ? '<th>操作</th>' : ''}
                    </tr>
                </thead>
                <tbody>
        `;

        list.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const sector = item.sector || '---';
            const marketCap = item.market_cap ? formatMarketCapOku(item.market_cap) : '---';
            const price = item.stock_price ? formatWatchlistPrice(item.stock_price) : '---';
            const per = item.per_forward ? `${item.per_forward.toFixed(1)}倍` : '---';
            const pbr = item.pbr ? `${item.pbr.toFixed(2)}倍` : '---';
            const divYield = item.dividend_yield ? `${item.dividend_yield.toFixed(2)}%` : '---';
            const payoutRatio = item.payout_ratio != null ? `${Number(item.payout_ratio).toFixed(1)}%` : '---';
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}` : '---';
            const matchRateClass = getMatchRateClass(item.match_rate);
            const gcDate = formatScrapedDate(item.gc_date);
            const dcDate = formatScrapedDate(item.dc_date);
            const trend = getTrendDirection(item.gc_date, item.dc_date);

            html += `
                <tr class="${trend.cls ? 'row-' + trend.cls : ''}">
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td class="${matchRateClass}">${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per_forward, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td>${divYield}</td>
                    <td>${payoutRatio}</td>
                    <td>${gcDate}</td>
                    <td>${dcDate}</td>
                    <td class="${trend.cls}">${trend.label}</td>
                    ${IS_ADMIN ? `<td><button class="delete-btn" onclick="removeFromWatchlist('${code}')">削除</button></td>` : ''}
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    function sortWatchlist(key) {
        if (currentSort.key === key) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.key = key;
            currentSort.asc = true;
        }
        applyFilterAndSort();
    }

    const filterIds = ['filterMatchMin','filterMatchMax','filterCapMin','filterCapMax',
        'filterPerMin','filterPerMax','filterPbrMin','filterPbrMax','filterDivMin','filterDivMax'];

    function resetFilters() {
        filterIds.forEach(id => { document.getElementById(id).value = ''; });
        currentSort = { key: null, asc: true };
        applyFilterAndSort();
    }

    // フィルター入力時にリアルタイム反映
    document.addEventListener('DOMContentLoaded', function() {
        filterIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', applyFilterAndSort);
        });
    });

    // 時価総額フォーマット（億円単位入力 → 兆/億表示）
    function formatMarketCapOku(oku) {
        if (oku === null || oku === undefined) return '---';
        if (oku >= 10000) return `${(oku / 10000).toFixed(1)}兆`;
        return `${Math.round(oku)}億`;
    }

    // 株価フォーマット
    function formatWatchlistPrice(num) {
        if (num === null || num === undefined) return '---';
        return `¥${Math.round(num).toLocaleString()}`;
    }

    // 指標の色分けクラスを取得
    function getMetricClass(value, goodThreshold, warningThreshold) {
        if (value === null || value === undefined) return '';
        if (value <= goodThreshold) return 'metric-good';
        if (value <= warningThreshold) return 'metric-warning';
        return 'metric-danger';
    }

    // 合致度の色分けクラスを取得
    function getMatchRateClass(value) {
        if (value === null || value === undefined) return '';
        if (value >= 58) return 'match-rate-high';
        if (value >= 33) return 'match-rate-medium';
        return 'match-rate-low';
    }

    // ウォッチリストから削除
    async function removeFromWatchlist(code) {
        if (!confirm(`${code} を登録リストから削除しますか？`)) return;

        try {
            const response = await fetch(`/api/watchlist/remove/${code}`, { method: 'DELETE' });
            const data = await response.json();

            if (response.ok) {
                loadWatchlist();
            } else {
                showErrorModal('削除できませんでした。しばらくしてからもう一度お試しください。');
            }
        } catch (error) {
            showErrorModal('接続がうまくいきませんでした。ページを再読み込みしてお試しください。');
        }
    }

    // ========================================
    // ウォッチリスト一括分析機能
    // ========================================

    let wlAnalyzePolling = null;

    function getWlBtnLabel() {
        return `${watchlistCache.length}件 詳細取得`;
    }

    async function analyzeWlStocks(force = false) {
        const btn = document.getElementById('wlAnalyzeBtn');
        const stopBtn = document.getElementById('wlStopBtn');
        btn.disabled = true;
        stopBtn.style.display = 'inline-block';

        try {
            const response = await fetch('/api/watchlist/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ force })
            });
            const data = await response.json();

            if (response.ok) {
                if (data.status && data.status.total === 0) {
                    btn.disabled = false;
                    btn.textContent = getWlBtnLabel();
                    stopBtn.style.display = 'none';
                    if (!force) {
                        const ok = await showConfirmModal('本日解析済ですが再度解析しますか？');
                        if (ok) analyzeWlStocks(true);
                    }
                } else {
                    startWlAnalyzePolling();
                }
            } else {
                if (data.status && data.status.running) {
                    startWlAnalyzePolling();
                } else {
                    showErrorModal('データを取得できませんでした。\nしばらくしてからもう一度お試しください。');
                    btn.disabled = false;
                    btn.textContent = getWlBtnLabel();
                    stopBtn.style.display = 'none';
                }
            }
        } catch (error) {
            showErrorModal('接続がうまくいきませんでした。\nページを再読み込みしてお試しください。');
            btn.disabled = false;
            btn.textContent = getWlBtnLabel();
            stopBtn.style.display = 'none';
        }
    }

    async function stopWlAnalyze() {
        try {
            await fetch('/api/watchlist/analyze/stop', { method: 'POST' });
            document.getElementById('wlStopBtn').disabled = true;
            document.getElementById('wlStopBtn').textContent = '停止中...';
        } catch (e) {
            console.error('停止リクエスト失敗:', e);
        }
    }

    async function recalculateMatchRates() {
        const btn = document.getElementById('recalcBtn');
        btn.disabled = true;
        btn.textContent = '再計算中...';

        try {
            const response = await fetch('/api/watchlist/recalculate', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                showSuccessModal(data.message);
                loadWatchlist();
            } else {
                showErrorModal('再計算できませんでした。しばらくしてからもう一度お試しください。');
            }
        } catch (e) {
            showErrorModal('接続がうまくいきませんでした。ページを再読み込みしてお試しください。');
        }

        btn.disabled = false;
        btn.textContent = '合致度再計算';
    }

    function finishWlAnalyzeUI() {
        const btn = document.getElementById('wlAnalyzeBtn');
        const stopBtn = document.getElementById('wlStopBtn');
        btn.disabled = false;
        btn.textContent = getWlBtnLabel();
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = '停止';
    }

    function startWlAnalyzePolling() {
        if (wlAnalyzePolling) clearInterval(wlAnalyzePolling);

        wlAnalyzePolling = setInterval(async () => {
            try {
                const statusRes = await fetch('/api/watchlist/analyze/status');
                const status = await statusRes.json();

                document.getElementById('wlAnalyzeBtn').textContent = `分析中 ${status.done}/${status.total}`;

                loadWatchlist();

                if (!status.running) {
                    clearInterval(wlAnalyzePolling);
                    wlAnalyzePolling = null;
                    finishWlAnalyzeUI();
                }
            } catch (e) {
                clearInterval(wlAnalyzePolling);
                wlAnalyzePolling = null;
                finishWlAnalyzeUI();
            }
        }, 3000);
    }

    // ========================================
    // ウォッチリスト全件削除
    // ========================================

    async function removeAllWatchlist() {
        if (!confirm('ウォッチリストの全銘柄を削除しますか？')) return;

        try {
            const response = await fetch('/api/watchlist/remove-all', { method: 'DELETE' });
            if (response.ok) {
                loadWatchlist();
            } else {
                const data = await response.json();
                showErrorModal('削除できませんでした。しばらくしてからもう一度お試しください。');
            }
        } catch (error) {
            showErrorModal('接続がうまくいきませんでした。ページを再読み込みしてお試しください。');
        }
    }

    // ========================================
    // 高配当企業登録機能
    // ========================================

    function openDividendRegisterModal() {
        document.getElementById('dividendRegisterModal').style.display = 'flex';
        document.getElementById('dividendCodesInput').value = '';
        document.getElementById('dividendRegisterStatus').innerHTML = '';
    }

    function closeDividendRegisterModal() {
        document.getElementById('dividendRegisterModal').style.display = 'none';
    }

    document.getElementById('dividendRegisterModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeDividendRegisterModal();
    });

    async function submitDividendRegister() {
        const input = document.getElementById('dividendCodesInput').value.trim();
        const statusDiv = document.getElementById('dividendRegisterStatus');
        const submitBtn = document.querySelector('#dividendRegisterModal .modal-submit-btn');

        if (!input) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">銘柄コードを入力してください</span>';
            return;
        }

        const codes = input.split(/[,\n\s]+/).map(code => code.trim().replace('.T', '')).filter(code => code && /^\d{3,4}[A-Z]?$/.test(code));

        if (codes.length === 0) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">有効な銘柄コード（3〜4桁の数字+英字）が見つかりません</span>';
            return;
        }

        const uniqueCodes = [...new Set(codes)];

        submitBtn.disabled = true;
        submitBtn.textContent = '登録中...';
        statusDiv.innerHTML = `<span style="color: #3b82f6;">登録中... (0/${uniqueCodes.length})</span>`;

        let successCount = 0;
        let failedCodes = [];

        for (let i = 0; i < uniqueCodes.length; i++) {
            const code = uniqueCodes[i] + '.T';
            try {
                const response = await fetch('/api/dividend-stocks/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company_code: code })
                });
                if (response.ok) { successCount++; } else { failedCodes.push(uniqueCodes[i]); }
            } catch (error) { failedCodes.push(uniqueCodes[i]); }
            statusDiv.innerHTML = `<span style="color: #3b82f6;">登録中... (${i + 1}/${uniqueCodes.length})</span>`;
        }

        submitBtn.disabled = false;
        submitBtn.textContent = '登録';

        let resultMsg = `<span style="color: #16a34a;">${successCount}件を登録しました</span>`;
        if (failedCodes.length > 0) {
            resultMsg += `<br><span style="color: #dc2626;">失敗: ${failedCodes.join(', ')}</span>`;
        }
        statusDiv.innerHTML = resultMsg;

        if (successCount > 0) {
            dividendLoaded = false;
            loadDividendStocks();
        }
    }

    // ========================================
    // 条件合致企業登録機能（一括登録）
    // ========================================

    function openBulkRegisterModal() {
        document.getElementById('bulkRegisterModal').style.display = 'flex';
        document.getElementById('bulkCodesInput').value = '';
        document.getElementById('bulkRegisterStatus').innerHTML = '';
    }

    function closeBulkRegisterModal() {
        document.getElementById('bulkRegisterModal').style.display = 'none';
    }

    document.getElementById('bulkRegisterModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeBulkRegisterModal();
    });

    async function submitBulkRegister() {
        const input = document.getElementById('bulkCodesInput').value.trim();
        const statusDiv = document.getElementById('bulkRegisterStatus');
        const submitBtn = document.querySelector('.modal-submit-btn');

        if (!input) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">銘柄コードを入力してください</span>';
            return;
        }

        const codes = input.split(/[,\n\s]+/).map(code => code.trim().replace('.T', '')).filter(code => code && /^\d{3,4}[A-Z]?$/.test(code));

        if (codes.length === 0) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">有効な銘柄コード（3〜4桁の数字+英字）が見つかりません</span>';
            return;
        }

        const uniqueCodes = [...new Set(codes)];

        submitBtn.disabled = true;
        submitBtn.textContent = '登録中...';
        statusDiv.innerHTML = `<span style="color: #3b82f6;">登録中... (0/${uniqueCodes.length})</span>`;

        let successCount = 0;
        let failedCodes = [];

        for (let i = 0; i < uniqueCodes.length; i++) {
            const code = uniqueCodes[i] + '.T';
            try {
                const response = await fetch('/api/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company_code: code })
                });
                if (response.ok) { successCount++; } else { failedCodes.push(uniqueCodes[i]); }
            } catch (error) { failedCodes.push(uniqueCodes[i]); }
            statusDiv.innerHTML = `<span style="color: #3b82f6;">登録中... (${i + 1}/${uniqueCodes.length})</span>`;
        }

        submitBtn.disabled = false;
        submitBtn.textContent = '登録';

        if (failedCodes.length === 0) {
            statusDiv.innerHTML = `<span style="color: #10b981;">${successCount}件の銘柄を登録しました</span>`;
        } else {
            statusDiv.innerHTML = `<span style="color: #f59e0b;">${successCount}件登録、${failedCodes.length}件失敗 (${failedCodes.join(', ')})</span>`;
        }

        loadWatchlist();
        setTimeout(() => { closeBulkRegisterModal(); }, 2000);
    }

    // ========================================
    // タブ切り替え機能
    // ========================================

    function switchTab(tabName) {
        document.querySelectorAll('.watchlist-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tabContent-${tabName}`).classList.add('active');

        sessionStorage.setItem('activeTab', tabName);

        if (tabName === 'favorite' && !favoriteLoaded) loadFavoriteStocks();
        if (tabName === 'dividend' && !dividendLoaded) loadDividendStocks();
        if (tabName === 'gc' && gcStocksCache.length === 0) loadGcStocks();
        if (tabName === 'dc' && dcStocksCache.length === 0) loadDcStocks();
        if (tabName === 'technical' && technicalStocksCache.length === 0) loadTechnicalStocks();
    }

    // ========================================
    // お気に入り銘柄
    // ========================================

    let favoriteLoaded = false;
    let favoriteCache = [];
    let favSort = { key: 'match_rate', dir: 'desc' };

    async function loadFavoriteStocks() {
        favoriteLoaded = true;
        const content = document.getElementById('favoriteContent');
        content.innerHTML = '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>';

        try {
            const response = await fetch('/api/favorite-stocks');
            const data = await response.json();
            if (response.ok) {
                favoriteCache = data.favorite_stocks || [];
                applyFavFilters();
            } else {
                content.innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
            }
        } catch (error) {
            content.innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
        }
    }

    // フィルタ入力イベント
    document.getElementById('favFilterBar')?.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => applyFavFilters());
    });

    function applyFavFilters() {
        let list = [...favoriteCache];

        const matchMin = parseFloat(document.getElementById('favFilterMatchMin')?.value);
        const matchMax = parseFloat(document.getElementById('favFilterMatchMax')?.value);
        const capMin = parseFloat(document.getElementById('favFilterCapMin')?.value);
        const capMax = parseFloat(document.getElementById('favFilterCapMax')?.value);
        const perMin = parseFloat(document.getElementById('favFilterPerMin')?.value);
        const perMax = parseFloat(document.getElementById('favFilterPerMax')?.value);
        const pbrMin = parseFloat(document.getElementById('favFilterPbrMin')?.value);
        const pbrMax = parseFloat(document.getElementById('favFilterPbrMax')?.value);
        const divMin = parseFloat(document.getElementById('favFilterDivMin')?.value);
        const divMax = parseFloat(document.getElementById('favFilterDivMax')?.value);

        if (!isNaN(matchMin)) list = list.filter(i => i.match_rate != null && i.match_rate >= matchMin);
        if (!isNaN(matchMax)) list = list.filter(i => i.match_rate != null && i.match_rate <= matchMax);
        if (!isNaN(capMin)) list = list.filter(i => i.market_cap != null && i.market_cap >= capMin);
        if (!isNaN(capMax)) list = list.filter(i => i.market_cap != null && i.market_cap <= capMax);
        if (!isNaN(perMin)) list = list.filter(i => i.per_forward != null && i.per_forward >= perMin);
        if (!isNaN(perMax)) list = list.filter(i => i.per_forward != null && i.per_forward <= perMax);
        if (!isNaN(pbrMin)) list = list.filter(i => i.pbr != null && i.pbr >= pbrMin);
        if (!isNaN(pbrMax)) list = list.filter(i => i.pbr != null && i.pbr <= pbrMax);
        if (!isNaN(divMin)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield >= divMin);
        if (!isNaN(divMax)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield <= divMax);

        // ソート
        if (favSort.key) {
            list.sort((a, b) => {
                const aVal = a[favSort.key] || 0;
                const bVal = b[favSort.key] || 0;
                return favSort.dir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        renderFavoriteStocks(list);
    }

    function resetFavFilters() {
        document.getElementById('favFilterBar')?.querySelectorAll('input').forEach(input => input.value = '');
        applyFavFilters();
    }

    function sortFavColumn(key) {
        if (favSort.key === key) {
            favSort.dir = favSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            favSort.key = key;
            favSort.dir = key === 'match_rate' ? 'desc' : 'asc';
        }
        applyFavFilters();
    }

    function favSortIcon(key) {
        if (favSort.key !== key) return '<i class="fas fa-sort" style="color:#999;font-size:10px;margin-left:3px;"></i>';
        return favSort.dir === 'asc'
            ? '<i class="fas fa-sort-up" style="color:#2d6a4f;font-size:10px;margin-left:3px;"></i>'
            : '<i class="fas fa-sort-down" style="color:#2d6a4f;font-size:10px;margin-left:3px;"></i>';
    }

    function renderFavoriteStocks(list) {
        const content = document.getElementById('favoriteContent');

        if (list.length === 0 && favoriteCache.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">お気に入り銘柄がありません。銘柄詳細ページの★ボタンから追加してください。</div>';
            return;
        }
        if (list.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">条件に一致する企業がありません</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>コード</th>
                        <th>会社名</th>
                        <th class="sortable" onclick="sortFavColumn('match_rate')">合致度${favSortIcon('match_rate')}</th>
                        <th>セクター</th>
                        <th class="sortable" onclick="sortFavColumn('market_cap')">時価総額${favSortIcon('market_cap')}</th>
                        <th class="sortable" onclick="sortFavColumn('stock_price')">株価${favSortIcon('stock_price')}</th>
                        <th class="sortable" onclick="sortFavColumn('per_forward')">PER${favSortIcon('per_forward')}</th>
                        <th class="sortable" onclick="sortFavColumn('pbr')">PBR${favSortIcon('pbr')}</th>
                        <th class="sortable" onclick="sortFavColumn('dividend_yield')">配当利回り${favSortIcon('dividend_yield')}</th>
                        <th class="sortable" onclick="sortFavColumn('payout_ratio')">配当性向${favSortIcon('payout_ratio')}</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;

        list.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const sector = item.sector || '---';
            const marketCap = item.market_cap ? formatMarketCapOku(item.market_cap) : '---';
            const price = item.stock_price ? formatWatchlistPrice(item.stock_price) : '---';
            const per = item.per_forward ? `${Number(item.per_forward).toFixed(1)}倍` : '---';
            const pbr = item.pbr ? `${Number(item.pbr).toFixed(2)}倍` : '---';
            const divYield = item.dividend_yield ? `${Number(item.dividend_yield).toFixed(2)}%` : '---';
            const payoutRatio = item.payout_ratio != null ? `${Number(item.payout_ratio).toFixed(1)}%` : '---';
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}` : '---';
            const matchRateClass = getMatchRateClass(item.match_rate);

            html += `
                <tr>
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td class="${matchRateClass}">${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per_forward, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td>${divYield}</td>
                    <td>${payoutRatio}</td>
                    <td><button class="delete-btn" onclick="removeFavoriteStock('${code}')">解除</button></td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    async function removeFavoriteStock(code) {
        if (!confirm('この企業をお気に入りから解除しますか？')) return;
        try {
            const response = await fetch(`/api/favorite-stocks/remove/${code}`, { method: 'DELETE' });
            if (response.ok) {
                favoriteCache = favoriteCache.filter(item => item.company_code !== code);
                applyFavFilters();
            } else {
                alert('解除できませんでした。しばらくしてからもう一度お試しください。');
            }
        } catch (error) {
            alert('解除できませんでした。しばらくしてからもう一度お試しください。');
        }
    }

    // ========================================
    // 高配当企業
    // ========================================

    let dividendLoaded = false;
    let dividendCache = [];
    let divSort = { key: 'dividend_yield', dir: 'desc' };

    async function loadDividendStocks() {
        dividendLoaded = true;
        const content = document.getElementById('dividendContent');
        content.innerHTML = '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>';

        try {
            const response = await fetch('/api/dividend-stocks');
            const data = await response.json();
            if (response.ok) {
                dividendCache = data.dividend_stocks || [];
                applyDivFilters();
            } else {
                content.innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
            }
        } catch (error) {
            content.innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
        }
    }

    // フィルタ入力イベント
    document.getElementById('divFilterBar')?.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => applyDivFilters());
    });

    function applyDivFilters() {
        let list = [...dividendCache];

        const matchMin = parseFloat(document.getElementById('divFilterMatchMin')?.value);
        const matchMax = parseFloat(document.getElementById('divFilterMatchMax')?.value);
        const capMin = parseFloat(document.getElementById('divFilterCapMin')?.value);
        const capMax = parseFloat(document.getElementById('divFilterCapMax')?.value);
        const perMin = parseFloat(document.getElementById('divFilterPerMin')?.value);
        const perMax = parseFloat(document.getElementById('divFilterPerMax')?.value);
        const pbrMin = parseFloat(document.getElementById('divFilterPbrMin')?.value);
        const pbrMax = parseFloat(document.getElementById('divFilterPbrMax')?.value);
        const divMin = parseFloat(document.getElementById('divFilterDivMin')?.value);
        const divMax = parseFloat(document.getElementById('divFilterDivMax')?.value);

        if (!isNaN(matchMin)) list = list.filter(i => i.match_rate != null && i.match_rate >= matchMin);
        if (!isNaN(matchMax)) list = list.filter(i => i.match_rate != null && i.match_rate <= matchMax);
        if (!isNaN(capMin)) list = list.filter(i => i.market_cap != null && i.market_cap >= capMin);
        if (!isNaN(capMax)) list = list.filter(i => i.market_cap != null && i.market_cap <= capMax);
        if (!isNaN(perMin)) list = list.filter(i => i.per_forward != null && i.per_forward >= perMin);
        if (!isNaN(perMax)) list = list.filter(i => i.per_forward != null && i.per_forward <= perMax);
        if (!isNaN(pbrMin)) list = list.filter(i => i.pbr != null && i.pbr >= pbrMin);
        if (!isNaN(pbrMax)) list = list.filter(i => i.pbr != null && i.pbr <= pbrMax);
        if (!isNaN(divMin)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield >= divMin);
        if (!isNaN(divMax)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield <= divMax);

        // ソート
        if (divSort.key) {
            list.sort((a, b) => {
                const aVal = a[divSort.key] || 0;
                const bVal = b[divSort.key] || 0;
                return divSort.dir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        // 詳細取得ボタンのラベル更新
        const totalCount = dividendCache.length;
        const filteredCount = list.length;
        const countLabel = totalCount === filteredCount ? `${totalCount}` : `${filteredCount}/${totalCount}`;
        const divBtn = document.getElementById('divAnalyzeBtn');
        if (divBtn && !div_analyze_status_running) divBtn.textContent = `${countLabel}件 詳細取得`;

        renderDividendStocks(list);
    }

    function resetDivFilters() {
        document.getElementById('divFilterBar')?.querySelectorAll('input').forEach(input => input.value = '');
        applyDivFilters();
    }

    function sortDivColumn(key) {
        if (divSort.key === key) {
            divSort.dir = divSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            divSort.key = key;
            divSort.dir = key === 'dividend_yield' ? 'desc' : 'asc';
        }
        applyDivFilters();
    }

    function divSortIcon(key) {
        if (divSort.key !== key) return '<i class="fas fa-sort" style="color:#999;font-size:10px;margin-left:3px;"></i>';
        return divSort.dir === 'asc'
            ? '<i class="fas fa-sort-up" style="color:#2d6a4f;font-size:10px;margin-left:3px;"></i>'
            : '<i class="fas fa-sort-down" style="color:#2d6a4f;font-size:10px;margin-left:3px;"></i>';
    }

    function renderDividendStocks(list) {
        const content = document.getElementById('dividendContent');


        if (list.length === 0 && dividendCache.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">高配当企業が登録されていません。「高配当企業登録」ボタンから銘柄を登録してください。</div>';
            return;
        }
        if (list.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">条件に一致する企業がありません</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>コード</th>
                        <th>会社名</th>
                        <th class="sortable" onclick="sortDivColumn('match_rate')">合致度${divSortIcon('match_rate')}</th>
                        <th>セクター</th>
                        <th class="sortable" onclick="sortDivColumn('market_cap')">時価総額${divSortIcon('market_cap')}</th>
                        <th class="sortable" onclick="sortDivColumn('stock_price')">株価${divSortIcon('stock_price')}</th>
                        <th class="sortable" onclick="sortDivColumn('per_forward')">PER${divSortIcon('per_forward')}</th>
                        <th class="sortable" onclick="sortDivColumn('pbr')">PBR${divSortIcon('pbr')}</th>
                        <th class="sortable" onclick="sortDivColumn('dividend_yield')">配当利回り${divSortIcon('dividend_yield')}</th>
                        <th class="sortable" onclick="sortDivColumn('payout_ratio')">配当性向${divSortIcon('payout_ratio')}</th>
                        ${IS_ADMIN ? '<th>操作</th>' : ''}
                    </tr>
                </thead>
                <tbody>
        `;

        list.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const sector = item.sector || '---';
            const marketCap = item.market_cap ? formatMarketCapOku(item.market_cap) : '---';
            const price = item.stock_price ? formatWatchlistPrice(item.stock_price) : '---';
            const per = item.per_forward ? `${Number(item.per_forward).toFixed(1)}倍` : '---';
            const pbr = item.pbr ? `${Number(item.pbr).toFixed(2)}倍` : '---';
            const divYield = item.dividend_yield ? `${Number(item.dividend_yield).toFixed(2)}%` : '---';
            const payoutRatio = item.payout_ratio != null ? `${Number(item.payout_ratio).toFixed(1)}%` : '---';
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}` : '---';
            const matchRateClass = getMatchRateClass(item.match_rate);

            html += `
                <tr>
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td class="${matchRateClass}">${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per_forward, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td><strong>${divYield}</strong></td>
                    <td>${payoutRatio}</td>
                    ${IS_ADMIN ? `<td><button class="delete-btn" onclick="removeDividendStock('${code}')">解除</button></td>` : ''}
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    async function removeDividendStock(code) {
        if (!confirm('この企業を高配当リストから解除しますか？')) return;
        try {
            const response = await fetch(`/api/dividend-stocks/remove/${code}`, { method: 'DELETE' });
            if (response.ok) {
                dividendCache = dividendCache.filter(item => item.company_code !== code);
                applyDivFilters();
            } else {
                alert('解除できませんでした。しばらくしてからもう一度お試しください。');
            }
        } catch (error) {
            alert('解除できませんでした。しばらくしてからもう一度お試しください。');
        }
    }

    // ========================================
    // 高配当企業 - 詳細取得（バックグラウンド分析）
    // ========================================

    let div_analyze_status_running = false;
    let divAnalyzePolling = null;

    async function analyzeDivStocks(force = false) {
        const btn = document.getElementById('divAnalyzeBtn');
        const stopBtn = document.getElementById('divStopBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 開始中...';
        stopBtn.style.display = 'inline-block';

        try {
            const response = await fetch('/api/dividend-stocks/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ force })
            });
            const data = await response.json();

            if (response.ok) {
                if (data.status && data.status.total === 0) {
                    btn.disabled = false;
                    btn.textContent = `${dividendCache.length}件 詳細取得`;
                    stopBtn.style.display = 'none';
                    if (!force) {
                        const ok = await showConfirmModal('本日解析済ですが再度解析しますか？');
                        if (ok) analyzeDivStocks(true);
                    }
                } else {
                    div_analyze_status_running = true;
                    divAnalyzePolling = setInterval(pollDivAnalyzeStatus, 2000);
                }
            } else {
                showErrorModal('分析を開始できませんでした。しばらくしてからもう一度お試しください。');
                btn.disabled = false;
                btn.textContent = `${dividendCache.length}件 詳細取得`;
                stopBtn.style.display = 'none';
            }
        } catch (error) {
            console.error('通信エラー:', error);
            showErrorModal('接続がうまくいきませんでした。ページを再読み込みしてお試しください。');
            btn.disabled = false;
            btn.textContent = `${dividendCache.length}件 詳細取得`;
            stopBtn.style.display = 'none';
        }
    }

    async function pollDivAnalyzeStatus() {
        try {
            const response = await fetch('/api/dividend-stocks/analyze/status');
            const status = await response.json();

            const btn = document.getElementById('divAnalyzeBtn');
            const stopBtn = document.getElementById('divStopBtn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${status.done}/${status.total}件 分析中...`;

            // 順次表示: 分析中もデータをリロード
            dividendLoaded = false;
            await loadDividendStocks();

            if (!status.running) {
                clearInterval(divAnalyzePolling);
                divAnalyzePolling = null;
                div_analyze_status_running = false;
                btn.disabled = false;
                btn.textContent = `${dividendCache.length}件 詳細取得`;
                stopBtn.style.display = 'none';

                const errMsg = status.errors > 0 ? `（${status.errors}件エラー）` : '';
                showSuccessModal(`${status.done}件の分析が完了しました${errMsg}`);
            }
        } catch (error) {
            console.error('ステータス取得エラー:', error);
        }
    }

    async function stopDivAnalyze() {
        const stopBtn = document.getElementById('divStopBtn');
        stopBtn.disabled = true;
        stopBtn.textContent = '停止中...';
        try {
            await fetch('/api/dividend-stocks/analyze/stop', { method: 'POST' });
        } catch (error) {
            console.error('停止リクエストエラー:', error);
        }
    }

    // ========================================
    // GC銘柄関連機能
    // ========================================

    let gcStocksCache = [];

    async function loadGcStocks() {
        try {
            const response = await fetch('/api/gc-stocks');
            const data = await response.json();
            if (response.ok) {
                renderGcStocks(data.gc_stocks || []);
            } else {
                document.getElementById('gcContent').innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
            }
        } catch (error) {
            document.getElementById('gcContent').innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
        }
    }

    async function fetchGcStocks() {
        const btn = document.getElementById('gcFetchBtn');
        btn.disabled = true;
        btn.textContent = '取得中...';

        document.getElementById('gcContent').innerHTML =
            '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">kabutan.jpからデータを取得中...（10〜30秒程度）</div></div>';

        try {
            const response = await fetch('/api/gc-stocks/scrape', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
            const data = await response.json();
            if (response.ok) {
                renderGcStocks(data.gc_stocks || []);
            } else {
                console.error('GC取得エラー:', data.error);
                document.getElementById('gcContent').innerHTML = '<div class="watchlist-empty">データを取得できませんでした。しばらくしてからもう一度お試しください。</div>';
            }
        } catch (error) {
            console.error('GC通信エラー:', error);
            document.getElementById('gcContent').innerHTML = '<div class="watchlist-empty">接続がうまくいきませんでした。ページを再読み込みしてお試しください。</div>';
        } finally {
            btn.disabled = false;
            btn.textContent = '取得';
        }
    }

    function renderGcStocks(stocks) {
        gcStocksCache = stocks;

        const content = document.getElementById('gcContent');
        const countElement = document.getElementById('gcCount');
        countElement.textContent = `${stocks.length}件`;

        if (stocks.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">GC銘柄がありません。「取得」ボタンでデータを取得してください。</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>コード</th>
                        <th>会社名</th>
                        <th>合致度</th>
                        <th>セクター</th>
                        <th>時価総額</th>
                        <th>株価</th>
                        <th>PER</th>
                        <th>PBR</th>
                        <th>配当利回り</th>
                        <th>GC形成日</th>
                        <th>方向</th>
                    </tr>
                </thead>
                <tbody>
        `;

        stocks.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}/120` : '---';
            const sector = item.sector || '---';
            const marketCap = item.market_cap !== null && item.market_cap !== undefined ? `${Number(item.market_cap).toLocaleString()}億` : '---';
            const price = item.stock_price !== null && item.stock_price !== undefined ? Number(item.stock_price).toLocaleString() + '円' : '---';
            const per = item.per !== null && item.per !== undefined ? `${Number(item.per).toFixed(1)}倍` : '---';
            const pbr = item.pbr !== null && item.pbr !== undefined ? `${Number(item.pbr).toFixed(2)}倍` : '---';
            const divYield = item.dividend_yield !== null && item.dividend_yield !== undefined ? `${Number(item.dividend_yield).toFixed(2)}%` : '---';
            const gcDate = formatScrapedDate(item.gc_date);
            const trend = getTrendDirection(item.gc_date, item.dc_date);

            html += `
                <tr class="${trend.cls ? 'row-' + trend.cls : ''}">
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td>${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td>${divYield}</td>
                    <td>${gcDate}</td>
                    <td class="${trend.cls}">${trend.label}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    // GC銘柄の詳細分析
    let gcAnalyzePolling = null;

    async function analyzeGcStocks() {
        if (gcStocksCache.length === 0) { showErrorModal('先にGC銘柄を取得してください'); return; }

        const btn = document.getElementById('gcAnalyzeBtn');
        const stopBtn = document.getElementById('gcStopBtn');
        btn.disabled = true;
        stopBtn.style.display = 'inline-block';

        try {
            const response = await fetch('/api/gc-stocks/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
            const data = await response.json();

            if (response.ok) {
                if (data.status && data.status.total === 0) {
                    btn.disabled = false;
                    btn.textContent = '詳細取得';
                    stopBtn.style.display = 'none';
                    showSuccessModal('全銘柄の分析が完了済みです');
                } else {
                    startGcAnalyzePolling();
                }
            } else {
                if (data.status && data.status.running) {
                    startGcAnalyzePolling();
                } else {
                    console.error('GC分析エラー:', data.error);
                    document.getElementById('gcContent').innerHTML = '<div class="watchlist-empty">分析を開始できませんでした。しばらくしてからもう一度お試しください。</div>';
                    btn.disabled = false;
                    btn.textContent = '詳細取得';
                    stopBtn.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('GC通信エラー:', error);
            document.getElementById('gcContent').innerHTML = '<div class="watchlist-empty">接続がうまくいきませんでした。ページを再読み込みしてお試しください。</div>';
            btn.disabled = false;
            btn.textContent = '詳細取得';
            stopBtn.style.display = 'none';
        }
    }

    async function stopGcAnalyze() {
        try {
            await fetch('/api/gc-stocks/analyze/stop', { method: 'POST' });
            document.getElementById('gcStopBtn').disabled = true;
            document.getElementById('gcStopBtn').textContent = '停止中...';
        } catch (e) {
            console.error('停止リクエスト失敗:', e);
        }
    }

    function finishGcAnalyzeUI() {
        const btn = document.getElementById('gcAnalyzeBtn');
        const stopBtn = document.getElementById('gcStopBtn');
        btn.disabled = false;
        btn.textContent = '詳細取得';
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = '停止';
    }

    function startGcAnalyzePolling() {
        if (gcAnalyzePolling) clearInterval(gcAnalyzePolling);

        gcAnalyzePolling = setInterval(async () => {
            try {
                const statusRes = await fetch('/api/gc-stocks/analyze/status');
                const status = await statusRes.json();

                document.getElementById('gcAnalyzeBtn').textContent = `分析中 ${status.done}/${status.total}`;

                const dataRes = await fetch('/api/gc-stocks');
                const data = await dataRes.json();
                if (dataRes.ok) renderGcStocks(data.gc_stocks || []);

                if (!status.running) {
                    clearInterval(gcAnalyzePolling);
                    gcAnalyzePolling = null;
                    finishGcAnalyzeUI();
                }
            } catch (e) {
                clearInterval(gcAnalyzePolling);
                gcAnalyzePolling = null;
                finishGcAnalyzeUI();
            }
        }, 3000);
    }

    // scraped_atをyyyy/mm/dd形式に変換
    function formatScrapedDate(dateStr) {
        if (!dateStr) return '---';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return '---';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}/${m}/${day}`;
    }

    // トレンド方向判定（GC/DC日付比較）
    function getTrendDirection(gcDate, dcDate) {
        if (!gcDate && !dcDate) return { label: '---', cls: '' };
        if (gcDate && !dcDate) return { label: '↗', cls: 'trend-up' };
        if (!gcDate && dcDate) return { label: '↘', cls: 'trend-down' };
        const gc = new Date(gcDate);
        const dc = new Date(dcDate);
        if (gc > dc) return { label: '↗', cls: 'trend-up' };
        if (dc > gc) return { label: '↘', cls: 'trend-down' };
        return { label: '---', cls: '' };
    }

    // ========================================
    // DC銘柄関連機能
    // ========================================

    let dcStocksCache = [];

    async function loadDcStocks() {
        try {
            const response = await fetch('/api/dc-stocks');
            const data = await response.json();
            if (response.ok) {
                renderDcStocks(data.dc_stocks || []);
            } else {
                document.getElementById('dcContent').innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
            }
        } catch (error) {
            document.getElementById('dcContent').innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
        }
    }

    async function fetchDcStocks() {
        const btn = document.getElementById('dcFetchBtn');
        btn.disabled = true;
        btn.textContent = '取得中...';

        document.getElementById('dcContent').innerHTML =
            '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">kabutan.jpからデータを取得中...（10〜30秒程度）</div></div>';

        try {
            const response = await fetch('/api/dc-stocks/scrape', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
            const data = await response.json();
            if (response.ok) {
                renderDcStocks(data.dc_stocks || []);
            } else {
                console.error('DC取得エラー:', data.error);
                document.getElementById('dcContent').innerHTML = '<div class="watchlist-empty">データを取得できませんでした。しばらくしてからもう一度お試しください。</div>';
            }
        } catch (error) {
            console.error('DC通信エラー:', error);
            document.getElementById('dcContent').innerHTML = '<div class="watchlist-empty">接続がうまくいきませんでした。ページを再読み込みしてお試しください。</div>';
        } finally {
            btn.disabled = false;
            btn.textContent = '取得';
        }
    }

    function renderDcStocks(stocks) {
        dcStocksCache = stocks;

        const content = document.getElementById('dcContent');
        const countElement = document.getElementById('dcCount');
        countElement.textContent = `${stocks.length}件`;

        if (stocks.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">DC銘柄がありません。「取得」ボタンでデータを取得してください。</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>コード</th>
                        <th>銘柄名</th>
                        <th>市場</th>
                        <th>株価</th>
                        <th>PER</th>
                        <th>PBR</th>
                        <th>DC形成日</th>
                        <th>方向</th>
                    </tr>
                </thead>
                <tbody>
        `;

        stocks.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const market = item.market || '---';
            const price = item.stock_price !== null && item.stock_price !== undefined ? Number(item.stock_price).toLocaleString() + '円' : '---';
            const per = item.per !== null && item.per !== undefined ? `${Number(item.per).toFixed(1)}倍` : '---';
            const pbr = item.pbr !== null && item.pbr !== undefined ? `${Number(item.pbr).toFixed(2)}倍` : '---';
            const formedDate = formatScrapedDate(item.dc_date);
            const trend = getTrendDirection(item.gc_date, item.dc_date);

            html += `
                <tr class="${trend.cls ? 'row-' + trend.cls : ''}">
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td>${market}</td>
                    <td>${price}</td>
                    <td>${per}</td>
                    <td>${pbr}</td>
                    <td>${formedDate}</td>
                    <td class="${trend.cls}">${trend.label}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    // ========================================
    // テクニカル分析関連機能
    // ========================================

    let technicalStocksCache = [];
    let techSort = { key: '', dir: 'asc' };

    async function loadTechnicalStocks() {
        document.getElementById('technicalContent').innerHTML =
            '<div class="gc-loading"><div class="gc-spinner"></div><div class="gc-loading-text">読み込み中...</div></div>';

        try {
            const response = await fetch('/api/technical-stocks');
            const data = await response.json();
            if (response.ok) {
                technicalStocksCache = data.technical_stocks || [];
                applyTechFilters();
            } else {
                document.getElementById('technicalContent').innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
            }
        } catch (error) {
            document.getElementById('technicalContent').innerHTML = '<div class="watchlist-empty">データの読み込みに失敗しました。ページを再読み込みしてお試しください。</div>';
        }
    }

    // フィルタ入力イベント
    document.getElementById('techFilterBar')?.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', () => applyTechFilters());
        el.addEventListener('change', () => applyTechFilters());
    });

    function applyTechFilters() {
        let list = [...technicalStocksCache];

        const matchMin = parseFloat(document.getElementById('techFilterMatchMin')?.value);
        const matchMax = parseFloat(document.getElementById('techFilterMatchMax')?.value);
        const capMin = parseFloat(document.getElementById('techFilterCapMin')?.value);
        const capMax = parseFloat(document.getElementById('techFilterCapMax')?.value);
        const perMin = parseFloat(document.getElementById('techFilterPerMin')?.value);
        const perMax = parseFloat(document.getElementById('techFilterPerMax')?.value);
        const pbrMin = parseFloat(document.getElementById('techFilterPbrMin')?.value);
        const pbrMax = parseFloat(document.getElementById('techFilterPbrMax')?.value);
        const divMin = parseFloat(document.getElementById('techFilterDivMin')?.value);
        const divMax = parseFloat(document.getElementById('techFilterDivMax')?.value);
        const trendFilter = document.getElementById('techFilterTrend')?.value || '';

        if (!isNaN(matchMin)) list = list.filter(i => i.match_rate != null && i.match_rate >= matchMin);
        if (!isNaN(matchMax)) list = list.filter(i => i.match_rate != null && i.match_rate <= matchMax);
        if (!isNaN(capMin)) list = list.filter(i => i.market_cap != null && i.market_cap >= capMin);
        if (!isNaN(capMax)) list = list.filter(i => i.market_cap != null && i.market_cap <= capMax);
        if (!isNaN(perMin)) list = list.filter(i => i.per != null && i.per >= perMin);
        if (!isNaN(perMax)) list = list.filter(i => i.per != null && i.per <= perMax);
        if (!isNaN(pbrMin)) list = list.filter(i => i.pbr != null && i.pbr >= pbrMin);
        if (!isNaN(pbrMax)) list = list.filter(i => i.pbr != null && i.pbr <= pbrMax);
        if (!isNaN(divMin)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield >= divMin);
        if (!isNaN(divMax)) list = list.filter(i => i.dividend_yield != null && i.dividend_yield <= divMax);

        if (trendFilter === 'gc') {
            list = list.filter(i => {
                const t = getTrendDirection(i.gc_date, i.dc_date);
                return t.cls === 'gc-trend';
            });
        } else if (trendFilter === 'dc') {
            list = list.filter(i => {
                const t = getTrendDirection(i.gc_date, i.dc_date);
                return t.cls === 'dc-trend';
            });
        }

        // ソート
        if (techSort.key) {
            list.sort((a, b) => {
                const aVal = a[techSort.key] || 0;
                const bVal = b[techSort.key] || 0;
                return techSort.dir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        renderTechnicalStocks(list, false);

        // 分析中でなければボタンラベル更新
        if (!tech_analyze_status_running) {
            document.getElementById('techAnalyzeBtn').textContent = `${technicalStocksCache.length}件 詳細取得`;
        }
    }

    function resetTechFilters() {
        document.getElementById('techFilterBar')?.querySelectorAll('input').forEach(input => input.value = '');
        const sel = document.getElementById('techFilterTrend');
        if (sel) sel.value = '';
        applyTechFilters();
    }

    function sortTechColumn(key) {
        if (techSort.key === key) {
            techSort.dir = techSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            techSort.key = key;
            techSort.dir = 'asc';
        }
        applyTechFilters();
    }

    function techSortIcon(key) {
        if (techSort.key !== key) return '<i class="fas fa-sort" style="color:#999;font-size:10px;margin-left:3px;"></i>';
        return techSort.dir === 'asc'
            ? '<i class="fas fa-sort-up" style="color:#2d6a4f;font-size:10px;margin-left:3px;"></i>'
            : '<i class="fas fa-sort-down" style="color:#2d6a4f;font-size:10px;margin-left:3px;"></i>';
    }

    function renderTechnicalStocks(stocks, updateCache) {
        if (updateCache !== false) technicalStocksCache = stocks;

        const content = document.getElementById('technicalContent');

        if (stocks.length === 0 && technicalStocksCache.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">GC/DC形成日を持つ銘柄がありません</div>';
            return;
        }
        if (stocks.length === 0) {
            content.innerHTML = '<div class="watchlist-empty">条件に一致する銘柄がありません</div>';
            return;
        }

        let html = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>コード</th>
                        <th>会社名</th>
                        <th class="sortable" onclick="sortTechColumn('match_rate')">合致度${techSortIcon('match_rate')}</th>
                        <th>セクター</th>
                        <th class="sortable" onclick="sortTechColumn('market_cap')">時価総額${techSortIcon('market_cap')}</th>
                        <th class="sortable" onclick="sortTechColumn('stock_price')">株価${techSortIcon('stock_price')}</th>
                        <th class="sortable" onclick="sortTechColumn('per')">PER${techSortIcon('per')}</th>
                        <th class="sortable" onclick="sortTechColumn('pbr')">PBR${techSortIcon('pbr')}</th>
                        <th class="sortable" onclick="sortTechColumn('dividend_yield')">配当利回り${techSortIcon('dividend_yield')}</th>
                        <th>GC</th>
                        <th>DC</th>
                        <th>方向</th>
                        <th>取得</th>
                    </tr>
                </thead>
                <tbody>
        `;

        stocks.forEach(item => {
            const code = item.company_code || '---';
            const name = item.company_name || '---';
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}` : '---';
            const matchRateClass = getMatchRateClass(item.match_rate);
            const sector = item.sector || '---';
            const marketCap = item.market_cap ? formatMarketCapOku(item.market_cap) : '---';
            const price = item.stock_price ? formatWatchlistPrice(item.stock_price) : '---';
            const per = item.per ? `${Number(item.per).toFixed(1)}倍` : '---';
            const pbr = item.pbr ? `${Number(item.pbr).toFixed(2)}倍` : '---';
            const divYield = item.dividend_yield ? `${Number(item.dividend_yield).toFixed(2)}%` : '---';
            const gcDate = formatScrapedDate(item.gc_date);
            const dcDate = formatScrapedDate(item.dc_date);
            const trend = getTrendDirection(item.gc_date, item.dc_date);

            html += `
                <tr id="tech-row-${code}" class="${trend.cls ? 'row-' + trend.cls : ''}">
                    <td>${code}</td>
                    <td class="company-name-cell" onclick="window.open('/stock/${code.replace('.T','')}', '_blank')">${name}</td>
                    <td class="${matchRateClass}">${matchRate}</td>
                    <td>${sector}</td>
                    <td>${marketCap}</td>
                    <td>${price}</td>
                    <td class="${getMetricClass(item.per, 15, 30)}">${per}</td>
                    <td class="${getMetricClass(item.pbr, 1, 2)}">${pbr}</td>
                    <td>${divYield}</td>
                    <td>${gcDate}</td>
                    <td>${dcDate}</td>
                    <td class="${trend.cls}">${trend.label}</td>
                    <td><button class="delete-btn" style="color: var(--accent-color); border-color: var(--accent-color);" id="tech-btn-${code}" onclick="refreshTechnicalStock('${code}')"><i class="fas ${item.analyzed_at ? 'fa-sync-alt' : 'fa-download'}" style="font-size: 0.7rem;"></i></button></td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        content.innerHTML = html;
    }

    // ========================================
    // テクニカル分析: 一括詳細取得
    // ========================================

    let tech_analyze_status_running = false;
    let techAnalyzePolling = null;

    async function analyzeTechStocks() {
        const btn = document.getElementById('techAnalyzeBtn');
        const stopBtn = document.getElementById('techStopBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 開始中...';
        stopBtn.style.display = 'inline-block';

        try {
            const response = await fetch('/api/technical-stocks/analyze', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                if (data.status && data.status.total === 0) {
                    btn.disabled = false;
                    btn.textContent = `${technicalStocksCache.length}件 詳細取得`;
                    stopBtn.style.display = 'none';
                    showSuccessModal('全銘柄の分析が完了済みです');
                } else {
                    tech_analyze_status_running = true;
                    techAnalyzePolling = setInterval(pollTechAnalyzeStatus, 2000);
                }
            } else {
                showErrorModal('分析を開始できませんでした。しばらくしてからもう一度お試しください。');
                btn.disabled = false;
                btn.textContent = `${technicalStocksCache.length}件 詳細取得`;
                stopBtn.style.display = 'none';
            }
        } catch (error) {
            console.error('通信エラー:', error);
            showErrorModal('接続がうまくいきませんでした。ページを再読み込みしてお試しください。');
            btn.disabled = false;
            btn.textContent = `${technicalStocksCache.length}件 詳細取得`;
            stopBtn.style.display = 'none';
        }
    }

    async function pollTechAnalyzeStatus() {
        try {
            const response = await fetch('/api/technical-stocks/analyze/status');
            const status = await response.json();

            const btn = document.getElementById('techAnalyzeBtn');
            const stopBtn = document.getElementById('techStopBtn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${status.done}/${status.total}件 分析中...`;

            // 順次表示: 分析中もデータをリロード
            await loadTechnicalStocks();

            if (!status.running) {
                clearInterval(techAnalyzePolling);
                techAnalyzePolling = null;
                tech_analyze_status_running = false;
                btn.disabled = false;
                btn.textContent = `${technicalStocksCache.length}件 詳細取得`;
                stopBtn.style.display = 'none';

                const errMsg = status.errors > 0 ? `（${status.errors}件エラー）` : '';
                showSuccessModal(`${status.done}件の分析が完了しました${errMsg}`);
            }
        } catch (error) {
            console.error('ステータス取得エラー:', error);
        }
    }

    async function stopTechAnalyze() {
        const stopBtn = document.getElementById('techStopBtn');
        stopBtn.disabled = true;
        stopBtn.textContent = '停止中...';
        try {
            await fetch('/api/technical-stocks/analyze/stop', { method: 'POST' });
        } catch (error) {
            console.error('停止リクエストエラー:', error);
        }
    }

    // テクニカル分析: 1銘柄の最新データ取得
    async function refreshTechnicalStock(code) {
        const btn = document.getElementById(`tech-btn-${code}`);
        if (!btn) return;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 0.7rem;"></i>';

        try {
            const symbol = /^\d{3,4}[A-Z]?$/.test(code) ? `${code}.T` : code;
            const response = await fetch('/api/stock/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: symbol })
            });

            if (response.ok) {
                // signal_stocksの表示を更新するためリロード
                await loadTechnicalStocks();
            } else {
                const data = await response.json();
                if (data.timeout || response.status === 504) {
                    showErrorModal('データ取得の応答に時間がかかりすぎたため、中断しました。\nしばらくしてからもう一度お試しください。');
                } else {
                    showErrorModal('データを取得できませんでした。\nしばらくしてからもう一度お試しください。');
                }
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download" style="font-size: 0.7rem;"></i>';
            }
        } catch (error) {
            showErrorModal('接続がうまくいきませんでした。\nページを再読み込みしてお試しください。');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-download" style="font-size: 0.7rem;"></i>';
        }
    }

    // 未回答質問の通知バナー
    (async function() {
        try {
            const res = await fetch('/api/community/questions/unanswered-count');
            const data = await res.json();
            if (data.count > 0) {
                document.getElementById('unansweredCount').textContent = data.count;
                document.getElementById('unansweredBanner').style.display = 'block';
            }
        } catch (e) {}
    })();

</script>
{% endblock %}
