{% extends "layout.html" %}

{% block title %}みんなの企業研究ノート - Company Note{% endblock %}

{% block content %}
<style>
    .community {
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
    }
    .community-hero {
        background: #fafaf8;
        border-bottom: 1px solid #e8e8e4;
    }
    .cm-card {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 12px;
        transition: all 0.2s ease;
    }
    .cm-card:hover {
        border-color: #d4d4d4;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .note-card {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 10px;
        border-left: 3px solid #1b4332;
        padding: 16px 18px;
        transition: all 0.2s ease;
    }
    .note-card:hover {
        border-color: #d4d4d4;
        border-left-color: #1b4332;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .section-head {
        font-size: 13px;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
    }
    .section-head i { color: #2d6a4f; font-size: 12px; }
    .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        background: #f0fdf4;
        color: #15803d;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tag:hover { background: #dcfce7; }
    .tag.active { background: #1b4332; color: #fff; }
    .sort-btn {
        font-size: 11px; padding: 4px 10px; border-radius: 5px;
        border: 1px solid #ebebeb; background: #fff; color: #525252;
        cursor: pointer; transition: all 0.15s;
    }
    .sort-btn:hover, .sort-btn.active { border-color: #2d6a4f; color: #1b4332; background: #f0fdf4; }
    .star { color: #eab308; font-size: 11px; }
    .star-empty { color: #d4d4d4; font-size: 11px; }
    .user-icon {
        width: 32px; height: 32px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 700; flex-shrink: 0;
    }
    .user-icon.anonymous { background: #f3f4f6; color: #9ca3af; }
    .user-icon.named { background: #f0fdf4; color: #1b4332; }
    .empty-state {
        text-align: center; padding: 40px 20px;
    }
    .empty-state i { font-size: 36px; color: #d4d4d4; margin-bottom: 12px; }
    .empty-state p { font-size: 13px; color: #a3a3a3; margin-bottom: 10px; }
    .sidebar-tag {
        display: flex; align-items: center; justify-content: space-between;
        padding: 6px 10px; border-radius: 6px; cursor: pointer;
        transition: all 0.15s; font-size: 12px;
    }
    .sidebar-tag:hover { background: #f0fdf4; }
    .sidebar-tag.active { background: #1b4332; color: #fff; }
    .sidebar-tag .tag-count {
        font-size: 10px; padding: 1px 6px; border-radius: 10px;
        background: #f3f4f6; color: #737373;
    }
    .sidebar-tag.active .tag-count { background: rgba(255,255,255,0.2); color: #fff; }
    .form-input-cm {
        width: 100%; padding: 8px 12px 8px 34px;
        border: 1px solid #ebebeb; border-radius: 8px;
        font-size: 13px; color: #1a1a1a; background: #fff;
        outline: none; transition: border-color 0.2s;
    }
    .form-input-cm:focus { border-color: #2d6a4f; }
    .load-more-btn {
        background: #fff; color: #2d6a4f; border: 1px solid #ebebeb;
        border-radius: 8px; padding: 8px 24px; font-size: 13px;
        font-weight: 500; cursor: pointer; transition: all 0.2s;
    }
    .load-more-btn:hover { border-color: #2d6a4f; background: #f0fdf4; }
</style>

<div class="community min-h-screen" style="background: #f7f7f5;" x-data="communityApp()">

    <!-- ヘッダー -->
    <div class="community-hero">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <p class="text-xs font-semibold tracking-widest uppercase mb-1" style="color: #16a34a;">Community</p>
                    <h1 class="text-xl font-bold" style="color: #1a1a1a;">みんなの企業研究ノート</h1>
                    <p class="text-xs mt-1" style="color: #737373;">他のユーザーの企業研究を読んで、新しい視点を学ぼう</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-center px-3 py-1.5 rounded-lg" style="background:#fff; border:1px solid #ebebeb;">
                        <div class="text-base font-bold" style="color:#1b4332;" x-text="notes.length"></div>
                        <div class="text-xs" style="color:#737373;">公開ノート</div>
                    </div>
                    <a href="/mypage" class="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium" style="background:#1b4332; color:#fff; text-decoration:none;">
                        <i class="fas fa-pen" style="font-size:10px;"></i>自分のノートを書く
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-5">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">

            <!-- ===== 左サイドバー ===== -->
            <div class="lg:col-span-3 space-y-5">
                <!-- 検索 -->
                <div class="cm-card p-4">
                    <div style="position:relative;">
                        <i class="fas fa-search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#a3a3a3; font-size:12px;"></i>
                        <input type="text" placeholder="ノートを検索..." x-model="searchQuery" class="form-input-cm">
                    </div>
                </div>

                <!-- 並び替え -->
                <div class="cm-card p-4">
                    <h3 class="section-head"><i class="fas fa-sort"></i>並び替え</h3>
                    <div class="flex flex-col gap-1.5">
                        <button class="sort-btn" :class="{ 'active': sortBy === 'date' }" @click="sortBy = 'date'" style="text-align:left;">
                            <i class="fas fa-clock mr-1" style="font-size:10px;"></i>新しい順
                        </button>
                        <button class="sort-btn" :class="{ 'active': sortBy === 'star' }" @click="sortBy = 'star'" style="text-align:left;">
                            <i class="fas fa-star mr-1" style="font-size:10px;"></i>理解度順
                        </button>
                    </div>
                </div>

                <!-- 人気タグ -->
                <div class="cm-card p-4">
                    <h3 class="section-head"><i class="fas fa-tags"></i>人気タグ</h3>
                    <div x-show="loading" class="text-center py-2">
                        <i class="fas fa-spinner fa-spin" style="color:#a3a3a3; font-size:12px;"></i>
                    </div>
                    <div class="space-y-0.5" x-show="!loading">
                        <div class="sidebar-tag" :class="{ 'active': activeTag === '' }" @click="activeTag = ''">
                            <span>すべて</span>
                            <span class="tag-count" x-text="notes.length"></span>
                        </div>
                        <template x-for="tag in popularTags" :key="tag.name">
                            <div class="sidebar-tag" :class="{ 'active': activeTag === tag.name }" @click="activeTag = activeTag === tag.name ? '' : tag.name">
                                <span x-text="tag.name"></span>
                                <span class="tag-count" x-text="tag.count"></span>
                            </div>
                        </template>
                        <p x-show="popularTags.length === 0 && !loading" class="text-xs py-2" style="color:#a3a3a3;">タグはまだありません</p>
                    </div>
                </div>
            </div>

            <!-- ===== メイン: ノート一覧 ===== -->
            <div class="lg:col-span-9">

                <!-- ローディング -->
                <div x-show="loading" class="empty-state">
                    <div><i class="fas fa-spinner fa-spin" style="font-size:28px; color:#2d6a4f;"></i></div>
                    <p>ノートを読み込み中...</p>
                </div>

                <!-- ノート一覧 -->
                <div class="space-y-3" x-show="!loading">
                    <template x-for="note in filteredNotes" :key="note.id">
                        <div class="note-card">
                            <div class="flex items-start gap-3">
                                <!-- ユーザーアイコン -->
                                <div class="user-icon" :class="note.is_anonymous ? 'anonymous' : 'named'" x-text="note.is_anonymous ? '匿' : (note.user_id || '').slice(-2).toUpperCase()"></div>

                                <!-- コンテンツ -->
                                <div style="flex:1; min-width:0;">
                                    <!-- ヘッダー行 -->
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span class="text-xs font-medium" style="color:#525252;" x-text="note.is_anonymous ? '匿名ユーザー' : note.user_id"></span>
                                        <span x-show="note.company_name" class="text-xs px-1.5 py-0.5 rounded" style="background:#eff6ff; color:#2563eb;">
                                            <i class="fas fa-building mr-0.5" style="font-size:9px;"></i>
                                            <span x-text="note.company_name"></span>
                                            <span x-show="note.company_code" class="ml-0.5" style="color:#93c5fd;" x-text="note.company_code"></span>
                                        </span>
                                        <span class="text-xs" style="color:#a3a3a3;" x-text="formatDate(note.created_at)"></span>
                                    </div>

                                    <!-- タイトル -->
                                    <h3 class="text-sm font-bold mb-1" style="color:#1a1a1a;" x-text="note.title"></h3>

                                    <!-- 本文プレビュー -->
                                    <p class="text-xs leading-relaxed mb-2" style="color:#525252; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;" x-text="note.content"></p>

                                    <!-- フッター: タグ + 理解度 -->
                                    <div class="flex items-center justify-between flex-wrap gap-2">
                                        <div class="flex items-center gap-1.5 flex-wrap">
                                            <template x-for="t in (note.tags || [])" :key="t">
                                                <span class="tag" @click="activeTag = t" x-text="t"></span>
                                            </template>
                                        </div>
                                        <div x-show="note.stars > 0" class="flex items-center gap-0.5">
                                            <span class="text-xs" style="color:#a3a3a3;">理解度</span>
                                            <template x-for="i in 5" :key="i">
                                                <span :class="i <= (note.stars || 0) ? 'star' : 'star-empty'">&#9733;</span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- 空状態 -->
                    <div x-show="filteredNotes.length === 0 && !loading" class="empty-state">
                        <div><i class="fas fa-book-open"></i></div>
                        <p x-show="searchQuery || activeTag">条件に一致するノートが見つかりません</p>
                        <p x-show="!searchQuery && !activeTag">まだ公開ノートがありません</p>
                        <p x-show="!searchQuery && !activeTag" class="text-xs" style="color:#a3a3a3;">マイページからノートを書いて「コミュニティに公開」してみましょう</p>
                        <div class="mt-3" x-show="searchQuery || activeTag">
                            <button class="sort-btn" @click="searchQuery = ''; activeTag = ''">フィルタをリセット</button>
                        </div>
                        <div class="mt-3" x-show="!searchQuery && !activeTag">
                            <a href="/mypage" class="sort-btn" style="text-decoration:none; display:inline-block;">
                                <i class="fas fa-pen mr-1" style="font-size:10px;"></i>ノートを書く
                            </a>
                        </div>
                    </div>

                    <!-- もっと読み込むボタン -->
                    <div x-show="hasMore && filteredNotes.length > 0" class="text-center py-4">
                        <button class="load-more-btn" @click="loadMore()" :disabled="loadingMore">
                            <span x-show="!loadingMore">もっと読み込む</span>
                            <span x-show="loadingMore"><i class="fas fa-spinner fa-spin mr-1"></i>読み込み中...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function communityApp() {
    return {
        notes: [],
        tags: [],
        searchQuery: '',
        sortBy: 'date',
        activeTag: '',
        loading: true,
        loadingMore: false,
        hasMore: false,
        offset: 0,
        limit: 50,

        async init() {
            await Promise.all([this.loadNotes(), this.loadTags()]);
        },

        async loadNotes() {
            this.loading = true;
            try {
                const res = await fetch('/api/notes?limit=' + this.limit + '&offset=0');
                const data = await res.json();
                if (data.notes) {
                    this.notes = data.notes;
                    this.offset = data.notes.length;
                    this.hasMore = data.notes.length >= this.limit;
                }
            } catch (e) {
                console.error('公開ノート取得エラー:', e);
            }
            this.loading = false;
        },

        async loadMore() {
            this.loadingMore = true;
            try {
                const res = await fetch('/api/notes?limit=' + this.limit + '&offset=' + this.offset);
                const data = await res.json();
                if (data.notes && data.notes.length > 0) {
                    this.notes = [...this.notes, ...data.notes];
                    this.offset += data.notes.length;
                    this.hasMore = data.notes.length >= this.limit;
                } else {
                    this.hasMore = false;
                }
            } catch (e) {
                console.error('追加読み込みエラー:', e);
            }
            this.loadingMore = false;
        },

        async loadTags() {
            try {
                const res = await fetch('/api/notes/tags');
                const data = await res.json();
                if (data.tags) {
                    this.tags = data.tags;
                }
            } catch (e) {
                console.error('タグ取得エラー:', e);
            }
        },

        get popularTags() {
            return this.tags.slice(0, 15);
        },

        get filteredNotes() {
            let result = [...this.notes];
            if (this.searchQuery) {
                const q = this.searchQuery.toLowerCase();
                result = result.filter(n =>
                    (n.title || '').toLowerCase().includes(q) ||
                    (n.company_code || '').includes(q) ||
                    (n.company_name || '').toLowerCase().includes(q) ||
                    (n.content || '').toLowerCase().includes(q) ||
                    (n.tags || []).some(t => t.toLowerCase().includes(q))
                );
            }
            if (this.activeTag) {
                result = result.filter(n => (n.tags || []).includes(this.activeTag));
            }
            if (this.sortBy === 'star') {
                result.sort((a, b) => (b.stars || 0) - (a.stars || 0));
            } else {
                result.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            return result;
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const now = new Date();
            const diff = now - d;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            if (hours < 1) return '数分前';
            if (hours < 24) return hours + '時間前';
            const days = Math.floor(hours / 24);
            if (days < 7) return days + '日前';
            return (d.getMonth() + 1) + '/' + d.getDate();
        },
    };
}
</script>
{% endblock %}
