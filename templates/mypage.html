{% extends "layout.html" %}

{% block title %}マイノート - Company Note{% endblock %}

{% block content %}
<style>
    .mypage {
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
    }
    .mypage-hero {
        background: #fafaf8;
        border-bottom: 1px solid #e8e8e4;
    }
    .mp-card {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 12px;
        transition: all 0.2s ease;
    }
    .mp-card:hover {
        border-color: #d4d4d4;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .note-card {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 10px;
        border-left: 3px solid #1b4332;
        padding: 12px 14px;
        transition: all 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        display: block;
        color: inherit;
    }
    .note-card:hover {
        border-color: #d4d4d4;
        border-left-color: #1b4332;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .section-head {
        font-size: 13px;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
    }
    .section-head i { color: #2d6a4f; font-size: 12px; }
    .tag {
        display: inline-block;
        padding: 1px 7px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        background: #f0fdf4;
        color: #15803d;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tag:hover { background: #dcfce7; }
    .tag.active { background: #1b4332; color: #fff; }
    .btn-sm-green {
        background: #1b4332; color: #fff; border: none;
        border-radius: 6px; padding: 5px 12px;
        font-size: 12px; font-weight: 500; cursor: pointer;
        transition: background 0.2s;
    }
    .btn-sm-green:hover { background: #2d6a4f; }
    .btn-sm-outline {
        background: transparent; color: #2d6a4f;
        border: 1px solid #d4d4d4; border-radius: 6px;
        padding: 5px 12px; font-size: 12px; font-weight: 500;
        cursor: pointer; transition: all 0.2s;
    }
    .btn-sm-outline:hover { border-color: #2d6a4f; background: #f0fdf4; }
    .star { color: #eab308; font-size: 11px; }
    .star-empty { color: #d4d4d4; font-size: 11px; }
    .sort-btn {
        font-size: 11px; padding: 3px 8px; border-radius: 5px;
        border: 1px solid #ebebeb; background: #fff; color: #525252;
        cursor: pointer; transition: all 0.15s;
    }
    .sort-btn:hover, .sort-btn.active { border-color: #2d6a4f; color: #1b4332; background: #f0fdf4; }
    .empty-state {
        text-align: center; padding: 24px 16px;
    }
    .empty-state i { font-size: 28px; color: #d4d4d4; margin-bottom: 8px; }
    .empty-state p { font-size: 12px; color: #a3a3a3; margin-bottom: 10px; }
    /* モーダル */
    .modal-overlay {
        position: fixed; inset: 0; z-index: 9999;
        background: rgba(0,0,0,0.4);
        display: flex; align-items: center; justify-content: center;
    }
    .modal-content {
        background: #fff; border-radius: 12px;
        padding: 24px 28px; max-width: 560px; width: 92%;
        max-height: 85vh; overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .form-label {
        display: block; font-size: 12px; font-weight: 600;
        color: #525252; margin-bottom: 4px;
    }
    .form-input {
        width: 100%; padding: 8px 12px;
        border: 1px solid #ebebeb; border-radius: 8px;
        font-size: 13px; color: #1a1a1a; background: #fff;
        outline: none; transition: border-color 0.2s;
        box-sizing: border-box;
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
    }
    .form-input:focus { border-color: #2d6a4f; }
    .form-textarea {
        width: 100%; padding: 8px 12px;
        border: 1px solid #ebebeb; border-radius: 8px;
        font-size: 13px; color: #1a1a1a; background: #fff;
        outline: none; resize: vertical; min-height: 120px;
        transition: border-color 0.2s;
    }
    .form-textarea:focus { border-color: #2d6a4f; }
    .star-input { cursor: pointer; font-size: 18px; transition: color 0.15s; }
    .toggle-switch {
        position: relative; width: 36px; height: 20px;
        background: #d4d4d4; border-radius: 10px;
        cursor: pointer; transition: background 0.2s;
    }
    .toggle-switch.on { background: #1b4332; }
    .toggle-switch .toggle-dot {
        position: absolute; top: 2px; left: 2px;
        width: 16px; height: 16px; background: #fff;
        border-radius: 50%; transition: left 0.2s;
    }
    .toggle-switch.on .toggle-dot { left: 18px; }
    .note-actions {
        display: flex; gap: 4px; opacity: 0;
        transition: opacity 0.15s;
    }
    .note-card:hover .note-actions { opacity: 1; }
    .note-action-btn {
        padding: 2px 6px; border-radius: 4px; border: none;
        background: transparent; cursor: pointer; font-size: 11px;
        color: #a3a3a3; transition: all 0.15s;
    }
    .note-action-btn:hover { background: #f0fdf4; color: #1b4332; }
    .note-action-btn.delete:hover { background: #fef2f2; color: #dc2626; }

    /* デモ売買スタイル */
    .demo-summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }
    .demo-summary-card {
        background: #f8faf8;
        border: 1px solid #ebebeb;
        border-radius: 10px;
        padding: 14px 16px;
    }
    .demo-summary-label {
        font-size: 11px;
        font-weight: 500;
        color: #737373;
        margin-bottom: 4px;
    }
    .demo-summary-value {
        font-size: 15px;
        font-weight: 700;
        color: #1a1a1a;
        letter-spacing: -0.01em;
        font-variant-numeric: tabular-nums;
    }
    .demo-summary-value.loading-placeholder {
        color: #a3a3a3;
        font-size: 12px;
        font-weight: 400;
    }
    .demo-action-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .demo-btn-buy {
        padding: 7px 16px;
        background: #1b4332;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .demo-btn-buy:hover { background: #2d6a4f; }
    .demo-btn-outline {
        padding: 7px 16px;
        background: #fff;
        color: #525252;
        border: 1px solid #ebebeb;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .demo-btn-outline:hover {
        border-color: #2d6a4f;
        color: #1b4332;
        background: #f0fdf4;
    }
    .demo-btn-outline.active {
        border-color: #2d6a4f;
        color: #1b4332;
        background: #f0fdf4;
    }
    .demo-btn-reset {
        margin-left: auto;
        padding: 5px 10px;
        background: none;
        color: #a3a3a3;
        border: 1px solid #ebebeb;
        border-radius: 5px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .demo-btn-reset:hover {
        color: #525252;
        border-color: #d4d4d4;
    }
    .demo-holdings-section {
        background: #fff;
        border: 1px solid #ebebeb;
        border-left: 3px solid #1b4332;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .demo-card-title {
        font-size: 13px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 14px;
        padding-left: 6px;
    }
    .demo-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .demo-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 12px;
    }
    .demo-table thead th {
        background: #fafaf8;
        font-weight: 600;
        color: #1a1a1a;
        padding: 8px 10px;
        text-align: left;
        border-bottom: 2px solid #ebebeb;
        white-space: nowrap;
        font-size: 11px;
    }
    .demo-table thead th:first-child { border-radius: 6px 0 0 0; }
    .demo-table thead th:last-child { border-radius: 0 6px 0 0; }
    .demo-table tbody td {
        padding: 8px 10px;
        border-bottom: 1px solid #ebebeb;
        color: #525252;
        vertical-align: middle;
    }
    .demo-table tbody tr:last-child td { border-bottom: none; }
    .demo-table tbody tr:hover td { background: #fafaf8; }
    .demo-table .col-code {
        font-weight: 600;
        color: #1b4332;
        white-space: nowrap;
    }
    .demo-table .col-name a {
        color: #1a1a1a;
        text-decoration: none;
        font-weight: 500;
    }
    .demo-table .col-name a:hover {
        color: #2d6a4f;
        text-decoration: underline;
    }
    .demo-table .col-num {
        text-align: right;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
    }
    .demo-table .col-reason {
        max-width: 180px;
        font-size: 11px;
        color: #737373;
        line-height: 1.5;
    }
    .demo-table .col-action { text-align: center; white-space: nowrap; }
    .demo-btn-sell-sm {
        padding: 4px 10px;
        background: none;
        color: #525252;
        border: 1px solid #ebebeb;
        border-radius: 5px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .demo-btn-sell-sm:hover {
        border-color: #2d6a4f;
        color: #1b4332;
        background: #f0fdf4;
    }
    .demo-empty-state {
        text-align: center;
        padding: 32px 16px;
    }
    .demo-empty-state-icon {
        font-size: 24px;
        color: #d4d4d4;
        margin-bottom: 8px;
    }
    .demo-empty-state p {
        font-size: 12px;
        color: #a3a3a3;
    }
    .demo-history-section {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .demo-trade-type-buy {
        color: #2d6a4f;
        font-weight: 600;
    }
    .demo-trade-type-sell {
        color: #6b7280;
        font-weight: 600;
    }
    .demo-trade-type-deposit {
        color: #0369a1;
        font-weight: 600;
    }
    /* デモ売買モーダル */
    .demo-modal-card {
        background: #fff;
        border-radius: 12px;
        padding: 24px 28px;
        max-width: 480px;
        width: 92%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .demo-modal-title {
        font-size: 15px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 16px;
    }
    .demo-form-group { margin-bottom: 14px; }
    .demo-form-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 5px;
    }
    .demo-form-helper {
        font-size: 11px;
        color: #a3a3a3;
        margin-top: 3px;
        line-height: 1.5;
    }
    .demo-form-info {
        font-size: 12px;
        color: #525252;
        padding: 10px 12px;
        background: #fafaf8;
        border-radius: 8px;
        margin-bottom: 14px;
    }
    .demo-form-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
    }
    .demo-form-info-label {
        color: #737373;
        font-size: 11px;
    }
    .demo-form-info-value {
        font-weight: 600;
        font-variant-numeric: tabular-nums;
    }
    .demo-modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 18px;
    }
    .demo-btn-cancel {
        padding: 7px 16px;
        background: #f3f4f6;
        color: #525252;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    .demo-btn-cancel:hover { background: #e5e7eb; }
    .demo-btn-confirm {
        padding: 7px 16px;
        background: #1b4332;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .demo-btn-confirm:hover { background: #2d6a4f; }
    .demo-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
    /* オートコンプリート */
    .demo-autocomplete-wrapper { position: relative; }
    .demo-suggest-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ebebeb;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10100;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .demo-suggest-option {
        padding: 7px 12px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        gap: 6px;
        align-items: center;
        transition: background 0.15s;
    }
    .demo-suggest-option:hover,
    .demo-suggest-option.highlighted { background: #f0f7f4; }
    .demo-suggest-option-code {
        font-weight: 600;
        color: #1b4332;
        min-width: 40px;
    }
    .demo-suggest-option-name {
        color: #737373;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .demo-loading-spinner-sm {
        width: 14px;
        height: 14px;
        border: 2px solid #ebebeb;
        border-top-color: #1b4332;
        border-radius: 50%;
        animation: demoSpin 0.8s linear infinite;
        display: inline-block;
    }
    @keyframes demoSpin {
        to { transform: rotate(360deg); }
    }
    textarea.form-input {
        resize: vertical;
        min-height: 60px;
    }
    /* デモタブ切り替え */
    .demo-tab-btn {
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 500;
        color: #a3a3a3;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        cursor: pointer;
        transition: color 0.15s, border-color 0.15s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .demo-tab-btn:hover {
        color: #525252;
    }
    .demo-tab-btn.active {
        color: #1b4332;
        border-bottom-color: #1b4332;
        font-weight: 600;
    }
    /* 売買分析スタイル */
    .demo-analysis-section {
        background: #fff;
        border: 1px solid #ebebeb;
        border-left: 3px solid #2d6a4f;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .demo-analysis-section .demo-card-title {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .demo-analysis-section .demo-card-title i {
        color: #2d6a4f;
        font-size: 12px;
    }
    .analysis-chart-container {
        position: relative;
        width: 100%;
        height: 220px;
        margin-top: 8px;
    }
    .analysis-reason-item {
        padding: 10px 14px;
        border: 1px solid #ebebeb;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #fafaf8;
    }
    .analysis-reason-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        font-size: 11px;
        color: #737373;
    }
    .analysis-reason-text {
        font-size: 12px;
        color: #525252;
        line-height: 1.6;
    }
    @media (max-width: 768px) {
        .demo-summary-grid {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        .demo-summary-card { padding: 10px 14px; }
        .demo-summary-value { font-size: 13px; }
        .demo-table { font-size: 11px; }
        .demo-table thead th,
        .demo-table tbody td { padding: 6px 6px; }
        .demo-table .col-reason { max-width: 100px; }
        .demo-modal-card { padding: 18px 18px; width: 95%; }
        .analysis-chart-container { height: 180px; }
    }
</style>

<div class="mypage min-h-screen" style="background: #f7f7f5;" x-data="mypageApp()" x-cloak>

    <!-- ヘッダー（コンパクト） -->
    <div class="mypage-hero">
        <div class="max-w-7xl mx-auto px-6 py-5">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <!-- 左: プロフィール -->
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 w-11 h-11 rounded-full flex items-center justify-center text-sm font-bold text-white" style="background: #1b4332;" x-text="userId.slice(-2).toUpperCase()"></div>
                    <div>
                        <p class="text-xs font-semibold tracking-widest uppercase" style="color: #16a34a;">My Note</p>
                        <h1 class="text-lg font-bold leading-tight" style="color: #1a1a1a;">マイノート</h1>
                    </div>
                </div>
                <!-- 右: 学習ステータス -->
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <div class="text-lg font-bold" style="color:#1b4332;" x-text="notes.length"></div>
                        <div class="text-xs" style="color:#737373;">ノート数</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold" style="color:#1b4332;" x-text="uniqueCompanies"></div>
                        <div class="text-xs" style="color:#737373;">研究企業</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold" style="color:#1b4332;" x-text="publicCount"></div>
                        <div class="text-xs" style="color:#737373;">公開ノート</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ダッシュボード本体 -->
    <div class="max-w-7xl mx-auto px-6 py-5">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">

            <!-- ===== マイノートカード ===== -->
            <div class="lg:col-span-5 mp-card p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="section-head mb-0"><i class="fas fa-book"></i>マイノート</h2>
                            <button class="btn-sm-green" @click="openCreateModal()"><i class="fas fa-plus mr-1" style="font-size:10px;"></i>作成</button>
                        </div>

                        <!-- ソート＆フィルタ -->
                        <div class="mb-3 flex items-center gap-2 flex-wrap">
                            <!-- 検索 -->
                            <div style="position:relative; flex:1; min-width:120px;">
                                <i class="fas fa-search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#a3a3a3; font-size:12px;"></i>
                                <input type="text" placeholder="ノートを検索..." x-model="noteSearch" class="form-input" style="padding-left:32px;" autocomplete="off" name="note-search-noautofill">
                            </div>
                            <!-- ソートボタン -->
                            <div class="flex items-center gap-1">
                                <button class="sort-btn" :class="{ 'active': noteSort === 'date' }" @click="noteSort = 'date'">
                                    <i class="fas fa-clock mr-0.5" style="font-size:9px;"></i>新しい順
                                </button>
                                <button class="sort-btn" :class="{ 'active': noteSort === 'star' }" @click="noteSort = 'star'">
                                    <i class="fas fa-star mr-0.5" style="font-size:9px;"></i>評価順
                                </button>
                            </div>
                        </div>

                        <!-- ローディング -->
                        <div x-show="loading" class="empty-state">
                            <div><i class="fas fa-spinner fa-spin" style="font-size:24px; color:#2d6a4f;"></i></div>
                            <p>ノートを読み込み中...</p>
                        </div>

                        <!-- ノート一覧 -->
                        <div class="space-y-2" x-show="!loading">
                            <template x-for="note in filteredNotes" :key="note.id">
                                <div class="note-card" @click="openEditModal(note)">
                                    <div class="flex items-start justify-between mb-1">
                                        <div style="min-width:0; flex:1;">
                                            <span class="text-sm font-bold" style="color:#1a1a1a;" x-text="note.title"></span>
                                            <span class="text-xs ml-1.5" style="color:#a3a3a3;" x-text="note.company_name ? note.company_name + ' (' + note.company_code + ')' : ''"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span x-show="note.is_public" class="text-xs px-1.5 py-0.5 rounded" style="background:#f0fdf4; color:#15803d; font-size:10px;">公開</span>
                                            <span>
                                                <template x-for="i in 5" :key="i">
                                                    <span :class="i <= (note.stars || 0) ? 'star' : 'star-empty'">&#9733;</span>
                                                </template>
                                            </span>
                                            <!-- 操作ボタン -->
                                            <div class="note-actions">
                                                <button class="note-action-btn delete" @click.stop="confirmDelete(note)" title="削除">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs leading-relaxed mb-1.5" style="color:#525252; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;" x-text="note.content"></p>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-1.5">
                                            <template x-for="t in (note.tags || [])" :key="t">
                                                <span class="tag" x-text="t" style="cursor:default;"></span>
                                            </template>
                                        </div>
                                        <span class="text-xs" style="color:#a3a3a3;" x-text="formatDate(note.created_at)"></span>
                                    </div>
                                </div>
                            </template>

                            <!-- 空状態 -->
                            <div x-show="filteredNotes.length === 0 && !loading" class="empty-state">
                                <div><i class="fas fa-book-open"></i></div>
                                <p x-show="noteSearch || activeTag">条件に一致するノートが見つかりません</p>
                                <p x-show="!noteSearch && !activeTag">まだノートがありません</p>
                                <button x-show="noteSearch || activeTag" class="btn-sm-outline" @click="noteSearch = ''; activeTag = ''">フィルタをリセット</button>
                                <button x-show="!noteSearch && !activeTag" class="btn-sm-green" @click="openCreateModal()">
                                    <i class="fas fa-plus mr-1" style="font-size:10px;"></i>最初のノートを作成
                                </button>
                            </div>
                        </div>
            </div>

            <!-- ===== デモ売買カード ===== -->
            <div class="lg:col-span-7 mp-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="section-head mb-0"><i class="fas fa-flask"></i>デモ売買</h2>
                </div>
                <!-- 説明文 -->
                        <div style="margin-bottom: 14px;">
                            <p class="text-xs" style="color:#737373;">仮想資金で売買を体験し、投資判断力を磨きましょう</p>
                            <p class="text-xs" style="color:#a3a3a3; margin-top:2px;">※ デモ用の参考価格です（最終分析時の株価を使用）</p>
                        </div>

                        <!-- デモローディング -->
                        <div x-show="!demoLoaded" class="demo-empty-state">
                            <div><i class="fas fa-spinner fa-spin" style="font-size:20px; color:#2d6a4f;"></i></div>
                            <p style="margin-top:8px;">デモ口座を読み込み中...</p>
                        </div>

                        <div x-show="demoLoaded">
                            <!-- アカウントサマリー -->
                            <div class="demo-summary-grid">
                                <div class="demo-summary-card">
                                    <div class="demo-summary-label">現金残高</div>
                                    <div class="demo-summary-value">
                                        <template x-if="demoAccountLoaded">
                                            <span x-text="formatYen(demoAccount.cash_balance)"></span>
                                        </template>
                                        <template x-if="!demoAccountLoaded">
                                            <span class="loading-placeholder">---</span>
                                        </template>
                                    </div>
                                </div>
                                <div class="demo-summary-card">
                                    <div class="demo-summary-label">保有銘柄合計</div>
                                    <div class="demo-summary-value">
                                        <template x-if="demoAccountLoaded">
                                            <span x-text="formatYen(demoAccount.total_value)"></span>
                                        </template>
                                        <template x-if="!demoAccountLoaded">
                                            <span class="loading-placeholder">---</span>
                                        </template>
                                    </div>
                                </div>
                                <div class="demo-summary-card">
                                    <div class="demo-summary-label">総資産</div>
                                    <div class="demo-summary-value">
                                        <template x-if="demoAccountLoaded">
                                            <span x-text="formatYen(demoAccount.total_assets)"></span>
                                        </template>
                                        <template x-if="!demoAccountLoaded">
                                            <span class="loading-placeholder">---</span>
                                        </template>
                                    </div>
                                </div>
                                <div class="demo-summary-card">
                                    <div class="demo-summary-label">原資（入金合計）</div>
                                    <div class="demo-summary-value">
                                        <template x-if="demoAccountLoaded">
                                            <span x-text="formatYen(demoAccount.total_deposited)"></span>
                                        </template>
                                        <template x-if="!demoAccountLoaded">
                                            <span class="loading-placeholder">---</span>
                                        </template>
                                    </div>
                                </div>
                                <div class="demo-summary-card">
                                    <div class="demo-summary-label">収益</div>
                                    <div class="demo-summary-value">
                                        <template x-if="demoAccountLoaded">
                                            <span
                                                x-text="(demoAccount.profit >= 0 ? '+' : '') + formatYen(demoAccount.profit)"
                                                :style="demoAccount.profit > 0 ? 'color:#2d6a4f' : demoAccount.profit < 0 ? 'color:#b91c1c' : ''"
                                            ></span>
                                        </template>
                                        <template x-if="!demoAccountLoaded">
                                            <span class="loading-placeholder">---</span>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- アクションボタン行 -->
                            <div class="demo-action-row">
                                <button class="demo-btn-buy" @click="openDemoBuyModal()">
                                    <i class="fas fa-plus" style="font-size:10px;"></i>
                                    購入する
                                </button>
                                <button class="demo-btn-outline" @click="openDemoDepositModal()">
                                    <i class="fas fa-wallet" style="font-size:10px;"></i>
                                    資金追加
                                </button>
                                <button class="demo-btn-reset" @click="confirmDemoReset()">
                                    <i class="fas fa-undo" style="font-size:9px; margin-right:2px;"></i>
                                    リセット
                                </button>
                            </div>

                            <!-- タブ切り替え -->
                            <div style="display:flex; gap:0; border-bottom:2px solid #ebebeb; margin-bottom:16px;">
                                <button class="demo-tab-btn" :class="{ 'active': demoActiveTab === 'holdings' }" @click="switchDemoTab('holdings')">
                                    <i class="fas fa-briefcase" style="font-size:10px;"></i> 保有銘柄
                                </button>
                                <button class="demo-tab-btn" :class="{ 'active': demoActiveTab === 'history' }" @click="switchDemoTab('history')">
                                    <i class="fas fa-list" style="font-size:10px;"></i> 売買履歴
                                </button>
                                <button class="demo-tab-btn" :class="{ 'active': demoActiveTab === 'analysis' }" @click="switchDemoTab('analysis')">
                                    <i class="fas fa-chart-bar" style="font-size:10px;"></i> 売買分析
                                </button>
                            </div>

                            <!-- 保有銘柄テーブル -->
                            <div class="demo-holdings-section" x-show="demoActiveTab === 'holdings'">
                                <div style="display:flex; align-items:center; justify-content:flex-end; margin-bottom:14px;">
                                    <button class="demo-btn-outline" @click="fetchAllLivePrices()" :disabled="livePriceLoading" style="padding:5px 12px; font-size:11px;">
                                        <template x-if="!livePriceLoading">
                                            <span><i class="fas fa-sync-alt" style="font-size:9px; margin-right:3px;"></i>現在株価を取得</span>
                                        </template>
                                        <template x-if="livePriceLoading">
                                            <span><i class="fas fa-spinner fa-spin" style="font-size:9px; margin-right:3px;"></i>取得中...</span>
                                        </template>
                                    </button>
                                </div>

                                <template x-if="demoAccountLoaded && demoAccount.holdings && demoAccount.holdings.length > 0">
                                    <div class="demo-table-wrapper">
                                        <table class="demo-table">
                                            <thead>
                                                <tr>
                                                    <th>銘柄コード</th>
                                                    <th>会社名</th>
                                                    <th style="text-align:right;">保有数</th>
                                                    <th style="text-align:right;">平均取得単価</th>
                                                    <th style="text-align:right;">参考価格</th>
                                                    <th style="text-align:right;">評価額</th>
                                                    <th>購入理由メモ</th>
                                                    <th style="text-align:center;">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="(h, idx) in demoAccount.holdings" :key="h.company_code">
                                                    <tr>
                                                        <td class="col-code" x-text="h.company_code"></td>
                                                        <td class="col-name">
                                                            <a :href="'/stock/' + h.company_code" x-text="h.company_name || '\u2014'"></a>
                                                        </td>
                                                        <td class="col-num" x-text="formatNumber(h.shares)"></td>
                                                        <td class="col-num" x-text="formatYen(h.avg_cost)"></td>
                                                        <td class="col-num" x-text="h.current_price != null ? formatYen(h.current_price) : '\u2014'"></td>
                                                        <td class="col-num" x-text="h.market_value != null ? formatYen(h.market_value) : '\u2014'"></td>
                                                        <td class="col-reason" x-text="h.buy_reason || '\u2014'"></td>
                                                        <td class="col-action">
                                                            <button class="demo-btn-sell-sm" @click="openDemoSellModal(h)">売却</button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>

                                <template x-if="demoAccountLoaded && (!demoAccount.holdings || demoAccount.holdings.length === 0)">
                                    <div class="demo-empty-state">
                                        <div class="demo-empty-state-icon">
                                            <i class="fas fa-folder-open"></i>
                                        </div>
                                        <p>保有銘柄はありません。購入してみましょう。</p>
                                    </div>
                                </template>

                                <template x-if="!demoAccountLoaded">
                                    <div class="demo-empty-state">
                                        <div class="demo-loading-spinner-sm" style="width:24px; height:24px; border-width:3px; margin:0 auto 10px;"></div>
                                        <p>読み込み中...</p>
                                    </div>
                                </template>
                            </div>

                            <!-- 売買履歴パネル -->
                            <div class="demo-history-section" x-show="demoActiveTab === 'history'" x-cloak>

                                <template x-if="demoHistoryLoaded && demoTrades.length > 0">
                                    <div class="demo-table-wrapper">
                                        <table class="demo-table">
                                            <thead>
                                                <tr>
                                                    <th>日時</th>
                                                    <th>銘柄</th>
                                                    <th>売買区分</th>
                                                    <th style="text-align:right;">株数</th>
                                                    <th style="text-align:right;">単価</th>
                                                    <th style="text-align:right;">金額</th>
                                                    <th>理由メモ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="(t, idx) in demoTrades" :key="idx">
                                                    <tr>
                                                        <td style="white-space:nowrap; font-size:11px;" x-text="formatDemoDate(t.traded_at)"></td>
                                                        <td>
                                                            <span class="col-code" x-text="t.company_code" style="margin-right:4px;"></span>
                                                            <span style="color:#525252; font-size:11px;" x-text="t.company_name || ''"></span>
                                                        </td>
                                                        <td>
                                                            <span :class="t.trade_type === 'buy' ? 'demo-trade-type-buy' : t.trade_type === 'sell' ? 'demo-trade-type-sell' : 'demo-trade-type-deposit'"
                                                                x-text="t.trade_type === 'buy' ? '購入' : t.trade_type === 'sell' ? '売却' : '入金'"></span>
                                                        </td>
                                                        <td class="col-num" x-text="t.trade_type === 'deposit' ? '\u2014' : formatNumber(t.shares)"></td>
                                                        <td class="col-num" x-text="t.trade_type === 'deposit' ? '\u2014' : formatYen(t.price)"></td>
                                                        <td class="col-num" x-text="formatYen(t.total_amount)"></td>
                                                        <td class="col-reason" x-text="t.reason || '\u2014'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>

                                <template x-if="demoHistoryLoaded && demoTrades.length === 0">
                                    <div class="demo-empty-state">
                                        <div class="demo-empty-state-icon">
                                            <i class="fas fa-receipt"></i>
                                        </div>
                                        <p>売買履歴はまだありません。</p>
                                    </div>
                                </template>

                                <template x-if="!demoHistoryLoaded">
                                    <div class="demo-empty-state">
                                        <div class="demo-loading-spinner-sm" style="width:24px; height:24px; border-width:3px; margin:0 auto 10px;"></div>
                                        <p>読み込み中...</p>
                                    </div>
                                </template>
                            </div>

                            <!-- 売買分析パネル -->
                            <div class="demo-analysis-section" x-show="demoActiveTab === 'analysis'" x-cloak>

                                <!-- データなし -->
                                <template x-if="demoHistoryLoaded && demoTrades.length === 0">
                                    <div class="demo-empty-state">
                                        <div class="demo-empty-state-icon"><i class="fas fa-chart-pie"></i></div>
                                        <p>売買履歴がありません。取引を行うと分析が表示されます。</p>
                                    </div>
                                </template>

                                <!-- データあり -->
                                <template x-if="demoHistoryLoaded && demoTrades.length > 0">
                                    <div>
                                        <!-- A. 取引サマリーカード（コメントアウト中） -->
                                        <!--
                                        <div class="demo-summary-grid" style="margin-top:12px;">
                                            <div class="demo-summary-card">
                                                <div class="demo-summary-label">総取引回数</div>
                                                <div class="demo-summary-value" x-text="getAnalysisData().totalCount + ' 回'"></div>
                                                <div style="font-size:11px; color:#737373; margin-top:2px;">
                                                    購入 <span style="color:#2d6a4f; font-weight:600;" x-text="getAnalysisData().buyCount"></span>回 / 売却 <span style="color:#6b7280; font-weight:600;" x-text="getAnalysisData().sellCount"></span>回
                                                </div>
                                            </div>
                                            <div class="demo-summary-card">
                                                <div class="demo-summary-label">取引銘柄数</div>
                                                <div class="demo-summary-value" x-text="getAnalysisData().uniqueStockCount + ' 銘柄'"></div>
                                            </div>
                                            <div class="demo-summary-card">
                                                <div class="demo-summary-label">取引活動期間</div>
                                                <div class="demo-summary-value" style="font-size:13px;" x-text="getAnalysisData().activityPeriod"></div>
                                            </div>
                                        </div>
                                        -->
                                        <!-- 損益サマリー -->
                                        <div class="demo-summary-grid" style="grid-template-columns: repeat(2, 1fr);">
                                            <div class="demo-summary-card">
                                                <div class="demo-summary-label">実現損益（売却済み）</div>
                                                <div class="demo-summary-value" :style="{ color: getAnalysisData().totalRealizedPL >= 0 ? '#1b4332' : '#9a3412' }" x-text="formatPL(getAnalysisData().totalRealizedPL)"></div>
                                                <div style="font-size:10px; color:#a3a3a3; margin-top:2px;">売却完了した取引の損益合計</div>
                                            </div>
                                            <div class="demo-summary-card">
                                                <div class="demo-summary-label">含み損益（保有中）</div>
                                                <template x-if="getAnalysisData().hasUnrealized">
                                                    <div>
                                                        <div class="demo-summary-value" :style="{ color: getAnalysisData().totalUnrealizedPL >= 0 ? '#1b4332' : '#9a3412' }" x-text="formatPL(getAnalysisData().totalUnrealizedPL)"></div>
                                                        <div style="font-size:10px; color:#a3a3a3; margin-top:2px;">現在の参考価格との差額</div>
                                                    </div>
                                                </template>
                                                <template x-if="!getAnalysisData().hasUnrealized">
                                                    <div>
                                                        <div class="demo-summary-value" style="color:#a3a3a3; font-size:12px; font-weight:400;">株価未取得</div>
                                                        <div style="font-size:10px; color:#a3a3a3; margin-top:2px;">「現在株価を取得」で更新してください</div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- B. 銘柄別取引まとめテーブル -->
                                        <div style="margin-bottom:16px;">
                                            <div style="font-size:12px; font-weight:600; color:#1a1a1a; margin-bottom:8px; padding-left:2px;">銘柄別取引まとめ</div>
                                            <div class="demo-table-wrapper">
                                                <table class="demo-table">
                                                    <thead>
                                                        <tr>
                                                            <th>銘柄コード</th>
                                                            <th>会社名</th>
                                                            <th style="text-align:right;">購入回数</th>
                                                            <th style="text-align:right;">売却回数</th>
                                                            <th style="text-align:right;">平均取得単価</th>
                                                            <th style="text-align:right;">実現損益</th>
                                                            <th>最新メモ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <template x-for="stock in getAnalysisData().byStock" :key="stock.code">
                                                            <tr>
                                                                <td class="col-code" x-text="stock.code"></td>
                                                                <td class="col-name"><a :href="'/stock/' + stock.code" x-text="stock.name || '\u2014'"></a></td>
                                                                <td class="col-num" x-text="stock.buyCount"></td>
                                                                <td class="col-num" x-text="stock.sellCount"></td>
                                                                <td class="col-num" x-text="stock.avgBuyPrice > 0 ? formatYen(Math.round(stock.avgBuyPrice)) : '\u2014'"></td>
                                                                <td class="col-num" :style="{ color: stock.realizedPL > 0 ? '#1b4332' : stock.realizedPL < 0 ? '#9a3412' : '#737373' }" x-text="stock.sellCount > 0 ? formatPL(stock.realizedPL) : '\u2014'"></td>
                                                                <td class="col-reason" x-text="stock.latestReason || '\u2014'"></td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- C. 資産推移・実現損益チャート -->
                                        <div style="margin-bottom:16px;">
                                            <div style="font-size:12px; font-weight:600; color:#1a1a1a; margin-bottom:8px; padding-left:2px;">総資産・実現損益の推移</div>
                                            <div class="analysis-chart-container">
                                                <canvas x-ref="analysisChart"></canvas>
                                            </div>
                                        </div>

                                        <!-- D. 購入理由ふりかえりリスト -->
                                        <template x-if="getAnalysisData().reasonList.length > 0">
                                            <div>
                                                <div style="font-size:12px; font-weight:600; color:#1a1a1a; margin-bottom:8px; padding-left:2px;">判断理由ふりかえり</div>
                                                <template x-for="(r, idx) in getAnalysisData().reasonList" :key="idx">
                                                    <div class="analysis-reason-item">
                                                        <div class="analysis-reason-meta">
                                                            <span x-text="formatDemoDate(r.traded_at)"></span>
                                                            <span style="font-weight:600; color:#1b4332;" x-text="r.company_code"></span>
                                                            <span :class="r.trade_type === 'buy' ? 'demo-trade-type-buy' : r.trade_type === 'sell' ? 'demo-trade-type-sell' : 'demo-trade-type-deposit'"
                                                                x-text="r.trade_type === 'buy' ? '購入' : r.trade_type === 'sell' ? '売却' : '入金'"></span>
                                                        </div>
                                                        <div class="analysis-reason-text" x-text="r.reason"></div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- ローディング -->
                                <template x-if="!demoHistoryLoaded">
                                    <div class="demo-empty-state">
                                        <div class="demo-loading-spinner-sm" style="width:24px; height:24px; border-width:3px; margin:0 auto 10px;"></div>
                                        <p>分析データを読み込み中...</p>
                                    </div>
                                </template>
                            </div>
                        </div>
            </div>

            <!-- ===== 紹介コードカード ===== -->
            <template x-if="referralCode">
                <div class="lg:col-span-12 mp-card p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="section-head mb-0"><i class="fas fa-share-alt"></i>紹介リンク</h2>
                    </div>
                    <p class="text-xs mb-3" style="color:#737373;">お客様にこのリンクを共有すると、紹介コードが自動入力された状態で登録ページが開きます</p>

                    <!-- 紹介コード表示 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:stretch;">
                        <!-- コード -->
                        <div style="flex:0 0 auto;">
                            <div class="text-xs font-semibold mb-1" style="color:#525252;">紹介コード</div>
                            <div style="background:#f7f7f5; border:1px solid #ebebeb; border-radius:8px; padding:10px 16px; font-size:18px; font-weight:700; letter-spacing:2px; color:#1b4332; text-align:center;"
                                x-text="referralCode"></div>
                        </div>
                        <!-- リンク＋コピー -->
                        <div style="flex:1; min-width:200px;">
                            <div class="text-xs font-semibold mb-1" style="color:#525252;">紹介リンク</div>
                            <div style="display:flex; gap:8px;">
                                <input type="text" class="form-input" :value="referralLink" readonly
                                    style="flex:1; font-size:13px; color:#525252; background:#f7f7f5; cursor:text;"
                                    @click="$el.select()">
                                <button class="btn-sm-green" @click="copyReferralLink()" style="white-space:nowrap; padding:8px 14px;">
                                    <i class="fas fa-copy mr-1" style="font-size:10px;"></i>
                                    <span x-text="referralCopied ? 'コピー済み' : 'コピー'"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 紹介人数（非表示）-->
                    <!--
                    <template x-if="referralCount !== null">
                        <div class="mt-3" style="font-size:12px; color:#737373;">
                            <i class="fas fa-users" style="margin-right:4px; font-size:10px;"></i>
                            紹介済み: <span style="font-weight:600; color:#1b4332;" x-text="referralCount + '人'"></span>
                        </div>
                    </template>
                    -->
                </div>
            </template>
        </div>
    </div>

    <!-- ===== ノート作成/編集モーダル ===== -->
    <div x-show="showModal" class="modal-overlay" @click.self="showModal = false" x-cloak>
        <div class="modal-content" @click.stop>
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-base font-bold" style="color:#1a1a1a;" x-text="editingNote ? 'ノートを編集' : '新しいノートを作成'"></h3>
                <button @click="showModal = false" style="color:#a3a3a3; background:none; border:none; cursor:pointer; font-size:16px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- 投稿名 -->
                <div x-show="form.is_public">
                    <label class="form-label">投稿名</label>
                    <input type="text" class="form-input" x-model="form.poster_name" placeholder="投稿時に表示される名前（空欄でデフォルト名を使用）" maxlength="30">
                    <p class="text-xs mt-1" style="color:#a3a3a3;">この投稿だけの表示名を設定できます</p>
                </div>

                <!-- タイトル -->
                <div>
                    <label class="form-label">タイトル <span style="color:#dc2626;">*</span></label>
                    <input type="text" class="form-input" x-model="form.title" placeholder="例: キーエンスの営業利益率の秘密">
                </div>

                <!-- 企業紐づけ（任意） -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="form-label">銘柄コード（任意）</label>
                        <input type="text" class="form-input" x-model="form.company_code" placeholder="例: 6861">
                    </div>
                    <div>
                        <label class="form-label">企業名（任意）</label>
                        <input type="text" class="form-input" x-model="form.company_name" placeholder="例: キーエンス">
                    </div>
                </div>

                <!-- 本文 -->
                <div>
                    <label class="form-label">本文 <span style="color:#dc2626;">*</span></label>
                    <textarea class="form-textarea" x-model="form.content" placeholder="企業への所感やメモを自由に書いてください..."></textarea>
                </div>

                <!-- 理解度 -->
                <div>
                    <label class="form-label">理解度</label>
                    <div class="flex items-center gap-1">
                        <template x-for="i in 5" :key="i">
                            <span class="star-input" :style="{ color: i <= form.stars ? '#eab308' : '#d4d4d4' }" @click="form.stars = i">&#9733;</span>
                        </template>
                        <button x-show="form.stars > 0" @click="form.stars = 0" class="text-xs ml-2" style="color:#a3a3a3; background:none; border:none; cursor:pointer;">クリア</button>
                    </div>
                </div>

                <!-- タグ -->
                <div>
                    <label class="form-label">タグ（カンマ区切り）</label>
                    <input type="text" class="form-input" x-model="form.tagsInput" placeholder="例: 高収益, IoT, ファブレス">
                </div>

                <!-- 公開設定 -->
                <div class="flex items-center justify-between p-3 rounded-lg" style="background:#f8faf8; border:1px solid #ebebeb;">
                    <div>
                        <p class="text-xs font-bold" style="color:#1a1a1a;">コミュニティに公開</p>
                        <p class="text-xs" style="color:#a3a3a3;">他のユーザーがあなたのノートを閲覧できます</p>
                    </div>
                    <div class="toggle-switch" :class="{ 'on': form.is_public }" @click="form.is_public = !form.is_public">
                        <div class="toggle-dot"></div>
                    </div>
                </div>

                <!-- 匿名設定 -->
                <div x-show="form.is_public" class="flex items-center justify-between p-3 rounded-lg" style="background:#f8faf8; border:1px solid #ebebeb;">
                    <div>
                        <p class="text-xs font-bold" style="color:#1a1a1a;">匿名で投稿</p>
                        <p class="text-xs" style="color:#a3a3a3;">投稿名を非表示にします</p>
                    </div>
                    <div class="toggle-switch" :class="{ 'on': form.is_anonymous }" @click="form.is_anonymous = !form.is_anonymous">
                        <div class="toggle-dot"></div>
                    </div>
                </div>
            </div>

            <!-- ボタン -->
            <div class="flex justify-end gap-2 mt-5" style="border-top:1px solid #ebebeb; padding-top:16px;">
                <button class="btn-sm-outline" @click="showModal = false">キャンセル</button>
                <button class="btn-sm-green" @click="saveNote()" :disabled="saving" style="padding:6px 20px;">
                    <span x-show="!saving" x-text="editingNote ? '更新する' : '作成する'"></span>
                    <span x-show="saving"><i class="fas fa-spinner fa-spin mr-1"></i>保存中...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== ノート削除確認モーダル ===== -->
    <div x-show="showDeleteConfirm" class="modal-overlay" @click.self="showDeleteConfirm = false" x-cloak>
        <div class="modal-content" style="max-width:380px; text-align:center;" @click.stop>
            <div style="margin-bottom:16px;">
                <i class="fas fa-trash-alt" style="font-size:32px; color:#dc2626;"></i>
            </div>
            <p class="text-sm font-bold mb-1" style="color:#1a1a1a;">ノートを削除しますか？</p>
            <p class="text-xs mb-4" style="color:#a3a3a3;">この操作は取り消せません</p>
            <div class="flex justify-center gap-2">
                <button class="btn-sm-outline" @click="showDeleteConfirm = false">キャンセル</button>
                <button class="btn-sm-green" @click="deleteNote()" style="background:#dc2626; padding:6px 20px;">削除する</button>
            </div>
        </div>
    </div>

    <!-- ===== デモ購入モーダル ===== -->
    <div class="modal-overlay" x-show="demoBuyModalOpen" x-cloak @click.self="closeDemoBuyModal()">
        <div class="demo-modal-card" @click.stop>
            <div class="demo-modal-title">銘柄を購入する</div>

            <!-- 企業選択 -->
            <div class="demo-form-group">
                <label class="demo-form-label">銘柄</label>
                <div class="demo-autocomplete-wrapper">
                    <input
                        type="text"
                        class="form-input"
                        placeholder="銘柄コードまたは企業名を入力"
                        x-model="demoBuyForm.query"
                        @input="onDemoBuyInput()"
                        @focus="onDemoBuyFocus()"
                        @blur="onDemoBuyBlur()"
                        @keydown="onDemoBuyKeydown($event)"
                        autocomplete="off"
                    >
                    <div class="demo-suggest-dropdown" x-show="demoBuyForm.showDropdown && demoBuyForm.filtered.length > 0" x-cloak>
                        <template x-for="(item, idx) in demoBuyForm.filtered" :key="item.c">
                            <div class="demo-suggest-option" :class="{ 'highlighted': demoBuyForm.highlightIndex === idx }" @mousedown.prevent="selectDemoBuyCompany(item)">
                                <span class="demo-suggest-option-code" x-text="item.c"></span>
                                <span class="demo-suggest-option-name" x-text="item.n"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- 参考価格表示 -->
            <template x-if="demoBuyForm.selectedCode">
                <div class="demo-form-info">
                    <div class="demo-form-info-row">
                        <span class="demo-form-info-label">参考価格</span>
                        <span class="demo-form-info-value">
                            <template x-if="demoBuyForm.priceLoading">
                                <span class="demo-loading-spinner-sm"></span>
                            </template>
                            <template x-if="!demoBuyForm.priceLoading">
                                <span x-text="demoBuyForm.refPrice != null ? formatYen(demoBuyForm.refPrice) : '\u2014'"></span>
                            </template>
                        </span>
                    </div>
                </div>
            </template>

            <!-- 既存保有情報 -->
            <template x-if="demoBuyForm.existingHolding">
                <div class="demo-form-info" style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:10px 14px;">
                    <div style="font-size:12px; font-weight:600; color:#1b4332; margin-bottom:6px;">この銘柄を保有中</div>
                    <div class="demo-form-info-row">
                        <span class="demo-form-info-label">保有株数</span>
                        <span class="demo-form-info-value" x-text="demoBuyForm.existingHolding.shares.toLocaleString('ja-JP') + ' 株'"></span>
                    </div>
                    <div class="demo-form-info-row">
                        <span class="demo-form-info-label">平均取得単価</span>
                        <span class="demo-form-info-value" x-text="demoBuyForm.existingHolding.avg_cost != null ? formatYen(demoBuyForm.existingHolding.avg_cost) : '\u2014'"></span>
                    </div>
                </div>
            </template>

            <!-- 株数 -->
            <div class="demo-form-group">
                <label class="demo-form-label">株数</label>
                <input type="number" class="form-input" placeholder="購入する株数を入力" x-model.number="demoBuyForm.shares" min="1" step="1">
            </div>

            <!-- 購入理由メモ -->
            <div class="demo-form-group">
                <label class="demo-form-label">購入理由メモ</label>
                <textarea class="form-input" placeholder="なぜこの企業に注目したのか、どんな点を評価したのか記録しましょう" x-model="demoBuyForm.reason" rows="3" style="resize:vertical; min-height:60px;"></textarea>
                <div class="demo-form-helper">なぜこの企業に注目したのか、どんな点を評価したのか記録しましょう</div>
            </div>

            <!-- 合計金額・残高 -->
            <template x-if="demoBuyForm.refPrice != null && demoBuyForm.shares > 0">
                <div class="demo-form-info">
                    <div class="demo-form-info-row">
                        <span class="demo-form-info-label">購入金額（税抜概算）</span>
                        <span class="demo-form-info-value" x-text="formatYen(demoBuyForm.refPrice * demoBuyForm.shares)"></span>
                    </div>
                    <div class="demo-form-info-row" style="border-top:1px solid #ebebeb; margin-top:4px; padding-top:6px;">
                        <span class="demo-form-info-label">現在の現金残高</span>
                        <span class="demo-form-info-value" x-text="formatYen(demoAccount.cash_balance)"></span>
                    </div>
                </div>
            </template>

            <div class="demo-modal-actions">
                <button class="demo-btn-cancel" @click="closeDemoBuyModal()">キャンセル</button>
                <button class="demo-btn-confirm" @click="executeDemoBuy()" :disabled="!canDemoBuy || demoBuyForm.submitting">
                    <template x-if="demoBuyForm.submitting">
                        <span><span class="demo-loading-spinner-sm" style="vertical-align:middle; margin-right:4px;"></span>処理中...</span>
                    </template>
                    <template x-if="!demoBuyForm.submitting">
                        <span>購入する</span>
                    </template>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== デモ売却モーダル ===== -->
    <div class="modal-overlay" x-show="demoSellModalOpen" x-cloak @click.self="closeDemoSellModal()">
        <div class="demo-modal-card" @click.stop>
            <div class="demo-modal-title">銘柄を売却する</div>

            <!-- 銘柄情報 -->
            <div class="demo-form-info" style="margin-bottom:16px;">
                <div class="demo-form-info-row">
                    <span class="demo-form-info-label">銘柄</span>
                    <span class="demo-form-info-value">
                        <span x-text="demoSellForm.companyCode" style="margin-right:4px;"></span>
                        <span x-text="demoSellForm.companyName" style="font-weight:400; color:#525252;"></span>
                    </span>
                </div>
                <div class="demo-form-info-row">
                    <span class="demo-form-info-label">保有数</span>
                    <span class="demo-form-info-value" x-text="formatNumber(demoSellForm.currentShares) + ' 株'"></span>
                </div>
                <div class="demo-form-info-row">
                    <span class="demo-form-info-label">参考価格</span>
                    <span class="demo-form-info-value" x-text="demoSellForm.currentPrice != null ? formatYen(demoSellForm.currentPrice) : '\u2014'"></span>
                </div>
            </div>

            <!-- 売却株数 -->
            <div class="demo-form-group">
                <label class="demo-form-label">売却株数</label>
                <input type="number" class="form-input" placeholder="売却する株数を入力" x-model.number="demoSellForm.shares" min="1" :max="demoSellForm.currentShares" step="1">
            </div>

            <!-- 売却理由メモ -->
            <div class="demo-form-group">
                <label class="demo-form-label">売却理由メモ</label>
                <textarea class="form-input" placeholder="売却の判断理由を記録しましょう" x-model="demoSellForm.reason" rows="3" style="resize:vertical; min-height:60px;"></textarea>
                <div class="demo-form-helper">売却の判断理由を記録しましょう</div>
            </div>

            <!-- 売却金額 -->
            <template x-if="demoSellForm.currentPrice != null && demoSellForm.shares > 0">
                <div class="demo-form-info">
                    <div class="demo-form-info-row">
                        <span class="demo-form-info-label">売却金額（税抜概算）</span>
                        <span class="demo-form-info-value" x-text="formatYen(demoSellForm.currentPrice * demoSellForm.shares)"></span>
                    </div>
                </div>
            </template>

            <div class="demo-modal-actions">
                <button class="demo-btn-cancel" @click="closeDemoSellModal()">キャンセル</button>
                <button class="demo-btn-confirm" @click="executeDemoSell()" :disabled="!canDemoSell || demoSellForm.submitting">
                    <template x-if="demoSellForm.submitting">
                        <span><span class="demo-loading-spinner-sm" style="vertical-align:middle; margin-right:4px;"></span>処理中...</span>
                    </template>
                    <template x-if="!demoSellForm.submitting">
                        <span>売却する</span>
                    </template>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== 資金追加モーダル ===== -->
    <div class="modal-overlay" x-show="demoDepositModalOpen" x-cloak @click.self="demoDepositModalOpen = false">
        <div class="demo-modal-card" @click.stop>
            <div class="demo-modal-title">資金を追加する</div>

            <div class="demo-form-info" style="margin-bottom:16px;">
                <div class="demo-form-info-row">
                    <span class="demo-form-info-label">現在の現金残高</span>
                    <span class="demo-form-info-value" x-text="formatYen(demoAccount.cash_balance)"></span>
                </div>
                <div class="demo-form-info-row">
                    <span class="demo-form-info-label">累計入金額（原資）</span>
                    <span class="demo-form-info-value" x-text="formatYen(demoAccount.total_deposited)"></span>
                </div>
            </div>

            <div class="demo-form-group">
                <label class="demo-form-label">追加金額（円）</label>
                <input type="number" class="form-input" placeholder="例: 500000" x-model.number="demoDepositForm.amount" min="10000" step="10000">
            </div>

            <!-- 金額ガイド -->
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:16px;">
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoDepositForm.amount = 100000">+10万</button>
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoDepositForm.amount = 300000">+30万</button>
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoDepositForm.amount = 500000">+50万</button>
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoDepositForm.amount = 1000000">+100万</button>
            </div>

            <div class="demo-modal-actions">
                <button class="demo-btn-cancel" @click="demoDepositModalOpen = false">キャンセル</button>
                <button class="demo-btn-confirm" @click="executeDemoDeposit()" :disabled="!demoDepositForm.amount || demoDepositForm.amount <= 0 || demoDepositForm.submitting">
                    <template x-if="demoDepositForm.submitting">
                        <span><span class="demo-loading-spinner-sm" style="vertical-align:middle; margin-right:4px;"></span>処理中...</span>
                    </template>
                    <template x-if="!demoDepositForm.submitting">
                        <span>追加する</span>
                    </template>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== リセットモーダル（金額選択＋ツールチップ） ===== -->
    <div class="modal-overlay" x-show="demoResetModalOpen" x-cloak @click.self="demoResetModalOpen = false">
        <div class="demo-modal-card" @click.stop>
            <div class="demo-modal-title">デモ口座をリセット</div>
            <p style="font-size:13px; color:#525252; margin-bottom:16px;">保有銘柄と売買履歴がすべて削除され、新しい初期資金でやり直します。</p>

            <div class="demo-form-group">
                <label class="demo-form-label">初期資金（円）</label>
                <input type="number" class="form-input" x-model.number="demoResetForm.amount" min="10000" step="10000">
            </div>

            <!-- 金額プリセット -->
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;">
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoResetForm.amount = 300000">30万</button>
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px; border-color:#2d6a4f; color:#2d6a4f;" @click="demoResetForm.amount = 1000000">100万</button>
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoResetForm.amount = 3000000">300万</button>
                <button class="demo-btn-outline" style="padding:4px 10px; font-size:11px;" @click="demoResetForm.amount = 10000000">1000万</button>
            </div>

            <!-- ツールチップ（目安ガイド） -->
            <div style="background:#f7f7f5; border-radius:8px; padding:10px 14px; margin-bottom:16px; font-size:12px; color:#525252; line-height:1.7;">
                <div style="font-weight:600; color:#1a1a1a; margin-bottom:4px;">資金の目安</div>
                <div><span style="color:#2d6a4f; font-weight:500;">初心者</span> — 30万円（少額で感覚をつかむ）</div>
                <div><span style="color:#2d6a4f; font-weight:500;">中級者</span> — 100〜300万円（分散投資を練習）</div>
                <div><span style="color:#2d6a4f; font-weight:500;">上級者</span> — 1,000万円〜（本格的なポートフォリオ構築）</div>
            </div>

            <div class="demo-modal-actions">
                <button class="demo-btn-cancel" @click="demoResetModalOpen = false">キャンセル</button>
                <button class="demo-btn-confirm demo-btn-reset-confirm" @click="executeDemoReset()" :disabled="!demoResetForm.amount || demoResetForm.amount < 10000 || demoResetForm.submitting"
                    style="background:#b91c1c;">
                    <template x-if="demoResetForm.submitting">
                        <span><span class="demo-loading-spinner-sm" style="vertical-align:middle; margin-right:4px;"></span>処理中...</span>
                    </template>
                    <template x-if="!demoResetForm.submitting">
                        <span>リセットする</span>
                    </template>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function mypageApp() {
    return {
        /* --- マイノート状態 --- */
        noteSearch: '',
        noteSort: 'date',
        activeTag: '',
        notes: [],
        userId: '',
        loading: true,
        showModal: false,
        showDeleteConfirm: false,
        editingNote: null,
        deletingNote: null,
        saving: false,
        // 投稿名（ノートフォーム用）
        displayName: '',
        form: {
            title: '',
            content: '',
            company_code: '',
            company_name: '',
            stars: 0,
            tagsInput: '',
            is_public: false,
            is_anonymous: false,
        },

        /* --- デモ売買状態 --- */
        demoLoaded: false,
        allCompanies: [],
        demoAccount: { cash_balance: 0, total_value: 0, total_assets: 0, total_deposited: 0, profit: 0, holdings: [] },
        demoAccountLoaded: false,
        demoTrades: [],
        demoHistoryLoaded: false,
        demoActiveTab: 'holdings',
        showDemoHistory: false,
        showDemoAnalysis: false,
        demoAnalysisChart: null,
        livePriceLoading: false,
        demoBuyModalOpen: false,
        demoBuyForm: {
            query: '',
            selectedCode: null,
            selectedName: null,
            filtered: [],
            showDropdown: false,
            highlightIndex: -1,
            refPrice: null,
            priceLoading: false,
            shares: '',
            reason: '',
            submitting: false
        },
        demoSellModalOpen: false,
        demoSellForm: {
            companyCode: '',
            companyName: '',
            currentShares: 0,
            currentPrice: null,
            shares: '',
            reason: '',
            submitting: false
        },
        demoDepositModalOpen: false,
        demoDepositForm: { amount: '', submitting: false },
        demoResetModalOpen: false,
        demoResetForm: { amount: 1000000, submitting: false },

        /* --- 紹介コード --- */
        referralCode: null,
        referralLink: '',
        referralCopied: false,
        referralCount: null,

        async init() {
            // ユーザー情報を取得（投稿名デフォルト用）
            try {
                const meRes = await fetch('/api/auth/me');
                const meData = await meRes.json();
                if (meData.logged_in && meData.user) {
                    this.displayName = meData.user.display_name || '';
                }
            } catch (e) {}
            await this.loadNotes();
            // デモ売買も自動読込
            this.loadDemo();
            // 紹介コード取得
            this.loadReferral();
        },

        async loadNotes() {
            this.loading = true;
            var maxRetries = 2;
            for (var attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    var res = await fetch('/api/notes/my');
                    if (res.ok) {
                        var data = await res.json();
                        if (data.notes) {
                            this.notes = data.notes;
                            this.userId = data.user_id || '';
                        }
                        this.loading = false;
                        return;
                    }
                    if (res.status < 500 || attempt >= maxRetries) break;
                } catch (e) {
                    if (attempt >= maxRetries) break;
                }
                await new Promise(function(r) { setTimeout(r, (attempt + 1) * 1000); });
            }
            this.loading = false;
        },

        get uniqueCompanies() {
            const codes = new Set();
            this.notes.forEach(n => { if (n.company_code) codes.add(n.company_code); });
            return codes.size;
        },

        get publicCount() {
            return this.notes.filter(n => n.is_public).length;
        },

        get avgStars() {
            const rated = this.notes.filter(n => n.stars > 0);
            if (rated.length === 0) return '-';
            const avg = rated.reduce((s, n) => s + n.stars, 0) / rated.length;
            return '\u2605' + avg.toFixed(1);
        },

        get allTags() {
            const tags = new Set();
            this.notes.forEach(n => (n.tags || []).forEach(t => tags.add(t)));
            return [...tags];
        },

        get filteredNotes() {
            let result = [...this.notes];
            if (this.noteSearch) {
                const q = this.noteSearch.toLowerCase();
                result = result.filter(n =>
                    (n.title || '').toLowerCase().includes(q) ||
                    (n.company_code || '').includes(q) ||
                    (n.company_name || '').toLowerCase().includes(q) ||
                    (n.content || '').toLowerCase().includes(q) ||
                    (n.tags || []).some(t => t.toLowerCase().includes(q))
                );
            }
            if (this.activeTag) {
                result = result.filter(n => (n.tags || []).includes(this.activeTag));
            }
            if (this.noteSort === 'star') {
                result.sort((a, b) => (b.stars || 0) - (a.stars || 0));
            } else {
                result.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            return result;
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return (d.getMonth() + 1) + '/' + d.getDate();
        },

        openCreateModal() {
            this.editingNote = null;
            this.form = {
                title: '', content: '', company_code: '', company_name: '',
                stars: 0, tagsInput: '', is_public: false, is_anonymous: false,
                poster_name: this.displayName,
            };
            this.showModal = true;
        },

        openEditModal(note) {
            this.editingNote = note;
            this.form = {
                title: note.title || '',
                content: note.content || '',
                company_code: note.company_code || '',
                company_name: note.company_name || '',
                stars: note.stars || 0,
                tagsInput: (note.tags || []).join(', '),
                is_public: note.is_public || false,
                is_anonymous: note.is_anonymous || false,
                poster_name: note.poster_name || this.displayName,
            };
            this.showModal = true;
        },

        async saveNote() {
            if (!this.form.title.trim() || !this.form.content.trim()) {
                showErrorModal('タイトルと本文は必須です');
                return;
            }
            this.saving = true;
            const tags = this.form.tagsInput
                .split(/[,、]/)
                .map(t => t.trim())
                .filter(t => t.length > 0);
            const payload = {
                title: this.form.title.trim(),
                content: this.form.content.trim(),
                company_code: this.form.company_code.trim() || null,
                company_name: this.form.company_name.trim() || null,
                stars: this.form.stars,
                tags: tags,
                is_public: this.form.is_public,
                is_anonymous: this.form.is_anonymous,
                poster_name: (this.form.poster_name || '').trim() || null,
            };
            try {
                let res;
                if (this.editingNote) {
                    res = await fetch('/api/notes/' + this.editingNote.id, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                } else {
                    res = await fetch('/api/notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                }
                const data = await res.json();
                if (res.ok) {
                    this.showModal = false;
                    await this.loadNotes();
                } else {
                    showErrorModal(data.error || '保存に失敗しました');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました');
            }
            this.saving = false;
        },

        confirmDelete(note) {
            this.deletingNote = note;
            this.showDeleteConfirm = true;
        },

        async deleteNote() {
            if (!this.deletingNote) return;
            try {
                const res = await fetch('/api/notes/' + this.deletingNote.id, { method: 'DELETE' });
                if (res.ok) {
                    this.showDeleteConfirm = false;
                    this.deletingNote = null;
                    await this.loadNotes();
                } else {
                    const data = await res.json();
                    showErrorModal(data.error || '削除に失敗しました');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました');
            }
        },

        /* ========================================
         * デモ売買機能
         * ======================================== */

        /* デモデータ初期読み込み */
        /* --- 紹介コード --- */
        async loadReferral() {
            try {
                var res = await fetch('/api/referrals/code');
                if (!res.ok) return;
                var data = await res.json();
                if (data.referral_code) {
                    this.referralCode = data.referral_code;
                    this.referralLink = data.referral_link;
                }
            } catch (e) {}
            // 紹介人数も取得
            try {
                var res2 = await fetch('/api/referrals/my');
                if (res2.ok) {
                    var data2 = await res2.json();
                    this.referralCount = (data2.referrals || []).length;
                }
            } catch (e) {}
        },

        copyReferralLink() {
            if (!this.referralLink) return;
            navigator.clipboard.writeText(this.referralLink).then(() => {
                this.referralCopied = true;
                setTimeout(() => { this.referralCopied = false; }, 2000);
            }).catch(() => {
                // フォールバック
                var input = document.createElement('textarea');
                input.value = this.referralLink;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                this.referralCopied = true;
                setTimeout(() => { this.referralCopied = false; }, 2000);
            });
        },

        async loadDemo() {
            var companiesPromise = fetch('/static/companies.json')
                .then(function(res) { return res.ok ? res.json() : []; })
                .catch(function() { return []; });

            var accountPromise = this.fetchDemoAccount();

            try {
                this.allCompanies = await companiesPromise;
            } catch (e) {
                console.error('企業リストの読み込みに失敗しました', e);
            }

            await accountPromise;
            this.demoLoaded = true;
        },

        /* デモアカウント情報取得（リトライ付き） */
        async fetchDemoAccount() {
            var maxRetries = 2;
            for (var attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    var res = await fetch('/api/demo/account');
                    if (res.ok) {
                        var data = await res.json();
                        this.demoAccount = {
                            cash_balance: data.cash_balance || 0,
                            total_value: data.total_value || 0,
                            total_assets: data.total_assets || 0,
                            holdings: data.holdings || []
                        };
                        this.demoAccountLoaded = true;
                        return;
                    }
                    /* サーバーエラー(5xx)ならリトライ、クライアントエラー(4xx)は即終了 */
                    if (res.status < 500 || attempt >= maxRetries) {
                        showErrorModal('データの読み込みに少し時間がかかっています。\nデータには影響ありませんので、少し待ってからページを再読み込みしてみてください。');
                        this.demoAccountLoaded = true;
                        return;
                    }
                } catch (e) {
                    if (attempt >= maxRetries) {
                        showErrorModal('データの読み込みに少し時間がかかっています。\nデータには影響ありませんので、少し待ってからページを再読み込みしてみてください。');
                        this.demoAccountLoaded = true;
                        return;
                    }
                }
                /* リトライ前に少し待つ（1秒→2秒） */
                await new Promise(function(r) { setTimeout(r, (attempt + 1) * 1000); });
            }
            this.demoAccountLoaded = true;
        },

        /* デモ売買履歴取得 */
        async fetchDemoHistory() {
            this.demoHistoryLoaded = false;
            try {
                var res = await fetch('/api/demo/history');
                if (res.ok) {
                    var data = await res.json();
                    this.demoTrades = data.trades || [];
                } else {
                    showErrorModal('売買履歴の取得に失敗しました。');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました。');
            }
            this.demoHistoryLoaded = true;
        },

        /* デモ参考価格取得 */
        async fetchDemoRefPrice(code) {
            this.demoBuyForm.priceLoading = true;
            this.demoBuyForm.refPrice = null;
            try {
                /* まずライブ株価を取得 */
                var res = await fetch('/api/stock/current-price/' + encodeURIComponent(code));
                if (res.ok) {
                    var data = await res.json();
                    if (data && data.price != null) {
                        this.demoBuyForm.refPrice = data.price;
                        this.demoBuyForm.priceLoading = false;
                        return;
                    }
                }
            } catch (e) { /* ライブ取得失敗 → フォールバック */ }
            try {
                /* フォールバック: screened_latestのキャッシュ価格 */
                var res2 = await fetch('/api/stock/screened/' + encodeURIComponent(code));
                if (res2.ok) {
                    var data2 = await res2.json();
                    if (data2 && data2.stock_price != null) {
                        this.demoBuyForm.refPrice = data2.stock_price;
                    }
                }
            } catch (e) { /* キャッシュも取得失敗は静かに処理 */ }
            this.demoBuyForm.priceLoading = false;
        },

        /* 保有銘柄の現在株価を一括取得 */
        async fetchAllLivePrices() {
            if (!this.demoAccount.holdings || this.demoAccount.holdings.length === 0) return;
            this.livePriceLoading = true;
            var holdings = this.demoAccount.holdings;
            var prices = {};
            var failedCount = 0;
            // まず全銘柄の株価を取得（UIは更新しない）
            for (var i = 0; i < holdings.length; i++) {
                try {
                    var res = await fetch('/api/stock/current-price/' + encodeURIComponent(holdings[i].company_code));
                    if (res.ok) {
                        var data = await res.json();
                        if (data.price != null) {
                            prices[holdings[i].company_code] = data.price;
                        }
                    } else {
                        failedCount++;
                    }
                } catch (e) {
                    failedCount++;
                }
            }
            // 取得完了後に一括でUIに反映
            var updatedHoldings = holdings.map(function(h) {
                var newPrice = prices[h.company_code];
                if (newPrice != null) {
                    return Object.assign({}, h, {
                        current_price: newPrice,
                        market_value: newPrice * h.shares
                    });
                }
                return Object.assign({}, h);
            });
            var totalValue = 0;
            updatedHoldings.forEach(function(h) {
                totalValue += (h.current_price || 0) * h.shares;
            });
            this.demoAccount = Object.assign({}, this.demoAccount, {
                holdings: updatedHoldings,
                total_value: totalValue,
                total_assets: this.demoAccount.cash_balance + totalValue
            });
            this.livePriceLoading = false;
            if (failedCount > 0) {
                showErrorModal(failedCount + '件の銘柄の株価取得に失敗しました');
            }
        },

        /* タブ切り替え */
        switchDemoTab(tab) {
            this.demoActiveTab = tab;
            if (tab === 'history') {
                this.showDemoHistory = true;
                this.showDemoAnalysis = false;
                if (!this.demoHistoryLoaded) {
                    this.fetchDemoHistory();
                }
            } else if (tab === 'analysis') {
                this.showDemoAnalysis = true;
                this.showDemoHistory = false;
                if (!this.demoHistoryLoaded) {
                    this.fetchDemoHistory().then(() => {
                        this.$nextTick(() => { this.renderAnalysisChart(); });
                    });
                } else {
                    this.$nextTick(() => { this.renderAnalysisChart(); });
                }
            } else {
                this.showDemoHistory = false;
                this.showDemoAnalysis = false;
            }
        },

        /* 売買履歴表示切替（後方互換） */
        toggleDemoHistory() {
            this.switchDemoTab(this.demoActiveTab === 'history' ? 'holdings' : 'history');
        },

        /* 売買分析表示切替（後方互換） */
        toggleDemoAnalysis() {
            this.switchDemoTab(this.demoActiveTab === 'analysis' ? 'holdings' : 'analysis');
        },

        /* 売買分析データ集計 */
        getAnalysisData() {
            var trades = this.demoTrades || [];
            if (trades.length === 0) {
                return {
                    totalCount: 0, buyCount: 0, sellCount: 0,
                    uniqueStockCount: 0, activityPeriod: '\u2014',
                    byStock: [], monthlyData: {}, reasonList: []
                };
            }

            var buyCount = 0;
            var sellCount = 0;
            var stockMap = {};
            var monthMap = {};
            var reasonList = [];
            var dates = [];

            for (var i = 0; i < trades.length; i++) {
                var t = trades[i];
                if (t.trade_type === 'deposit') continue;
                var isBuy = t.trade_type === 'buy';
                if (isBuy) { buyCount++; } else { sellCount++; }

                // 日付収集
                if (t.traded_at) {
                    dates.push(new Date(t.traded_at));
                }

                // 銘柄別集計
                var code = t.company_code || 'unknown';
                if (!stockMap[code]) {
                    stockMap[code] = {
                        code: code,
                        name: t.company_name || '',
                        buyCount: 0, sellCount: 0,
                        totalBuyShares: 0, totalSellShares: 0,
                        totalBuyAmount: 0, totalSellAmount: 0,
                        avgBuyPrice: 0, realizedPL: 0,
                        latestReason: '', latestReasonDate: null
                    };
                }
                var sm = stockMap[code];
                if (isBuy) {
                    sm.buyCount++;
                    sm.totalBuyShares += (t.shares || 0);
                    sm.totalBuyAmount += (t.total_amount || (t.price || 0) * (t.shares || 0));
                } else {
                    sm.sellCount++;
                    sm.totalSellShares += (t.shares || 0);
                    sm.totalSellAmount += (t.total_amount || (t.price || 0) * (t.shares || 0));
                }
                // 最新の理由メモを保持
                if (t.reason && t.reason.trim()) {
                    var td = t.traded_at ? new Date(t.traded_at) : new Date(0);
                    if (!sm.latestReasonDate || td > sm.latestReasonDate) {
                        sm.latestReason = t.reason;
                        sm.latestReasonDate = td;
                    }
                }

                // 月別集計
                if (t.traded_at) {
                    try {
                        var d = new Date(t.traded_at);
                        var monthKey = d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0');
                        if (!monthMap[monthKey]) {
                            monthMap[monthKey] = { buy: 0, sell: 0 };
                        }
                        if (isBuy) { monthMap[monthKey].buy++; } else { monthMap[monthKey].sell++; }
                    } catch (e) {}
                }

                // 理由メモあり取引を収集
                if (t.reason && t.reason.trim()) {
                    reasonList.push(t);
                }
            }

            // 活動期間
            var activityPeriod = '\u2014';
            if (dates.length > 0) {
                dates.sort(function(a, b) { return a - b; });
                var fmt = function(d) {
                    return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
                };
                if (dates.length === 1) {
                    activityPeriod = fmt(dates[0]);
                } else {
                    activityPeriod = fmt(dates[0]) + ' 〜 ' + fmt(dates[dates.length - 1]);
                }
            }

            // 銘柄別の損益計算
            var totalRealizedPL = 0;
            var stockKeys = Object.keys(stockMap);
            for (var j = 0; j < stockKeys.length; j++) {
                var s = stockMap[stockKeys[j]];
                // 平均取得単価
                if (s.totalBuyShares > 0) {
                    s.avgBuyPrice = s.totalBuyAmount / s.totalBuyShares;
                }
                // 実現損益 = 売却総額 - (平均取得単価 × 売却株数)
                if (s.sellCount > 0 && s.avgBuyPrice > 0) {
                    s.realizedPL = s.totalSellAmount - (s.avgBuyPrice * s.totalSellShares);
                }
                totalRealizedPL += s.realizedPL;
            }

            // 含み損益（保有中銘柄）
            var totalUnrealizedPL = 0;
            var hasUnrealized = false;
            var holdings = (this.demoAccount && this.demoAccount.holdings) || [];
            for (var k = 0; k < holdings.length; k++) {
                var h = holdings[k];
                if (h.current_price != null && h.avg_cost != null && h.shares > 0) {
                    totalUnrealizedPL += (h.current_price - h.avg_cost) * h.shares;
                    hasUnrealized = true;
                }
            }

            // 銘柄別配列
            var byStock = Object.values(stockMap);
            byStock.sort(function(a, b) { return (b.buyCount + b.sellCount) - (a.buyCount + a.sellCount); });

            // 理由リストは新しい順
            reasonList.sort(function(a, b) {
                return new Date(b.traded_at || 0) - new Date(a.traded_at || 0);
            });

            // 月別の総資産・実現損益の推移を計算
            var sortedMonths = Object.keys(monthMap).sort();
            var monthlyAssets = {};
            var monthlyRealizedPL = {};
            var runningRealizedPL = 0;
            // 取引を日付順にソート
            var sortedTrades = trades.slice().sort(function(a, b) {
                return new Date(a.traded_at || 0) - new Date(b.traded_at || 0);
            });
            // 各取引の時点での累計を月別に集計
            var runningCash = (this.demoAccount && this.demoAccount.total_deposited) || 0;
            var holdingMap = {}; // code -> { shares, totalCost }
            for (var ti = 0; ti < sortedTrades.length; ti++) {
                var tr = sortedTrades[ti];
                if (!tr.traded_at) continue;
                var trDate = new Date(tr.traded_at);
                var mKey = trDate.getFullYear() + '/' + String(trDate.getMonth() + 1).padStart(2, '0');
                var trCode = tr.company_code || 'unknown';
                var trAmount = tr.total_amount || ((tr.price || 0) * (tr.shares || 0));

                if (tr.trade_type === 'deposit') {
                    // 入金はrunningCashに含まれている（total_deposited）
                } else if (tr.trade_type === 'buy') {
                    if (!holdingMap[trCode]) holdingMap[trCode] = { shares: 0, totalCost: 0 };
                    holdingMap[trCode].shares += (tr.shares || 0);
                    holdingMap[trCode].totalCost += trAmount;
                } else if (tr.trade_type === 'sell') {
                    if (holdingMap[trCode] && holdingMap[trCode].shares > 0) {
                        var avgCost = holdingMap[trCode].totalCost / holdingMap[trCode].shares;
                        runningRealizedPL += trAmount - (avgCost * (tr.shares || 0));
                        holdingMap[trCode].shares -= (tr.shares || 0);
                        holdingMap[trCode].totalCost = avgCost * holdingMap[trCode].shares;
                    }
                }
                // 月末時点として上書き（同月の最後の取引が残る）
                monthlyRealizedPL[mKey] = Math.round(runningRealizedPL);
            }
            // 総資産は現在の値のみ確定できるため、実現損益の推移を基に近似
            // 入金総額 + 実現損益の累計 = その時点での資産概算（保有株評価を除く）
            var depositTotal = (this.demoAccount && this.demoAccount.total_deposited) || 0;
            for (var mi = 0; mi < sortedMonths.length; mi++) {
                var mk = sortedMonths[mi];
                var rpl = monthlyRealizedPL[mk] || (mi > 0 ? monthlyAssets[sortedMonths[mi-1]] - depositTotal : 0);
                monthlyAssets[mk] = depositTotal + rpl;
                if (!monthlyRealizedPL[mk] && mi > 0) {
                    monthlyRealizedPL[mk] = monthlyRealizedPL[sortedMonths[mi-1]] || 0;
                }
            }

            return {
                totalCount: trades.length,
                buyCount: buyCount,
                sellCount: sellCount,
                uniqueStockCount: Object.keys(stockMap).length,
                activityPeriod: activityPeriod,
                byStock: byStock,
                monthlyData: monthMap,
                monthlyAssets: monthlyAssets,
                monthlyRealizedPL: monthlyRealizedPL,
                reasonList: reasonList,
                totalRealizedPL: totalRealizedPL,
                totalUnrealizedPL: totalUnrealizedPL,
                hasUnrealized: hasUnrealized
            };
        },

        /* 総資産・実現損益チャート描画 */
        renderAnalysisChart() {
            var canvas = this.$refs.analysisChart;
            if (!canvas) return;
            var data = this.getAnalysisData();
            var monthMap = data.monthlyData;
            var labels = Object.keys(monthMap).sort();
            if (labels.length === 0) return;

            var assetsData = labels.map(function(k) { return data.monthlyAssets[k] || 0; });
            var plData = labels.map(function(k) { return data.monthlyRealizedPL[k] || 0; });

            // 既存チャートを破棄
            if (this.demoAnalysisChart) {
                this.demoAnalysisChart.destroy();
                this.demoAnalysisChart = null;
            }

            // 金額フォーマット用
            var formatVal = function(val) {
                if (Math.abs(val) >= 10000) {
                    return (val / 10000).toFixed(1) + '万';
                }
                return val.toLocaleString();
            };

            this.demoAnalysisChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '総資産',
                            data: assetsData,
                            borderColor: '#1b4332',
                            backgroundColor: 'rgba(27, 67, 50, 0.08)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: '#1b4332',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            yAxisID: 'yAssets'
                        },
                        {
                            label: '実現損益（累計）',
                            data: plData,
                            borderColor: '#6b7280',
                            backgroundColor: 'rgba(107, 114, 128, 0.08)',
                            borderWidth: 2,
                            borderDash: [4, 3],
                            fill: false,
                            tension: 0.3,
                            pointBackgroundColor: '#6b7280',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            yAxisID: 'yPL'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        },
                        yAssets: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '総資産(円)',
                                font: { size: 10 },
                                color: '#1b4332'
                            },
                            ticks: {
                                font: { size: 10 },
                                color: '#1b4332',
                                callback: function(val) { return formatVal(val); }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        yPL: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '実現損益(円)',
                                font: { size: 10 },
                                color: '#6b7280'
                            },
                            ticks: {
                                font: { size: 10 },
                                color: '#6b7280',
                                callback: function(val) { return formatVal(val); }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 11 }, boxWidth: 12, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var val = context.parsed.y;
                                    var label = context.dataset.label || '';
                                    return label + ': ' + (val != null ? val.toLocaleString() + '円' : '\u2014');
                                }
                            }
                        }
                    }
                }
            });
        },

        /* 資金追加モーダル */
        openDemoDepositModal() {
            this.demoDepositForm = { amount: '', submitting: false };
            this.demoDepositModalOpen = true;
        },

        async executeDemoDeposit() {
            if (!this.demoDepositForm.amount || this.demoDepositForm.amount <= 0 || this.demoDepositForm.submitting) return;
            this.demoDepositForm.submitting = true;

            try {
                var res = await fetch('/api/demo/deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: this.demoDepositForm.amount })
                });
                var data = await res.json();
                if (res.ok && data.success) {
                    showSuccessModal(data.message || '資金を追加しました。');
                    this.demoDepositModalOpen = false;
                    this.demoAccountLoaded = false;
                    this.demoHistoryLoaded = false;
                    await this.fetchDemoAccount();
                    if (this.showDemoHistory) this.fetchDemoHistory();
                } else {
                    showErrorModal(data.message || data.error || '資金追加に失敗しました。');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました。');
            }
            this.demoDepositForm.submitting = false;
        },

        /* デモリセット */
        async confirmDemoReset() {
            this.demoResetForm = { amount: 1000000, submitting: false };
            this.demoResetModalOpen = true;
        },

        async executeDemoReset() {
            if (this.demoResetForm.submitting) return;
            this.demoResetForm.submitting = true;

            try {
                var res = await fetch('/api/demo/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initial_amount: this.demoResetForm.amount || 1000000 })
                });
                var data = await res.json();
                if (res.ok && data.success) {
                    showSuccessModal(data.message || 'デモ口座をリセットしました。');
                    this.demoResetModalOpen = false;
                    this.demoAccountLoaded = false;
                    this.demoHistoryLoaded = false;
                    this.demoTrades = [];
                    this.showDemoHistory = false;
                    this.showDemoAnalysis = false;
                    if (this.demoAnalysisChart) {
                        this.demoAnalysisChart.destroy();
                        this.demoAnalysisChart = null;
                    }
                    await this.fetchDemoAccount();
                } else {
                    showErrorModal(data.message || 'リセットに失敗しました。');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました。');
            }
            this.demoResetForm.submitting = false;
        },

        /* --- デモ購入モーダル --- */
        openDemoBuyModal() {
            this.demoBuyForm = {
                query: '',
                selectedCode: null,
                selectedName: null,
                filtered: [],
                showDropdown: false,
                highlightIndex: -1,
                refPrice: null,
                priceLoading: false,
                shares: '',
                reason: '',
                submitting: false,
                existingHolding: null
            };
            this.demoBuyModalOpen = true;
        },

        closeDemoBuyModal() {
            this.demoBuyModalOpen = false;
        },

        /* オートコンプリート：購入 */
        onDemoBuyInput() {
            this.demoBuyForm.selectedCode = null;
            this.demoBuyForm.selectedName = null;
            this.demoBuyForm.refPrice = null;
            this.demoBuyForm.highlightIndex = -1;
            this.demoBuyForm.existingHolding = null;
            var q = this.demoBuyForm.query.trim().toLowerCase();
            if (q.length === 0) {
                this.demoBuyForm.filtered = [];
                this.demoBuyForm.showDropdown = false;
                return;
            }
            this.demoBuyForm.filtered = this.allCompanies
                .filter(function(item) {
                    return item.c.indexOf(q) !== -1 || item.n.toLowerCase().indexOf(q) !== -1;
                })
                .slice(0, 30);
            this.demoBuyForm.showDropdown = this.demoBuyForm.filtered.length > 0;
        },

        onDemoBuyFocus() {
            if (this.demoBuyForm.filtered.length > 0 && this.demoBuyForm.query.trim().length > 0) {
                this.demoBuyForm.showDropdown = true;
            }
        },

        onDemoBuyBlur() {
            var self = this;
            setTimeout(function() {
                self.demoBuyForm.showDropdown = false;
            }, 200);
        },

        onDemoBuyKeydown(event) {
            var form = this.demoBuyForm;
            if (!form.showDropdown || form.filtered.length === 0) return;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                form.highlightIndex = (form.highlightIndex + 1) % form.filtered.length;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                form.highlightIndex = form.highlightIndex <= 0
                    ? form.filtered.length - 1
                    : form.highlightIndex - 1;
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (form.highlightIndex >= 0 && form.highlightIndex < form.filtered.length) {
                    this.selectDemoBuyCompany(form.filtered[form.highlightIndex]);
                }
            } else if (event.key === 'Escape') {
                form.showDropdown = false;
            }
        },

        selectDemoBuyCompany(item) {
            this.demoBuyForm.query = item.c + ' ' + item.n;
            this.demoBuyForm.selectedCode = item.c;
            this.demoBuyForm.selectedName = item.n;
            this.demoBuyForm.showDropdown = false;
            this.demoBuyForm.highlightIndex = -1;
            this.fetchDemoRefPrice(item.c);

            /* 既存保有を検索 */
            var holdings = this.demoAccount.holdings || [];
            var selectedCode = item.c.replace('.T', '');
            this.demoBuyForm.existingHolding = null;
            for (var i = 0; i < holdings.length; i++) {
                var hCode = (holdings[i].company_code || '').replace('.T', '');
                if (hCode === selectedCode) {
                    this.demoBuyForm.existingHolding = holdings[i];
                    break;
                }
            }
        },

        get canDemoBuy() {
            if (!this.demoBuyForm.selectedCode) return false;
            if (this.demoBuyForm.refPrice == null) return false;
            if (!this.demoBuyForm.shares || this.demoBuyForm.shares <= 0) return false;
            var total = this.demoBuyForm.refPrice * this.demoBuyForm.shares;
            if (total > this.demoAccount.cash_balance) return false;
            return true;
        },

        async executeDemoBuy() {
            if (!this.canDemoBuy || this.demoBuyForm.submitting) return;
            this.demoBuyForm.submitting = true;

            try {
                var res = await fetch('/api/demo/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_code: this.demoBuyForm.selectedCode,
                        shares: this.demoBuyForm.shares,
                        reason: this.demoBuyForm.reason
                    })
                });
                var data = await res.json();
                if (res.ok && data.success) {
                    showSuccessModal(data.message || '購入が完了しました。');
                    this.closeDemoBuyModal();
                    this.demoAccountLoaded = false;
                    this.demoHistoryLoaded = false;
                    await this.fetchDemoAccount();
                    if (this.showDemoHistory) {
                        this.fetchDemoHistory();
                    }
                } else {
                    showErrorModal(data.message || '購入に失敗しました。');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました。');
            }
            this.demoBuyForm.submitting = false;
        },

        /* --- デモ売却モーダル --- */
        openDemoSellModal(holding) {
            this.demoSellForm = {
                companyCode: holding.company_code,
                companyName: holding.company_name || '',
                currentShares: holding.shares || 0,
                currentPrice: holding.current_price,
                shares: '',
                reason: '',
                submitting: false
            };
            this.demoSellModalOpen = true;
        },

        closeDemoSellModal() {
            this.demoSellModalOpen = false;
        },

        get canDemoSell() {
            if (!this.demoSellForm.companyCode) return false;
            if (!this.demoSellForm.shares || this.demoSellForm.shares <= 0) return false;
            if (this.demoSellForm.shares > this.demoSellForm.currentShares) return false;
            return true;
        },

        async executeDemoSell() {
            if (!this.canDemoSell || this.demoSellForm.submitting) return;
            this.demoSellForm.submitting = true;

            try {
                var res = await fetch('/api/demo/sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_code: this.demoSellForm.companyCode,
                        shares: this.demoSellForm.shares,
                        reason: this.demoSellForm.reason
                    })
                });
                var data = await res.json();
                if (res.ok && data.success) {
                    showSuccessModal(data.message || '売却が完了しました。');
                    this.closeDemoSellModal();
                    this.demoAccountLoaded = false;
                    this.demoHistoryLoaded = false;
                    await this.fetchDemoAccount();
                    if (this.showDemoHistory) {
                        this.fetchDemoHistory();
                    }
                } else {
                    showErrorModal(data.message || '売却に失敗しました。');
                }
            } catch (e) {
                showErrorModal('通信エラーが発生しました。');
            }
            this.demoSellForm.submitting = false;
        },

        /* --- デモ用フォーマットユーティリティ --- */
        formatYen(val) {
            if (val == null || typeof val !== 'number' || isNaN(val)) return '\u2014';
            return '\u00a5' + val.toLocaleString('ja-JP');
        },

        formatNumber(val) {
            if (val == null || isNaN(val)) return '\u2014';
            return Number(val).toLocaleString('ja-JP');
        },

        formatPL(val) {
            if (val == null || typeof val !== 'number' || isNaN(val)) return '\u2014';
            var rounded = Math.round(val);
            var formatted = Math.abs(rounded).toLocaleString('ja-JP');
            if (rounded > 0) return '+\u00a5' + formatted;
            if (rounded < 0) return '\u2212\u00a5' + formatted;
            return '\u00a50';
        },

        formatDemoDate(dateStr) {
            if (!dateStr) return '\u2014';
            try {
                var d = new Date(dateStr);
                if (isNaN(d.getTime())) return '\u2014';
                var year = d.getFullYear();
                var month = String(d.getMonth() + 1).padStart(2, '0');
                var day = String(d.getDate()).padStart(2, '0');
                var hours = String(d.getHours()).padStart(2, '0');
                var minutes = String(d.getMinutes()).padStart(2, '0');
                return year + '/' + month + '/' + day + ' ' + hours + ':' + minutes;
            } catch (e) {
                return '\u2014';
            }
        },
    };
}
</script>
{% endblock %}
