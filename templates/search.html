{% extends "layout.html" %}

{% block title %}企業情報 - Company Note{% endblock %}

{% block content %}
<style>
    /* 統一デザイン */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

    :root {
        --primary-color: #1b4332;
        --secondary-color: #2d6a4f;
        --accent-color: #2d6a4f;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --border-color: #e5e5e0;
        --bg-light: #fafaf8;
    }

    body {
        background: #f7f7f5;
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
        color: var(--text-primary);
    }

    .report-container {
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
    }

    /* ヘッダー */
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #ebebeb;
        margin-bottom: 20px;
    }

    .report-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .search-bar {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .search-input-wrapper {
        position: relative;
    }

    .stock-code-input {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95rem;
        width: 280px;
        transition: all 0.2s;
    }

    .stock-code-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.1);
    }

    .suggest-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 240px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        display: none;
    }

    .suggest-item {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .suggest-item:hover,
    .suggest-item.active {
        background: #f0f7f4;
    }

    .suggest-code {
        font-weight: 600;
        color: var(--primary-color);
        min-width: 40px;
    }

    .suggest-name {
        color: var(--text-secondary);
    }

    .analyze-button {
        padding: 8px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .analyze-button:hover {
        background: var(--secondary-color);
    }

    .register-button {
        padding: 8px 20px;
        background: var(--success-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .register-button:hover {
        background: #059669;
    }

    .register-button.registered {
        background: var(--text-secondary);
        cursor: default;
    }

    .register-button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }

    /* メインコンテンツグリッド */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* サマリーカード */
    .summary-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
    }

    .company-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 2px;
    }

    .stock-price-display {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .company-code {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 15px;
    }

    .key-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .metric-item {
        padding: 12px;
        background: var(--bg-light);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
    }

    /* 上部のグラデーションバー */
    .metric-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-color), #52b788);
        opacity: 0.8;
    }

    .metric-item.good::before {
        background: linear-gradient(90deg, var(--success-color), #34d399);
    }

    .metric-item.warning::before {
        background: linear-gradient(90deg, var(--warning-color), #fbbf24);
    }

    .metric-item.danger::before {
        background: linear-gradient(90deg, var(--danger-color), #f87171);
    }

    /* ホバー時のアニメーション */
    .metric-item:hover::before {
        height: 4px;
        opacity: 1;
    }

    .metric-item {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .metric-sub {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* 合致度カード */
    .score-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .score-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .score-main {
        text-align: center;
        padding: 10px 0;
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .score-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    .score-value.high { color: #10b981; }
    .score-value.medium { color: #f59e0b; }
    .score-value.low { color: #ef4444; }

    .score-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .score-details {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px 12px;
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 0.75rem;
    }

    .score-item-label {
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .score-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }

    .score-item-status {
        font-weight: 500;
    }

    .score-item-status.pass { color: #10b981; }
    .score-item-status.fail { color: #ef4444; }

    .chart-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        height: 100%;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .time-selector {
        display: flex;
        gap: 5px;
    }

    .time-btn {
        padding: 4px 8px;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .time-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .chart-placeholder {
        height: 220px;
        background: var(--bg-light);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* 詳細テーブル - 4カラムに変更 */
    .details-section {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    /* カードの上部に細いグラデーションライン */
    .detail-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-color), #52b788);
        opacity: 0.6;
    }

    .detail-card:hover::after {
        height: 3px;
        opacity: 1;
    }

    .detail-header {
        background: var(--bg-light);
        padding: 12px 16px;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .detail-content {
        padding: 16px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .detail-value {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    /* 財務指標テーブル */
    .financial-table {
        width: 100%;
        font-size: 0.85rem;
    }

    .financial-table th {
        text-align: left;
        padding: 8px 0;
        color: var(--text-secondary);
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
    }

    .financial-table td {
        padding: 8px 0;
        color: var(--text-primary);
    }

    .trend-up {
        color: var(--success-color);
    }

    .trend-down {
        color: var(--danger-color);
    }

    /* 株主構成 */
    .shareholder-list, .executive-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .shareholder-item, .executive-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .shareholder-item:last-child, .executive-item:last-child {
        border-bottom: none;
    }

    .shareholder-name, .executive-name {
        font-size: 0.85rem;
        color: var(--text-primary);
    }

    .shareholder-percent {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--accent-color);
    }

    .executive-title {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .founder-tag {
        display: inline-block;
        padding: 2px 6px;
        background: var(--warning-color);
        color: white;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }

    .executive-tag {
        display: inline-block;
        padding: 2px 6px;
        background: var(--accent-color);
        color: white;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }

    /* ローディング */
    .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 0.95rem;
    }

    .loading-subtext {
        font-size: 0.8rem;
        color: var(--text-secondary);
        opacity: 0.7;
    }

    .results-area {
        display: none;
    }

    .results-area.active {
        display: block;
    }

    /* 編集可能フィールド */
    .editable-field {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 2px 6px;
        margin: -2px -6px;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        width: auto;
        min-width: 60px;
        transition: all 0.2s;
    }

    .editable-field:hover {
        border-color: var(--border-color);
        background: white;
    }

    .editable-field:focus {
        outline: none;
        border-color: var(--accent-color);
        background: white;
        box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
    }

    .editable-cell {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 3px;
        padding: 4px 8px;
        font-size: inherit;
        color: inherit;
        width: 80px;
        text-align: right;
        transition: all 0.2s;
        -moz-appearance: textfield;
    }

    .editable-cell::-webkit-outer-spin-button,
    .editable-cell::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .editable-cell:hover {
        border-color: var(--border-color);
        background: white;
    }

    .editable-cell:focus {
        outline: none;
        border-color: var(--accent-color);
        background: white;
    }

    /* 保存ボタン */
    .save-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        text-align: center;
    }

    .save-section.active {
        display: block;
    }

    .save-button {
        padding: 12px 40px;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .save-button:hover {
        background: var(--primary-color);
    }

    .save-button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }

    .edit-hint {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 10px;
    }

    /* レスポンシブ */
    @media (max-width: 1400px) {
        .details-section {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }

        .details-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .report-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .search-bar {
            width: 100%;
        }

        .stock-code-input {
            flex: 1;
        }

        .key-metrics {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* === タブ切り替えスタイル === */
    .info-tab {
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        padding: 6px 16px;
        font-size: 14px;
        font-weight: 400;
        color: #a3a3a3;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
    }

    .info-tab:hover {
        color: #525252;
    }

    .info-tab.active {
        color: #1b4332;
        font-weight: 600;
        border-bottom: 2px solid #1b4332;
    }

    /* === 企業比較タブ用スタイル === */
    .compare-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 0 60px;
    }

    .compare-container .page-header {
        padding: 20px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 28px;
    }

    .compare-container .page-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 0 6px 0;
    }

    .compare-container .page-header p {
        font-size: 0.875rem;
        color: #737373;
        margin: 0;
    }

    .selection-card {
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .selection-card-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding-left: 12px;
        border-left: 3px solid var(--primary-color);
    }

    .company-slots {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .company-slot {
        position: relative;
        flex: 1;
        min-width: 240px;
        max-width: 360px;
    }

    .slot-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #737373;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .slot-label .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .slot-label .dot-a { background: #1b4332; }
    .slot-label .dot-b { background: #3b82f6; }
    .slot-label .dot-c { background: #ea580c; }

    .slot-input-wrapper {
        position: relative;
    }

    .slot-input {
        width: 100%;
        padding: 10px 36px 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        color: var(--text-primary);
        background: #ffffff;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
    }

    .slot-input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.1);
    }

    .slot-input::placeholder {
        color: #a3a3a3;
    }

    .slot-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #a3a3a3;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 2px 4px;
        display: none;
    }

    .slot-clear:hover {
        color: #525252;
    }

    .suggest-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 220px;
        overflow-y: auto;
        z-index: 200;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        display: none;
    }

    .suggest-option {
        padding: 8px 14px;
        cursor: pointer;
        font-size: 0.8125rem;
        display: flex;
        gap: 8px;
        align-items: center;
        transition: background 0.15s;
    }

    .suggest-option:hover,
    .suggest-option.highlighted {
        background: #f0f7f4;
    }

    .suggest-option-code {
        font-weight: 600;
        color: var(--primary-color);
        min-width: 44px;
    }

    .suggest-option-name {
        color: #737373;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-add {
        padding: 8px 16px;
        background: var(--bg-light);
        color: #525252;
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .btn-add:hover {
        border-color: var(--secondary-color);
        color: var(--primary-color);
        background: #f0f7f4;
    }

    .btn-add:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .btn-compare {
        padding: 10px 28px;
        background: var(--primary-color);
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-compare:hover {
        background: var(--secondary-color);
    }

    .btn-compare:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-remove-slot {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 20px;
        height: 20px;
        background: #ef4444;
        color: #fff;
        border: 2px solid #ffffff;
        border-radius: 50%;
        font-size: 0.625rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        line-height: 1;
        z-index: 10;
    }

    .btn-remove-slot:hover {
        background: #dc2626;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-state-icon {
        font-size: 2.5rem;
        color: #a3a3a3;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        font-size: 1.0625rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-state p {
        font-size: 0.8125rem;
        color: #737373;
        line-height: 1.7;
        max-width: 400px;
        margin: 0 auto;
    }

    .compare-loading-state {
        text-align: center;
        padding: 48px 20px;
    }

    .compare-loading-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
    }

    .compare-loading-state p {
        font-size: 0.875rem;
        color: #737373;
    }

    .results-section {
        margin-top: 8px;
    }

    .result-card {
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .result-card-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        padding-left: 12px;
        border-left: 3px solid var(--success-color);
    }

    .radar-chart-wrapper {
        max-width: 520px;
        margin: 0 auto;
        position: relative;
    }

    .compare-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .compare-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.8125rem;
    }

    .compare-table thead th {
        background: var(--bg-light);
        font-weight: 600;
        color: var(--text-primary);
        padding: 10px 14px;
        text-align: center;
        border-bottom: 2px solid var(--border-color);
        white-space: nowrap;
    }

    .compare-table thead th:first-child {
        text-align: left;
        padding-left: 16px;
        border-radius: 8px 0 0 0;
    }

    .compare-table thead th:last-child {
        border-radius: 0 8px 0 0;
    }

    .compare-table tbody td {
        padding: 10px 14px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        color: #525252;
        transition: background 0.15s;
    }

    .compare-table tbody td:first-child {
        text-align: left;
        padding-left: 16px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        min-width: 140px;
    }

    .compare-table tbody tr:last-child td {
        border-bottom: none;
    }

    .compare-table tbody tr:hover td {
        background: var(--bg-light);
    }

    .cell-best {
        background: #f0fdf4 !important;
        font-weight: 600;
        color: var(--primary-color) !important;
    }

    .cell-worst {
        background: #fef2f2 !important;
        color: #b91c1c !important;
    }

    .company-header-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .company-header-code {
        font-size: 0.6875rem;
        color: #737373;
        font-weight: 400;
    }

    @media (max-width: 768px) {
        .compare-container {
            padding: 16px 0 40px;
        }

        .company-slots {
            flex-direction: column;
        }

        .company-slot {
            max-width: 100%;
        }

        .radar-chart-wrapper {
            max-width: 100%;
        }

        .compare-table {
            font-size: 0.75rem;
        }

        .compare-table thead th,
        .compare-table tbody td {
            padding: 8px 10px;
        }
    }
</style>

<div class="report-container">
    <!-- ヘッダー -->
    <div class="report-header">
        <div style="display:flex; align-items:center; gap:24px;">
            <div class="report-title">企業情報</div>
            <div style="display:flex; gap:0;">
                <button class="info-tab active" id="tabBtnSearch" onclick="switchInfoTab('search')">銘柄検索</button>
                <button class="info-tab" id="tabBtnCompare" onclick="switchInfoTab('compare')">企業比較</button>
            </div>
        </div>
        <div class="search-bar" id="searchBarArea">
            <div class="search-input-wrapper">
                <input type="text" class="stock-code-input" id="stockCode" placeholder="銘柄コードまたは会社名" autocomplete="off">
                <div class="suggest-list" id="suggestList"></div>
            </div>
            <button class="analyze-button" onclick="analyzeStock()">抽出</button>
            <button class="register-button" id="registerBtn" onclick="registerStock()" style="display: none;">登録</button>
        </div>
    </div>

    <!-- 銘柄検索タブ -->
    <div id="tabSearch">

    <!-- ローディング -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">データを取得中...</div>
            <div class="loading-subtext">目安：10～20秒程度</div>
        </div>
    </div>

    <!-- 結果エリア -->
    <div class="results-area" id="resultsArea">
        <!-- メインコンテンツ -->
        <div class="content-grid">
            <!-- 左側: サマリー情報 -->
            <div class="summary-card">
                <div class="company-name">トヨタ自動車</div>
                <div class="stock-price-display" id="stock-price-display">¥2,850</div>
                <div class="company-code">銘柄コード: 7203 | 自動車製造業</div>

                <div class="key-metrics">
                    <div class="metric-item good">
                        <div class="metric-label">自己資本比率</div>
                        <div class="metric-value">42.5%</div>
                        <div class="metric-sub">健全性: 良好</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">営業利益率</div>
                        <div class="metric-value">9.8%</div>
                        <div class="metric-sub">収益性: 良好</div>
                    </div>
                    <div class="metric-item warning">
                        <div class="metric-label">PER</div>
                        <div class="metric-value">11.2倍</div>
                        <div class="metric-sub">業界平均: 10.5倍</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">PBR</div>
                        <div class="metric-value">0.95倍</div>
                        <div class="metric-sub">割安水準</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">配当利回り</div>
                        <div class="metric-value">2.8%</div>
                        <div class="metric-sub">5年連続増配</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">時価総額</div>
                        <div class="metric-value">40.2兆円</div>
                        <div class="metric-sub">国内最大級</div>
                    </div>
                </div>
            </div>

            <!-- 中央: 合致度スコア -->
            <div class="score-card">
                <div class="score-header">合致度</div>
                <div class="score-main">
                    <div class="score-value" id="score-value">--</div>
                    <div class="score-label">/ 100</div>
                </div>
                <div class="score-details" id="score-details">
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#64748b;"></span>時価総額 ≤700億</span>
                        <span class="score-item-status" id="score-market-cap">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#2563eb;"></span>自己資本比率 ≥30%</span>
                        <span class="score-item-status" id="score-equity-ratio">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#16a34a;"></span>売上成長(実績)</span>
                        <span class="score-item-status" id="score-revenue-growth">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#059669;"></span>売上成長(予想)</span>
                        <span class="score-item-status" id="score-revenue-forecast">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#ea580c;"></span>営業利益率 ≥10%</span>
                        <span class="score-item-status" id="score-op-margin">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#0d9488;"></span>営利成長(実績)</span>
                        <span class="score-item-status" id="score-op-growth">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#0891b2;"></span>営利成長(予想)</span>
                        <span class="score-item-status" id="score-op-forecast">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#7c3aed;"></span>営業CF >0</span>
                        <span class="score-item-status" id="score-op-cf">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#a855f7;"></span>フリーCF >0</span>
                        <span class="score-item-status" id="score-free-cf">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#dc2626;"></span>ROA >4.5%</span>
                        <span class="score-item-status" id="score-roa">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#ca8a04;"></span>PER <40倍</span>
                        <span class="score-item-status" id="score-per">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#db2777;"></span>PBR <10倍</span>
                        <span class="score-item-status" id="score-pbr">--</span>
                    </div>
                </div>
            </div>

            <!-- 右側: チャート -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">株価推移</div>
                </div>
                <div class="chart-placeholder" id="tradingview-chart-container">
                    <div style="display:flex;align-items:center;justify-content:center;height:300px;color:#64748b;">
                        銘柄を選択するとチャートが表示されます
                    </div>
                </div>
            </div>
        </div>

        <!-- 会社概要・事業説明セクション -->
        <div class="business-summary-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">事業概要</div>
                <div class="detail-content">
                    <div id="business-summary-content" style="line-height: 1.8; color: var(--text-primary); font-size: 0.95rem;">
                        <div class="loading-state" style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            データを読み込み中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 財務データテーブル（四季報スタイル） -->
        <div class="financial-data-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">財務データ（直近5年）</div>
                <div class="detail-content" style="overflow-x: auto;">
                    <table class="financial-table" style="width: 100%; min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; width: 100px;">決算期</th>
                                <th>売上高(億円)</th>
                                <th>営業利益(億円)</th>
                                <th>経常利益(億円)</th>
                                <th>純利益(億円)</th>
                                <th>1株益(円)</th>
                                <th>1株配(円)</th>
                                <th>配当性向(%)</th>
                            </tr>
                        </thead>
                        <tbody id="financial-data-tbody">
                            <tr data-year="1">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="2">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="3">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="4">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="5">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- キャッシュフロー・財務指標テーブル -->
        <div class="financial-metrics-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">キャッシュフロー・財務指標</div>
                <div class="detail-content" style="overflow-x: auto;">
                    <table class="financial-table" style="width: 100%; min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; width: 100px;">決算期</th>
                                <th>営業CF(億円)</th>
                                <th>投資CF(億円)</th>
                                <th>財務CF(億円)</th>
                                <th>現金等(億円)</th>
                                <th>流動負債(億円)</th>
                                <th>自己資本比率(%)</th>
                                <th>ROE(%)</th>
                                <th>ROA(%)</th>
                            </tr>
                        </thead>
                        <tbody id="cf-metrics-tbody">
                            <tr data-year="1">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="2">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="3">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="4">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="5">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 詳細情報セクション - 3カラム（財務健全性・主要株主・役員構成） -->
        <div class="details-section" style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 20px;">

            <!-- 財務健全性 -->
            <div class="detail-card">
                <div class="detail-header">財務健全性</div>
                <div class="detail-content">
                    <div class="detail-row">
                        <span class="detail-label">現預金</span>
                        <span class="detail-value" id="cash-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">流動負債</span>
                        <span class="detail-value" id="current-liab-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">流動比率</span>
                        <span class="detail-value" id="current-ratio-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">配当性向</span>
                        <span class="detail-value" id="payout-ratio-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">信用倍率</span>
                        <span class="detail-value" id="margin-ratio-display">---</span>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f5f9;">
                        <div class="detail-row">
                            <span class="detail-label" style="font-size: 0.75rem; color: #94a3b8;">現預金推移</span>
                        </div>
                        <div id="cash-trend" style="margin-top: 8px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #64748b;">
                                <span id="cash-old">---</span>
                                <span>→</span>
                                <span id="cash-new" style="font-weight: 600;">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主要株主 -->
            <div class="detail-card">
                <div class="detail-header">主要株主</div>
                <div class="detail-content">
                    <div id="major-holders-content">
                        <div class="loading-state">データを読み込み中...</div>
                    </div>
                    <!-- データソース -->
                    <div id="holders-source-left" style="margin-top: 10px; font-size: 11px; color: #666;">
                    </div>
                </div>
            </div>

            <!-- 役員構成 -->
            <div class="detail-card">
                <div class="detail-header">役員構成</div>
                <div class="detail-content">
                    <div id="company-officers-content">
                        <div class="loading-state">データを読み込み中...</div>
                    </div>
                    <!-- データソース -->
                    <div id="holders-source-right" style="margin-top: 10px; font-size: 11px; color: #666;">
                    </div>
                </div>
            </div>
        </div>

        {% if is_admin %}
        <!-- 保存セクション -->
        <div class="save-section" id="saveSection">
            <p class="edit-hint">表示されている値は直接編集できます。編集後は下のボタンで保存してください。</p>
            <button class="save-button" onclick="saveEditedData()">変更を保存</button>
        </div>
        {% endif %}
    </div>

    </div><!-- /tabSearch -->

    <!-- 企業比較タブ -->
    <div id="tabCompare" style="display:none;">
        <div class="compare-container" x-data="compareApp()" x-init="init()">

            <!-- ページヘッダー -->
            <div class="page-header">
                <h1><i class="fas fa-balance-scale" style="font-size: 1.25rem; margin-right: 8px;"></i>企業比較</h1>
                <p>2~3社の財務指標をレーダーチャートとテーブルで比較できます</p>
            </div>

            <!-- 企業選択カード -->
            <div class="selection-card">
                <div class="selection-card-title">比較する企業を選択</div>

                <div class="company-slots">
                    <!-- 企業スロット A -->
                    <div class="company-slot">
                        <div class="slot-label">
                            <span class="dot dot-a"></span>
                            企業 A
                        </div>
                        <div class="slot-input-wrapper">
                            <input
                                type="text"
                                class="slot-input"
                                placeholder="銘柄コードまたは企業名"
                                x-model="slots[0].query"
                                @input="onInput(0)"
                                @focus="onFocus(0)"
                                @blur="onBlur(0)"
                                @keydown="onKeydown($event, 0)"
                                autocomplete="off"
                            >
                            <button
                                class="slot-clear"
                                x-show="slots[0].selected"
                                @click="clearSlot(0)"
                                style="display:none;"
                                :style="slots[0].selected ? 'display:block' : 'display:none'"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                            <div
                                class="suggest-dropdown"
                                x-ref="dropdown0"
                                :style="slots[0].showDropdown ? 'display:block' : 'display:none'"
                            >
                                <template x-for="(item, idx) in slots[0].filtered" :key="item.c">
                                    <div
                                        class="suggest-option"
                                        :class="{ 'highlighted': slots[0].highlightIndex === idx }"
                                        @mousedown.prevent="selectCompany(0, item)"
                                    >
                                        <span class="suggest-option-code" x-text="item.c"></span>
                                        <span class="suggest-option-name" x-text="item.n"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- 企業スロット B -->
                    <div class="company-slot">
                        <div class="slot-label">
                            <span class="dot dot-b"></span>
                            企業 B
                        </div>
                        <div class="slot-input-wrapper">
                            <input
                                type="text"
                                class="slot-input"
                                placeholder="銘柄コードまたは企業名"
                                x-model="slots[1].query"
                                @input="onInput(1)"
                                @focus="onFocus(1)"
                                @blur="onBlur(1)"
                                @keydown="onKeydown($event, 1)"
                                autocomplete="off"
                            >
                            <button
                                class="slot-clear"
                                x-show="slots[1].selected"
                                @click="clearSlot(1)"
                                style="display:none;"
                                :style="slots[1].selected ? 'display:block' : 'display:none'"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                            <div
                                class="suggest-dropdown"
                                x-ref="dropdown1"
                                :style="slots[1].showDropdown ? 'display:block' : 'display:none'"
                            >
                                <template x-for="(item, idx) in slots[1].filtered" :key="item.c">
                                    <div
                                        class="suggest-option"
                                        :class="{ 'highlighted': slots[1].highlightIndex === idx }"
                                        @mousedown.prevent="selectCompany(1, item)"
                                    >
                                        <span class="suggest-option-code" x-text="item.c"></span>
                                        <span class="suggest-option-name" x-text="item.n"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- 企業スロット C（オプション） -->
                    <div class="company-slot" x-show="slotCount >= 3" x-cloak style="position: relative;">
                        <button
                            class="btn-remove-slot"
                            @click="removeThirdSlot()"
                            title="3社目を削除"
                        >
                            <i class="fas fa-times" style="font-size: 0.5rem;"></i>
                        </button>
                        <div class="slot-label">
                            <span class="dot dot-c"></span>
                            企業 C
                        </div>
                        <div class="slot-input-wrapper">
                            <input
                                type="text"
                                class="slot-input"
                                placeholder="銘柄コードまたは企業名"
                                x-model="slots[2].query"
                                @input="onInput(2)"
                                @focus="onFocus(2)"
                                @blur="onBlur(2)"
                                @keydown="onKeydown($event, 2)"
                                autocomplete="off"
                            >
                            <button
                                class="slot-clear"
                                x-show="slots[2].selected"
                                @click="clearSlot(2)"
                                style="display:none;"
                                :style="slots[2].selected ? 'display:block' : 'display:none'"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                            <div
                                class="suggest-dropdown"
                                x-ref="dropdown2"
                                :style="slots[2].showDropdown ? 'display:block' : 'display:none'"
                            >
                                <template x-for="(item, idx) in slots[2].filtered" :key="item.c">
                                    <div
                                        class="suggest-option"
                                        :class="{ 'highlighted': slots[2].highlightIndex === idx }"
                                        @mousedown.prevent="selectCompany(2, item)"
                                    >
                                        <span class="suggest-option-code" x-text="item.c"></span>
                                        <span class="suggest-option-name" x-text="item.n"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ボタン群 -->
                <div class="action-buttons">
                    <button
                        class="btn-add"
                        @click="addThirdSlot()"
                        :disabled="slotCount >= 3"
                        x-show="slotCount < 3"
                    >
                        <i class="fas fa-plus" style="font-size: 0.7rem;"></i>
                        追加
                    </button>
                    <button
                        class="btn-compare"
                        @click="fetchComparison()"
                        :disabled="!canCompare || loading"
                    >
                        <template x-if="!loading">
                            <span><i class="fas fa-chart-radar" style="font-size: 0.8rem;"></i> 比較する</span>
                        </template>
                        <template x-if="loading">
                            <span><i class="fas fa-circle-notch fa-spin" style="font-size: 0.8rem;"></i> 取得中...</span>
                        </template>
                    </button>
                </div>
            </div>

            <!-- 空状態（初期表示） -->
            <div x-show="!loading && !hasResults" class="selection-card" x-cloak>
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3>企業を選んで比較しましょう</h3>
                    <p>
                        上の入力欄に銘柄コードまたは企業名を入力してください。
                        2社以上を選択し「比較する」ボタンを押すと、
                        財務指標のレーダーチャートと比較テーブルが表示されます。
                    </p>
                    <p style="margin-top: 12px; font-size: 0.75rem; color: #a3a3a3;">
                        ※ 比較にはダッシュボードで事前に分析済みの企業が必要です
                    </p>
                </div>
            </div>

            <!-- ローディング -->
            <div x-show="loading" class="selection-card" x-cloak>
                <div class="compare-loading-state">
                    <div class="compare-loading-spinner"></div>
                    <p>財務データを取得しています...</p>
                </div>
            </div>

            <!-- 結果エリア -->
            <div x-show="hasResults && !loading" class="results-section" x-cloak>

                <!-- レーダーチャート -->
                <div class="result-card">
                    <div class="result-card-title">レーダーチャート</div>
                    <div class="radar-chart-wrapper">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <!-- 比較テーブル -->
                <div class="result-card">
                    <div class="result-card-title">指標比較テーブル</div>
                    <div class="compare-table-wrapper">
                        <table class="compare-table">
                            <thead>
                                <tr>
                                    <th>指標</th>
                                    <template x-for="(co, ci) in companies" :key="ci">
                                        <th>
                                            <div class="company-header-cell">
                                                <span x-text="co.company_name || co.company_code"></span>
                                                <span class="company-header-code" x-text="co.company_code"></span>
                                            </div>
                                        </th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>セクター</td>
                                    <template x-for="(co, ci) in companies" :key="'sector-'+ci">
                                        <td x-text="co.sector || '\u2014'"></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>時価総額（億円）</td>
                                    <template x-for="(co, ci) in companies" :key="'mcap-'+ci">
                                        <td x-text="formatMarketCapCompare(co.market_cap)"></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>株価（円）</td>
                                    <template x-for="(co, ci) in companies" :key="'price-'+ci">
                                        <td x-text="formatNum(co.stock_price, 0)"></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>合致度（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'match-'+ci">
                                        <td
                                            :class="cellClass('match_rate', ci, 'higher')"
                                            x-text="formatNum(co.match_rate, 1)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>PER（倍）</td>
                                    <template x-for="(co, ci) in companies" :key="'per-'+ci">
                                        <td
                                            :class="cellClass('per_forward', ci, 'lower')"
                                            x-text="formatNum(co.per_forward, 1)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>PBR（倍）</td>
                                    <template x-for="(co, ci) in companies" :key="'pbr-'+ci">
                                        <td
                                            :class="cellClass('pbr', ci, 'lower')"
                                            x-text="formatNum(co.pbr, 2)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>配当利回り（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'divy-'+ci">
                                        <td
                                            :class="cellClass('dividend_yield', ci, 'higher')"
                                            x-text="formatNum(co.dividend_yield, 2)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>配当性向（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'payout-'+ci">
                                        <td x-text="formatNum(co.payout_ratio, 1)"></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>ROE（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'roe-'+ci">
                                        <td
                                            :class="cellClass('roe', ci, 'higher')"
                                            x-text="formatNum(co.roe, 2)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>ROA（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'roa-'+ci">
                                        <td
                                            :class="cellClass('roa', ci, 'higher')"
                                            x-text="formatNum(co.roa, 2)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>営業利益率（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'opm-'+ci">
                                        <td
                                            :class="cellClass('operating_margin', ci, 'higher')"
                                            x-text="formatNum(co.operating_margin, 2)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>自己資本比率（%）</td>
                                    <template x-for="(co, ci) in companies" :key="'eq-'+ci">
                                        <td
                                            :class="cellClass('equity_ratio', ci, 'higher')"
                                            x-text="formatNum(co.equity_ratio, 1)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>EPS（円）</td>
                                    <template x-for="(co, ci) in companies" :key="'eps-'+ci">
                                        <td
                                            :class="cellClass('eps', ci, 'higher')"
                                            x-text="formatNum(co.eps, 1)"
                                        ></td>
                                    </template>
                                </tr>
                                <tr>
                                    <td>1株配当（円）</td>
                                    <template x-for="(co, ci) in companies" :key="'dps-'+ci">
                                        <td
                                            :class="cellClass('dps', ci, 'higher')"
                                            x-text="formatNum(co.dps, 1)"
                                        ></td>
                                    </template>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- /tabCompare -->

</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
    // 管理者モードフラグ
    const IS_ADMIN = {{ 'true' if is_admin else 'false' }};

    // グローバル変数でチャートインスタンスを保持
    let priceChart = null;
    let candlestickSeries = null;
    let volumeSeries = null;

    // 現在分析中の銘柄データを保持
    let currentStockData = null;
    let currentSymbol = null;

    // ローソク足チャートを表示する関数
    function showCandlestickChart(priceHistory) {
        const container = document.getElementById('tradingview-chart-container');
        if (!container) return;

        // コンテナをクリア
        container.innerHTML = '';

        // データがない場合
        if (!priceHistory || priceHistory.length === 0) {
            container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:300px;color:#666;">株価データがありません</div>';
            return;
        }

        // 既存のチャートを破棄
        if (priceChart) {
            priceChart.remove();
            priceChart = null;
        }

        // チャートを作成
        priceChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 300,
            layout: {
                background: { type: 'solid', color: '#ffffff' },
                textColor: '#333333',
            },
            grid: {
                vertLines: { color: '#e1e1e1' },
                horzLines: { color: '#e1e1e1' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
            localization: {
                locale: 'ja-JP',
                dateFormat: 'yyyy/MM/dd',
            },
        });

        // ローソク足シリーズを追加
        candlestickSeries = priceChart.addCandlestickSeries({
            upColor: '#ef5350',
            downColor: '#26a69a',
            borderUpColor: '#ef5350',
            borderDownColor: '#26a69a',
            wickUpColor: '#ef5350',
            wickDownColor: '#26a69a',
        });

        // データをフィルタリング（nullを除去）
        const validData = priceHistory.filter(d =>
            d.open !== null && d.high !== null && d.low !== null && d.close !== null
        );

        // データをセット
        candlestickSeries.setData(validData);

        // チャートを全データにフィット
        priceChart.timeScale().fitContent();

        // リサイズ対応
        const resizeObserver = new ResizeObserver(entries => {
            if (priceChart) {
                const { width } = entries[0].contentRect;
                priceChart.applyOptions({ width: width });
            }
        });
        resizeObserver.observe(container);
    }

    // 銘柄分析
    async function analyzeStock() {
        const stockCode = document.getElementById('stockCode').value.trim().toUpperCase();

        if (!stockCode) {
            showErrorModal('銘柄コードを入力してください');
            return;
        }

        // 4桁数字なら日本株として.Tを付ける
        const symbol = /^\d{4}$/.test(stockCode) ? `${stockCode}.T` : stockCode;

        // ローディング表示
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resultsArea').classList.remove('active');

        // 登録ボタンを一旦非表示
        const registerBtn = document.getElementById('registerBtn');
        registerBtn.style.display = 'none';

        try {
            const response = await fetch('/api/stock/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: symbol })
            });

            const data = await response.json();

            if (response.ok) {
                // 分析データを保持
                currentStockData = data;
                currentSymbol = symbol;

                // 結果を表示
                updateResults(data);
                document.getElementById('resultsArea').classList.add('active');

                // 登録状態をチェックしてボタンを表示
                const isRegistered = await checkRegistrationStatus(symbol);
                registerBtn.style.display = 'inline-block';
                if (isRegistered) {
                    registerBtn.textContent = 'データ更新';
                    registerBtn.classList.add('registered');
                    registerBtn.disabled = false;
                } else {
                    registerBtn.textContent = '登録';
                    registerBtn.classList.remove('registered');
                    registerBtn.disabled = false;
                }
            } else {
                if (data.timeout || response.status === 504) {
                    showErrorModal('データ取得の応答に時間がかかりすぎたため、中断しました。\n再度お試しください。');
                } else {
                    showErrorModal('データを取得できませんでした。\n銘柄コードをご確認のうえ、再度お試しください。');
                }
            }
        } catch (error) {
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                showErrorModal('データ取得の応答に時間がかかりすぎたため、中断しました。\n再度お試しください。');
            } else {
                showErrorModal('通信中にエラーが発生しました。\n再度お試しください。');
            }
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // 結果を更新する関数
    function updateResults(data) {
        console.log('API Response Data:', data);

        // 通貨情報をグローバル変数に保存
        window.currentCurrency = data.currency || 'JPY';

        // 会社名（日本語優先）
        const companyNameElement = document.querySelector('.company-name');
        if (companyNameElement) {
            const displayName = data.name_jp || data.name || data.symbol;
            companyNameElement.textContent = displayName;
        }

        // 株価表示
        const stockPriceDisplay = document.getElementById('stock-price-display');
        if (stockPriceDisplay && data.last_price) {
            const currency = data.currency === 'JPY' ? '¥' : '$';
            stockPriceDisplay.textContent = `${currency}${formatNumber(data.last_price)}`;
        } else if (stockPriceDisplay) {
            stockPriceDisplay.textContent = '---';
        }

        // 銘柄コードと業種（日本語優先表示）
        const companyCodeElement = document.querySelector('.company-code');
        if (companyCodeElement) {
            const industryJa = data.industry_jp || null;
            const sectorJa = data.sector_jp || null;
            const industryEn = data.industry || null;
            const sectorEn = data.sector || null;

            let industryLine = "";
            if (industryJa) {
                industryLine = industryJa + (sectorJa ? `（${sectorJa}）` : "");
            } else if (industryEn) {
                industryLine = industryEn + (sectorEn ? ` (${sectorEn})` : "");
            } else {
                industryLine = '---';
            }

            companyCodeElement.textContent = `銘柄コード: ${data.symbol}` + (industryLine !== '---' ? ` | 業種: ${industryLine}` : "");
        }

        // 自己資本比率のフォールバック処理
        const equityRatio =
            data.equity_ratio_pct ??
            data.equity_ratio ??
            (Array.isArray(data.equity_ratio_list) && data.equity_ratio_list.length > 0
                ? data.equity_ratio_list.sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.value
                : null);

        // 主要指標を更新（業種情報を渡して評価テキスト生成）
        const industryForPER = data.industry_jp || data.industry || '';
        updateMetric('equity-ratio', equityRatio, '%', '自己資本比率', industryForPER);
        updateMetric('op-margin', data.op_margin_pct, '%', '営業利益率', industryForPER);
        updateMetric('per', data.per, '倍', 'PER', industryForPER);
        updateMetric('pbr', data.pbr, '倍', 'PBR', industryForPER);
        updateMetric('dividend-yield', data.dividend_yield, '%', '配当利回り', industryForPER);
        updateMetric('market-cap', data.market_cap, data.currency, '時価総額', industryForPER);

        // 財務指標テーブル更新（四季報スタイル）
        updateFinancialYearTable(data);

        // 配当情報更新
        updateDividendInfo(data);

        // 主要株主・役員情報を更新
        updateHoldersAndOfficers(data);

        // 会社概要・事業説明を更新
        updateBusinessSummary(data);

        // ローソク足チャート表示
        if (data.price_history && data.price_history.length > 0) {
            showCandlestickChart(data.price_history);
        }

        // 株価情報
        const chartTitle = document.querySelector('.chart-title');
        if (chartTitle && data.last_price) {
            const currency = data.currency === 'JPY' ? '¥' : '$';
            chartTitle.textContent = `株価推移（現在値: ${currency}${formatNumber(data.last_price)}）`;
        }

        // 合致度スコアカードを更新（抽出データをSupabase形式に変換）
        const scoreData = convertToScoreFormat(data);
        updateScoreCard(scoreData);
    }

    // 抽出データをスコアカード用形式に変換
    function convertToScoreFormat(data) {
        function getLatestValue(arr) {
            if (!arr || !Array.isArray(arr) || arr.length === 0) return null;
            const sorted = [...arr].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            return sorted[0]?.value ?? null;
        }

        const marketCapOku = data.market_cap ? data.market_cap / 1e8 : null;
        const opCfRaw = getLatestValue(data.operating_cf);
        const operatingCf = opCfRaw ? opCfRaw / 1e8 : null;
        const invCfRaw = getLatestValue(data.investing_cf);
        const investingCf = invCfRaw ? invCfRaw / 1e8 : null;
        const freeCf = (operatingCf !== null && investingCf !== null) ? operatingCf + investingCf : null;
        const roa = getLatestValue(data.roa);
        const equityRatio = data.equity_ratio_pct ?? data.equity_ratio ?? getLatestValue(data.equity_ratio_list);
        const operatingMargin = data.op_margin_pct ?? data.operating_margin;
        const per = data.per;
        const pbr = data.pbr;
        const forecastRevenue = data.forecast_revenue;
        const forecastOpIncome = data.forecast_op_income;
        const revenueList = data.revenue || [];
        const opIncomeList = data.op_income || [];

        let score = 0;
        if (marketCapOku !== null && marketCapOku <= 700) score += 10;
        if (equityRatio !== null && equityRatio >= 30) score += 10;
        if (revenueList.length >= 2) {
            const sorted = [...revenueList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0]?.value && sorted[1]?.value && sorted[1].value > 0) {
                const growth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (forecastRevenue && revenueList.length >= 1) {
            const sorted = [...revenueList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const lastRevenue = sorted[0]?.value ? sorted[0].value / 1e8 : null;
            if (lastRevenue && lastRevenue > 0) {
                const growth = ((forecastRevenue - lastRevenue) / lastRevenue) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (operatingMargin !== null && operatingMargin >= 10) score += 10;
        if (opIncomeList.length >= 2) {
            const sorted = [...opIncomeList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0]?.value && sorted[1]?.value && sorted[1].value > 0) {
                const growth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (forecastOpIncome && opIncomeList.length >= 1) {
            const sorted = [...opIncomeList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const lastOpIncome = sorted[0]?.value ? sorted[0].value / 1e8 : null;
            if (lastOpIncome && lastOpIncome > 0) {
                const growth = ((forecastOpIncome - lastOpIncome) / lastOpIncome) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (operatingCf !== null && operatingCf > 0) score += 10;
        if (freeCf !== null && freeCf > 0) score += 10;
        if (roa !== null && roa > 4.5) score += 10;
        if (per !== null && per > 0 && per < 40) score += 10;
        if (pbr !== null && pbr > 0 && pbr < 10) score += 10;

        return {
            match_rate: Math.round(score * 100 / 120),
            market_cap: marketCapOku,
            equity_ratio: equityRatio,
            operating_margin: operatingMargin,
            operating_cf: operatingCf,
            free_cf: freeCf,
            roa: roa,
            per_forward: per,
            pbr: pbr,
            forecast_revenue: forecastRevenue,
            forecast_op_income: forecastOpIncome,
            financial_history: {
                revenue: revenueList,
                op_income: opIncomeList
            },
            cf_history: {
                roa: data.roa || []
            }
        };
    }

    // 業種別のPER基準値マッピング
    const industryPERBenchmarks = {
        'Technology': { good: 25, warning: 40 },
        'Software': { good: 30, warning: 50 },
        'Internet': { good: 35, warning: 60 },
        'Semiconductors': { good: 20, warning: 35 },
        'Biotechnology': { good: 30, warning: 50 },
        'Healthcare': { good: 20, warning: 35 },
        'Renewable Energy': { good: 25, warning: 40 },
        'Automobiles': { good: 10, warning: 15 },
        'Manufacturing': { good: 12, warning: 18 },
        'Industrial': { good: 15, warning: 22 },
        'Construction': { good: 10, warning: 15 },
        'Banks': { good: 10, warning: 15 },
        'Insurance': { good: 12, warning: 18 },
        'Financial Services': { good: 15, warning: 25 },
        'Retail': { good: 18, warning: 28 },
        'Consumer Goods': { good: 15, warning: 25 },
        'Food & Beverage': { good: 18, warning: 28 },
        'Utilities': { good: 12, warning: 18 },
        'Real Estate': { good: 20, warning: 30 },
        'Transportation': { good: 15, warning: 22 },
        'default': { good: 15, warning: 25 }
    };

    function getIndustryPERBenchmark(industry) {
        if (industryPERBenchmarks[industry]) return industryPERBenchmarks[industry];
        for (const [key, value] of Object.entries(industryPERBenchmarks)) {
            if (industry && industry.toLowerCase().includes(key.toLowerCase())) return value;
        }
        return industryPERBenchmarks['default'];
    }

    // 指標を更新する関数（業種情報を追加）- 編集可能版
    function updateMetric(className, value, suffix, label, industryInfo = null) {
        const elements = document.querySelectorAll('.metric-item');
        for (const elem of elements) {
            const labelElem = elem.querySelector('.metric-label');
            if (labelElem && labelElem.textContent === label) {
                const valueElem = elem.querySelector('.metric-value');
                if (valueElem) {
                    const dataKey = label.replace(/\s/g, '_').toLowerCase();
                    let displayValue = '';
                    let rawValue = value;

                    if (value !== null && value !== undefined) {
                        if (label === '時価総額') {
                            displayValue = formatAmount(value, suffix);
                            rawValue = value;
                        } else {
                            displayValue = formatNumber(value);
                            rawValue = value;
                        }
                    } else {
                        displayValue = '';
                        rawValue = '';
                    }

                    if (IS_ADMIN) {
                        valueElem.innerHTML = `<input type="text" class="editable-field"
                            data-metric="${dataKey}"
                            data-suffix="${suffix}"
                            data-raw="${rawValue}"
                            value="${displayValue}"
                            onchange="onMetricEdit(this)"
                            onfocus="this.select()"
                        >${label !== '時価総額' ? suffix : ''}`;
                    } else {
                        const suffixText = label !== '時価総額' ? suffix : '';
                        valueElem.textContent = displayValue ? `${displayValue}${suffixText}` : '---';
                    }
                }

                // 評価テキストと色分け
                const subElem = elem.querySelector('.metric-sub');
                elem.classList.remove('good', 'warning', 'danger');
                const isBankOrRE = industryInfo && /銀行|不動産|bank|real estate|reit/i.test(industryInfo);
                if (label === '自己資本比率' && value != null) {
                    if (isBankOrRE) {
                        if (value >= 10) { elem.classList.add('good'); if (subElem) subElem.textContent = '健全(業種考慮)'; }
                        else if (value >= 5) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準(業種考慮)'; }
                        else { elem.classList.add('danger'); if (subElem) subElem.textContent = '注意'; }
                    } else {
                        if (value >= 40) { elem.classList.add('good'); if (subElem) subElem.textContent = '健全'; }
                        else if (value >= 30) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準'; }
                        else { elem.classList.add('danger'); if (subElem) subElem.textContent = '注意'; }
                    }
                } else if (label === '営業利益率' && value != null) {
                    if (value >= 15) { elem.classList.add('good'); if (subElem) subElem.textContent = '高収益'; }
                    else if (value >= 10) { elem.classList.add('good'); if (subElem) subElem.textContent = '良好'; }
                    else if (value >= 5) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準'; }
                    else { elem.classList.add('danger'); if (subElem) subElem.textContent = '低い'; }
                } else if (label === 'PER' && value != null) {
                    const benchmark = getIndustryPERBenchmark(industryInfo);
                    if (value <= benchmark.good) elem.classList.add('good');
                    else if (value <= benchmark.warning) elem.classList.add('warning');
                    else elem.classList.add('danger');
                    if (subElem) subElem.textContent = `業種基準: ${benchmark.good}-${benchmark.warning}倍`;
                } else if (label === 'PBR' && value != null) {
                    if (value <= 1) { elem.classList.add('good'); if (subElem) subElem.textContent = '割安'; }
                    else if (value <= 2) { elem.classList.add('warning'); if (subElem) subElem.textContent = '適正'; }
                    else { elem.classList.add('danger'); if (subElem) subElem.textContent = '割高'; }
                } else if (label === '配当利回り' && value != null) {
                    if (value >= 3) { elem.classList.add('good'); if (subElem) subElem.textContent = '高配当'; }
                    else if (value >= 2) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準'; }
                    else if (value > 0) { if (subElem) subElem.textContent = '低い'; }
                    else { if (subElem) subElem.textContent = '無配'; }
                } else if (label === '時価総額' && value != null) {
                    const oku = value / 1e8;
                    if (oku <= 300) { if (subElem) subElem.textContent = '小型株'; }
                    else if (oku <= 700) { if (subElem) subElem.textContent = '中小型'; }
                    else if (oku <= 3000) { if (subElem) subElem.textContent = '中型株'; }
                    else { if (subElem) subElem.textContent = '大型株'; }
                }
                break;
            }
        }
    }

    function onMetricEdit(input) { showSaveSection(); }

    // 財務テーブル更新
    function updateFinancialYearTable(data) {
        const yearDataMap = new Map();
        const dataTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income', 'eps', 'dps', 'payout_ratio',
                          'operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list', 'equity_ratio_list', 'roe', 'roa'];

        dataTypes.forEach(type => {
            if (data[type] && Array.isArray(data[type])) {
                data[type].forEach(item => {
                    const d = new Date(item.date);
                    const year = d.getFullYear();
                    const month = d.getMonth() + 1;
                    if (!yearDataMap.has(year)) {
                        yearDataMap.set(year, { _month: month, _date: item.date });
                    }
                    yearDataMap.get(year)[type] = item.value;
                });
            }
        });

        if (data.forecast_year) {
            const fd = new Date(data.forecast_year);
            const fYear = fd.getFullYear();
            const fMonth = fd.getMonth() + 1;
            if (!yearDataMap.has(fYear) || !yearDataMap.get(fYear).revenue) {
                if (!yearDataMap.has(fYear)) {
                    yearDataMap.set(fYear, { _month: fMonth, _date: data.forecast_year, _forecast: true });
                } else {
                    yearDataMap.get(fYear)._forecast = true;
                }
                const fy = yearDataMap.get(fYear);
                if (data.forecast_revenue) fy.revenue = data.forecast_revenue * 1e8;
                if (data.forecast_op_income) fy.op_income = data.forecast_op_income * 1e8;
                if (data.forecast_ordinary_income) fy.ordinary_income = data.forecast_ordinary_income * 1e8;
                if (data.forecast_net_income) fy.net_income = data.forecast_net_income * 1e8;
            }
        }

        const sortedYears = Array.from(yearDataMap.keys()).sort((a, b) => a - b).slice(-5);
        updateFinancialDataTable(sortedYears, yearDataMap);
        updateCashFlowMetricsTable(sortedYears, yearDataMap);
        updateLatestPayoutRatio(data);
        updateFinancialHealth(data);
    }

    function updateFinancialDataTable(years, dataMap) {
        const tbody = document.getElementById('financial-data-tbody');
        if (!tbody) return;

        years.forEach((year, index) => {
            const row = tbody.querySelector(`tr[data-year="${index + 1}"]`);
            if (!row) return;
            const yearLabel = row.querySelector('.year-label');
            if (yearLabel) {
                const yearData = dataMap.get(year) || {};
                const month = yearData._month;
                const forecast = yearData._forecast ? '(予)' : '';
                yearLabel.textContent = month ? `${year}年${month}月${forecast}` : `${year}年${forecast}`;
                yearLabel.dataset.fullDate = yearData._date || `${year}-03-31`;
                if (yearData._forecast) { yearLabel.style.color = '#1b4332'; yearLabel.style.whiteSpace = 'nowrap'; }
            }
            const yearData = dataMap.get(year) || {};
            updateCellValue(row, 'revenue', yearData.revenue);
            updateCellValue(row, 'op_income', yearData.op_income);
            updateCellValue(row, 'ordinary_income', yearData.ordinary_income);
            updateCellValue(row, 'net_income', yearData.net_income);
            updateCellValue(row, 'eps', yearData.eps, true);
            updateCellValue(row, 'dps', yearData.dps, true);
            updateCellValue(row, 'payout_ratio', yearData.payout_ratio, false, true);
        });
    }

    function updateCashFlowMetricsTable(years, dataMap) {
        const tbody = document.getElementById('cf-metrics-tbody');
        if (!tbody) return;

        years.forEach((year, index) => {
            const row = tbody.querySelector(`tr[data-year="${index + 1}"]`);
            if (!row) return;
            const yearLabel = row.querySelector('.year-label');
            if (yearLabel) {
                const yearData = dataMap.get(year) || {};
                const month = yearData._month;
                const forecast = yearData._forecast ? '(予)' : '';
                yearLabel.textContent = month ? `${year}年${month}月${forecast}` : `${year}年${forecast}`;
                yearLabel.dataset.fullDate = yearData._date || `${year}-03-31`;
                if (yearData._forecast) { yearLabel.style.color = '#1b4332'; yearLabel.style.whiteSpace = 'nowrap'; }
            }
            const yearData = dataMap.get(year) || {};
            updateCellValue(row, 'operating_cf', yearData.operating_cf);
            updateCellValue(row, 'investing_cf', yearData.investing_cf);
            updateCellValue(row, 'financing_cf', yearData.financing_cf);
            updateCellValue(row, 'cash', yearData.cash);
            updateCellValue(row, 'current_liabilities_list', yearData.current_liabilities_list);
            updateCellValue(row, 'equity_ratio_list', yearData.equity_ratio_list, false, true);
            updateCellValue(row, 'roe', yearData.roe, false, true);
            updateCellValue(row, 'roa', yearData.roa, false, true);
        });
    }

    function updateCellValue(row, dataType, value, isPerShare = false, isPercent = false) {
        const cell = row.querySelector(`td[data-type="${dataType}"]`);
        if (!cell) return;

        const yearIndex = row.getAttribute('data-year');
        let displayValue = '';
        let rawValue = value;

        const amountTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income',
                            'operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list'];

        if (value !== undefined && value !== null) {
            if (isPerShare) {
                displayValue = value.toFixed(2);
            } else if (isPercent) {
                displayValue = value.toFixed(1);
            } else if (amountTypes.includes(dataType)) {
                const okuValue = value / 1e8;
                displayValue = okuValue.toFixed(2);
            } else {
                displayValue = value.toFixed(2);
            }
            rawValue = value;
        } else {
            displayValue = '';
            rawValue = '';
        }

        cell.innerHTML = `<input type="number" class="editable-cell"
            data-type="${dataType}"
            data-year="${yearIndex}"
            data-raw="${rawValue}"
            data-is-percent="${isPercent}"
            data-is-pershare="${isPerShare}"
            data-is-amount="${amountTypes.includes(dataType)}"
            value="${displayValue}"
            onchange="onCellEdit(this)"
            onfocus="this.select()"
            step="0.01"
        >`;
    }

    function updateDividendInfo(data) {
        const rows = document.querySelectorAll('.detail-card .detail-row');
        for (const row of rows) {
            const label = row.querySelector('.detail-label');
            const value = row.querySelector('.detail-value');
            if (label && value) {
                if (label.textContent === '配当利回り' && data.dividend_yield !== null) {
                    value.textContent = `${data.dividend_yield.toFixed(2)}%`;
                }
            }
        }
    }

    function updateLatestPayoutRatio(data) {
        const payoutDisplay = document.getElementById('payout-ratio-display');
        if (payoutDisplay && data.payout_ratio && data.payout_ratio.length > 0) {
            const sortedPayoutRatios = data.payout_ratio.sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );
            const latestPayout = sortedPayoutRatios[0];
            if (latestPayout && latestPayout.value !== undefined) {
                payoutDisplay.textContent = `${latestPayout.value.toFixed(1)}%`;
            }
        }
    }

    function updateFinancialHealth(data) {
        const cashDisplay = document.getElementById('cash-display');
        const cashOld = document.getElementById('cash-old');
        const cashNew = document.getElementById('cash-new');

        if (data.cash && data.cash.length > 0) {
            const sortedCash = data.cash.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestCash = sortedCash[0];
            if (cashDisplay && latestCash) {
                cashDisplay.textContent = formatAmount(latestCash.value, window.currentCurrency);
            }
            if (cashOld && cashNew && sortedCash.length > 1) {
                const oldestCash = sortedCash[sortedCash.length - 1];
                cashOld.textContent = formatAmount(oldestCash.value, window.currentCurrency);
                cashNew.textContent = formatAmount(latestCash.value, window.currentCurrency);
            } else if (cashNew && latestCash) {
                cashNew.textContent = formatAmount(latestCash.value, window.currentCurrency);
            }
        }

        const currentLiabDisplay = document.getElementById('current-liab-display');
        let latestCurrentLiab = null;

        if (data.current_liabilities_list && data.current_liabilities_list.length > 0) {
            const sortedLiab = data.current_liabilities_list.sort((a, b) => new Date(b.date) - new Date(a.date));
            latestCurrentLiab = sortedLiab[0];
            if (currentLiabDisplay && latestCurrentLiab) {
                currentLiabDisplay.textContent = formatAmount(latestCurrentLiab.value, window.currentCurrency);
            }
        } else if (data.current_liabilities) {
            latestCurrentLiab = { value: data.current_liabilities };
            if (currentLiabDisplay) {
                currentLiabDisplay.textContent = formatAmount(data.current_liabilities, window.currentCurrency);
            }
        }

        const currentRatioDisplay = document.getElementById('current-ratio-display');
        if (currentRatioDisplay && latestCurrentLiab) {
            const currentAssetsList = data.current_assets_list || [];
            let latestCurrentAssets = null;
            if (currentAssetsList.length > 0) {
                const sortedAssets = currentAssetsList.sort((a, b) => new Date(b.date) - new Date(a.date));
                latestCurrentAssets = sortedAssets[0];
            } else if (data.cash && data.cash.length > 0) {
                const sortedCash = data.cash.sort((a, b) => new Date(b.date) - new Date(a.date));
                latestCurrentAssets = sortedCash[0];
            }
            if (latestCurrentAssets && latestCurrentLiab.value > 0) {
                const currentRatio = (latestCurrentAssets.value / latestCurrentLiab.value) * 100;
                currentRatioDisplay.textContent = `${currentRatio.toFixed(1)}%`;
                if (currentRatio >= 150) { currentRatioDisplay.style.color = 'var(--success-color)'; }
                else if (currentRatio >= 100) { currentRatioDisplay.style.color = 'var(--warning-color)'; }
                else { currentRatioDisplay.style.color = 'var(--danger-color)'; }
            }
        }

        const marginRatioDisplay = document.getElementById('margin-ratio-display');
        if (marginRatioDisplay) {
            if (data.margin_trading_ratio !== null && data.margin_trading_ratio !== undefined) {
                marginRatioDisplay.textContent = `${data.margin_trading_ratio.toFixed(2)}倍`;
                if (data.margin_trading_ratio < 1) { marginRatioDisplay.style.color = 'var(--danger-color)'; }
                else if (data.margin_trading_ratio <= 3) { marginRatioDisplay.style.color = 'var(--success-color)'; }
                else { marginRatioDisplay.style.color = 'var(--warning-color)'; }
                if (data.margin_trading_buy && data.margin_trading_sell) {
                    const buyFormatted = data.margin_trading_buy.toLocaleString();
                    const sellFormatted = data.margin_trading_sell.toLocaleString();
                    marginRatioDisplay.title = `買残: ${buyFormatted}株 / 売残: ${sellFormatted}株`;
                }
            } else {
                marginRatioDisplay.textContent = '---';
            }
        }
    }

    function calculateGrowthRate(dataArray) {
        if (dataArray.length < 2) return null;
        const latest = dataArray[0].value;
        const oldest = dataArray[dataArray.length - 1].value;
        const years = dataArray.length - 1;
        const rate = ((latest / oldest) ** (1 / years) - 1) * 100;
        return rate;
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return '---';
        if (typeof num === 'number') return num.toLocaleString('ja-JP', { maximumFractionDigits: 2 });
        return num;
    }

    function toNumberSafe(v) {
        if (v === null || v === undefined) return null;
        if (typeof v === 'string') v = v.replace(/,/g, '').trim();
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    }

    function formatAmount(num, currency = 'JPY') {
        const n0 = toNumberSafe(num);
        if (n0 === null) return '---';
        if (currency === 'JPY') {
            const sign = n0 < 0 ? '−' : '';
            const n = Math.abs(n0);
            if (n >= 1e12) return `${sign}${(n/1e12).toFixed(2)}兆円`;
            if (n >= 1e8)  return `${sign}${Math.round(n/1e8)}億円`;
            if (n >= 1e4)  return `${sign}${(n/1e4).toFixed(2)}万円`;
            return `${sign}${Math.round(n).toLocaleString()}円`;
        } else {
            const sign = n0 < 0 ? '-' : '';
            const n = Math.abs(n0);
            if (n >= 1e12) return `${sign}$${(n / 1e12).toFixed(2)}T`;
            if (n >= 1e9)  return `${sign}$${(n / 1e9).toFixed(2)}B`;
            if (n >= 1e6)  return `${sign}$${(n / 1e6).toFixed(2)}M`;
            return `${sign}$${Math.round(n).toLocaleString()}`;
        }
    }

    function formatMarketCap(num) {
        return formatAmount(num, window.currentCurrency || 'JPY');
    }

    // === サジェスト機能 ===
    let companiesData = [];
    let suggestIndex = -1;

    // 上場企業リストを読み込み
    fetch('/static/companies.json')
        .then(r => r.json())
        .then(data => { companiesData = data; })
        .catch(err => console.error('企業リスト読み込みエラー:', err));

    const stockInput = document.getElementById('stockCode');
    const suggestList = document.getElementById('suggestList');

    stockInput.addEventListener('input', function() {
        const query = this.value.trim();
        suggestIndex = -1;

        if (!query || query.length < 1) {
            suggestList.style.display = 'none';
            return;
        }

        const lower = query.toLowerCase();
        const matches = companiesData.filter(c =>
            c.c.startsWith(query) || c.n.toLowerCase().includes(lower)
        ).slice(0, 8);

        if (matches.length === 0) {
            suggestList.style.display = 'none';
            return;
        }

        suggestList.innerHTML = matches.map((m, i) =>
            `<div class="suggest-item" data-code="${m.c}" data-index="${i}">
                <span class="suggest-code">${m.c}</span>
                <span class="suggest-name">${m.n}</span>
            </div>`
        ).join('');
        suggestList.style.display = 'block';
    });

    // サジェスト項目クリック
    suggestList.addEventListener('click', function(e) {
        const item = e.target.closest('.suggest-item');
        if (item) {
            stockInput.value = item.dataset.code;
            suggestList.style.display = 'none';
            analyzeStock();
        }
    });

    // キーボード操作（上下矢印・Enter・Escape）
    stockInput.addEventListener('keydown', function(e) {
        const items = suggestList.querySelectorAll('.suggest-item');
        if (suggestList.style.display === 'none' || items.length === 0) {
            if (e.key === 'Enter') { analyzeStock(); }
            return;
        }

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            suggestIndex = Math.min(suggestIndex + 1, items.length - 1);
            items.forEach((el, i) => el.classList.toggle('active', i === suggestIndex));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            suggestIndex = Math.max(suggestIndex - 1, 0);
            items.forEach((el, i) => el.classList.toggle('active', i === suggestIndex));
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (suggestIndex >= 0 && items[suggestIndex]) {
                stockInput.value = items[suggestIndex].dataset.code;
                suggestList.style.display = 'none';
                analyzeStock();
            } else {
                suggestList.style.display = 'none';
                analyzeStock();
            }
        } else if (e.key === 'Escape') {
            suggestList.style.display = 'none';
        }
    });

    // 入力欄外クリックでサジェスト閉じる
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-input-wrapper')) {
            suggestList.style.display = 'none';
        }
    });

    // 主要株主・役員情報を更新
    function updateHoldersAndOfficers(data) {
        updateMajorHolders(data);
        updateCompanyOfficers(data);
        updateHoldersSource(data);
    }

    function updateMajorHolders(data) {
        const majorHoldersContent = document.getElementById('major-holders-content');
        if (!majorHoldersContent) return;

        let html = '';
        let hasData = false;

        if (data.major_holders && data.major_holders.length > 0) {
            const insiderData = data.major_holders.find(h => h.Breakdown && h.Breakdown.includes('insider'));
            const institutionData = data.major_holders.find(h => h.Breakdown && h.Breakdown.includes('institution'));

            if (insiderData || institutionData) {
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">';
                html += '<thead><tr style="background-color: #f8f9fa;">';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">保有者</th>';
                html += '<th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6; font-size: 13px;">比率</th>';
                html += '</tr></thead><tbody>';
                if (insiderData) {
                    const percentage = (insiderData.Value * 100).toFixed(1);
                    html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #dc2626;">創業家・内部者</td>`;
                    html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${percentage}%</td></tr>`;
                }
                if (institutionData) {
                    const percentage = (institutionData.Value * 100).toFixed(1);
                    html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee;">機関投資家</td>`;
                    html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${percentage}%</td></tr>`;
                }
                html += '</tbody></table>';
                hasData = true;
            }
        }

        const topHolders = [];
        if (data.major_shareholders_jp && data.major_shareholders_jp.length > 0) {
            topHolders.push(...data.major_shareholders_jp.slice(0, 5).map(h => ({
                name: h.name || 'N/A', percentage: h.ratio ? h.ratio.toFixed(2) : 'N/A', type: '日本語'
            })));
        } else if (data.institutional_holders && data.institutional_holders.length > 0) {
            topHolders.push(...data.institutional_holders.slice(0, 5).map(h => ({
                name: h.Holder || 'N/A', percentage: h['% Out'] ? (h['% Out'] * 100).toFixed(2) : 'N/A', type: '機関'
            })));
        } else if (data.institution_ownership && data.institution_ownership.length > 0) {
            topHolders.push(...data.institution_ownership.slice(0, 5).map(h => ({
                name: h.organization || 'N/A', percentage: h.pctHeld ? (h.pctHeld * 100).toFixed(2) : 'N/A', type: '機関'
            })));
        }

        if (topHolders.length > 0) {
            html += '<div style="margin-top: 10px;">';
            html += '<div style="font-weight: bold; margin-bottom: 8px; color: #374151;">筆頭株主</div>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 12px;">順位</th>';
            html += '<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 12px;">株主名</th>';
            html += '<th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #dee2e6; font-size: 12px;">保有比率</th>';
            html += '</tr></thead><tbody>';
            topHolders.forEach((holder, index) => {
                const rankIcon = index === 0 ? '1' : (index === 1 ? '2' : `${index + 1}`);
                html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; text-align: center;">${rankIcon}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 11px;">${holder.name}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; color: #2563eb; font-size: 12px;">${holder.percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';
            hasData = true;
        }

        if (!hasData) {
            html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">データが取得できませんでした</div>';
        }

        majorHoldersContent.innerHTML = html;
    }

    function updateCompanyOfficers(data) {
        const officersContent = document.getElementById('company-officers-content');
        if (!officersContent) return;

        let html = '';

        if (data.company_officers && data.company_officers.length > 0) {
            const importantOfficers = [];
            const otherOfficers = [];

            data.company_officers.forEach(officer => {
                const title = officer.title_jp || officer.title || '';
                const name = officer.name_jp || officer.name || '';
                const isCEO = title.includes('CEO') || title.includes('President') || title.includes('社長') || title.includes('代表');
                const isCFO = title.includes('CFO') || title.includes('Chief Financial') || title.includes('財務');
                const isCTO = title.includes('CTO') || title.includes('Chief Technology') || title.includes('技術');
                const isChairman = title.includes('Chairman') || title.includes('会長') || title.includes('取締役会長');
                const hasJpData = officer.title_jp || officer.name_jp;

                if (isCEO || isCFO || isCTO || isChairman) {
                    importantOfficers.push({
                        name, title, age: officer.age, isImportant: true,
                        priority: isCEO ? 1 : (isChairman ? 2 : (isCFO ? 3 : 4)), hasJpData
                    });
                } else {
                    otherOfficers.push({ name, title, age: officer.age, isImportant: false, hasJpData });
                }
            });

            importantOfficers.sort((a, b) => a.priority - b.priority);

            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">役職</th>';
            html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">氏名</th>';
            html += '</tr></thead><tbody>';

            importantOfficers.forEach(officer => {
                const age = officer.age ? ` (${officer.age}歳)` : '';
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #374151;">${officer.title}</td>`;
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #1f2937;">${officer.name}${age}</td></tr>`;
            });

            const maxOtherOfficers = otherOfficers.some(o => o.hasJpData) ? 10 : 5;
            otherOfficers.slice(0, maxOtherOfficers).forEach(officer => {
                const age = officer.age ? ` (${officer.age}歳)` : '';
                html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 11px; color: #6b7280;">${officer.title}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #374151;">${officer.name}${age}</td></tr>`;
            });

            html += '</tbody></table>';

            const totalOfficers = data.company_officers.length;
            const displayedOfficers = importantOfficers.length + Math.min(otherOfficers.length, maxOtherOfficers);
            if (totalOfficers > displayedOfficers) {
                html += `<div style="margin-top: 8px; font-size: 11px; color: #6b7280; text-align: right;">他 ${totalOfficers - displayedOfficers} 名の役員</div>`;
            }
        } else {
            html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">データが取得できませんでした</div>';
        }

        officersContent.innerHTML = html;
    }

    function updateHoldersSource(data) {
        const sourceLeftElement = document.getElementById('holders-source-left');
        const sourceRightElement = document.getElementById('holders-source-right');
        if (!sourceLeftElement || !sourceRightElement) return;
        let sourceText = '';
        if (data.holders_source) {
            sourceText = `出典: ${data.holders_source}`;
            if (data.holders_fallback_needed) sourceText += ' (fallback)';
        }
        sourceLeftElement.textContent = sourceText;
        sourceRightElement.textContent = sourceText;
    }

    function updateBusinessSummary(data) {
        const summaryContent = document.getElementById('business-summary-content');
        if (!summaryContent) return;
        let html = '';
        if (data.business_summary_jp) {
            html = `<div style="margin-bottom: 15px;">
                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">事業特色</div>
                <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">${data.business_summary_jp}</div>
            </div>`;
        } else if (data.business_summary) {
            html = `<div>
                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">Business Summary</div>
                <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">${data.business_summary}</div>
            </div>`;
        }
        if (!data.business_summary_jp && !data.business_summary) {
            html = '<div style="color: var(--text-secondary); text-align: center; padding: 20px; font-style: italic;">事業概要データが取得できませんでした</div>';
        }
        summaryContent.innerHTML = html;
    }

    // 合致度スコアカードを更新
    function updateScoreCard(data) {
        const scoreValue = document.getElementById('score-value');
        const matchRate = data.match_rate;
        if (matchRate !== null && matchRate !== undefined) {
            scoreValue.textContent = matchRate;
            scoreValue.className = 'score-value';
            if (matchRate >= 58) scoreValue.classList.add('high');
            else if (matchRate >= 33) scoreValue.classList.add('medium');
            else scoreValue.classList.add('low');
        } else {
            scoreValue.textContent = '--';
            scoreValue.className = 'score-value';
        }

        const marketCap = data.market_cap;
        updateScoreItem('score-market-cap', marketCap !== null && marketCap <= 700, marketCap ? `${Math.round(marketCap)}億` : null);
        const equityRatio = data.equity_ratio;
        updateScoreItem('score-equity-ratio', equityRatio !== null && equityRatio >= 30, equityRatio ? `${equityRatio.toFixed(1)}%` : null);

        let revenueGrowth = null, revenueGrowthPass = false;
        const financialHistory = parseJsonField(data.financial_history);
        if (financialHistory && financialHistory.revenue && financialHistory.revenue.length >= 2) {
            const sorted = [...financialHistory.revenue].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted.length >= 2 && sorted[0].value && sorted[1].value && sorted[1].value > 0) {
                revenueGrowth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                revenueGrowthPass = revenueGrowth > 0;
            }
        }
        updateScoreItem('score-revenue-growth', revenueGrowthPass, revenueGrowth !== null ? `${revenueGrowth.toFixed(1)}%` : null);

        let revenueForecastGrowth = null, revenueForecastPass = false;
        const forecastRevenue = data.forecast_revenue;
        if (forecastRevenue && financialHistory && financialHistory.revenue && financialHistory.revenue.length >= 1) {
            const sorted = [...financialHistory.revenue].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0].value && sorted[0].value > 0) {
                const forecastYen = forecastRevenue * 1e8;
                revenueForecastGrowth = ((forecastYen - sorted[0].value) / sorted[0].value) * 100;
                revenueForecastPass = revenueForecastGrowth > 0;
            }
        }
        updateScoreItem('score-revenue-forecast', revenueForecastPass, revenueForecastGrowth !== null ? `${revenueForecastGrowth.toFixed(1)}%` : null);

        const opMargin = data.operating_margin;
        updateScoreItem('score-op-margin', opMargin !== null && opMargin >= 10, opMargin ? `${opMargin.toFixed(1)}%` : null);

        let opGrowth = null, opGrowthPass = false;
        if (financialHistory && financialHistory.op_income && financialHistory.op_income.length >= 2) {
            const sorted = [...financialHistory.op_income].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted.length >= 2 && sorted[0].value && sorted[1].value && sorted[1].value > 0) {
                opGrowth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                opGrowthPass = opGrowth > 0;
            }
        }
        updateScoreItem('score-op-growth', opGrowthPass, opGrowth !== null ? `${opGrowth.toFixed(1)}%` : null);

        let opForecastGrowth = null, opForecastPass = false;
        const forecastOpIncome = data.forecast_op_income;
        if (forecastOpIncome && financialHistory && financialHistory.op_income && financialHistory.op_income.length >= 1) {
            const sorted = [...financialHistory.op_income].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0].value && sorted[0].value > 0) {
                const forecastYen = forecastOpIncome * 1e8;
                opForecastGrowth = ((forecastYen - sorted[0].value) / sorted[0].value) * 100;
                opForecastPass = opForecastGrowth > 0;
            }
        }
        updateScoreItem('score-op-forecast', opForecastPass, opForecastGrowth !== null ? `${opForecastGrowth.toFixed(1)}%` : null);

        const operatingCf = data.operating_cf;
        updateScoreItem('score-op-cf', operatingCf !== null && operatingCf > 0, operatingCf ? `${operatingCf.toFixed(1)}億` : null);
        const freeCf = data.free_cf;
        updateScoreItem('score-free-cf', freeCf !== null && freeCf > 0, freeCf ? `${freeCf.toFixed(1)}億` : null);

        let roa = data.roa;
        if (roa === null || roa === undefined) {
            const cfHistory = parseJsonField(data.cf_history);
            if (cfHistory && cfHistory.roa && cfHistory.roa.length > 0) {
                const sorted = [...cfHistory.roa].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                roa = sorted[0].value;
            }
        }
        updateScoreItem('score-roa', roa !== null && roa > 4.5, roa ? `${roa.toFixed(1)}%` : null);

        const per = data.per_forward;
        updateScoreItem('score-per', per !== null && per > 0 && per < 40, per ? `${per.toFixed(1)}倍` : null);
        const pbr = data.pbr;
        updateScoreItem('score-pbr', pbr !== null && pbr > 0 && pbr < 10, pbr ? `${pbr.toFixed(2)}倍` : null);
    }

    function parseJsonField(field) {
        if (!field) return null;
        if (typeof field === 'object') return field;
        try { return JSON.parse(field); } catch { return null; }
    }

    function updateScoreItem(elementId, pass, value) {
        const element = document.getElementById(elementId);
        if (!element) return;
        if (value === null) {
            element.textContent = '--';
            element.className = 'score-item-status';
        } else {
            element.textContent = pass ? `✓ ${value}` : `✗ ${value}`;
            element.className = 'score-item-status ' + (pass ? 'pass' : 'fail');
        }
    }

    // 登録状態をチェック
    async function checkRegistrationStatus(symbol) {
        try {
            const response = await fetch(`/api/watchlist/check/${symbol}`);
            const data = await response.json();
            return data.is_registered || false;
        } catch (error) {
            console.error('登録状態チェックエラー:', error);
            return false;
        }
    }

    // 銘柄を登録
    async function registerStock() {
        if (!currentSymbol || !currentStockData) {
            showErrorModal('先に銘柄を抽出してください');
            return;
        }

        const registerBtn = document.getElementById('registerBtn');
        registerBtn.disabled = true;
        registerBtn.textContent = '登録中...';

        try {
            const response = await fetch('/api/watchlist/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_code: currentSymbol,
                    stock_data: currentStockData
                })
            });

            const data = await response.json();

            if (response.ok) {
                registerBtn.textContent = 'データ更新';
                registerBtn.classList.add('registered');
                registerBtn.disabled = false;
            } else {
                showErrorModal('登録に失敗しました。再度お試しください。');
                registerBtn.disabled = false;
                registerBtn.textContent = '登録';
            }
        } catch (error) {
            showErrorModal('接続エラーです。再度お試しください。');
            registerBtn.disabled = false;
            registerBtn.textContent = '登録';
        }
    }

    // データ編集・保存機能
    function onCellEdit(input) { showSaveSection(); }

    function showSaveSection() {
        if (!IS_ADMIN) return;
        const saveSection = document.getElementById('saveSection');
        if (saveSection) saveSection.classList.add('active');
    }

    function hideSaveSection() {
        const saveSection = document.getElementById('saveSection');
        if (saveSection) saveSection.classList.remove('active');
    }

    async function saveEditedData() {
        if (!currentSymbol) { showErrorModal('保存する銘柄がありません'); return; }
        const saveBtn = document.querySelector('.save-button');
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中...';

        try {
            const editedData = collectEditedData();
            const response = await fetch('/api/watchlist/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_code: currentSymbol, edited_data: editedData })
            });
            const result = await response.json();
            if (response.ok) {
                showSuccessModal('データを保存しました');
                hideSaveSection();
            } else {
                showErrorModal('保存に失敗しました。再度お試しください。');
            }
        } catch (error) {
            showErrorModal('接続エラーです。再度お試しください。');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '変更を保存';
        }
    }

    function collectEditedData() {
        const data = {};
        const metricInputs = document.querySelectorAll('.editable-field[data-metric]');
        metricInputs.forEach(input => {
            const metric = input.getAttribute('data-metric');
            const value = parseEditedValue(input.value);
            if (metric && value !== null) {
                const keyMap = {
                    '自己資本比率': 'equity_ratio', '営業利益率': 'operating_margin',
                    'per': 'per_forward', 'pbr': 'pbr', '配当利回り': 'dividend_yield', '時価総額': 'market_cap'
                };
                const dbKey = keyMap[metric] || metric;
                data[dbKey] = value;
            }
        });

        const financialHistory = {};
        const cfHistory = {};
        const cellInputs = document.querySelectorAll('.editable-cell[data-type]');
        cellInputs.forEach(input => {
            const dataType = input.getAttribute('data-type');
            const yearIndex = input.getAttribute('data-year');
            const isAmount = input.getAttribute('data-is-amount') === 'true';
            let value = parseFloat(input.value);
            if (!dataType || !yearIndex || isNaN(value)) return;
            if (isAmount) value = value * 1e8;

            const financialTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income', 'eps', 'dps', 'payout_ratio'];
            const cfTypes = ['operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list', 'equity_ratio_list', 'roe', 'roa'];

            if (financialTypes.includes(dataType)) {
                if (!financialHistory[dataType]) financialHistory[dataType] = [];
                const yearLabel = document.querySelector(`#financial-data-tbody tr[data-year="${yearIndex}"] .year-label`);
                const fullDate = yearLabel && yearLabel.dataset.fullDate ? yearLabel.dataset.fullDate : `${yearIndex}-03-31`;
                financialHistory[dataType].push({ date: fullDate, value: value });
            } else if (cfTypes.includes(dataType)) {
                if (!cfHistory[dataType]) cfHistory[dataType] = [];
                const yearLabel = document.querySelector(`#cf-metrics-tbody tr[data-year="${yearIndex}"] .year-label`);
                const fullDate = yearLabel && yearLabel.dataset.fullDate ? yearLabel.dataset.fullDate : `${yearIndex}-03-31`;
                cfHistory[dataType].push({ date: fullDate, value: value });
            }
        });

        if (Object.keys(financialHistory).length > 0) data.financial_history = financialHistory;
        if (Object.keys(cfHistory).length > 0) data.cf_history = cfHistory;
        return data;
    }

    function parseEditedValue(str) {
        if (!str || str === '---' || str === '') return null;
        let value = str.replace(/,/g, '').trim();
        if (value.includes('兆')) { value = parseFloat(value.replace('兆', '').replace('円', '')) * 1e12; }
        else if (value.includes('億')) { value = parseFloat(value.replace('億', '').replace('円', '')) * 1e8; }
        else if (value.includes('万')) { value = parseFloat(value.replace('万', '').replace('円', '')) * 1e4; }
        else { value = parseFloat(value.replace('円', '').replace('%', '').replace('倍', '')); }
        return Number.isFinite(value) ? value : null;
    }

    // ページ読み込み時
    document.addEventListener('DOMContentLoaded', function() {
        if (!IS_ADMIN) {
            document.querySelectorAll('.editable-cell, .editable-field').forEach(el => {
                el.readOnly = true;
                el.style.cursor = 'default';
                el.style.pointerEvents = 'none';
            });
        }
    });

    // === タブ切り替え機能 ===
    function switchInfoTab(tab) {
        var tabSearch = document.getElementById('tabSearch');
        var tabCompare = document.getElementById('tabCompare');
        var btnSearch = document.getElementById('tabBtnSearch');
        var btnCompare = document.getElementById('tabBtnCompare');
        var searchBar = document.getElementById('searchBarArea');

        if (tab === 'search') {
            tabSearch.style.display = 'block';
            tabCompare.style.display = 'none';
            btnSearch.classList.add('active');
            btnCompare.classList.remove('active');
            searchBar.style.display = 'flex';
        } else {
            tabSearch.style.display = 'none';
            tabCompare.style.display = 'block';
            btnSearch.classList.remove('active');
            btnCompare.classList.add('active');
            searchBar.style.display = 'none';
        }
    }
</script>

<!-- 企業比較タブ用Alpine.jsアプリケーション -->
<script>
function compareApp() {
    return {
        /* --- 状態 --- */
        allCompanies: [],
        slotCount: 2,
        slots: [
            { query: '', selected: null, filtered: [], showDropdown: false, highlightIndex: -1 },
            { query: '', selected: null, filtered: [], showDropdown: false, highlightIndex: -1 },
            { query: '', selected: null, filtered: [], showDropdown: false, highlightIndex: -1 }
        ],
        loading: false,
        hasResults: false,
        companies: [],
        radarChart: null,

        /* --- 算出プロパティ --- */
        get canCompare() {
            var count = 0;
            for (var i = 0; i < this.slotCount; i++) {
                if (this.slots[i].selected) count++;
            }
            return count >= 2;
        },

        /* --- 初期化 --- */
        async init() {
            try {
                var res = await fetch('/static/companies.json');
                if (res.ok) {
                    this.allCompanies = await res.json();
                }
            } catch (e) {
                console.error('企業リストの読み込みに失敗しました', e);
            }
        },

        /* --- オートコンプリート --- */
        onInput(index) {
            var slot = this.slots[index];
            slot.selected = null;
            slot.highlightIndex = -1;
            var q = slot.query.trim().toLowerCase();
            if (q.length === 0) {
                slot.filtered = [];
                slot.showDropdown = false;
                return;
            }
            var usedCodes = new Set();
            for (var i = 0; i < this.slotCount; i++) {
                if (i !== index && this.slots[i].selected) {
                    usedCodes.add(this.slots[i].selected.c);
                }
            }
            slot.filtered = this.allCompanies
                .filter(function(item) {
                    if (usedCodes.has(item.c)) return false;
                    return item.c.indexOf(q) !== -1 || item.n.toLowerCase().indexOf(q) !== -1;
                })
                .slice(0, 30);
            slot.showDropdown = slot.filtered.length > 0;
        },

        onFocus(index) {
            var slot = this.slots[index];
            if (slot.filtered.length > 0 && slot.query.trim().length > 0) {
                slot.showDropdown = true;
            }
        },

        onBlur(index) {
            var self = this;
            setTimeout(function() {
                self.slots[index].showDropdown = false;
            }, 200);
        },

        onKeydown(event, index) {
            var slot = this.slots[index];
            if (!slot.showDropdown || slot.filtered.length === 0) return;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                slot.highlightIndex = (slot.highlightIndex + 1) % slot.filtered.length;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                slot.highlightIndex = slot.highlightIndex <= 0
                    ? slot.filtered.length - 1
                    : slot.highlightIndex - 1;
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (slot.highlightIndex >= 0 && slot.highlightIndex < slot.filtered.length) {
                    this.selectCompany(index, slot.filtered[slot.highlightIndex]);
                }
            } else if (event.key === 'Escape') {
                slot.showDropdown = false;
            }
        },

        selectCompany(index, item) {
            var slot = this.slots[index];
            slot.query = item.c + ' ' + item.n;
            slot.selected = item;
            slot.showDropdown = false;
            slot.highlightIndex = -1;
        },

        clearSlot(index) {
            var slot = this.slots[index];
            slot.query = '';
            slot.selected = null;
            slot.filtered = [];
            slot.showDropdown = false;
            slot.highlightIndex = -1;
        },

        /* --- スロット追加・削除 --- */
        addThirdSlot() {
            if (this.slotCount < 3) {
                this.slotCount = 3;
            }
        },

        removeThirdSlot() {
            this.clearSlot(2);
            this.slotCount = 2;
        },

        /* --- API呼び出し --- */
        async fetchComparison() {
            var codes = [];
            for (var i = 0; i < this.slotCount; i++) {
                if (this.slots[i].selected) {
                    codes.push(this.slots[i].selected.c);
                }
            }
            if (codes.length < 2) {
                showErrorModal('2社以上の企業を選択してください。');
                return;
            }

            this.loading = true;
            this.hasResults = false;

            try {
                var res = await fetch('/api/compare?codes=' + codes.join(','));
                var data = await res.json();

                if (!res.ok) {
                    showErrorModal(data.error || 'データの取得に失敗しました。');
                    this.loading = false;
                    return;
                }

                this.companies = data.companies;
                this.hasResults = true;
                this.loading = false;

                var self = this;
                this.$nextTick(function() {
                    self.renderRadarChart();
                });

            } catch (e) {
                showErrorModal('通信エラーが発生しました。しばらくしてからお試しください。');
                this.loading = false;
            }
        },

        /* --- レーダーチャート描画 --- */
        renderRadarChart() {
            var canvas = document.getElementById('radarChart');
            if (!canvas) return;

            if (this.radarChart) {
                this.radarChart.destroy();
                this.radarChart = null;
            }

            var labels = ['合致度', '自己資本比率', '営業利益率', 'ROE', 'PER逆数', '配当利回り'];

            var datasets = [];
            var colors = [
                { border: 'rgba(27,67,50,0.7)',  fill: 'rgba(27,67,50,0.15)' },
                { border: 'rgba(59,130,246,0.7)', fill: 'rgba(59,130,246,0.15)' },
                { border: 'rgba(234,88,12,0.7)',  fill: 'rgba(234,88,12,0.15)' }
            ];

            for (var i = 0; i < this.companies.length; i++) {
                var co = this.companies[i];
                var perInverse = (co.per_forward && co.per_forward > 0)
                    ? Math.min(100 / co.per_forward, 20)
                    : 0;

                datasets.push({
                    label: (co.company_name || co.company_code),
                    data: [
                        this.safeNum(co.match_rate),
                        this.safeNum(co.equity_ratio),
                        this.safeNum(co.operating_margin),
                        this.safeNum(co.roe),
                        perInverse,
                        this.safeNum(co.dividend_yield)
                    ],
                    borderColor: colors[i].border,
                    backgroundColor: colors[i].fill,
                    borderWidth: 2,
                    pointBackgroundColor: colors[i].border,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 1,
                    pointRadius: 3
                });
            }

            var allValues = [];
            for (var d = 0; d < datasets.length; d++) {
                for (var v = 0; v < datasets[d].data.length; v++) {
                    allValues.push(datasets[d].data[v]);
                }
            }
            var maxVal = Math.max.apply(null, allValues);
            var suggestedMax = Math.ceil(maxVal / 10) * 10;
            if (suggestedMax < 10) suggestedMax = 10;

            this.radarChart = new Chart(canvas, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: "'Inter', 'Noto Sans JP', sans-serif",
                                    size: 12
                                },
                                padding: 16,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var val = context.parsed.r;
                                    return context.dataset.label + ': ' + (val != null ? val.toFixed(2) : '\u2014');
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            ticks: {
                                stepSize: suggestedMax > 50 ? 20 : 10,
                                font: {
                                    family: "'Inter', 'Noto Sans JP', sans-serif",
                                    size: 10
                                },
                                color: '#a3a3a3',
                                backdropColor: 'transparent'
                            },
                            pointLabels: {
                                font: {
                                    family: "'Inter', 'Noto Sans JP', sans-serif",
                                    size: 12,
                                    weight: '500'
                                },
                                color: '#525252'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.06)'
                            },
                            angleLines: {
                                color: 'rgba(0,0,0,0.06)'
                            }
                        }
                    }
                }
            });
        },

        /* --- テーブル色分け --- */
        cellClass(field, companyIndex, direction) {
            var values = [];
            for (var i = 0; i < this.companies.length; i++) {
                var v = this.companies[i][field];
                values.push(v != null && typeof v === 'number' ? v : null);
            }

            var currentVal = values[companyIndex];
            if (currentVal === null) return '';

            var validValues = [];
            for (var j = 0; j < values.length; j++) {
                if (values[j] !== null) validValues.push(values[j]);
            }
            if (validValues.length < 2) return '';

            var best, worst;
            if (direction === 'higher') {
                best = Math.max.apply(null, validValues);
                worst = Math.min.apply(null, validValues);
            } else {
                best = Math.min.apply(null, validValues);
                worst = Math.max.apply(null, validValues);
            }

            if (best === worst) return '';

            if (currentVal === best) return 'cell-best';
            if (currentVal === worst) return 'cell-worst';
            return '';
        },

        /* --- ユーティリティ --- */
        safeNum(val) {
            if (val === null || val === undefined || typeof val !== 'number' || isNaN(val)) return 0;
            return val;
        },

        formatNum(val, decimals) {
            if (val === null || val === undefined || typeof val !== 'number' || isNaN(val)) return '\u2014';
            return val.toLocaleString('ja-JP', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        },

        formatMarketCapCompare(val) {
            if (val === null || val === undefined || typeof val !== 'number' || isNaN(val)) return '\u2014';
            var oku = val;
            if (val > 100000) {
                oku = val / 100000000;
            }
            return oku.toLocaleString('ja-JP', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
    };
}
</script>
{% endblock %}
