{% extends "layout.html" %}

{% block title %}銘柄検索 - Company Note{% endblock %}

{% block content %}
<style>
    /* 統一デザイン */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

    :root {
        --primary-color: #1b4332;
        --secondary-color: #2d6a4f;
        --accent-color: #2d6a4f;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --border-color: #e5e5e0;
        --bg-light: #fafaf8;
    }

    body {
        background: #f7f7f5;
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
        color: var(--text-primary);
    }

    .report-container {
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
    }

    /* ヘッダー */
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #ebebeb;
        margin-bottom: 20px;
    }

    .report-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .search-bar {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .stock-code-input {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95rem;
        width: 180px;
        transition: all 0.2s;
    }

    .stock-code-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.1);
    }

    .analyze-button {
        padding: 8px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .analyze-button:hover {
        background: var(--secondary-color);
    }

    .register-button {
        padding: 8px 20px;
        background: var(--success-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .register-button:hover {
        background: #059669;
    }

    .register-button.registered {
        background: var(--text-secondary);
        cursor: default;
    }

    .register-button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }

    /* メインコンテンツグリッド */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* サマリーカード */
    .summary-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
    }

    .company-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 2px;
    }

    .stock-price-display {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .company-code {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 15px;
    }

    .key-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .metric-item {
        padding: 12px;
        background: var(--bg-light);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
    }

    /* 上部のグラデーションバー */
    .metric-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-color), #52b788);
        opacity: 0.8;
    }

    .metric-item.good::before {
        background: linear-gradient(90deg, var(--success-color), #34d399);
    }

    .metric-item.warning::before {
        background: linear-gradient(90deg, var(--warning-color), #fbbf24);
    }

    .metric-item.danger::before {
        background: linear-gradient(90deg, var(--danger-color), #f87171);
    }

    /* ホバー時のアニメーション */
    .metric-item:hover::before {
        height: 4px;
        opacity: 1;
    }

    .metric-item {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .metric-sub {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* 合致度カード */
    .score-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .score-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .score-main {
        text-align: center;
        padding: 10px 0;
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .score-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    .score-value.high { color: #10b981; }
    .score-value.medium { color: #f59e0b; }
    .score-value.low { color: #ef4444; }

    .score-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .score-details {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px 12px;
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 0.75rem;
    }

    .score-item-label {
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .score-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }

    .score-item-status {
        font-weight: 500;
    }

    .score-item-status.pass { color: #10b981; }
    .score-item-status.fail { color: #ef4444; }

    .chart-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        height: 100%;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .time-selector {
        display: flex;
        gap: 5px;
    }

    .time-btn {
        padding: 4px 8px;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .time-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .chart-placeholder {
        height: 220px;
        background: var(--bg-light);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* 詳細テーブル - 4カラムに変更 */
    .details-section {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    /* カードの上部に細いグラデーションライン */
    .detail-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-color), #52b788);
        opacity: 0.6;
    }

    .detail-card:hover::after {
        height: 3px;
        opacity: 1;
    }

    .detail-header {
        background: var(--bg-light);
        padding: 12px 16px;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .detail-content {
        padding: 16px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .detail-value {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    /* 財務指標テーブル */
    .financial-table {
        width: 100%;
        font-size: 0.85rem;
    }

    .financial-table th {
        text-align: left;
        padding: 8px 0;
        color: var(--text-secondary);
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
    }

    .financial-table td {
        padding: 8px 0;
        color: var(--text-primary);
    }

    .trend-up {
        color: var(--success-color);
    }

    .trend-down {
        color: var(--danger-color);
    }

    /* 株主構成 */
    .shareholder-list, .executive-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .shareholder-item, .executive-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .shareholder-item:last-child, .executive-item:last-child {
        border-bottom: none;
    }

    .shareholder-name, .executive-name {
        font-size: 0.85rem;
        color: var(--text-primary);
    }

    .shareholder-percent {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--accent-color);
    }

    .executive-title {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .founder-tag {
        display: inline-block;
        padding: 2px 6px;
        background: var(--warning-color);
        color: white;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }

    .executive-tag {
        display: inline-block;
        padding: 2px 6px;
        background: var(--accent-color);
        color: white;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }

    /* ローディング */
    .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 0.95rem;
    }

    .loading-subtext {
        font-size: 0.8rem;
        color: var(--text-secondary);
        opacity: 0.7;
    }

    .results-area {
        display: none;
    }

    .results-area.active {
        display: block;
    }

    /* 編集可能フィールド */
    .editable-field {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 2px 6px;
        margin: -2px -6px;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        width: auto;
        min-width: 60px;
        transition: all 0.2s;
    }

    .editable-field:hover {
        border-color: var(--border-color);
        background: white;
    }

    .editable-field:focus {
        outline: none;
        border-color: var(--accent-color);
        background: white;
        box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
    }

    .editable-cell {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 3px;
        padding: 4px 8px;
        font-size: inherit;
        color: inherit;
        width: 80px;
        text-align: right;
        transition: all 0.2s;
        -moz-appearance: textfield;
    }

    .editable-cell::-webkit-outer-spin-button,
    .editable-cell::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .editable-cell:hover {
        border-color: var(--border-color);
        background: white;
    }

    .editable-cell:focus {
        outline: none;
        border-color: var(--accent-color);
        background: white;
    }

    /* 保存ボタン */
    .save-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        text-align: center;
    }

    .save-section.active {
        display: block;
    }

    .save-button {
        padding: 12px 40px;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .save-button:hover {
        background: var(--primary-color);
    }

    .save-button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }

    .edit-hint {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 10px;
    }

    /* レスポンシブ */
    @media (max-width: 1400px) {
        .details-section {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }

        .details-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .report-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .search-bar {
            width: 100%;
        }

        .stock-code-input {
            flex: 1;
        }

        .key-metrics {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<div class="report-container">
    <!-- ヘッダー -->
    <div class="report-header">
        <div class="report-title">銘柄検索</div>
        <div class="search-bar">
            <input type="text" class="stock-code-input" id="stockCode" placeholder="銘柄コード (例: 7203 / 6758.T / AAPL)">
            <button class="analyze-button" onclick="analyzeStock()">抽出</button>
            <button class="register-button" id="registerBtn" onclick="registerStock()" style="display: none;">登録</button>
        </div>
    </div>

    <!-- ローディング -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">データを取得中...</div>
            <div class="loading-subtext">目安：10～20秒程度</div>
        </div>
    </div>

    <!-- 結果エリア -->
    <div class="results-area" id="resultsArea">
        <!-- メインコンテンツ -->
        <div class="content-grid">
            <!-- 左側: サマリー情報 -->
            <div class="summary-card">
                <div class="company-name">トヨタ自動車</div>
                <div class="stock-price-display" id="stock-price-display">¥2,850</div>
                <div class="company-code">銘柄コード: 7203 | 自動車製造業</div>

                <div class="key-metrics">
                    <div class="metric-item good">
                        <div class="metric-label">自己資本比率</div>
                        <div class="metric-value">42.5%</div>
                        <div class="metric-sub">健全性: 良好</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">営業利益率</div>
                        <div class="metric-value">9.8%</div>
                        <div class="metric-sub">収益性: 良好</div>
                    </div>
                    <div class="metric-item warning">
                        <div class="metric-label">PER</div>
                        <div class="metric-value">11.2倍</div>
                        <div class="metric-sub">業界平均: 10.5倍</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">PBR</div>
                        <div class="metric-value">0.95倍</div>
                        <div class="metric-sub">割安水準</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">配当利回り</div>
                        <div class="metric-value">2.8%</div>
                        <div class="metric-sub">5年連続増配</div>
                    </div>
                    <div class="metric-item good">
                        <div class="metric-label">時価総額</div>
                        <div class="metric-value">40.2兆円</div>
                        <div class="metric-sub">国内最大級</div>
                    </div>
                </div>
            </div>

            <!-- 中央: 合致度スコア -->
            <div class="score-card">
                <div class="score-header">合致度</div>
                <div class="score-main">
                    <div class="score-value" id="score-value">--</div>
                    <div class="score-label">/ 100</div>
                </div>
                <div class="score-details" id="score-details">
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#64748b;"></span>時価総額 ≤700億</span>
                        <span class="score-item-status" id="score-market-cap">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#2563eb;"></span>自己資本比率 ≥30%</span>
                        <span class="score-item-status" id="score-equity-ratio">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#16a34a;"></span>売上成長(実績)</span>
                        <span class="score-item-status" id="score-revenue-growth">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#059669;"></span>売上成長(予想)</span>
                        <span class="score-item-status" id="score-revenue-forecast">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#ea580c;"></span>営業利益率 ≥10%</span>
                        <span class="score-item-status" id="score-op-margin">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#0d9488;"></span>営利成長(実績)</span>
                        <span class="score-item-status" id="score-op-growth">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#0891b2;"></span>営利成長(予想)</span>
                        <span class="score-item-status" id="score-op-forecast">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#7c3aed;"></span>営業CF >0</span>
                        <span class="score-item-status" id="score-op-cf">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#a855f7;"></span>フリーCF >0</span>
                        <span class="score-item-status" id="score-free-cf">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#dc2626;"></span>ROA >4.5%</span>
                        <span class="score-item-status" id="score-roa">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#ca8a04;"></span>PER <40倍</span>
                        <span class="score-item-status" id="score-per">--</span>
                    </div>
                    <div class="score-item">
                        <span class="score-item-label"><span class="score-dot" style="background:#db2777;"></span>PBR <10倍</span>
                        <span class="score-item-status" id="score-pbr">--</span>
                    </div>
                </div>
            </div>

            <!-- 右側: チャート -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">株価推移</div>
                </div>
                <div class="chart-placeholder" id="tradingview-chart-container">
                    <div style="display:flex;align-items:center;justify-content:center;height:300px;color:#64748b;">
                        銘柄を選択するとチャートが表示されます
                    </div>
                </div>
            </div>
        </div>

        <!-- 会社概要・事業説明セクション -->
        <div class="business-summary-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">事業概要</div>
                <div class="detail-content">
                    <div id="business-summary-content" style="line-height: 1.8; color: var(--text-primary); font-size: 0.95rem;">
                        <div class="loading-state" style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            データを読み込み中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 財務データテーブル（四季報スタイル） -->
        <div class="financial-data-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">財務データ（直近5年）</div>
                <div class="detail-content" style="overflow-x: auto;">
                    <table class="financial-table" style="width: 100%; min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; width: 100px;">決算期</th>
                                <th>売上高(億円)</th>
                                <th>営業利益(億円)</th>
                                <th>経常利益(億円)</th>
                                <th>純利益(億円)</th>
                                <th>1株益(円)</th>
                                <th>1株配(円)</th>
                                <th>配当性向(%)</th>
                            </tr>
                        </thead>
                        <tbody id="financial-data-tbody">
                            <tr data-year="1">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="2">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="3">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="4">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                            <tr data-year="5">
                                <td class="year-label">---</td>
                                <td data-type="revenue">---</td>
                                <td data-type="op_income">---</td>
                                <td data-type="ordinary_income">---</td>
                                <td data-type="net_income">---</td>
                                <td data-type="eps">---</td>
                                <td data-type="dps">---</td>
                                <td data-type="payout_ratio">---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- キャッシュフロー・財務指標テーブル -->
        <div class="financial-metrics-section" style="margin-bottom: 20px;">
            <div class="detail-card" style="grid-column: 1 / -1;">
                <div class="detail-header">キャッシュフロー・財務指標</div>
                <div class="detail-content" style="overflow-x: auto;">
                    <table class="financial-table" style="width: 100%; min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; width: 100px;">決算期</th>
                                <th>営業CF(億円)</th>
                                <th>投資CF(億円)</th>
                                <th>財務CF(億円)</th>
                                <th>現金等(億円)</th>
                                <th>流動負債(億円)</th>
                                <th>自己資本比率(%)</th>
                                <th>ROE(%)</th>
                                <th>ROA(%)</th>
                            </tr>
                        </thead>
                        <tbody id="cf-metrics-tbody">
                            <tr data-year="1">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="2">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="3">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="4">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                            <tr data-year="5">
                                <td class="year-label">---</td>
                                <td data-type="operating_cf">---</td>
                                <td data-type="investing_cf">---</td>
                                <td data-type="financing_cf">---</td>
                                <td data-type="cash">---</td>
                                <td data-type="current_liabilities_list">---</td>
                                <td data-type="equity_ratio_list">---</td>
                                <td data-type="roe">---</td>
                                <td data-type="roa">---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 詳細情報セクション - 3カラム（財務健全性・主要株主・役員構成） -->
        <div class="details-section" style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 20px;">

            <!-- 財務健全性 -->
            <div class="detail-card">
                <div class="detail-header">財務健全性</div>
                <div class="detail-content">
                    <div class="detail-row">
                        <span class="detail-label">現預金</span>
                        <span class="detail-value" id="cash-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">流動負債</span>
                        <span class="detail-value" id="current-liab-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">流動比率</span>
                        <span class="detail-value" id="current-ratio-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">配当性向</span>
                        <span class="detail-value" id="payout-ratio-display">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">信用倍率</span>
                        <span class="detail-value" id="margin-ratio-display">---</span>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f5f9;">
                        <div class="detail-row">
                            <span class="detail-label" style="font-size: 0.75rem; color: #94a3b8;">現預金推移</span>
                        </div>
                        <div id="cash-trend" style="margin-top: 8px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #64748b;">
                                <span id="cash-old">---</span>
                                <span>→</span>
                                <span id="cash-new" style="font-weight: 600;">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主要株主 -->
            <div class="detail-card">
                <div class="detail-header">主要株主</div>
                <div class="detail-content">
                    <div id="major-holders-content">
                        <div class="loading-state">データを読み込み中...</div>
                    </div>
                    <!-- データソース -->
                    <div id="holders-source-left" style="margin-top: 10px; font-size: 11px; color: #666;">
                    </div>
                </div>
            </div>

            <!-- 役員構成 -->
            <div class="detail-card">
                <div class="detail-header">役員構成</div>
                <div class="detail-content">
                    <div id="company-officers-content">
                        <div class="loading-state">データを読み込み中...</div>
                    </div>
                    <!-- データソース -->
                    <div id="holders-source-right" style="margin-top: 10px; font-size: 11px; color: #666;">
                    </div>
                </div>
            </div>
        </div>

        {% if is_admin %}
        <!-- 保存セクション -->
        <div class="save-section" id="saveSection">
            <p class="edit-hint">表示されている値は直接編集できます。編集後は下のボタンで保存してください。</p>
            <button class="save-button" onclick="saveEditedData()">変更を保存</button>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
    // 管理者モードフラグ
    const IS_ADMIN = {{ 'true' if is_admin else 'false' }};

    // グローバル変数でチャートインスタンスを保持
    let priceChart = null;
    let candlestickSeries = null;
    let volumeSeries = null;

    // 現在分析中の銘柄データを保持
    let currentStockData = null;
    let currentSymbol = null;

    // ローソク足チャートを表示する関数
    function showCandlestickChart(priceHistory) {
        const container = document.getElementById('tradingview-chart-container');
        if (!container) return;

        // コンテナをクリア
        container.innerHTML = '';

        // データがない場合
        if (!priceHistory || priceHistory.length === 0) {
            container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:300px;color:#666;">株価データがありません</div>';
            return;
        }

        // 既存のチャートを破棄
        if (priceChart) {
            priceChart.remove();
            priceChart = null;
        }

        // チャートを作成
        priceChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 300,
            layout: {
                background: { type: 'solid', color: '#ffffff' },
                textColor: '#333333',
            },
            grid: {
                vertLines: { color: '#e1e1e1' },
                horzLines: { color: '#e1e1e1' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
            localization: {
                locale: 'ja-JP',
                dateFormat: 'yyyy/MM/dd',
            },
        });

        // ローソク足シリーズを追加
        candlestickSeries = priceChart.addCandlestickSeries({
            upColor: '#ef5350',
            downColor: '#26a69a',
            borderUpColor: '#ef5350',
            borderDownColor: '#26a69a',
            wickUpColor: '#ef5350',
            wickDownColor: '#26a69a',
        });

        // データをフィルタリング（nullを除去）
        const validData = priceHistory.filter(d =>
            d.open !== null && d.high !== null && d.low !== null && d.close !== null
        );

        // データをセット
        candlestickSeries.setData(validData);

        // チャートを全データにフィット
        priceChart.timeScale().fitContent();

        // リサイズ対応
        const resizeObserver = new ResizeObserver(entries => {
            if (priceChart) {
                const { width } = entries[0].contentRect;
                priceChart.applyOptions({ width: width });
            }
        });
        resizeObserver.observe(container);
    }

    // 銘柄分析
    async function analyzeStock() {
        const stockCode = document.getElementById('stockCode').value.trim().toUpperCase();

        if (!stockCode) {
            showErrorModal('銘柄コードを入力してください');
            return;
        }

        // 4桁数字なら日本株として.Tを付ける
        const symbol = /^\d{4}$/.test(stockCode) ? `${stockCode}.T` : stockCode;

        // ローディング表示
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resultsArea').classList.remove('active');

        // 登録ボタンを一旦非表示
        const registerBtn = document.getElementById('registerBtn');
        registerBtn.style.display = 'none';

        try {
            const response = await fetch('/api/stock/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: symbol })
            });

            const data = await response.json();

            if (response.ok) {
                // 分析データを保持
                currentStockData = data;
                currentSymbol = symbol;

                // 結果を表示
                updateResults(data);
                document.getElementById('resultsArea').classList.add('active');

                // 登録状態をチェックしてボタンを表示
                const isRegistered = await checkRegistrationStatus(symbol);
                registerBtn.style.display = 'inline-block';
                if (isRegistered) {
                    registerBtn.textContent = 'データ更新';
                    registerBtn.classList.add('registered');
                    registerBtn.disabled = false;
                } else {
                    registerBtn.textContent = '登録';
                    registerBtn.classList.remove('registered');
                    registerBtn.disabled = false;
                }
            } else {
                if (data.timeout || response.status === 504) {
                    showErrorModal('データ取得の応答に時間がかかりすぎたため、中断しました。\n再度お試しください。');
                } else {
                    showErrorModal('データを取得できませんでした。\n銘柄コードをご確認のうえ、再度お試しください。');
                }
            }
        } catch (error) {
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                showErrorModal('データ取得の応答に時間がかかりすぎたため、中断しました。\n再度お試しください。');
            } else {
                showErrorModal('通信中にエラーが発生しました。\n再度お試しください。');
            }
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // 結果を更新する関数
    function updateResults(data) {
        console.log('API Response Data:', data);

        // 通貨情報をグローバル変数に保存
        window.currentCurrency = data.currency || 'JPY';

        // 会社名（日本語優先）
        const companyNameElement = document.querySelector('.company-name');
        if (companyNameElement) {
            const displayName = data.name_jp || data.name || data.symbol;
            companyNameElement.textContent = displayName;
        }

        // 株価表示
        const stockPriceDisplay = document.getElementById('stock-price-display');
        if (stockPriceDisplay && data.last_price) {
            const currency = data.currency === 'JPY' ? '¥' : '$';
            stockPriceDisplay.textContent = `${currency}${formatNumber(data.last_price)}`;
        } else if (stockPriceDisplay) {
            stockPriceDisplay.textContent = '---';
        }

        // 銘柄コードと業種（日本語優先表示）
        const companyCodeElement = document.querySelector('.company-code');
        if (companyCodeElement) {
            const industryJa = data.industry_jp || null;
            const sectorJa = data.sector_jp || null;
            const industryEn = data.industry || null;
            const sectorEn = data.sector || null;

            let industryLine = "";
            if (industryJa) {
                industryLine = industryJa + (sectorJa ? `（${sectorJa}）` : "");
            } else if (industryEn) {
                industryLine = industryEn + (sectorEn ? ` (${sectorEn})` : "");
            } else {
                industryLine = '---';
            }

            companyCodeElement.textContent = `銘柄コード: ${data.symbol}` + (industryLine !== '---' ? ` | 業種: ${industryLine}` : "");
        }

        // 自己資本比率のフォールバック処理
        const equityRatio =
            data.equity_ratio_pct ??
            data.equity_ratio ??
            (Array.isArray(data.equity_ratio_list) && data.equity_ratio_list.length > 0
                ? data.equity_ratio_list.sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.value
                : null);

        // 主要指標を更新（業種情報を渡して評価テキスト生成）
        const industryForPER = data.industry_jp || data.industry || '';
        updateMetric('equity-ratio', equityRatio, '%', '自己資本比率', industryForPER);
        updateMetric('op-margin', data.op_margin_pct, '%', '営業利益率', industryForPER);
        updateMetric('per', data.per, '倍', 'PER', industryForPER);
        updateMetric('pbr', data.pbr, '倍', 'PBR', industryForPER);
        updateMetric('dividend-yield', data.dividend_yield, '%', '配当利回り', industryForPER);
        updateMetric('market-cap', data.market_cap, data.currency, '時価総額', industryForPER);

        // 財務指標テーブル更新（四季報スタイル）
        updateFinancialYearTable(data);

        // 配当情報更新
        updateDividendInfo(data);

        // 主要株主・役員情報を更新
        updateHoldersAndOfficers(data);

        // 会社概要・事業説明を更新
        updateBusinessSummary(data);

        // ローソク足チャート表示
        if (data.price_history && data.price_history.length > 0) {
            showCandlestickChart(data.price_history);
        }

        // 株価情報
        const chartTitle = document.querySelector('.chart-title');
        if (chartTitle && data.last_price) {
            const currency = data.currency === 'JPY' ? '¥' : '$';
            chartTitle.textContent = `株価推移（現在値: ${currency}${formatNumber(data.last_price)}）`;
        }

        // 合致度スコアカードを更新（抽出データをSupabase形式に変換）
        const scoreData = convertToScoreFormat(data);
        updateScoreCard(scoreData);
    }

    // 抽出データをスコアカード用形式に変換
    function convertToScoreFormat(data) {
        function getLatestValue(arr) {
            if (!arr || !Array.isArray(arr) || arr.length === 0) return null;
            const sorted = [...arr].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            return sorted[0]?.value ?? null;
        }

        const marketCapOku = data.market_cap ? data.market_cap / 1e8 : null;
        const opCfRaw = getLatestValue(data.operating_cf);
        const operatingCf = opCfRaw ? opCfRaw / 1e8 : null;
        const invCfRaw = getLatestValue(data.investing_cf);
        const investingCf = invCfRaw ? invCfRaw / 1e8 : null;
        const freeCf = (operatingCf !== null && investingCf !== null) ? operatingCf + investingCf : null;
        const roa = getLatestValue(data.roa);
        const equityRatio = data.equity_ratio_pct ?? data.equity_ratio ?? getLatestValue(data.equity_ratio_list);
        const operatingMargin = data.op_margin_pct ?? data.operating_margin;
        const per = data.per;
        const pbr = data.pbr;
        const forecastRevenue = data.forecast_revenue;
        const forecastOpIncome = data.forecast_op_income;
        const revenueList = data.revenue || [];
        const opIncomeList = data.op_income || [];

        let score = 0;
        if (marketCapOku !== null && marketCapOku <= 700) score += 10;
        if (equityRatio !== null && equityRatio >= 30) score += 10;
        if (revenueList.length >= 2) {
            const sorted = [...revenueList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0]?.value && sorted[1]?.value && sorted[1].value > 0) {
                const growth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (forecastRevenue && revenueList.length >= 1) {
            const sorted = [...revenueList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const lastRevenue = sorted[0]?.value ? sorted[0].value / 1e8 : null;
            if (lastRevenue && lastRevenue > 0) {
                const growth = ((forecastRevenue - lastRevenue) / lastRevenue) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (operatingMargin !== null && operatingMargin >= 10) score += 10;
        if (opIncomeList.length >= 2) {
            const sorted = [...opIncomeList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0]?.value && sorted[1]?.value && sorted[1].value > 0) {
                const growth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (forecastOpIncome && opIncomeList.length >= 1) {
            const sorted = [...opIncomeList].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const lastOpIncome = sorted[0]?.value ? sorted[0].value / 1e8 : null;
            if (lastOpIncome && lastOpIncome > 0) {
                const growth = ((forecastOpIncome - lastOpIncome) / lastOpIncome) * 100;
                if (growth > 0) score += 10;
            }
        }
        if (operatingCf !== null && operatingCf > 0) score += 10;
        if (freeCf !== null && freeCf > 0) score += 10;
        if (roa !== null && roa > 4.5) score += 10;
        if (per !== null && per > 0 && per < 40) score += 10;
        if (pbr !== null && pbr > 0 && pbr < 10) score += 10;

        return {
            match_rate: Math.round(score * 100 / 120),
            market_cap: marketCapOku,
            equity_ratio: equityRatio,
            operating_margin: operatingMargin,
            operating_cf: operatingCf,
            free_cf: freeCf,
            roa: roa,
            per_forward: per,
            pbr: pbr,
            forecast_revenue: forecastRevenue,
            forecast_op_income: forecastOpIncome,
            financial_history: {
                revenue: revenueList,
                op_income: opIncomeList
            },
            cf_history: {
                roa: data.roa || []
            }
        };
    }

    // 業種別のPER基準値マッピング
    const industryPERBenchmarks = {
        'Technology': { good: 25, warning: 40 },
        'Software': { good: 30, warning: 50 },
        'Internet': { good: 35, warning: 60 },
        'Semiconductors': { good: 20, warning: 35 },
        'Biotechnology': { good: 30, warning: 50 },
        'Healthcare': { good: 20, warning: 35 },
        'Renewable Energy': { good: 25, warning: 40 },
        'Automobiles': { good: 10, warning: 15 },
        'Manufacturing': { good: 12, warning: 18 },
        'Industrial': { good: 15, warning: 22 },
        'Construction': { good: 10, warning: 15 },
        'Banks': { good: 10, warning: 15 },
        'Insurance': { good: 12, warning: 18 },
        'Financial Services': { good: 15, warning: 25 },
        'Retail': { good: 18, warning: 28 },
        'Consumer Goods': { good: 15, warning: 25 },
        'Food & Beverage': { good: 18, warning: 28 },
        'Utilities': { good: 12, warning: 18 },
        'Real Estate': { good: 20, warning: 30 },
        'Transportation': { good: 15, warning: 22 },
        'default': { good: 15, warning: 25 }
    };

    function getIndustryPERBenchmark(industry) {
        if (industryPERBenchmarks[industry]) return industryPERBenchmarks[industry];
        for (const [key, value] of Object.entries(industryPERBenchmarks)) {
            if (industry && industry.toLowerCase().includes(key.toLowerCase())) return value;
        }
        return industryPERBenchmarks['default'];
    }

    // 指標を更新する関数（業種情報を追加）- 編集可能版
    function updateMetric(className, value, suffix, label, industryInfo = null) {
        const elements = document.querySelectorAll('.metric-item');
        for (const elem of elements) {
            const labelElem = elem.querySelector('.metric-label');
            if (labelElem && labelElem.textContent === label) {
                const valueElem = elem.querySelector('.metric-value');
                if (valueElem) {
                    const dataKey = label.replace(/\s/g, '_').toLowerCase();
                    let displayValue = '';
                    let rawValue = value;

                    if (value !== null && value !== undefined) {
                        if (label === '時価総額') {
                            displayValue = formatAmount(value, suffix);
                            rawValue = value;
                        } else {
                            displayValue = formatNumber(value);
                            rawValue = value;
                        }
                    } else {
                        displayValue = '';
                        rawValue = '';
                    }

                    if (IS_ADMIN) {
                        valueElem.innerHTML = `<input type="text" class="editable-field"
                            data-metric="${dataKey}"
                            data-suffix="${suffix}"
                            data-raw="${rawValue}"
                            value="${displayValue}"
                            onchange="onMetricEdit(this)"
                            onfocus="this.select()"
                        >${label !== '時価総額' ? suffix : ''}`;
                    } else {
                        const suffixText = label !== '時価総額' ? suffix : '';
                        valueElem.textContent = displayValue ? `${displayValue}${suffixText}` : '---';
                    }
                }

                // 評価テキストと色分け
                const subElem = elem.querySelector('.metric-sub');
                elem.classList.remove('good', 'warning', 'danger');
                const isBankOrRE = industryInfo && /銀行|不動産|bank|real estate|reit/i.test(industryInfo);
                if (label === '自己資本比率' && value != null) {
                    if (isBankOrRE) {
                        if (value >= 10) { elem.classList.add('good'); if (subElem) subElem.textContent = '健全(業種考慮)'; }
                        else if (value >= 5) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準(業種考慮)'; }
                        else { elem.classList.add('danger'); if (subElem) subElem.textContent = '注意'; }
                    } else {
                        if (value >= 40) { elem.classList.add('good'); if (subElem) subElem.textContent = '健全'; }
                        else if (value >= 30) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準'; }
                        else { elem.classList.add('danger'); if (subElem) subElem.textContent = '注意'; }
                    }
                } else if (label === '営業利益率' && value != null) {
                    if (value >= 15) { elem.classList.add('good'); if (subElem) subElem.textContent = '高収益'; }
                    else if (value >= 10) { elem.classList.add('good'); if (subElem) subElem.textContent = '良好'; }
                    else if (value >= 5) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準'; }
                    else { elem.classList.add('danger'); if (subElem) subElem.textContent = '低い'; }
                } else if (label === 'PER' && value != null) {
                    const benchmark = getIndustryPERBenchmark(industryInfo);
                    if (value <= benchmark.good) elem.classList.add('good');
                    else if (value <= benchmark.warning) elem.classList.add('warning');
                    else elem.classList.add('danger');
                    if (subElem) subElem.textContent = `業種基準: ${benchmark.good}-${benchmark.warning}倍`;
                } else if (label === 'PBR' && value != null) {
                    if (value <= 1) { elem.classList.add('good'); if (subElem) subElem.textContent = '割安'; }
                    else if (value <= 2) { elem.classList.add('warning'); if (subElem) subElem.textContent = '適正'; }
                    else { elem.classList.add('danger'); if (subElem) subElem.textContent = '割高'; }
                } else if (label === '配当利回り' && value != null) {
                    if (value >= 3) { elem.classList.add('good'); if (subElem) subElem.textContent = '高配当'; }
                    else if (value >= 2) { elem.classList.add('warning'); if (subElem) subElem.textContent = '標準'; }
                    else if (value > 0) { if (subElem) subElem.textContent = '低い'; }
                    else { if (subElem) subElem.textContent = '無配'; }
                } else if (label === '時価総額' && value != null) {
                    const oku = value / 1e8;
                    if (oku <= 300) { if (subElem) subElem.textContent = '小型株'; }
                    else if (oku <= 700) { if (subElem) subElem.textContent = '中小型'; }
                    else if (oku <= 3000) { if (subElem) subElem.textContent = '中型株'; }
                    else { if (subElem) subElem.textContent = '大型株'; }
                }
                break;
            }
        }
    }

    function onMetricEdit(input) { showSaveSection(); }

    // 財務テーブル更新
    function updateFinancialYearTable(data) {
        const yearDataMap = new Map();
        const dataTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income', 'eps', 'dps', 'payout_ratio',
                          'operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list', 'equity_ratio_list', 'roe', 'roa'];

        dataTypes.forEach(type => {
            if (data[type] && Array.isArray(data[type])) {
                data[type].forEach(item => {
                    const d = new Date(item.date);
                    const year = d.getFullYear();
                    const month = d.getMonth() + 1;
                    if (!yearDataMap.has(year)) {
                        yearDataMap.set(year, { _month: month, _date: item.date });
                    }
                    yearDataMap.get(year)[type] = item.value;
                });
            }
        });

        if (data.forecast_year) {
            const fd = new Date(data.forecast_year);
            const fYear = fd.getFullYear();
            const fMonth = fd.getMonth() + 1;
            if (!yearDataMap.has(fYear) || !yearDataMap.get(fYear).revenue) {
                if (!yearDataMap.has(fYear)) {
                    yearDataMap.set(fYear, { _month: fMonth, _date: data.forecast_year, _forecast: true });
                } else {
                    yearDataMap.get(fYear)._forecast = true;
                }
                const fy = yearDataMap.get(fYear);
                if (data.forecast_revenue) fy.revenue = data.forecast_revenue * 1e8;
                if (data.forecast_op_income) fy.op_income = data.forecast_op_income * 1e8;
                if (data.forecast_ordinary_income) fy.ordinary_income = data.forecast_ordinary_income * 1e8;
                if (data.forecast_net_income) fy.net_income = data.forecast_net_income * 1e8;
            }
        }

        const sortedYears = Array.from(yearDataMap.keys()).sort((a, b) => a - b).slice(-5);
        updateFinancialDataTable(sortedYears, yearDataMap);
        updateCashFlowMetricsTable(sortedYears, yearDataMap);
        updateLatestPayoutRatio(data);
        updateFinancialHealth(data);
    }

    function updateFinancialDataTable(years, dataMap) {
        const tbody = document.getElementById('financial-data-tbody');
        if (!tbody) return;

        years.forEach((year, index) => {
            const row = tbody.querySelector(`tr[data-year="${index + 1}"]`);
            if (!row) return;
            const yearLabel = row.querySelector('.year-label');
            if (yearLabel) {
                const yearData = dataMap.get(year) || {};
                const month = yearData._month;
                const forecast = yearData._forecast ? '(予)' : '';
                yearLabel.textContent = month ? `${year}年${month}月${forecast}` : `${year}年${forecast}`;
                yearLabel.dataset.fullDate = yearData._date || `${year}-03-31`;
                if (yearData._forecast) { yearLabel.style.color = '#1b4332'; yearLabel.style.whiteSpace = 'nowrap'; }
            }
            const yearData = dataMap.get(year) || {};
            updateCellValue(row, 'revenue', yearData.revenue);
            updateCellValue(row, 'op_income', yearData.op_income);
            updateCellValue(row, 'ordinary_income', yearData.ordinary_income);
            updateCellValue(row, 'net_income', yearData.net_income);
            updateCellValue(row, 'eps', yearData.eps, true);
            updateCellValue(row, 'dps', yearData.dps, true);
            updateCellValue(row, 'payout_ratio', yearData.payout_ratio, false, true);
        });
    }

    function updateCashFlowMetricsTable(years, dataMap) {
        const tbody = document.getElementById('cf-metrics-tbody');
        if (!tbody) return;

        years.forEach((year, index) => {
            const row = tbody.querySelector(`tr[data-year="${index + 1}"]`);
            if (!row) return;
            const yearLabel = row.querySelector('.year-label');
            if (yearLabel) {
                const yearData = dataMap.get(year) || {};
                const month = yearData._month;
                const forecast = yearData._forecast ? '(予)' : '';
                yearLabel.textContent = month ? `${year}年${month}月${forecast}` : `${year}年${forecast}`;
                yearLabel.dataset.fullDate = yearData._date || `${year}-03-31`;
                if (yearData._forecast) { yearLabel.style.color = '#1b4332'; yearLabel.style.whiteSpace = 'nowrap'; }
            }
            const yearData = dataMap.get(year) || {};
            updateCellValue(row, 'operating_cf', yearData.operating_cf);
            updateCellValue(row, 'investing_cf', yearData.investing_cf);
            updateCellValue(row, 'financing_cf', yearData.financing_cf);
            updateCellValue(row, 'cash', yearData.cash);
            updateCellValue(row, 'current_liabilities_list', yearData.current_liabilities_list);
            updateCellValue(row, 'equity_ratio_list', yearData.equity_ratio_list, false, true);
            updateCellValue(row, 'roe', yearData.roe, false, true);
            updateCellValue(row, 'roa', yearData.roa, false, true);
        });
    }

    function updateCellValue(row, dataType, value, isPerShare = false, isPercent = false) {
        const cell = row.querySelector(`td[data-type="${dataType}"]`);
        if (!cell) return;

        const yearIndex = row.getAttribute('data-year');
        let displayValue = '';
        let rawValue = value;

        const amountTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income',
                            'operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list'];

        if (value !== undefined && value !== null) {
            if (isPerShare) {
                displayValue = value.toFixed(2);
            } else if (isPercent) {
                displayValue = value.toFixed(1);
            } else if (amountTypes.includes(dataType)) {
                const okuValue = value / 1e8;
                displayValue = okuValue.toFixed(2);
            } else {
                displayValue = value.toFixed(2);
            }
            rawValue = value;
        } else {
            displayValue = '';
            rawValue = '';
        }

        cell.innerHTML = `<input type="number" class="editable-cell"
            data-type="${dataType}"
            data-year="${yearIndex}"
            data-raw="${rawValue}"
            data-is-percent="${isPercent}"
            data-is-pershare="${isPerShare}"
            data-is-amount="${amountTypes.includes(dataType)}"
            value="${displayValue}"
            onchange="onCellEdit(this)"
            onfocus="this.select()"
            step="0.01"
        >`;
    }

    function updateDividendInfo(data) {
        const rows = document.querySelectorAll('.detail-card .detail-row');
        for (const row of rows) {
            const label = row.querySelector('.detail-label');
            const value = row.querySelector('.detail-value');
            if (label && value) {
                if (label.textContent === '配当利回り' && data.dividend_yield !== null) {
                    value.textContent = `${data.dividend_yield.toFixed(2)}%`;
                }
            }
        }
    }

    function updateLatestPayoutRatio(data) {
        const payoutDisplay = document.getElementById('payout-ratio-display');
        if (payoutDisplay && data.payout_ratio && data.payout_ratio.length > 0) {
            const sortedPayoutRatios = data.payout_ratio.sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );
            const latestPayout = sortedPayoutRatios[0];
            if (latestPayout && latestPayout.value !== undefined) {
                payoutDisplay.textContent = `${latestPayout.value.toFixed(1)}%`;
            }
        }
    }

    function updateFinancialHealth(data) {
        const cashDisplay = document.getElementById('cash-display');
        const cashOld = document.getElementById('cash-old');
        const cashNew = document.getElementById('cash-new');

        if (data.cash && data.cash.length > 0) {
            const sortedCash = data.cash.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestCash = sortedCash[0];
            if (cashDisplay && latestCash) {
                cashDisplay.textContent = formatAmount(latestCash.value, window.currentCurrency);
            }
            if (cashOld && cashNew && sortedCash.length > 1) {
                const oldestCash = sortedCash[sortedCash.length - 1];
                cashOld.textContent = formatAmount(oldestCash.value, window.currentCurrency);
                cashNew.textContent = formatAmount(latestCash.value, window.currentCurrency);
            } else if (cashNew && latestCash) {
                cashNew.textContent = formatAmount(latestCash.value, window.currentCurrency);
            }
        }

        const currentLiabDisplay = document.getElementById('current-liab-display');
        let latestCurrentLiab = null;

        if (data.current_liabilities_list && data.current_liabilities_list.length > 0) {
            const sortedLiab = data.current_liabilities_list.sort((a, b) => new Date(b.date) - new Date(a.date));
            latestCurrentLiab = sortedLiab[0];
            if (currentLiabDisplay && latestCurrentLiab) {
                currentLiabDisplay.textContent = formatAmount(latestCurrentLiab.value, window.currentCurrency);
            }
        } else if (data.current_liabilities) {
            latestCurrentLiab = { value: data.current_liabilities };
            if (currentLiabDisplay) {
                currentLiabDisplay.textContent = formatAmount(data.current_liabilities, window.currentCurrency);
            }
        }

        const currentRatioDisplay = document.getElementById('current-ratio-display');
        if (currentRatioDisplay && latestCurrentLiab) {
            const currentAssetsList = data.current_assets_list || [];
            let latestCurrentAssets = null;
            if (currentAssetsList.length > 0) {
                const sortedAssets = currentAssetsList.sort((a, b) => new Date(b.date) - new Date(a.date));
                latestCurrentAssets = sortedAssets[0];
            } else if (data.cash && data.cash.length > 0) {
                const sortedCash = data.cash.sort((a, b) => new Date(b.date) - new Date(a.date));
                latestCurrentAssets = sortedCash[0];
            }
            if (latestCurrentAssets && latestCurrentLiab.value > 0) {
                const currentRatio = (latestCurrentAssets.value / latestCurrentLiab.value) * 100;
                currentRatioDisplay.textContent = `${currentRatio.toFixed(1)}%`;
                if (currentRatio >= 150) { currentRatioDisplay.style.color = 'var(--success-color)'; }
                else if (currentRatio >= 100) { currentRatioDisplay.style.color = 'var(--warning-color)'; }
                else { currentRatioDisplay.style.color = 'var(--danger-color)'; }
            }
        }

        const marginRatioDisplay = document.getElementById('margin-ratio-display');
        if (marginRatioDisplay) {
            if (data.margin_trading_ratio !== null && data.margin_trading_ratio !== undefined) {
                marginRatioDisplay.textContent = `${data.margin_trading_ratio.toFixed(2)}倍`;
                if (data.margin_trading_ratio < 1) { marginRatioDisplay.style.color = 'var(--danger-color)'; }
                else if (data.margin_trading_ratio <= 3) { marginRatioDisplay.style.color = 'var(--success-color)'; }
                else { marginRatioDisplay.style.color = 'var(--warning-color)'; }
                if (data.margin_trading_buy && data.margin_trading_sell) {
                    const buyFormatted = data.margin_trading_buy.toLocaleString();
                    const sellFormatted = data.margin_trading_sell.toLocaleString();
                    marginRatioDisplay.title = `買残: ${buyFormatted}株 / 売残: ${sellFormatted}株`;
                }
            } else {
                marginRatioDisplay.textContent = '---';
            }
        }
    }

    function calculateGrowthRate(dataArray) {
        if (dataArray.length < 2) return null;
        const latest = dataArray[0].value;
        const oldest = dataArray[dataArray.length - 1].value;
        const years = dataArray.length - 1;
        const rate = ((latest / oldest) ** (1 / years) - 1) * 100;
        return rate;
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return '---';
        if (typeof num === 'number') return num.toLocaleString('ja-JP', { maximumFractionDigits: 2 });
        return num;
    }

    function toNumberSafe(v) {
        if (v === null || v === undefined) return null;
        if (typeof v === 'string') v = v.replace(/,/g, '').trim();
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    }

    function formatAmount(num, currency = 'JPY') {
        const n0 = toNumberSafe(num);
        if (n0 === null) return '---';
        if (currency === 'JPY') {
            const sign = n0 < 0 ? '−' : '';
            const n = Math.abs(n0);
            if (n >= 1e12) return `${sign}${(n/1e12).toFixed(2)}兆円`;
            if (n >= 1e8)  return `${sign}${Math.round(n/1e8)}億円`;
            if (n >= 1e4)  return `${sign}${(n/1e4).toFixed(2)}万円`;
            return `${sign}${Math.round(n).toLocaleString()}円`;
        } else {
            const sign = n0 < 0 ? '-' : '';
            const n = Math.abs(n0);
            if (n >= 1e12) return `${sign}$${(n / 1e12).toFixed(2)}T`;
            if (n >= 1e9)  return `${sign}$${(n / 1e9).toFixed(2)}B`;
            if (n >= 1e6)  return `${sign}$${(n / 1e6).toFixed(2)}M`;
            return `${sign}$${Math.round(n).toLocaleString()}`;
        }
    }

    function formatMarketCap(num) {
        return formatAmount(num, window.currentCurrency || 'JPY');
    }

    // Enterキーで分析
    document.getElementById('stockCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') { analyzeStock(); }
    });

    // 主要株主・役員情報を更新
    function updateHoldersAndOfficers(data) {
        updateMajorHolders(data);
        updateCompanyOfficers(data);
        updateHoldersSource(data);
    }

    function updateMajorHolders(data) {
        const majorHoldersContent = document.getElementById('major-holders-content');
        if (!majorHoldersContent) return;

        let html = '';
        let hasData = false;

        if (data.major_holders && data.major_holders.length > 0) {
            const insiderData = data.major_holders.find(h => h.Breakdown && h.Breakdown.includes('insider'));
            const institutionData = data.major_holders.find(h => h.Breakdown && h.Breakdown.includes('institution'));

            if (insiderData || institutionData) {
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">';
                html += '<thead><tr style="background-color: #f8f9fa;">';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">保有者</th>';
                html += '<th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6; font-size: 13px;">比率</th>';
                html += '</tr></thead><tbody>';
                if (insiderData) {
                    const percentage = (insiderData.Value * 100).toFixed(1);
                    html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #dc2626;">創業家・内部者</td>`;
                    html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${percentage}%</td></tr>`;
                }
                if (institutionData) {
                    const percentage = (institutionData.Value * 100).toFixed(1);
                    html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee;">機関投資家</td>`;
                    html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${percentage}%</td></tr>`;
                }
                html += '</tbody></table>';
                hasData = true;
            }
        }

        const topHolders = [];
        if (data.major_shareholders_jp && data.major_shareholders_jp.length > 0) {
            topHolders.push(...data.major_shareholders_jp.slice(0, 5).map(h => ({
                name: h.name || 'N/A', percentage: h.ratio ? h.ratio.toFixed(2) : 'N/A', type: '日本語'
            })));
        } else if (data.institutional_holders && data.institutional_holders.length > 0) {
            topHolders.push(...data.institutional_holders.slice(0, 5).map(h => ({
                name: h.Holder || 'N/A', percentage: h['% Out'] ? (h['% Out'] * 100).toFixed(2) : 'N/A', type: '機関'
            })));
        } else if (data.institution_ownership && data.institution_ownership.length > 0) {
            topHolders.push(...data.institution_ownership.slice(0, 5).map(h => ({
                name: h.organization || 'N/A', percentage: h.pctHeld ? (h.pctHeld * 100).toFixed(2) : 'N/A', type: '機関'
            })));
        }

        if (topHolders.length > 0) {
            html += '<div style="margin-top: 10px;">';
            html += '<div style="font-weight: bold; margin-bottom: 8px; color: #374151;">筆頭株主</div>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 12px;">順位</th>';
            html += '<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 12px;">株主名</th>';
            html += '<th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #dee2e6; font-size: 12px;">保有比率</th>';
            html += '</tr></thead><tbody>';
            topHolders.forEach((holder, index) => {
                const rankIcon = index === 0 ? '1' : (index === 1 ? '2' : `${index + 1}`);
                html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; text-align: center;">${rankIcon}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 11px;">${holder.name}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; color: #2563eb; font-size: 12px;">${holder.percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';
            hasData = true;
        }

        if (!hasData) {
            html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">データが取得できませんでした</div>';
        }

        majorHoldersContent.innerHTML = html;
    }

    function updateCompanyOfficers(data) {
        const officersContent = document.getElementById('company-officers-content');
        if (!officersContent) return;

        let html = '';

        if (data.company_officers && data.company_officers.length > 0) {
            const importantOfficers = [];
            const otherOfficers = [];

            data.company_officers.forEach(officer => {
                const title = officer.title_jp || officer.title || '';
                const name = officer.name_jp || officer.name || '';
                const isCEO = title.includes('CEO') || title.includes('President') || title.includes('社長') || title.includes('代表');
                const isCFO = title.includes('CFO') || title.includes('Chief Financial') || title.includes('財務');
                const isCTO = title.includes('CTO') || title.includes('Chief Technology') || title.includes('技術');
                const isChairman = title.includes('Chairman') || title.includes('会長') || title.includes('取締役会長');
                const hasJpData = officer.title_jp || officer.name_jp;

                if (isCEO || isCFO || isCTO || isChairman) {
                    importantOfficers.push({
                        name, title, age: officer.age, isImportant: true,
                        priority: isCEO ? 1 : (isChairman ? 2 : (isCFO ? 3 : 4)), hasJpData
                    });
                } else {
                    otherOfficers.push({ name, title, age: officer.age, isImportant: false, hasJpData });
                }
            });

            importantOfficers.sort((a, b) => a.priority - b.priority);

            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">役職</th>';
            html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px;">氏名</th>';
            html += '</tr></thead><tbody>';

            importantOfficers.forEach(officer => {
                const age = officer.age ? ` (${officer.age}歳)` : '';
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #374151;">${officer.title}</td>`;
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #1f2937;">${officer.name}${age}</td></tr>`;
            });

            const maxOtherOfficers = otherOfficers.some(o => o.hasJpData) ? 10 : 5;
            otherOfficers.slice(0, maxOtherOfficers).forEach(officer => {
                const age = officer.age ? ` (${officer.age}歳)` : '';
                html += `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 11px; color: #6b7280;">${officer.title}</td>`;
                html += `<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #374151;">${officer.name}${age}</td></tr>`;
            });

            html += '</tbody></table>';

            const totalOfficers = data.company_officers.length;
            const displayedOfficers = importantOfficers.length + Math.min(otherOfficers.length, maxOtherOfficers);
            if (totalOfficers > displayedOfficers) {
                html += `<div style="margin-top: 8px; font-size: 11px; color: #6b7280; text-align: right;">他 ${totalOfficers - displayedOfficers} 名の役員</div>`;
            }
        } else {
            html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">データが取得できませんでした</div>';
        }

        officersContent.innerHTML = html;
    }

    function updateHoldersSource(data) {
        const sourceLeftElement = document.getElementById('holders-source-left');
        const sourceRightElement = document.getElementById('holders-source-right');
        if (!sourceLeftElement || !sourceRightElement) return;
        let sourceText = '';
        if (data.holders_source) {
            sourceText = `出典: ${data.holders_source}`;
            if (data.holders_fallback_needed) sourceText += ' (fallback)';
        }
        sourceLeftElement.textContent = sourceText;
        sourceRightElement.textContent = sourceText;
    }

    function updateBusinessSummary(data) {
        const summaryContent = document.getElementById('business-summary-content');
        if (!summaryContent) return;
        let html = '';
        if (data.business_summary_jp) {
            html = `<div style="margin-bottom: 15px;">
                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">事業特色</div>
                <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">${data.business_summary_jp}</div>
            </div>`;
        } else if (data.business_summary) {
            html = `<div>
                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; font-size: 0.9rem;">Business Summary</div>
                <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--accent-color);">${data.business_summary}</div>
            </div>`;
        }
        if (!data.business_summary_jp && !data.business_summary) {
            html = '<div style="color: var(--text-secondary); text-align: center; padding: 20px; font-style: italic;">事業概要データが取得できませんでした</div>';
        }
        summaryContent.innerHTML = html;
    }

    // 合致度スコアカードを更新
    function updateScoreCard(data) {
        const scoreValue = document.getElementById('score-value');
        const matchRate = data.match_rate;
        if (matchRate !== null && matchRate !== undefined) {
            scoreValue.textContent = matchRate;
            scoreValue.className = 'score-value';
            if (matchRate >= 58) scoreValue.classList.add('high');
            else if (matchRate >= 33) scoreValue.classList.add('medium');
            else scoreValue.classList.add('low');
        } else {
            scoreValue.textContent = '--';
            scoreValue.className = 'score-value';
        }

        const marketCap = data.market_cap;
        updateScoreItem('score-market-cap', marketCap !== null && marketCap <= 700, marketCap ? `${Math.round(marketCap)}億` : null);
        const equityRatio = data.equity_ratio;
        updateScoreItem('score-equity-ratio', equityRatio !== null && equityRatio >= 30, equityRatio ? `${equityRatio.toFixed(1)}%` : null);

        let revenueGrowth = null, revenueGrowthPass = false;
        const financialHistory = parseJsonField(data.financial_history);
        if (financialHistory && financialHistory.revenue && financialHistory.revenue.length >= 2) {
            const sorted = [...financialHistory.revenue].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted.length >= 2 && sorted[0].value && sorted[1].value && sorted[1].value > 0) {
                revenueGrowth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                revenueGrowthPass = revenueGrowth > 0;
            }
        }
        updateScoreItem('score-revenue-growth', revenueGrowthPass, revenueGrowth !== null ? `${revenueGrowth.toFixed(1)}%` : null);

        let revenueForecastGrowth = null, revenueForecastPass = false;
        const forecastRevenue = data.forecast_revenue;
        if (forecastRevenue && financialHistory && financialHistory.revenue && financialHistory.revenue.length >= 1) {
            const sorted = [...financialHistory.revenue].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0].value && sorted[0].value > 0) {
                const forecastYen = forecastRevenue * 1e8;
                revenueForecastGrowth = ((forecastYen - sorted[0].value) / sorted[0].value) * 100;
                revenueForecastPass = revenueForecastGrowth > 0;
            }
        }
        updateScoreItem('score-revenue-forecast', revenueForecastPass, revenueForecastGrowth !== null ? `${revenueForecastGrowth.toFixed(1)}%` : null);

        const opMargin = data.operating_margin;
        updateScoreItem('score-op-margin', opMargin !== null && opMargin >= 10, opMargin ? `${opMargin.toFixed(1)}%` : null);

        let opGrowth = null, opGrowthPass = false;
        if (financialHistory && financialHistory.op_income && financialHistory.op_income.length >= 2) {
            const sorted = [...financialHistory.op_income].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted.length >= 2 && sorted[0].value && sorted[1].value && sorted[1].value > 0) {
                opGrowth = ((sorted[0].value - sorted[1].value) / sorted[1].value) * 100;
                opGrowthPass = opGrowth > 0;
            }
        }
        updateScoreItem('score-op-growth', opGrowthPass, opGrowth !== null ? `${opGrowth.toFixed(1)}%` : null);

        let opForecastGrowth = null, opForecastPass = false;
        const forecastOpIncome = data.forecast_op_income;
        if (forecastOpIncome && financialHistory && financialHistory.op_income && financialHistory.op_income.length >= 1) {
            const sorted = [...financialHistory.op_income].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            if (sorted[0].value && sorted[0].value > 0) {
                const forecastYen = forecastOpIncome * 1e8;
                opForecastGrowth = ((forecastYen - sorted[0].value) / sorted[0].value) * 100;
                opForecastPass = opForecastGrowth > 0;
            }
        }
        updateScoreItem('score-op-forecast', opForecastPass, opForecastGrowth !== null ? `${opForecastGrowth.toFixed(1)}%` : null);

        const operatingCf = data.operating_cf;
        updateScoreItem('score-op-cf', operatingCf !== null && operatingCf > 0, operatingCf ? `${operatingCf.toFixed(1)}億` : null);
        const freeCf = data.free_cf;
        updateScoreItem('score-free-cf', freeCf !== null && freeCf > 0, freeCf ? `${freeCf.toFixed(1)}億` : null);

        let roa = data.roa;
        if (roa === null || roa === undefined) {
            const cfHistory = parseJsonField(data.cf_history);
            if (cfHistory && cfHistory.roa && cfHistory.roa.length > 0) {
                const sorted = [...cfHistory.roa].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                roa = sorted[0].value;
            }
        }
        updateScoreItem('score-roa', roa !== null && roa > 4.5, roa ? `${roa.toFixed(1)}%` : null);

        const per = data.per_forward;
        updateScoreItem('score-per', per !== null && per > 0 && per < 40, per ? `${per.toFixed(1)}倍` : null);
        const pbr = data.pbr;
        updateScoreItem('score-pbr', pbr !== null && pbr > 0 && pbr < 10, pbr ? `${pbr.toFixed(2)}倍` : null);
    }

    function parseJsonField(field) {
        if (!field) return null;
        if (typeof field === 'object') return field;
        try { return JSON.parse(field); } catch { return null; }
    }

    function updateScoreItem(elementId, pass, value) {
        const element = document.getElementById(elementId);
        if (!element) return;
        if (value === null) {
            element.textContent = '--';
            element.className = 'score-item-status';
        } else {
            element.textContent = pass ? `✓ ${value}` : `✗ ${value}`;
            element.className = 'score-item-status ' + (pass ? 'pass' : 'fail');
        }
    }

    // 登録状態をチェック
    async function checkRegistrationStatus(symbol) {
        try {
            const response = await fetch(`/api/watchlist/check/${symbol}`);
            const data = await response.json();
            return data.is_registered || false;
        } catch (error) {
            console.error('登録状態チェックエラー:', error);
            return false;
        }
    }

    // 銘柄を登録
    async function registerStock() {
        if (!currentSymbol || !currentStockData) {
            showErrorModal('先に銘柄を抽出してください');
            return;
        }

        const registerBtn = document.getElementById('registerBtn');
        registerBtn.disabled = true;
        registerBtn.textContent = '登録中...';

        try {
            const response = await fetch('/api/watchlist/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_code: currentSymbol,
                    stock_data: currentStockData
                })
            });

            const data = await response.json();

            if (response.ok) {
                registerBtn.textContent = 'データ更新';
                registerBtn.classList.add('registered');
                registerBtn.disabled = false;
            } else {
                showErrorModal('登録に失敗しました。再度お試しください。');
                registerBtn.disabled = false;
                registerBtn.textContent = '登録';
            }
        } catch (error) {
            showErrorModal('接続エラーです。再度お試しください。');
            registerBtn.disabled = false;
            registerBtn.textContent = '登録';
        }
    }

    // データ編集・保存機能
    function onCellEdit(input) { showSaveSection(); }

    function showSaveSection() {
        if (!IS_ADMIN) return;
        const saveSection = document.getElementById('saveSection');
        if (saveSection) saveSection.classList.add('active');
    }

    function hideSaveSection() {
        const saveSection = document.getElementById('saveSection');
        if (saveSection) saveSection.classList.remove('active');
    }

    async function saveEditedData() {
        if (!currentSymbol) { showErrorModal('保存する銘柄がありません'); return; }
        const saveBtn = document.querySelector('.save-button');
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中...';

        try {
            const editedData = collectEditedData();
            const response = await fetch('/api/watchlist/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_code: currentSymbol, edited_data: editedData })
            });
            const result = await response.json();
            if (response.ok) {
                showSuccessModal('データを保存しました');
                hideSaveSection();
            } else {
                showErrorModal('保存に失敗しました。再度お試しください。');
            }
        } catch (error) {
            showErrorModal('接続エラーです。再度お試しください。');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '変更を保存';
        }
    }

    function collectEditedData() {
        const data = {};
        const metricInputs = document.querySelectorAll('.editable-field[data-metric]');
        metricInputs.forEach(input => {
            const metric = input.getAttribute('data-metric');
            const value = parseEditedValue(input.value);
            if (metric && value !== null) {
                const keyMap = {
                    '自己資本比率': 'equity_ratio', '営業利益率': 'operating_margin',
                    'per': 'per_forward', 'pbr': 'pbr', '配当利回り': 'dividend_yield', '時価総額': 'market_cap'
                };
                const dbKey = keyMap[metric] || metric;
                data[dbKey] = value;
            }
        });

        const financialHistory = {};
        const cfHistory = {};
        const cellInputs = document.querySelectorAll('.editable-cell[data-type]');
        cellInputs.forEach(input => {
            const dataType = input.getAttribute('data-type');
            const yearIndex = input.getAttribute('data-year');
            const isAmount = input.getAttribute('data-is-amount') === 'true';
            let value = parseFloat(input.value);
            if (!dataType || !yearIndex || isNaN(value)) return;
            if (isAmount) value = value * 1e8;

            const financialTypes = ['revenue', 'op_income', 'ordinary_income', 'net_income', 'eps', 'dps', 'payout_ratio'];
            const cfTypes = ['operating_cf', 'investing_cf', 'financing_cf', 'cash', 'current_liabilities_list', 'equity_ratio_list', 'roe', 'roa'];

            if (financialTypes.includes(dataType)) {
                if (!financialHistory[dataType]) financialHistory[dataType] = [];
                const yearLabel = document.querySelector(`#financial-data-tbody tr[data-year="${yearIndex}"] .year-label`);
                const fullDate = yearLabel && yearLabel.dataset.fullDate ? yearLabel.dataset.fullDate : `${yearIndex}-03-31`;
                financialHistory[dataType].push({ date: fullDate, value: value });
            } else if (cfTypes.includes(dataType)) {
                if (!cfHistory[dataType]) cfHistory[dataType] = [];
                const yearLabel = document.querySelector(`#cf-metrics-tbody tr[data-year="${yearIndex}"] .year-label`);
                const fullDate = yearLabel && yearLabel.dataset.fullDate ? yearLabel.dataset.fullDate : `${yearIndex}-03-31`;
                cfHistory[dataType].push({ date: fullDate, value: value });
            }
        });

        if (Object.keys(financialHistory).length > 0) data.financial_history = financialHistory;
        if (Object.keys(cfHistory).length > 0) data.cf_history = cfHistory;
        return data;
    }

    function parseEditedValue(str) {
        if (!str || str === '---' || str === '') return null;
        let value = str.replace(/,/g, '').trim();
        if (value.includes('兆')) { value = parseFloat(value.replace('兆', '').replace('円', '')) * 1e12; }
        else if (value.includes('億')) { value = parseFloat(value.replace('億', '').replace('円', '')) * 1e8; }
        else if (value.includes('万')) { value = parseFloat(value.replace('万', '').replace('円', '')) * 1e4; }
        else { value = parseFloat(value.replace('円', '').replace('%', '').replace('倍', '')); }
        return Number.isFinite(value) ? value : null;
    }

    // ページ読み込み時
    document.addEventListener('DOMContentLoaded', function() {
        if (!IS_ADMIN) {
            document.querySelectorAll('.editable-cell, .editable-field').forEach(el => {
                el.readOnly = true;
                el.style.cursor = 'default';
                el.style.pointerEvents = 'none';
            });
        }
    });
</script>
{% endblock %}
