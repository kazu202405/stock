{% extends "layout.html" %}

{% block title %}学習ノート - 企業のことをもっと知ろう{% endblock %}

{% block content %}
<style>
    .learning-page {
        font-family: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
    }

    .learning-hero {
        background: #fafaf8;
        border-bottom: 1px solid #e8e8e4;
    }

    /* タブバー */
    .learning-tabs {
        display: flex;
        gap: 24px;
        margin-top: 16px;
    }
    .learning-tab-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 0;
        font-size: 14px;
        font-weight: 400;
        color: #a3a3a3;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s;
    }
    .learning-tab-btn:hover {
        color: #525252;
    }
    .learning-tab-btn.active {
        color: #1b4332;
        font-weight: 600;
        border-bottom-color: #1b4332;
    }

    /* カード */
    .term-card {
        transition: all 0.2s ease;
        border: 1px solid #ebebeb;
    }
    .term-card:hover {
        border-color: #d4d4d4;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }

    .chevron-icon {
        transition: transform 0.25s ease;
    }

    /* ステップ番号 */
    .step-num {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        flex-shrink: 0;
    }

    /* セクションボックス */
    .content-section {
        border-radius: 12px;
        padding: 16px 18px;
    }
    .section-label {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.02em;
        margin-bottom: 8px;
    }

    /* === セクター分析タブ用スタイル === */

    /* セクターカード */
    .sector-card {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 12px;
        border-left: 3px solid #1b4332;
        padding: 20px 22px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .sector-card:hover {
        border-color: #d4d4d4;
        border-left-color: #1b4332;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .sector-card.active {
        border-color: #2d6a4f;
        border-left-color: #1b4332;
        box-shadow: 0 2px 16px rgba(27,67,50,0.10);
    }

    /* カウントバッジ */
    .count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 10px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        background: #f0fdf4;
        color: #15803d;
    }

    /* メトリクスグリッド */
    .metric-cell {
        padding: 8px 0;
    }
    .metric-label {
        font-size: 11px;
        color: #a3a3a3;
        font-weight: 500;
        margin-bottom: 2px;
    }
    .metric-value {
        font-size: 15px;
        font-weight: 600;
        color: #1a1a1a;
    }

    /* 詳細パネル */
    .detail-panel {
        background: #fff;
        border: 1px solid #ebebeb;
        border-radius: 12px;
        overflow: hidden;
    }
    .detail-header {
        padding: 20px 24px;
        border-bottom: 1px solid #ebebeb;
        background: #fafaf8;
    }

    /* サマリー統計バー */
    .stat-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 16px 24px;
        border-bottom: 1px solid #ebebeb;
        background: #fff;
    }
    .stat-item {
        flex: 1;
        min-width: 100px;
        text-align: center;
        padding: 8px 12px;
        border-radius: 8px;
        background: #fafaf8;
    }
    .stat-item-label {
        font-size: 11px;
        color: #a3a3a3;
        font-weight: 500;
        margin-bottom: 4px;
    }
    .stat-item-value {
        font-size: 16px;
        font-weight: 700;
        color: #1b4332;
    }

    /* テーブル */
    .company-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .company-table thead {
        background: #fafaf8;
    }
    .company-table th {
        padding: 10px 14px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: #737373;
        border-bottom: 1px solid #ebebeb;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        transition: color 0.15s;
    }
    .company-table th:hover {
        color: #1b4332;
    }
    .company-table th.sorted {
        color: #1b4332;
    }
    .sort-arrow {
        display: inline-block;
        margin-left: 4px;
        font-size: 10px;
        color: #1b4332;
    }
    .company-table td {
        padding: 10px 14px;
        border-bottom: 1px solid #f3f4f6;
        color: #525252;
    }
    .company-table tbody tr:hover {
        background: #fafaf8;
    }
    .company-table .avg-row {
        background: #f0fdf4;
        font-weight: 600;
    }
    .company-table .avg-row td {
        color: #1b4332;
        border-bottom: 2px solid #bbf7d0;
    }
    .company-link {
        color: #2d6a4f;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.15s;
    }
    .company-link:hover {
        color: #1b4332;
        text-decoration: underline;
    }

    /* チャートコンテナ */
    .chart-container {
        padding: 20px 24px;
        border-bottom: 1px solid #ebebeb;
    }

    /* ローディングスピナー */
    .sector-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 0;
    }
    .sector-spinner .spinner-ring {
        width: 40px;
        height: 40px;
        border: 3px solid #ebebeb;
        border-top-color: #1b4332;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 空状態 */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    .empty-state i {
        font-size: 40px;
        color: #d4d4d4;
        margin-bottom: 16px;
    }
    .empty-state p {
        font-size: 14px;
        color: #a3a3a3;
    }

    /* 合致度バー */
    .match-bar-bg {
        width: 60px;
        height: 6px;
        background: #f3f4f6;
        border-radius: 3px;
        overflow: hidden;
        display: inline-block;
        vertical-align: middle;
        margin-right: 6px;
    }
    .match-bar-fill {
        height: 100%;
        border-radius: 3px;
        background: #2d6a4f;
    }
</style>

<div class="learning-page min-h-screen" style="background: #f7f7f5;" x-data="{ activeTab: 'glossary', sectorLoaded: false }">

    <!-- ヘッダー -->
    <div class="learning-hero">
        <div class="max-w-3xl mx-auto px-6 py-10" :class="{ 'max-w-3xl': activeTab === 'glossary', 'max-w-7xl': activeTab === 'sector' }">
            <p class="text-xs font-semibold tracking-widest uppercase mb-3" style="color: #16a34a;">Learning Note</p>
            <h1 class="text-2xl font-bold mb-3" style="color: #1a1a1a;">企業を見る目を養う基礎知識</h1>
            <p class="text-sm leading-relaxed" style="color: #737373; max-width: 440px;">
                ひとつずつ、企業の読み解き方を身につけていきましょう。
            </p>
            <!-- タブバー -->
            <div class="learning-tabs">
                <button class="learning-tab-btn"
                        :class="{ 'active': activeTab === 'glossary' }"
                        @click="activeTab = 'glossary'">
                    <i class="fas fa-book-open" style="font-size: 13px;"></i>
                    用語解説
                </button>
                <button class="learning-tab-btn"
                        :class="{ 'active': activeTab === 'sector' }"
                        @click="activeTab = 'sector'; if (!sectorLoaded) { sectorLoaded = true; }">
                    <i class="fas fa-chart-pie" style="font-size: 13px;"></i>
                    セクター分析
                </button>
            </div>
        </div>
    </div>

    <!-- ===== 用語解説タブ ===== -->
    <div x-show="activeTab === 'glossary'" x-data="learningApp()">
        <div class="max-w-3xl mx-auto px-6 py-8">

            <!-- 全カテゴリを順に表示 -->
            <template x-for="(cat, catIdx) in categories" :key="cat.id">
                <div class="mb-12">
                    <!-- カテゴリ見出し -->
                    <div class="mb-5 flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white" style="background: #1b4332;">
                            <span x-text="catIdx + 1"></span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold mb-1" style="color: #1a1a1a;" x-text="cat.name"></h2>
                            <p class="text-sm leading-relaxed" style="color: #737373;" x-text="cat.description"></p>
                        </div>
                    </div>

                    <!-- 用語カード一覧 -->
                    <div class="space-y-3 ml-14">
                        <template x-for="term in getTermsByCategory(cat.id)" :key="term.id">
                            <div class="term-card bg-white rounded-xl overflow-hidden">
                                <!-- カードヘッダー -->
                                <button @click="toggle(term.id)" class="w-full px-5 py-4 flex items-center justify-between text-left cursor-pointer">
                                    <div class="flex items-center gap-4">
                                        <div class="w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0"
                                            :style="'background:' + term.accentBg">
                                            <i :class="term.icon" :style="'color:' + term.accent"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-bold" style="color: #1a1a1a;" x-text="term.title"></h3>
                                            <p class="text-xs mt-0.5" style="color: #a3a3a3;" x-text="term.subtitle"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs px-2 py-0.5 rounded font-medium"
                                            :style="term.level === '基本'
                                                ? 'background: #f0fdf4; color: #15803d;'
                                                : 'background: #fefce8; color: #a16207;'"
                                            x-text="term.level"></span>
                                        <i class="fas fa-chevron-down text-xs chevron-icon" style="color: #d4d4d4;"
                                            :style="openTerms.includes(term.id) ? 'transform: rotate(180deg)' : ''"></i>
                                    </div>
                                </button>

                                <!-- 展開コンテンツ -->
                                <div x-show="openTerms.includes(term.id)" x-collapse>
                                    <div class="px-5 pb-5 space-y-3" style="border-top: 1px solid #f5f5f5;">
                                        <div class="pt-4"></div>

                                        <!-- ひとことで -->
                                        <div class="content-section" style="background: #f8faf8; border-left: 3px solid #22c55e;">
                                            <p class="section-label" style="color: #16a34a;">ひとことで</p>
                                            <p class="text-sm leading-relaxed" style="color: #374151;" x-text="term.oneLiner"></p>
                                        </div>

                                        <!-- くわしく -->
                                        <div class="content-section" style="background: #fafafa;">
                                            <p class="section-label" style="color: #525252;">くわしく見てみると</p>
                                            <div class="space-y-3">
                                                <template x-for="(p, i) in term.explanation" :key="i">
                                                    <div class="flex items-start gap-3">
                                                        <div class="step-num mt-0.5 text-white" :style="'background:' + term.accent"
                                                            x-text="i + 1"></div>
                                                        <p class="text-sm leading-relaxed" style="color: #525252;" x-text="p"></p>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- 具体例 -->
                                        <div class="content-section" style="background: #f8f9fc;" x-show="term.example">
                                            <p class="section-label" style="color: #4b5563;">具体例でイメージすると</p>
                                            <p class="text-sm leading-relaxed" style="color: #525252;" x-text="term.example"></p>
                                        </div>

                                        <!-- ポイント -->
                                        <div class="content-section" style="background: #fefcf3; border-left: 3px solid #eab308;">
                                            <p class="section-label" style="color: #a16207;">つまり、ここが大事</p>
                                            <p class="text-sm leading-relaxed" style="color: #374151;" x-text="term.whyItMatters"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- フッター -->
            <div class="mt-4 text-center pb-8">
                <p class="text-xs" style="color: #a3a3a3;">気になる用語をタップすると、解説が開きます</p>
            </div>
        </div>
    </div>

    <!-- ===== セクター分析タブ ===== -->
    <div x-show="activeTab === 'sector'" x-cloak>
        <template x-if="sectorLoaded">
            <div x-data="sectorApp()" x-init="fetchData()">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

                    <!-- セクターサマリー情報 -->
                    <div class="flex items-center gap-4 mb-6" x-show="!loading && sectors.length > 0">
                        <span class="text-xs font-medium px-3 py-1 rounded-md" style="background: #fff; border: 1px solid #ebebeb; color: #525252;">
                            <i class="fas fa-layer-group mr-1" style="color: #2d6a4f;"></i>
                            <span x-text="sectors.length"></span> セクター
                        </span>
                        <span class="text-xs font-medium px-3 py-1 rounded-md" style="background: #fff; border: 1px solid #ebebeb; color: #525252;">
                            <i class="fas fa-building mr-1" style="color: #2d6a4f;"></i>
                            <span x-text="totalCompanies"></span> 社
                        </span>
                    </div>

                    <!-- ローディング状態 -->
                    <div x-show="loading" class="sector-spinner">
                        <div class="spinner-ring"></div>
                        <p class="mt-4 text-sm" style="color: #a3a3a3;">セクターデータを読み込み中...</p>
                    </div>

                    <!-- 空状態 -->
                    <div x-show="!loading && sectors.length === 0" class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <p>分析済みの企業データがありません。</p>
                        <p class="mt-1" style="font-size: 12px;">ダッシュボードから企業を分析すると、ここにセクター別の集計が表示されます。</p>
                    </div>

                    <!-- メインコンテンツ -->
                    <div x-show="!loading && sectors.length > 0">

                        <!-- セクターカードグリッド -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                            <template x-for="(s, idx) in sectors" :key="s.sector">
                                <div class="sector-card"
                                     :class="{ 'active': selectedSector && selectedSector.sector === s.sector }"
                                     @click="selectSector(s)">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="text-sm font-bold" style="color: #1a1a1a;" x-text="s.sector"></h3>
                                        <span class="count-badge" x-text="s.count + '社'"></span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-x-6 gap-y-1">
                                        <div class="metric-cell">
                                            <div class="metric-label">平均PER</div>
                                            <div class="metric-value" x-text="formatNum(s.avg_per, 1)"></div>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">平均PBR</div>
                                            <div class="metric-value" x-text="formatNum(s.avg_pbr, 2)"></div>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">平均配当利回り</div>
                                            <div class="metric-value">
                                                <span x-text="formatNum(s.avg_dividend_yield, 2)"></span>
                                                <span x-show="s.avg_dividend_yield != null" class="text-xs font-normal" style="color: #a3a3a3;">%</span>
                                            </div>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">平均ROE</div>
                                            <div class="metric-value">
                                                <span x-text="formatNum(s.avg_roe, 1)"></span>
                                                <span x-show="s.avg_roe != null" class="text-xs font-normal" style="color: #a3a3a3;">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- セクター説明 -->
                                    <template x-if="getSectorInfo(s.sector)">
                                        <div class="mt-3 pt-3" style="border-top: 1px solid #f3f4f6;">
                                            <p class="text-xs leading-relaxed" style="color: #737373;" x-text="getSectorInfo(s.sector).description"></p>
                                            <div class="mt-2 flex items-start gap-1.5">
                                                <i class="fas fa-chart-line flex-shrink-0 mt-0.5" style="font-size: 9px; color: #a3a3a3;"></i>
                                                <p class="text-xs leading-relaxed" style="color: #a3a3a3;" x-text="getSectorInfo(s.sector).movement"></p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>

                        <!-- セクター詳細パネル -->
                        <div x-show="selectedSector" x-transition class="detail-panel mb-8">

                            <!-- 詳細ヘッダー -->
                            <div class="detail-header">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-1 h-8 rounded-sm" style="background: #1b4332;"></div>
                                        <h2 class="text-lg font-bold" style="color: #1a1a1a;" x-text="selectedSector ? selectedSector.sector : ''"></h2>
                                    </div>
                                    <button @click="selectedSector = null; destroyChart();"
                                            class="text-xs px-3 py-1.5 rounded-md" style="background: #f3f4f6; color: #525252; border: none; cursor: pointer;">
                                        <i class="fas fa-times mr-1"></i>閉じる
                                    </button>
                                </div>
                            </div>

                            <!-- サマリー統計バー -->
                            <div class="stat-bar" x-show="selectedSector">
                                <div class="stat-item">
                                    <div class="stat-item-label">銘柄数</div>
                                    <div class="stat-item-value" x-text="selectedSector ? selectedSector.count : ''"></div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-item-label">平均PER</div>
                                    <div class="stat-item-value" x-text="selectedSector ? formatNum(selectedSector.avg_per, 1) : ''"></div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-item-label">平均PBR</div>
                                    <div class="stat-item-value" x-text="selectedSector ? formatNum(selectedSector.avg_pbr, 2) : ''"></div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-item-label">平均ROE</div>
                                    <div class="stat-item-value">
                                        <span x-text="selectedSector ? formatNum(selectedSector.avg_roe, 1) : ''"></span>
                                        <span class="text-xs font-normal" style="color: #a3a3a3;" x-show="selectedSector && selectedSector.avg_roe != null">%</span>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-item-label">平均営業利益率</div>
                                    <div class="stat-item-value">
                                        <span x-text="selectedSector ? formatNum(selectedSector.avg_operating_margin, 1) : ''"></span>
                                        <span class="text-xs font-normal" style="color: #a3a3a3;" x-show="selectedSector && selectedSector.avg_operating_margin != null">%</span>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-item-label">平均自己資本比率</div>
                                    <div class="stat-item-value">
                                        <span x-text="selectedSector ? formatNum(selectedSector.avg_equity_ratio, 1) : ''"></span>
                                        <span class="text-xs font-normal" style="color: #a3a3a3;" x-show="selectedSector && selectedSector.avg_equity_ratio != null">%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- PER分布チャート -->
                            <div class="chart-container" x-show="selectedSector && selectedSector.companies && selectedSector.companies.length > 0">
                                <h3 class="text-xs font-semibold mb-3" style="color: #737373;">
                                    <i class="fas fa-chart-bar mr-1" style="color: #2d6a4f;"></i>PER分布
                                </h3>
                                <div style="position: relative; width: 100%;" :style="'height:' + chartHeight + 'px'">
                                    <canvas id="perChart"></canvas>
                                </div>
                            </div>

                            <!-- 企業テーブル -->
                            <div class="overflow-x-auto" x-show="selectedSector">
                                <table class="company-table">
                                    <thead>
                                        <tr>
                                            <th @click="sortBy('company_code')" :class="{ 'sorted': sortKey === 'company_code' }">
                                                銘柄コード
                                                <span class="sort-arrow" x-show="sortKey === 'company_code'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('company_name')" :class="{ 'sorted': sortKey === 'company_name' }">
                                                会社名
                                                <span class="sort-arrow" x-show="sortKey === 'company_name'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('market_cap')" :class="{ 'sorted': sortKey === 'market_cap' }">
                                                時価総額(億円)
                                                <span class="sort-arrow" x-show="sortKey === 'market_cap'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('per_forward')" :class="{ 'sorted': sortKey === 'per_forward' }">
                                                PER
                                                <span class="sort-arrow" x-show="sortKey === 'per_forward'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('pbr')" :class="{ 'sorted': sortKey === 'pbr' }">
                                                PBR
                                                <span class="sort-arrow" x-show="sortKey === 'pbr'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('dividend_yield')" :class="{ 'sorted': sortKey === 'dividend_yield' }">
                                                配当利回り
                                                <span class="sort-arrow" x-show="sortKey === 'dividend_yield'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('roe')" :class="{ 'sorted': sortKey === 'roe' }">
                                                ROE
                                                <span class="sort-arrow" x-show="sortKey === 'roe'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('operating_margin')" :class="{ 'sorted': sortKey === 'operating_margin' }">
                                                営業利益率
                                                <span class="sort-arrow" x-show="sortKey === 'operating_margin'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                            <th @click="sortBy('match_rate')" :class="{ 'sorted': sortKey === 'match_rate' }">
                                                合致度
                                                <span class="sort-arrow" x-show="sortKey === 'match_rate'" x-text="sortDir === 'asc' ? '\u25B2' : '\u25BC'"></span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 業界平均行 -->
                                        <tr class="avg-row" x-show="selectedSector">
                                            <td style="color: #1b4332;">--</td>
                                            <td style="color: #1b4332; font-weight: 700;">
                                                <i class="fas fa-calculator mr-1" style="font-size: 10px;"></i>業界平均
                                            </td>
                                            <td>--</td>
                                            <td x-text="selectedSector ? formatNum(selectedSector.avg_per, 1) : ''"></td>
                                            <td x-text="selectedSector ? formatNum(selectedSector.avg_pbr, 2) : ''"></td>
                                            <td>
                                                <span x-text="selectedSector ? formatNum(selectedSector.avg_dividend_yield, 2) : ''"></span>
                                                <span x-show="selectedSector && selectedSector.avg_dividend_yield != null" style="color: #a3a3a3;">%</span>
                                            </td>
                                            <td>
                                                <span x-text="selectedSector ? formatNum(selectedSector.avg_roe, 1) : ''"></span>
                                                <span x-show="selectedSector && selectedSector.avg_roe != null" style="color: #a3a3a3;">%</span>
                                            </td>
                                            <td>
                                                <span x-text="selectedSector ? formatNum(selectedSector.avg_operating_margin, 1) : ''"></span>
                                                <span x-show="selectedSector && selectedSector.avg_operating_margin != null" style="color: #a3a3a3;">%</span>
                                            </td>
                                            <td>--</td>
                                        </tr>
                                        <!-- 個別企業行 -->
                                        <template x-for="c in sortedCompanies" :key="c.company_code">
                                            <tr>
                                                <td>
                                                    <a :href="'/stock/' + c.company_code" class="company-link" x-text="c.company_code"></a>
                                                </td>
                                                <td>
                                                    <a :href="'/stock/' + c.company_code" class="company-link" x-text="c.company_name"></a>
                                                </td>
                                                <td x-text="formatMarketCap(c.market_cap)"></td>
                                                <td x-text="formatNum(c.per_forward, 1)"></td>
                                                <td x-text="formatNum(c.pbr, 2)"></td>
                                                <td>
                                                    <span x-text="formatNum(c.dividend_yield, 2)"></span>
                                                    <span x-show="c.dividend_yield != null" style="color: #a3a3a3;">%</span>
                                                </td>
                                                <td>
                                                    <span x-text="formatNum(c.roe, 1)"></span>
                                                    <span x-show="c.roe != null" style="color: #a3a3a3;">%</span>
                                                </td>
                                                <td>
                                                    <span x-text="formatNum(c.operating_margin, 1)"></span>
                                                    <span x-show="c.operating_margin != null" style="color: #a3a3a3;">%</span>
                                                </td>
                                                <td>
                                                    <template x-if="c.match_rate != null">
                                                        <span class="flex items-center">
                                                            <span class="match-bar-bg">
                                                                <span class="match-bar-fill" :style="'width:' + Math.min(c.match_rate, 100) + '%'"></span>
                                                            </span>
                                                            <span x-text="c.match_rate + '%'" class="text-xs font-medium" style="color: #525252;"></span>
                                                        </span>
                                                    </template>
                                                    <template x-if="c.match_rate == null">
                                                        <span style="color: #d4d4d4;">&mdash;</span>
                                                    </template>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
function learningApp() {
    return {
        openTerms: [],

        categories: [
            {
                id: 'scale', name: '企業規模',
                description: '企業の大きさを測る指標です。時価総額が小さい企業は成長余地が大きい反面、リスクも高い。企業の「器」を知ることが分析の第一歩です。'
            },
            {
                id: 'safety', name: '財務の安全性',
                description: '財務がどれだけ安定しているかを見ます。借金に頼りすぎていないか、不況が来ても耐えられるか。長く付き合える企業かどうかの判断材料です。'
            },
            {
                id: 'growth', name: '成長性',
                description: '企業がどれだけ伸びているか。実績と予想の両面から、売上・利益の成長を確認します。過去の延長線上に未来があるとは限りませんが、大きなヒントになります。'
            },
            {
                id: 'profitability', name: '収益性',
                description: '企業がどれだけ効率よく利益を出せているか。売上の大きさだけでなく「どれだけ手元に残るか」「資産をどれだけ活かせているか」が本当の実力です。'
            },
            {
                id: 'cashflow', name: 'キャッシュフロー',
                description: '実際のお金の流れを見ます。利益が出ていても現金がなければ経営は回りません。帳簿ではなく「リアルなお金の動き」が企業の本当の健康状態です。'
            },
            {
                id: 'valuation', name: '割安度',
                description: 'いい企業でも、高すぎる値段で買えば損をします。今の株価がその企業の実力に見合っているかを考えるための指標です。'
            },
            {
                id: 'technical', name: 'テクニカル分析の基礎',
                description: '株価チャートの動きからトレンドを読み解く手法です。企業の実力（ファンダメンタル）とは別に、「市場がどう動いているか」を視覚的に捉えるための基本知識です。'
            },
            {
                id: 'strategy', name: '投資の考え方',
                description: '企業分析とは別に、知っておきたい投資の基本的な考え方です。感情に流されず、合理的に行動するための知恵を学びます。'
            },
        ],

        terms: [
            // === 企業規模 ===
            {
                id: 'market_cap', category: 'scale',
                title: '時価総額', subtitle: 'Market Capitalization',
                icon: 'fa-solid fa-building', accent: '#64748b', accentBg: '#f1f5f9',
                level: '基本',
                oneLiner: '企業の「値段」そのもの。株価 \u00d7 発行済株式数で計算される、市場が評価した企業の総額です。',
                explanation: [
                    '時価総額は「株価 \u00d7 発行済株式数」で計算します。たとえば株価5,000円で発行済株式が1億株なら、時価総額は5,000億円です。',
                    '一般的に、時価総額が大きい企業（大型株）は安定感がありますが成長余地は限られます。小さい企業（小型株）は成長余地が大きい反面、値動きが激しくなりやすいです。',
                    '本アプリでは時価総額700億円以下を基準としています。まだ市場に見つかっていない成長企業を探すための目安です。'
                ],
                example: 'トヨタ自動車は時価総額40兆円超の超大型株。一方、時価総額500億円の新興IT企業は、これから大きく伸びる可能性を秘めています。ただし、小型ゆえに1日で株価が大きく動くこともあります。',
                whyItMatters: '企業の「現在の評価額」がわかります。時価総額が小さいうちに見つけた優良企業は、将来の評価が上がったときに大きなリターンにつながる可能性があります。'
            },

            // === 安全性 ===
            {
                id: 'equity_ratio', category: 'safety',
                title: '自己資本比率', subtitle: 'Equity Ratio',
                icon: 'fa-solid fa-shield-halved', accent: '#2563eb', accentBg: '#eff6ff',
                level: '基本',
                oneLiner: '会社の資産のうち「自分のお金」がどれくらいあるか。借金体質かどうかが見えます。',
                explanation: [
                    '「総資産のうち、返さなくていいお金（自己資本）が何%あるか」を見ます。計算式は「自己資本 \u00f7 総資産 \u00d7 100」。',
                    '本アプリでは30%以上を基準にしています。一般的には40%以上で安全圏、50%超えで優良とされますが、30%は最低限の安全ラインです。',
                    '銀行や不動産は構造上低くなるため、業種ごとに水準が異なることは押さえておきましょう。'
                ],
                example: 'A社（80%）とB社（20%）。A社は資産のほとんどが自分のお金なので不況でも余裕。B社は80%が借金なので、売上が落ちると返済に苦しむ可能性があります。',
                whyItMatters: '不況に強く、倒産リスクが低い企業を見分けるための基本指標。安心して長期で見ていられる会社かどうかの重要な判断材料になります。'
            },

            {
                id: 'payout_ratio', category: 'safety',
                title: '配当性向', subtitle: 'Payout Ratio',
                icon: 'fa-solid fa-hand-holding-dollar', accent: '#2563eb', accentBg: '#eff6ff',
                level: '基本',
                oneLiner: '稼いだ利益のうち、どれだけを株主に配当で還元しているか。出しすぎていないかをチェックする指標です。',
                explanation: [
                    '「1株あたり配当金（DPS） \u00f7 1株あたり利益（EPS） \u00d7 100」で計算します。EPSが100円でDPSが30円なら配当性向30%。',
                    '30〜50%が一般的な目安。この範囲なら「適度に株主に還元しつつ、成長投資にもお金を回せている」バランスの良い状態です。',
                    '50%を超えると「利益の半分以上を配当に回している」状態。70%以上は要注意で、利益が少し減っただけで減配リスクが出てきます。100%超えは利益以上に配当を出しており、貯金（内部留保）を取り崩している可能性があります。',
                    '逆に低すぎる（10%未満など）場合は、株主還元に消極的か、成長投資に積極的かのどちらか。成長企業なら低くても問題ありません。'
                ],
                example: 'A社（配当性向35%）は利益の1/3を還元し、残りを設備投資や研究開発に使えるバランス型。B社（配当性向90%）は利回りが高く魅力的に見えますが、業績が少しでも悪化すれば減配の可能性が高く、配当を維持するための余力がほとんどありません。',
                whyItMatters: '高配当企業を探すときに「利回り」だけ見ると危険。配当性向が高すぎる企業は無理をして配当を出している可能性があり、減配リスクが高いです。利回りと配当性向をセットで確認することで、配当の「持続可能性」を判断できます。'
            },

            // === 成長性 ===
            {
                id: 'revenue_growth', category: 'growth',
                title: '売上成長率（実績）', subtitle: 'Revenue Growth Rate (Actual)',
                icon: 'fa-solid fa-arrow-up', accent: '#16a34a', accentBg: '#f0fdf4',
                level: '基本',
                oneLiner: '前年と比べて実際に売上がどれだけ伸びたか。企業が「成長しているか」を最もシンプルに見る数字です。',
                explanation: [
                    '「（今年の売上 \u2212 前年の売上）\u00f7 前年の売上 \u00d7 100」で計算します。前年100億 \u2192 今年120億なら成長率20%。',
                    '本アプリでは前年比プラス（0%超）を基準にしています。売上が前年を上回っていれば、少なくとも「縮小していない」ことが確認できます。',
                    '1年だけではなく、数年間の推移を見ることで「一時的な好調」か「持続的な成長」かを判断できます。'
                ],
                example: 'A社は毎年10%ずつ着実に成長。B社は去年50%伸びたが前年は横ばい。一見B社が優秀に見えますが、継続力ではA社の方が信頼できます。',
                whyItMatters: '売上が伸びている企業は「社会に求められている」ということ。市場が拡大しているのか、シェアを獲得しているのか。いずれにしても勢いのある企業です。'
            },
            {
                id: 'revenue_growth_forecast', category: 'growth',
                title: '売上成長率（予想）', subtitle: 'Revenue Growth Rate (Forecast)',
                icon: 'fa-solid fa-chart-line', accent: '#059669', accentBg: '#ecfdf5',
                level: '基本',
                oneLiner: '会社が出している来期の売上予想が、今期より伸びているか。「未来への自信」が見えます。',
                explanation: [
                    '企業は毎年、来期の業績予想を開示します。その売上予想が直近実績と比べてプラスかどうかを見ます。',
                    '予想がプラスということは、会社自身が「来年も伸びる」と考えている証拠。ただし予想はあくまで予想なので、過去の的中率も参考にすると良いです。',
                    '本アプリでは予想の売上成長率がプラス（0%超）を基準にしています。実績と予想の両方がプラスなら、より信頼感が増します。'
                ],
                example: '今期の売上が200億円で、来期予想が220億円なら成長率10%。会社自身が「まだ伸びる」と見ているサインです。ただし前回の予想が大きく外れている会社は割り引いて見る必要があります。',
                whyItMatters: '実績だけでなく「これから」を見ることで、成長の持続性を判断できます。実績・予想の両方がプラスなら、成長トレンドが続いている可能性が高いです。'
            },
            {
                id: 'op_growth', category: 'growth',
                title: '営業利益成長率（実績）', subtitle: 'Operating Income Growth (Actual)',
                icon: 'fa-solid fa-chart-column', accent: '#0d9488', accentBg: '#f0fdfa',
                level: '基本',
                oneLiner: '本業の利益が前年より伸びているか。売上だけでなく「稼ぐ力」自体が成長しているかがわかります。',
                explanation: [
                    '売上が伸びていても、コストがそれ以上に増えれば利益は減ります。営業利益の成長率は「本業の稼ぐ力」そのものの変化を見る指標です。',
                    '計算式は売上成長率と同じ考え方で「（今年の営業利益 \u2212 前年の営業利益）\u00f7 前年の営業利益 \u00d7 100」。',
                    '本アプリでは前年比プラス（0%超）を基準にしています。売上と営業利益の両方が伸びている企業は、健全に成長していると言えます。'
                ],
                example: '売上が10%伸びて、営業利益が20%伸びた企業。売上以上に利益が伸びているので「規模が大きくなるほど効率が上がる」構造を持っている可能性が高いです。',
                whyItMatters: '売上成長率とセットで見るのがコツ。売上は伸びているのに営業利益が減っていたら、コスト管理に問題がある可能性。両方プラスなら成長の質が高い企業です。'
            },
            {
                id: 'op_growth_forecast', category: 'growth',
                title: '営業利益成長率（予想）', subtitle: 'Operating Income Growth (Forecast)',
                icon: 'fa-solid fa-bullseye', accent: '#0891b2', accentBg: '#ecfeff',
                level: '基本',
                oneLiner: '来期の営業利益予想が今期より伸びているか。「利益面でも成長が続く」という会社の見通しです。',
                explanation: [
                    '売上予想と同じく、企業が開示する来期の営業利益予想を直近実績と比較します。',
                    '売上予想がプラスでも営業利益予想がマイナスなら、先行投資で一時的にコストが膨らむ計画かもしれません。逆に両方プラスなら堅実な成長路線です。',
                    '本アプリでは営業利益予想の成長率がプラス（0%超）を基準にしています。'
                ],
                example: '来期の売上予想が+10%なのに営業利益予想が\u221210%。新規事業への投資で一時的に利益が減る計画かもしれません。理由を確認することで、その企業の戦略が見えてきます。',
                whyItMatters: '成長性の4指標（売上実績・予想、営業利益実績・予想）がすべてプラスなら、その企業は「実績も将来も伸びている」状態。最も信頼感の高い成長パターンです。'
            },
            {
                id: 'shareholder_structure', category: 'growth',
                title: '株主構成（大株主・筆頭株主）', subtitle: 'Major Shareholders',
                icon: 'fa-solid fa-user-tie', accent: '#4f46e5', accentBg: '#eef2ff',
                level: '応用',
                oneLiner: '社長や役員が大株主に入っている会社は、経営者自身が「自分ごと」として経営している証拠です。',
                explanation: [
                    '企業の大株主一覧を見ると、誰がその会社の株を多く持っているかがわかります。筆頭株主とは最も多くの株を保有している株主のことです。',
                    '社長や役員が大株主に名を連ねている場合、その経営者は会社の業績が上がれば自分の資産も増えます。つまり株主と同じ目線で、本気で企業価値を高めようとするインセンティブがあります。',
                    '逆に、経営者がほとんど株を持っていない「サラリーマン社長」の場合、どうしても守りの経営になりがちです。自分の任期を無難にこなすことが優先され、大胆な成長投資に踏み切りにくい傾向があります。',
                    '創業者やその一族が大株主として残っている企業は、長期的な視点で経営される傾向が強く、短期的な利益よりも会社の持続的な成長を重視することが多いです。'
                ],
                example: 'A社の社長は発行済株式の15%を保有する筆頭株主。会社が成長すれば自身の資産も増えるため、積極的に新規事業や設備投資に取り組んでいます。一方、B社の社長は持株比率0.1%未満。リスクを取るメリットが薄く、現状維持の経営が続いています。',
                whyItMatters: '数字の指標だけでは見えない「経営者の本気度」がわかります。大株主に経営陣がいるかどうかは、企業が本当に成長に向かっているかを判断する隠れた重要ポイントです。'
            },

            // === 収益性 ===
            {
                id: 'operating_margin', category: 'profitability',
                title: '営業利益率', subtitle: 'Operating Profit Margin',
                icon: 'fa-solid fa-chart-bar', accent: '#ea580c', accentBg: '#fff7ed',
                level: '基本',
                oneLiner: '本業で100円売ったら何円残るか。企業の「稼ぐ力」がストレートに表れます。',
                explanation: [
                    '「売上のうち、本業でどれだけ利益が残ったか」を表します。計算式は「営業利益 \u00f7 売上高 \u00d7 100」。',
                    '本アプリでは10%以上を基準にしています。10%あれば「しっかり稼げている」と言える水準です。',
                    '業種によって水準はかなり異なります。IT企業なら30%超えも珍しくないですが、コンビニは3%程度。同業種で比べることも大切です。'
                ],
                example: 'コンビニA社（3%）とソフトウェアB社（30%）。100円売ってA社は3円、B社は30円の利益。ビジネスの構造でこれだけ差が出ます。',
                whyItMatters: '値下げ競争に巻き込まれにくく、独自の強みを持っている企業ほどこの数字が高い傾向があります。本業の実力を見る基本的な指標です。'
            },
            {
                id: 'roa', category: 'profitability',
                title: 'ROA（総資産利益率）', subtitle: 'Return on Assets',
                icon: 'fa-solid fa-percent', accent: '#dc2626', accentBg: '#fef2f2',
                level: '応用',
                oneLiner: '会社が持っている資産全体を使って、どれだけ利益を生み出せたか。経営の総合的な効率がわかります。',
                explanation: [
                    'ROAは「純利益 \u00f7 総資産 \u00d7 100」で計算します。自己資本だけでなく借入金も含めた「全ての資産」に対する利益率です。',
                    '本アプリでは4.5%超を基準にしています。日本企業の平均は3〜4%程度なので、4.5%超えは平均以上の効率で経営できている証拠です。',
                    'ROEとの違いは、ROEが「株主のお金」に対する効率、ROAが「全ての資産」に対する効率を見る点。借金が多い企業でもROAが高ければ資産活用が上手です。'
                ],
                example: '総資産1000億円でROA 5%なら、50億円の利益を生んでいます。同じ資産を持つ他社がROA 2%なら20億円。同じ資産でも使い方次第で利益は2.5倍変わります。',
                whyItMatters: '「この会社は持っている資産をうまく活かせているか」がわかります。ROAが高い企業は、少ない資産で大きな利益を出せる効率的な経営をしている証拠です。'
            },

            // === キャッシュフロー ===
            {
                id: 'operating_cf', category: 'cashflow',
                title: '営業キャッシュフロー', subtitle: 'Operating Cash Flow',
                icon: 'fa-solid fa-coins', accent: '#7c3aed', accentBg: '#faf5ff',
                level: '基本',
                oneLiner: '本業で実際に「現金が」いくら入ってきたか。利益とは違い、ごまかしがきかない数字です。',
                explanation: [
                    '「本業から実際に得た現金の額」です。利益は会計処理で調整できますが、現金の動きは操作できません。',
                    '本アプリではプラス（0超）を基準にしています。本業で現金が増えていなければ、いくら利益が出ていても実態として健全とは言えません。',
                    '利益が出ていても営業CFがマイナスなら、売掛金が未回収だったり在庫が膨らんでいたりする可能性があります。'
                ],
                example: 'A社は純利益50億だが営業CF 20億。お金の回収が追いついていない。B社は純利益30億で営業CF 60億。利益以上に現金が入っており、実態はB社の方が健全です。',
                whyItMatters: '「利益は意見、キャッシュは事実」という言葉があります。この数字がプラスの企業は、配当も新規投資もできる本当の体力がある企業です。'
            },
            {
                id: 'free_cf', category: 'cashflow',
                title: 'フリーキャッシュフロー', subtitle: 'Free Cash Flow',
                icon: 'fa-solid fa-wallet', accent: '#a855f7', accentBg: '#faf5ff',
                level: '応用',
                oneLiner: '企業が「自由に使えるお金」。本業で稼いだ現金から必要な投資を引いた残りです。',
                explanation: [
                    '「営業CF \u2212 設備投資」で計算します。本業で稼いで、事業維持に必要な投資を済ませた後に残るお金。',
                    '本アプリではプラス（0超）を基準にしています。フリーCFがプラスなら、事業を維持しながらも余裕がある状態です。',
                    'このお金は配当、借金返済、新規事業など、経営判断で自由に使えます。毎年プラスの企業は自力で成長できる力を持っています。'
                ],
                example: '営業CF 100億、設備投資40億 \u2192 フリーCF 60億円。この60億円は配当に回すことも、新工場を建てることもできる。経営の選択肢が広い状態です。',
                whyItMatters: '企業の「本当の余裕度」を示す数字。毎年プラスなら自力で成長でき、株主にも還元できる。長期的な健全性を見る最も信頼できる指標のひとつです。'
            },

            // === 割安度 ===
            {
                id: 'per', category: 'valuation',
                title: 'PER（株価収益率）', subtitle: 'Price Earnings Ratio',
                icon: 'fa-solid fa-tag', accent: '#ca8a04', accentBg: '#fefce8',
                level: '基本',
                oneLiner: '今の株価が「利益の何年分」にあたるか。市場の期待値がわかる指標です。',
                explanation: [
                    '「株価 \u00f7 1株あたり利益（EPS）」で計算。PER 15倍なら「15年分の利益を先払いしている」イメージです。',
                    '本アプリでは40倍未満を基準にしています。40倍を超えると期待先行で株価が膨らみすぎている可能性があります。',
                    '日本株の平均は約15倍。成長企業は30〜50倍でも買われることがありますが、同業種の平均と比較することが大切です。'
                ],
                example: 'A社（PER 10倍）とB社（PER 40倍）。A社が割安に見えますが、B社が毎年30%成長しているなら40倍でも妥当かもしれません。PERだけで判断せず、成長性と合わせて考えます。',
                whyItMatters: '市場がその企業の将来にどれだけ期待しているかの表れです。低すぎれば見落とされた可能性があり、高すぎれば期待過剰の可能性がある。企業の実力とセットで見ましょう。'
            },
            {
                id: 'pbr', category: 'valuation',
                title: 'PBR（株価純資産倍率）', subtitle: 'Price Book-value Ratio',
                icon: 'fa-solid fa-scale-balanced', accent: '#db2777', accentBg: '#fdf2f8',
                level: '基本',
                oneLiner: '株価が「会社の資産価値の何倍か」を示します。1倍以下なら資産価値より安く買える状態。',
                explanation: [
                    '「株価 \u00f7 1株あたり純資産（BPS）」で計算。PBR 1倍は「会社を解散して資産を分配したら株価と同額が戻る」水準です。',
                    '本アプリでは10倍未満を基準にしています。10倍を超えると、資産に対して株価がかなり高い状態。期待が過剰に織り込まれている可能性があります。',
                    '低い＝お買い得とは限りません。資産の中身（現金なのか、古い設備なのか）も確認が必要です。'
                ],
                example: 'PBR 0.7倍の会社。資産価値1000円に対して700円で買えます。ただしその資産が古い工場ばかりなら、実際の価値はもっと低いかもしれません。',
                whyItMatters: '資産面から見た株価の割安・割高がわかります。PER（利益面）とセットで見ることで、より立体的な判断ができるようになります。'
            },

            // === テクニカル分析の基礎 ===
            {
                id: 'moving_average', category: 'technical',
                title: '移動平均線', subtitle: 'Moving Average',
                icon: 'fa-solid fa-wave-square', accent: '#0891b2', accentBg: '#ecfeff',
                level: '基本',
                oneLiner: '一定期間の株価の平均値をつないだ線。日々の値動きをならして「大きな流れ」を見るための基本ツールです。',
                explanation: [
                    '移動平均線は、過去の一定期間（例えば25日間）の終値を平均して、それを毎日つないで描いた線です。日々の細かい上下をならして、トレンド（方向性）を見やすくします。',
                    'よく使われるのは「短期線（5日・25日）」と「長期線（75日・200日）」。短期線は直近の動きに敏感に反応し、長期線はゆっくりと大きな流れを表します。',
                    '株価が移動平均線より上にあれば「上昇トレンド」、下にあれば「下降トレンド」と読むのが基本です。ただしこれは過去の平均値なので、未来を予測するものではなく、あくまで「今の流れ」を視覚的に捉える道具です。'
                ],
                example: 'ある銘柄の株価が1,000円前後で毎日上がったり下がったりしているとき、25日移動平均線が950円→960円→970円とじわじわ上がっていたら、日々の上下に惑わされず「全体としては上昇傾向」と読めます。逆に移動平均線が下がり続けていれば、全体の流れは下向きです。',
                whyItMatters: '日々の株価だけ見ていると「木を見て森を見失う」状態になりがちです。移動平均線を使えば、細かいノイズを取り除いて大きなトレンドを把握できます。次に学ぶゴールデンクロス・デッドクロスの土台になる概念です。'
            },
            {
                id: 'golden_cross', category: 'technical',
                title: 'ゴールデンクロス', subtitle: 'Golden Cross',
                icon: 'fa-solid fa-arrow-trend-up', accent: '#16a34a', accentBg: '#f0fdf4',
                level: '基本',
                oneLiner: '短期の移動平均線が長期の移動平均線を下から上に突き抜ける現象。上昇トレンドへの転換サインとされます。',
                explanation: [
                    '短期移動平均線（例：25日線）が、長期移動平均線（例：75日線）を下から上に抜けることを「ゴールデンクロス（GC）」と呼びます。',
                    'これは「直近の株価の勢いが、長期的な流れを上回り始めた」ことを意味します。下落や横ばいのトレンドから上昇トレンドへの転換点として注目されるシグナルです。',
                    'ただし、GCが出たからといって必ず上がるわけではありません。「だまし」と呼ばれる一時的なクロスもあるため、出来高（売買の活発さ）や企業の業績など、他の情報と合わせて判断することが大切です。'
                ],
                example: 'ある銘柄がしばらく下落した後、25日線が75日線を下から上に抜けました。その後上昇トレンドに入り3ヶ月で20%上昇したケースもあれば、クロス後すぐにまた下がってしまう「だまし」のケースもあります。GCは「注目するきっかけ」であって、それだけで判断するものではありません。',
                whyItMatters: '本アプリのGC銘柄一覧で表示されるシグナルがまさにこれです。「なぜこの銘柄がピックアップされているのか」を理解した上で、企業の業績や財務と合わせて見ることで、より深い分析ができるようになります。'
            },
            {
                id: 'dead_cross', category: 'technical',
                title: 'デッドクロス', subtitle: 'Dead Cross',
                icon: 'fa-solid fa-arrow-trend-down', accent: '#64748b', accentBg: '#f1f5f9',
                level: '基本',
                oneLiner: '短期の移動平均線が長期の移動平均線を上から下に突き抜ける現象。下降トレンドへの転換サインとされます。',
                explanation: [
                    'ゴールデンクロスの逆で、短期移動平均線が長期移動平均線を上から下に抜けることを「デッドクロス（DC）」と呼びます。',
                    'これは「直近の株価の勢いが弱まり、長期的な流れを下回り始めた」ことを意味します。上昇トレンドから下落トレンドへの転換点として警戒されるシグナルです。',
                    'GCと同様に「だまし」もあります。一時的に下抜けしてもすぐに回復するケースもあるため、慌てず他の情報と合わせて冷静に判断しましょう。企業のファンダメンタルズ（業績・財務）が健全なら、一時的な調整の可能性もあります。'
                ],
                example: '好調だった銘柄の25日線が75日線を上から下に抜けました。「業績悪化で本格的な下落が始まった」ケースもあれば、「一時的な調整でその後すぐ回復した」ケースもあります。DCが出たからといって慌てるのではなく、なぜ株価が下がっているのか（業績？市場全体の動き？）を確認することが大切です。',
                whyItMatters: '本アプリのDC銘柄一覧で表示されるシグナルです。GCと対で理解することで、テクニカルシグナルの意味を正しく読み取れるようになります。テクニカルは「きっかけ」、ファンダメンタルは「裏付け」。両方合わせて見るのが企業分析の基本です。'
            },

            // === 投資の考え方 ===
            {
                id: 'dca', category: 'strategy',
                title: 'ドルコスト平均法', subtitle: 'Dollar-Cost Averaging',
                icon: 'fa-solid fa-calendar-check', accent: '#7c3aed', accentBg: '#faf5ff',
                level: '基本',
                oneLiner: '一定金額を定期的に買い続ける方法。「いつ買うか」を悩まなくてよくなる、シンプルで強力な考え方です。',
                explanation: [
                    '毎月同じ金額（例えば1万円）で同じ銘柄を買い続ける方法です。株価が高いときは少ない株数、安いときは多い株数を買うことになるので、1株あたりの購入単価が自然と平均化されます。',
                    '例えば毎月1万円で買う場合、株価が1,000円なら10株、500円なら20株、2,000円なら5株買えます。高いときに買いすぎず、安いときにたくさん買えるので、結果として「高値づかみ」のリスクが抑えられます。',
                    'この方法の最大のメリットは「買い時を考えなくていい」こと。プロでも「今が安いか高いか」を正確に当て続けることはできません。定期的に淡々と買い続けることで、感情に振り回されない行動ができます。',
                    'ただし万能ではありません。長期的に下がり続ける銘柄に対しては、平均取得単価が下がっても損失が拡大します。「どの企業を買うか」の見極め（＝企業分析）があってこそ、この手法が活きてきます。'
                ],
                example: '毎月1万円でA社の株を1年間買い続けたとします。株価は月によって800円〜1,200円で上下しました。12ヶ月の平均購入単価は約980円。もし「今が安い！」と思って最初に12万円を一括で買っていたら、そのときの株価1,100円が購入単価になり、ドルコスト平均法の方が結果的に安く買えたことになります。もちろん逆のケースもありますが、「タイミングを読む必要がない」のが最大の強みです。',
                whyItMatters: '「いい会社を見つけたけど、いつ買えばいいかわからない」という悩みを解消してくれる考え方です。企業分析で良い会社を見つけたら、あとは定期的に淡々と買い続ける。分析力と組み合わせることで、感情に左右されない合理的な行動につながります。'
            },
        ],

        getTermsByCategory(catId) {
            return this.terms.filter(t => t.category === catId);
        },

        toggle(id) {
            if (this.openTerms.includes(id)) {
                this.openTerms = this.openTerms.filter(t => t !== id);
            } else {
                this.openTerms.push(id);
            }
        }
    }
}

function sectorApp() {
    return {
        loading: true,
        sectors: [],
        selectedSector: null,
        sortKey: 'company_code',
        sortDir: 'asc',
        chartInstance: null,

        // セクター別の説明・値動き特徴
        sectorInfoMap: {
            '情報技術': {
                description: 'ソフトウェア・半導体・IT機器など技術革新を担うセクター。研究開発投資が大きく、成長期待が高い企業が多い。',
                movement: '景気拡大期に強く、金利上昇局面では割高感から売られやすい。個別企業の業績や新技術のインパクトで値動きが大きくなる傾向。'
            },
            '金融': {
                description: '銀行・証券・保険など、お金の流れを支えるセクター。金利環境や経済全体の動向に業績が左右される。',
                movement: '金利上昇局面では利ざや拡大で恩恵を受けやすい。景気後退期は貸し倒れリスクが意識され、下落しやすい傾向。'
            },
            '一般消費財・サービス': {
                description: '自動車・アパレル・外食・レジャーなど、消費者の「欲しい」に応えるセクター。景気の良し悪しで購買意欲が変わるため業績の波が出やすい。',
                movement: '景気回復期に先行して上がりやすく、景気後退の兆候では早めに売られる傾向。個人消費の動向やインバウンド需要の影響も大きい。'
            },
            '生活必需品': {
                description: '食品・日用品・飲料など、景気に関係なく日常的に必要とされる商品を扱うセクター。安定した需要が特徴。',
                movement: '景気に左右されにくく、相場全体が荒れているときに「守りの銘柄」として買われやすい。大きく上がりにくい反面、下落にも強いディフェンシブな性格。'
            },
            'ヘルスケア': {
                description: '製薬・医療機器・バイオテクノロジーなど、人々の健康を支えるセクター。高齢化社会で中長期的な成長が期待される。',
                movement: '景気に比較的左右されにくいディフェンシブな性格だが、新薬の承認・失敗など個別のイベントで大きく動くことがある。'
            },
            '資本財': {
                description: '機械・建設・航空・物流など、社会インフラや企業の設備投資を支えるセクター。経済活動の活発さが業績に直結する。',
                movement: '景気の波に連動しやすい景気敏感株が多い。設備投資サイクルや公共事業の動向に左右される傾向。'
            },
            '素材': {
                description: '化学・鉄鋼・非鉄金属・紙パルプなど、製造業の原材料を提供するセクター。資源価格や為替の影響を受けやすい。',
                movement: '資源価格や為替レートに敏感に反応する。景気拡大期は需要増で好調だが、景気後退期は需要減と在庫調整で下落しやすい。'
            },
            'エネルギー': {
                description: '石油・ガス・電力など、社会のエネルギー供給を担うセクター。原油価格やエネルギー政策の影響が大きい。',
                movement: '原油・天然ガスなどの資源価格と連動する傾向が強い。地政学リスクやOPECの動向など、海外要因で急変することもある。'
            },
            '不動産': {
                description: 'デベロッパー・REIT・不動産管理など、土地や建物に関わるセクター。金利と景気の両方に影響を受ける。',
                movement: '金利上昇局面では借入コスト増で逆風、金利低下局面では追い風。都市部の地価動向やオフィス空室率にも左右される。'
            },
            '公益事業': {
                description: '電力・ガス・水道など、社会インフラとして安定した需要がある事業。規制産業のため収益は安定しやすいが成長性は控えめ。',
                movement: '値動きは比較的穏やか。配当利回りが高めの銘柄が多く、金利低下局面では債券代わりに買われやすい。ディフェンシブの代表格。'
            },
            'コミュニケーション・サービス': {
                description: '通信・メディア・エンターテインメントなど、情報の伝達・発信に関わるセクター。通信インフラとコンテンツの両面がある。',
                movement: '通信インフラ系は安定的でディフェンシブ、メディア・コンテンツ系は広告収入や視聴動向で変動しやすい。セクター内で性格が分かれる。'
            }
        },

        // セクター名からセクター情報を取得
        getSectorInfo(sectorName) {
            return this.sectorInfoMap[sectorName] || null;
        },

        // セクターに含まれる企業数に応じたチャート高さ
        get chartHeight() {
            if (!this.selectedSector || !this.selectedSector.companies) return 200;
            var count = this.selectedSector.companies.length;
            // 各バーに30px、最低200px
            return Math.max(200, count * 30 + 60);
        },

        // 全企業数合計
        get totalCompanies() {
            var total = 0;
            for (var i = 0; i < this.sectors.length; i++) {
                total += this.sectors[i].count || 0;
            }
            return total;
        },

        // ソート済み企業リスト
        get sortedCompanies() {
            if (!this.selectedSector || !this.selectedSector.companies) return [];
            var companies = this.selectedSector.companies.slice();
            var key = this.sortKey;
            var dir = this.sortDir;
            companies.sort(function(a, b) {
                var valA = a[key];
                var valB = b[key];
                // null値は末尾に
                if (valA == null && valB == null) return 0;
                if (valA == null) return 1;
                if (valB == null) return -1;
                // 文字列比較
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return dir === 'asc' ? valA.localeCompare(valB, 'ja') : valB.localeCompare(valA, 'ja');
                }
                // 数値比較
                return dir === 'asc' ? valA - valB : valB - valA;
            });
            return companies;
        },

        // APIからデータ取得
        fetchData() {
            var self = this;
            self.loading = true;
            fetch('/api/sector/summary')
                .then(function(res) {
                    if (!res.ok) throw new Error('データの取得に失敗しました');
                    return res.json();
                })
                .then(function(data) {
                    self.sectors = data.sectors || [];
                    self.loading = false;
                })
                .catch(function(err) {
                    console.error('セクターデータ取得エラー:', err);
                    self.sectors = [];
                    self.loading = false;
                });
        },

        // セクターを選択
        selectSector(sector) {
            // 同じセクターをクリックした場合はトグル
            if (this.selectedSector && this.selectedSector.sector === sector.sector) {
                this.selectedSector = null;
                this.destroyChart();
                return;
            }
            this.selectedSector = sector;
            this.sortKey = 'company_code';
            this.sortDir = 'asc';
            // チャートは次フレームで描画（DOM更新後）
            var self = this;
            this.$nextTick(function() {
                self.renderChart();
                // 詳細パネルまでスクロール
                var panel = document.querySelector('.detail-panel');
                if (panel) {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        },

        // ソートキー切り替え
        sortBy(key) {
            if (this.sortKey === key) {
                this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortKey = key;
                this.sortDir = 'asc';
            }
        },

        // 数値フォーマット（null安全）
        formatNum(val, decimals) {
            if (val == null || val === '' || isNaN(val)) return '\u2014';
            return Number(val).toLocaleString('ja-JP', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        },

        // 時価総額フォーマット
        formatMarketCap(val) {
            if (val == null || val === '' || isNaN(val)) return '\u2014';
            return Number(val).toLocaleString('ja-JP');
        },

        // チャート破棄
        destroyChart() {
            if (this.chartInstance) {
                this.chartInstance.destroy();
                this.chartInstance = null;
            }
        },

        // PER分布バーチャートを描画
        renderChart() {
            this.destroyChart();
            if (!this.selectedSector || !this.selectedSector.companies || this.selectedSector.companies.length === 0) return;

            var canvas = document.getElementById('perChart');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');

            // PERの値でソート（nullは除外）
            var companies = this.selectedSector.companies
                .filter(function(c) { return c.per_forward != null && !isNaN(c.per_forward); })
                .sort(function(a, b) { return b.per_forward - a.per_forward; });

            if (companies.length === 0) return;

            var labels = companies.map(function(c) { return c.company_name; });
            var dataValues = companies.map(function(c) { return c.per_forward; });
            var avgPer = this.selectedSector.avg_per;

            this.chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PER',
                        data: dataValues,
                        backgroundColor: '#2d6a4f',
                        borderColor: '#2d6a4f',
                        borderWidth: 0,
                        borderRadius: 3,
                        barThickness: 16
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleFont: { family: "'Inter', 'Noto Sans JP', sans-serif", size: 12 },
                            bodyFont: { family: "'Inter', 'Noto Sans JP', sans-serif", size: 12 },
                            padding: 10,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    return 'PER: ' + context.parsed.x.toFixed(1) + '\u500D';
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: '#f3f4f6',
                                drawBorder: false
                            },
                            ticks: {
                                font: { family: "'Inter', 'Noto Sans JP', sans-serif", size: 11 },
                                color: '#a3a3a3',
                                callback: function(value) {
                                    return value + '\u500D';
                                }
                            },
                            title: {
                                display: true,
                                text: 'PER (\u500D)',
                                font: { family: "'Inter', 'Noto Sans JP', sans-serif", size: 11, weight: '500' },
                                color: '#a3a3a3'
                            }
                        },
                        y: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                font: { family: "'Inter', 'Noto Sans JP', sans-serif", size: 11 },
                                color: '#525252'
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'avgLine',
                    afterDraw: function(chart) {
                        if (avgPer == null || isNaN(avgPer)) return;
                        var xScale = chart.scales.x;
                        var chartArea = chart.chartArea;
                        var xPos = xScale.getPixelForValue(avgPer);
                        if (xPos < chartArea.left || xPos > chartArea.right) return;

                        var ctx2 = chart.ctx;
                        ctx2.save();
                        ctx2.strokeStyle = '#ef4444';
                        ctx2.lineWidth = 2;
                        ctx2.setLineDash([6, 4]);
                        ctx2.beginPath();
                        ctx2.moveTo(xPos, chartArea.top);
                        ctx2.lineTo(xPos, chartArea.bottom);
                        ctx2.stroke();

                        // ラベル
                        ctx2.setLineDash([]);
                        ctx2.fillStyle = '#ef4444';
                        ctx2.font = "500 10px 'Inter', 'Noto Sans JP', sans-serif";
                        ctx2.textAlign = 'center';
                        ctx2.fillText('\u5E73\u5747 ' + avgPer.toFixed(1), xPos, chartArea.top - 6);
                        ctx2.restore();
                    }
                }]
            });
        }
    };
}
</script>
{% endblock %}
