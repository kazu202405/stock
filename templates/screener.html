{% extends "layout.html" %}

{% block title %}お気に入り企業一覧{% endblock %}

{% block content %}
<div class="min-h-screen" style="background: #fafaf8;">
    <!-- ヘッダーセクション -->
    <div class="text-white" style="background: linear-gradient(135deg, #1b4332, #2d6a4f, #1b4332);">
        <div class="max-w-none mx-auto px-6 py-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight mb-2">
                        <i class="fas fa-star text-yellow-400 mr-2"></i>お気に入り企業一覧
                    </h1>
                    <p class="text-slate-300 text-lg">登録した企業の財務データを一覧で確認</p>
                </div>
                <div class="mt-6 lg:mt-0 text-right">
                    <div class="text-center lg:text-right">
                        <div class="text-2xl font-bold text-yellow-400" id="favoriteCount">0</div>
                        <div class="text-sm text-slate-400">登録企業数</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- テーブルセクション -->
    <div class="max-w-none mx-auto px-6 py-6">
        <!-- 空状態メッセージ（データがない場合） -->
        <div id="emptyState" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-star text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">お気に入りが登録されていません</h3>
                <p class="text-gray-500 mb-6">トップページで企業を分析し、お気に入りに登録しましょう</p>
                <a href="/dashboard" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                    <i class="fas fa-search mr-2"></i>企業を探す
                </a>
            </div>
        </div>

        <!-- 注記 -->
        <p style="font-size:11px; color:#a3a3a3; margin-bottom:12px; line-height:1.5;">※ 掲載情報は企業の財務状況を整理したものであり、特定銘柄の推奨ではありません。</p>

        <!-- テーブル -->
        <div id="tableContainer" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="company">
                                <div class="flex items-center space-x-1">
                                    <span>企業名</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="match_rate">
                                <div class="flex items-center space-x-1">
                                    <span>合致度</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                セクター
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="market_cap">
                                <div class="flex items-center space-x-1">
                                    <span>時価総額</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="stock_price">
                                <div class="flex items-center space-x-1">
                                    <span>株価</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="equity_ratio">
                                <div class="flex items-center space-x-1">
                                    <span>自己資本比率</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="operating_margin">
                                <div class="flex items-center space-x-1">
                                    <span>営業利益率</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="per">
                                <div class="flex items-center space-x-1">
                                    <span>PER</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="pbr">
                                <div class="flex items-center space-x-1">
                                    <span>PBR</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors sortable" data-sort="dividend_yield">
                                <div class="flex items-center space-x-1">
                                    <span>配当利回り</span>
                                    <i class="fas fa-sort text-gray-400 text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                アクション
                            </th>
                        </tr>
                    </thead>
                    <tbody id="favoritesTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    /* 合致度の色分け */
    .match-high { color: #16a34a; font-weight: 600; }
    .match-medium { color: #ca8a04; font-weight: 600; }
    .match-low { color: #dc2626; font-weight: 600; }
</style>

<script>
    let favorites = [];
    let sortColumn = '';
    let sortDirection = 'asc';
    let isLoading = true;

    // APIからウォッチリストデータを取得
    async function loadFavorites() {
        const tbody = document.getElementById('favoritesTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('tableContainer');

        // ローディング表示
        tableContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="px-4 py-12 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-3 block"></i>
                    データを読み込み中...
                </td>
            </tr>
        `;

        try {
            const response = await fetch('/api/watchlist');
            if (!response.ok) throw new Error('データの取得に失敗しました');
            const data = await response.json();
            favorites = data.watchlist || [];
        } catch (err) {
            console.error('ウォッチリスト取得エラー:', err);
            favorites = [];
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-12 text-center text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-3 block"></i>
                        データの読み込みに失敗しました。ページを再読み込みしてお試しください。
                    </td>
                </tr>
            `;
            return;
        }

        isLoading = false;
        renderFavorites();
    }

    // 時価総額フォーマット（億円単位 → 兆/億表示）
    function formatMarketCapOku(oku) {
        if (oku === null || oku === undefined) return '---';
        if (oku >= 10000) {
            return `${(oku / 10000).toFixed(1)}兆`;
        }
        return `${Math.round(oku)}億`;
    }

    // 株価フォーマット
    function formatWatchlistPrice(num) {
        if (num === null || num === undefined) return '---';
        return `¥${Math.round(num).toLocaleString()}`;
    }

    // 合致度の色分けクラスを取得
    function getMatchRateClass(value) {
        if (value === null || value === undefined) return '';
        if (value >= 70) return 'match-high';
        if (value >= 40) return 'match-medium';
        return 'match-low';
    }

    // セクターのバッジ色を取得
    function getSectorBadge(sector) {
        const colors = {
            'テクノロジー': 'bg-blue-100 text-blue-800',
            '消費財': 'bg-purple-100 text-purple-800',
            '素材': 'bg-gray-100 text-gray-800',
            '製造業': 'bg-indigo-100 text-indigo-800',
            '金融': 'bg-green-100 text-green-800',
            'ヘルスケア': 'bg-red-100 text-red-800'
        };
        return colors[sector] || 'bg-gray-100 text-gray-800';
    }

    // テーブル描画
    function renderFavorites() {
        const tbody = document.getElementById('favoritesTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('tableContainer');
        const countEl = document.getElementById('favoriteCount');

        countEl.textContent = favorites.length;

        if (favorites.length === 0) {
            emptyState.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        tableContainer.classList.remove('hidden');

        let html = '';
        favorites.forEach(item => {
            const matchRate = item.match_rate !== null && item.match_rate !== undefined ? `${item.match_rate}` : '---';
            const matchClass = getMatchRateClass(item.match_rate);
            const sectorBadge = getSectorBadge(item.sector);

            const equityRatio = item.equity_ratio;
            const equityClass = equityRatio == null ? 'bg-gray-100 text-gray-800'
                : equityRatio >= 50 ? 'bg-green-100 text-green-800'
                : equityRatio >= 30 ? 'bg-yellow-100 text-yellow-800'
                : 'bg-red-100 text-red-800';
            const opMargin = item.operating_margin;
            const opClass = opMargin == null ? 'bg-gray-100 text-gray-800'
                : opMargin >= 15 ? 'bg-green-100 text-green-800'
                : opMargin >= 5 ? 'bg-yellow-100 text-yellow-800'
                : 'bg-red-100 text-red-800';

            html += `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900 cursor-pointer hover:text-blue-600"
                                 onclick="analyzeFromFavorite('${item.company_code}')">
                                ${item.company_name || '---'}
                            </div>
                            <div class="text-xs text-gray-500">${item.company_code}</div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="text-sm font-semibold ${matchClass}">${matchRate}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${sectorBadge}">${item.sector || '---'}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                        ${formatMarketCapOku(item.market_cap)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatWatchlistPrice(item.stock_price)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${equityClass}">
                            ${equityRatio != null ? equityRatio + '%' : '---'}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${opClass}">
                            ${opMargin != null ? opMargin + '%' : '---'}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.per_forward ? Number(item.per_forward).toFixed(1) + '倍' : '---'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.pbr ? Number(item.pbr).toFixed(2) + '倍' : '---'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.dividend_yield ? Number(item.dividend_yield).toFixed(2) + '%' : '---'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <button onclick="removeFavorite('${item.company_code}')"
                                class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                            <i class="fas fa-trash-alt mr-1"></i>削除
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // お気に入りから削除（API連携）
    async function removeFavorite(code) {
        if (!confirm('この企業をお気に入りから削除しますか？')) return;

        try {
            const response = await fetch(`/api/watchlist/remove/${code}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('削除に失敗しました');
            favorites = favorites.filter(item => item.company_code !== code);
            renderFavorites();
        } catch (err) {
            console.error('削除エラー:', err);
            alert('削除できませんでした。しばらくしてからもう一度お試しください。');
        }
    }

    // 企業名クリック → トップページの分析パネルへ遷移
    function analyzeFromFavorite(code) {
        const stockCode = code.replace('.T', '');
        window.location.href = `/dashboard?code=${stockCode}`;
    }

    // ソート機能
    document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const column = th.dataset.sort;

            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // ヘッダーのアイコン更新
            document.querySelectorAll('th.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort text-gray-400 text-xs';
            });
            const currentIcon = th.querySelector('i');
            currentIcon.className = sortDirection === 'asc'
                ? 'fas fa-sort-up text-blue-500 text-xs'
                : 'fas fa-sort-down text-blue-500 text-xs';

            // ソート実行
            sortFavorites(column, sortDirection);
        });
    });

    function sortFavorites(column, direction) {
        favorites.sort((a, b) => {
            let aVal, bVal;

            if (column === 'company') {
                aVal = a.company_name;
                bVal = b.company_name;
                return direction === 'asc' ? aVal.localeCompare(bVal, 'ja') : bVal.localeCompare(aVal, 'ja');
            }

            // 数値カラム
            aVal = a[column] || 0;
            bVal = b[column] || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
        });

        renderFavorites();
    }

    // 初期表示（APIからデータ取得）
    loadFavorites();
</script>
{% endblock %}
