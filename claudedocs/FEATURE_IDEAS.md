# 機能追加アイデア

## ユーザー提案

| 機能 | 概要 | 必要なもの | 優先度 |
|------|------|-----------|--------|
| **マイページ充実** | ダッシュボード的なもの（今は空っぽ） | 表示コンテンツの設計 | 高 |
| **スコアリング** | 複数指標を総合評価して点数化 | 評価基準の設計 | 高 |
| **お気に入り登録** | ユーザー別の銘柄保存 | ログイン機能（未実装）、現在はダミーデータ版あり | 高 |

---

## 最優先タスク（認証・課金基盤）

以下はサービス公開前に必須の基盤機能。他の機能追加より先に着手すること。

### 1. ログイン機能の有効化
- **現状**: `models/login.py` は存在するが `app.py` でコメントアウト中。`root.py` に仮ルート（何でもログイン可）あり
- **やること**:
  - `app.py` の `from models.login import *` を有効化
  - DB接続（Supabase の users テーブル）との疎通確認
  - flask-login のセッション管理を正常動作させる
  - 仮ルート（`root.py` の `/login`）を削除し、`login.py` の本物に切り替え
  - ログイン成功後のリダイレクト先: `/dashboard`

### 2. アカウント作成（新規登録）機能
- **やること**:
  - `/register` ルート + 登録フォーム（`templates/register.html`）作成
  - メールアドレス + パスワードで登録
  - パスワードハッシュ化（werkzeug）
  - 登録後の自動ログイン → `/dashboard` へリダイレクト
  - LP の「無料で始める」ボタンを `/register` にリンク
  - login.html の「アカウントをお持ちでない方はこちら」を `/register` にリンク

### 3. 代理店 / ユーザーのロール切り分け
- **ロール設計**:
  - `user`（一般ユーザー）: 分析機能、お気に入り、マイページ
  - `agency`（代理店）: 上記 + 配下ユーザー管理、代理店ダッシュボード
  - `admin`（システム管理者）: 全権限 + 管理画面（`/dashboard/admin`）
- **DB変更**: users テーブルに `role` カラム追加（`VARCHAR(20) DEFAULT 'user'`）
- **やること**:
  - ルートごとのアクセス制御（デコレータ or ミドルウェア）
  - 代理店向けダッシュボード（配下ユーザー一覧、利用状況）
  - ナビバーの表示分岐（ロールに応じたメニュー）

### 4. Stripe 課金連携
- **課金モデル案**:
  - 一般ユーザー: 月額サブスクリプション（Stripe Checkout / Customer Portal）
  - 代理店: 代理店プラン（配下ユーザー数に応じた従量 or 固定料金）
- **DB変更**:
  - users テーブルに `stripe_customer_id`, `subscription_status`, `subscription_plan` 追加
  - 新規テーブル: `subscriptions`（プラン詳細、課金履歴）
- **やること**:
  - Stripe アカウント設定、API キー管理
  - プラン作成（Stripe Dashboard or API）
  - Checkout セッション生成 → 決済完了 Webhook 受信
  - Customer Portal でプラン変更・解約
  - 代理店: 配下ユーザーの一括課金 or 個別課金の設計
  - 未課金ユーザーのアクセス制限（無料枠の設計）

### 5. お気に入り登録のユーザー紐付け
- **現状**: screener.html はダミーデータ表示。watchlist API は Supabase 連携済みだがユーザー認証なし
- **やること**:
  - ログインユーザーの ID で watchlist を絞り込み
  - screener.html のダミーデータを `/api/watchlist` 呼び出しに置き換え
  - 未ログイン時はログインページへリダイレクト

### 実装順序
```
1. ログイン有効化（既存コードの有効化 + 動作確認）
2. アカウント作成（登録フォーム + DB登録）
3. ロール切り分け（role カラム + アクセス制御）
4. お気に入りのユーザー紐付け（watchlist API の認証対応）
5. Stripe 課金連携（サブスクリプション + 代理店プラン）
```

---

## 追加提案

### 投資判断サポート系

| 機能 | 概要 | 難易度 | 備考 |
|------|------|--------|------|
| **銘柄比較** | 2〜4銘柄を横並びで比較表示 | 低 | UIの追加だけで実現可能 |
| **銘柄メモ** | 銘柄ごとに投資判断メモを残せる | 低 | テーブル追加のみ |
| **アラート設定** | 株価や指標が閾値超えたら通知 | 中 | バックグラウンドジョブ必要 |
| **配当カレンダー** | 登録銘柄の配当予定日一覧 | 中 | yfinanceから取得可能 |

### ポートフォリオ系

| 機能 | 概要 | 難易度 | 備考 |
|------|------|--------|------|
| **保有銘柄管理** | 購入価格・株数を登録して損益計算 | 中 | 新規テーブル設計必要 |
| **セクター配分** | ポートフォリオの業種分散を可視化 | 中 | Chart.jsで円グラフ |
| **配当収入予測** | 年間配当収入の見込み計算 | 低 | 既存データで計算可能 |

### 分析強化系

| 機能 | 概要 | 難易度 | 備考 |
|------|------|--------|------|
| **業種平均比較** | 同業他社との指標比較 | 中 | 業種別の集計処理必要 |
| **成長率ランキング** | 売上・利益成長率でランク表示 | 低 | 既存データでソート |
| **割安度判定** | PER/PBR/配当利回りで割安銘柄抽出 | 低 | フィルター追加のみ |

### 出力系

| 機能 | 概要 | 難易度 | 備考 |
|------|------|--------|------|
| **PDF/Excelレポート** | 分析結果をファイル出力 | 中 | reportlab / openpyxl |
| **共有リンク** | 分析結果を他の人に共有 | 中 | 公開URL生成機能 |

---

## 優先度の提案

### Phase 1（すぐ実装可能・効果高い）

1. **スコアリング機能**　OK？
   - 既存データで計算するだけ
   - 評価基準例：
     - 自己資本比率 40%以上 → +20点
     - 営業利益率 10%以上 → +20点
     - ROE 12%以上 → +20点
     - 3年連続増収 → +20点
     - 配当利回り 3%以上 → +10点
     - PER 15倍以下 → +10点

2. **銘柄比較**
   - UIの追加だけで実現可能
   - ウォッチリストから複数選択 → 比較画面表示

3. **マイページ充実**
   - ウォッチリスト概要（登録数、スコア上位3銘柄）
   - 配当予定カレンダー（直近の配当）
   - 最近分析した銘柄

### Phase 2（中期的に実装）

4. **銘柄メモ機能**
   - screened_latestテーブルに`memo`カラム追加
   - 投資判断の理由を記録

5. **保有銘柄管理**
   - 新規テーブル: `holdings`
     - company_code, shares, purchase_price, purchase_date
   - 損益計算表示

6. **配当カレンダー**
   - yfinanceから配当予定日取得
   - カレンダー形式で表示

### Phase 3（将来的に検討）

7. **アラート機能**
8. **PDF/Excelレポート出力**
9. **業種平均比較**

---

## 合致度基準（yomu.md準拠）

### 総合合致度（120点満点）

12項目 × 10点 = 120点満点。各条件を満たせば10点加算。
※ コード実装は `stock.html` の `convertToScoreFormat()` を参照

| # | 指標 | 条件 | 配点 |
|---|------|------|------|
| 1 | 時価総額 | <= 700億円 | 10点 |
| 2 | 自己資本比率 | >= 30% | 10点 |
| 3 | 売上高増減率(2期前→前期) | > 0% | 10点 |
| 4 | 売上高営業利益率 | >= 10% | 10点 |
| 5 | 営業利益増減率(2期前→前期) | > 0% | 10点 |
| 6 | 営業CF前期 | > 0億円 | 10点 |
| 7 | フリーCF前期 | > 0億円 | 10点 |
| 8 | ROA(前期) | > 4.5% | 10点 |
| 9 | PER(来期) | < 40倍 | 10点 |
| 10 | PBR | < 10倍 | 10点 |
| 11 | 売上高増減率(前期→今期予) | > 0% | 10点 |
| 12 | 営業利益増減率(前期→今期予) | > 0% | 10点 |

### 未実装の条件（データ取得困難）

※ 業績予想データ取得機能は追加済み（項目11・12で一部活用中）

| 指標 | 理由 |
|------|------|
| TK会社乖離(売上高/営業利益) | データソースなし |
| 売上高増減率(今期予→来期予) | 来期予想データの取得が必要 |
| 営業利益増減率(今期予→来期予) | 来期予想データの取得が必要 |
| 上場年月 | 取得処理の追加が必要 |

### 合致度ランク

| ランク | 合致度 | 評価 |
|--------|--------|------|
| S | 80〜100 | 非常に優良 |
| A | 60〜79 | 優良 |
| B | 40〜59 | 標準 |
| C | 20〜39 | 要注意 |
| D | 0〜19 | 条件未達 |

---

## 必要なDB変更

### screened_latest テーブル追加カラム
```sql
ALTER TABLE screened_latest ADD COLUMN memo TEXT;
ALTER TABLE screened_latest ADD COLUMN score INTEGER;
ALTER TABLE screened_latest ADD COLUMN score_rank VARCHAR(1);
```

### 新規テーブル: holdings（保有銘柄）
```sql
CREATE TABLE holdings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    company_code VARCHAR(20) NOT NULL,
    shares INTEGER NOT NULL,
    purchase_price DECIMAL(10,2),
    purchase_date DATE,
    memo TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 新規テーブル: favorites（お気に入り）
```sql
CREATE TABLE favorites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    company_code VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, company_code)
);
```
